(function($,undef){"use strict";var debug=false;window.FileUpload_Debug=function(){if(debug&&console.log)if($.browser.msie){var output="Log: ";$.each(arguments,function(){output+=this});console.log(output)}else console.log.apply(console,arguments)};window.FileUpload_ToJSONIfPossible=function(responseText){if(responseText)try{return $.parseJSON(responseText)}catch(e){window.FileUpload_Debug(e)}return responseText}})(jQuery,"undefined");(function($,undef,debug){"use strict";var default_options={chunkEndpoint:"",finalEndpoint:"",beforeFinalSend:function(){},multipartEndpoint:"",completeRetries:300,defaultDataType:"json",defaultContentType:"application/x-www-form-urlencoded; charset=UTF-8",numberOfSimultaneousFileUploads:2,serializeFormData:true,chunkSize:5242880,maxFileSize:4294967296,runtimes:["HTMLRuntime","FlashRuntime","FrameRuntime"],autoUpload:false,deleteOnFailure:false,flashPath:"../swf/",ajaxLoader:"../img/ajax-loader.gif",fileLoading:"Loading file",fileComplete:"Complete",fileSize:"File too large"};function assert(expr,exception){if(expr)throw exception}function FileUpload(element,options){assert(element.nodeName.toLowerCase()!=="form","Invalid element, expected form nodeName");this.options=$.extend({},default_options,options||{});this.element=$(element);this.runtime=this.createRuntime();assert(!this.runtime,"No runtime supported");if(this.options.layout){this.element.addClass("layout-"+this.options.layout.toLowerCase());this.layout=new FileUpload.Layout[this.options.layout](this);this.layout.create()}this.runtime.create(this)}FileUpload.defaultOptions=default_options;FileUpload.hasSupport=function(runtimes){try{return new FileUpload(document.createElement("form"),{runtimes:runtimes||["HTMLRuntime","FlashRuntime"]})!==null}catch(e){return false}};FileUpload.formatBytes=function(bytes){var output=bytes/1024;if(output<1024)return output.toFixed(2)+"KB";output=output/1024;if(output<1024)return output.toFixed(2)+"MB";return(output/1024).toFixed(2)+"GB"};FileUpload.prototype.createRuntime=function(){var runtimeIndex,runtimes=this.options.runtimes;for(runtimeIndex=0;runtimeIndex<runtimes.length;runtimeIndex++){var runtimeName=runtimes[runtimeIndex];var Runtime=FileUpload.Runtime[runtimeName];if(Runtime.supports()){this.runtimeName=runtimeName;return new Runtime(this)}}return null};FileUpload.prototype.triggerEvent=function(eventName){if($.isFunction(this.options[eventName]))this.options[eventName].apply(this,$.makeArray(arguments).slice(1));this.element.trigger("FileUpload_"+eventName,$.makeArray(arguments).slice(1))};FileUpload.prototype.on=function(eventName,handler){var eventNames=$.map(eventName.split(" "),function(value){return"FileUpload_"+value+".FileUpload"}).join(" ");this.element.on(eventNames,handler)};$.each(["send","abort","remove"],function(){var functionName=this;FileUpload.prototype[functionName]=function(){this.runtime[functionName].apply(this.runtime,arguments)}});FileUpload.prototype.finalizeSend=function(file,success,responseHandler){responseHandler=responseHandler||$.noop;var submitData=$.extend({},{FileUploadId:file.fuid,FileUploadName:encodeURIComponent(file.name),FileUploadType:file.type,FileUploadSuccess:success,FileUploadSize:file.size},this.options.data||{});if(this.options.serializeFormData)$.each(this.element.serializeArray(),function(i,item){submitData[item.name]=item.value});var self=this;$.ajax(this.options.finalEndpoint,{beforeSend:this.options.beforeFinalSend,type:"post",dataType:this.options.defaultDataType,data:submitData,contentType:this.options.defaultContentType,success:function(response){responseHandler(false,response);self.triggerEvent("filefinish",file,success,false,response)},error:function(xhr){var text=window.FileUpload_ToJSONIfPossible(xhr.responseText);responseHandler(true,text);self.triggerEvent("filefinish",file,success,true,text)},file:file})};FileUpload.prototype.destroy=function(){if(this.layout){this.element.removeClass("layout-"+this.options.layout.toLowerCase());this.layout.destroy(this);delete this.layout}this.runtime.destroy(this);delete this.runtime;this.element.unbind(".FileUpload")};window.FileUpload=FileUpload})(jQuery,"undefined",FileUpload_Debug);(function($,undef,debug){"use strict";FileUpload.File=function(fuid,name,size,type){this.fuid=fuid||0;this.name=name||"unknown";this.size=size||0;this.type=type||"application/octet-stream"}})(jQuery,"undefined",FileUpload_Debug);(function($,undef,debug){"use strict";function Runtime(){}Runtime.create=function(name,runtimeCode){var runtime=function(fileUpload){this.fileUpload=fileUpload};$.extend(runtime.prototype,Runtime.prototype,runtimeCode);FileUpload.Runtime[name]=runtime;FileUpload.Runtime[name].supports=runtimeCode.supports};$.each(["create","destroy","send","abort","supports","remove","uploading"],function(){Runtime.prototype[this]=$.noop});Runtime.prototype.abort=function(fileId){if(fileId&&this.files[fileId]){debug("Aborting file id:",fileId);this.files[fileId].abort()}else if(!fileId){this.fileUpload.triggerEvent("abort");debug("Aborting all file uploads");this.fileStack=[];$.each(this.files,function(){this.abort()})}};Runtime.prototype.remove=function(fileId){if(fileId&&this.files[fileId]){var file=this.files[fileId];if(file.isUploading())throw"Abort or complete in order to remove";file.destroy();delete this.files[fileId]}else if(!fileId){if(this.uploading())throw"Abort or complete in order to remove";$.each(this.files,function(){this.destroy()});this.files={}}};FileUpload.Runtime=Runtime})(jQuery,"undefined",FileUpload_Debug);(function($,undef,debug){"use strict";function Layout(){}Layout.create=function(name,layoutCode){var layout=function(fileUpload){this.fileUpload=fileUpload};$.extend(layout.prototype,Layout.prototype,layoutCode);window.FileUpload.Layout[name]=layout};Layout.prototype.create=Layout.prototype.destroy=$.noop;FileUpload.Layout=Layout})(jQuery,"undefined",FileUpload_Debug);(function($,undef,debug){"use strict";FileUpload.Runtime.create("HTMLRuntime",{create:function(){this.filesUploading=0;this.files={};this.counter=0;var self=this,HTMLFile=FileUpload.Runtime.HTMLRuntime.File;this.fileUpload.element.on("change.FileUpload",":file",function(e){var target=e.target,newFiles=[];$.each(target.files,function(){var htmlFile=new HTMLFile(this,self.createFileOptions(self.counter));if(this.size>self.fileUpload.options.maxFileSize)self.fileUpload.triggerEvent("filesizeerror",htmlFile.info);else{self.files[self.counter]=new HTMLFile(this,self.createFileOptions(self.counter));newFiles.push(self.files[self.counter].info);self.counter++}});self.fileUpload.triggerEvent("select",newFiles);if(self.fileUpload.options.autoUpload)self.fileUpload.send();if(self.fileUpload.options.clearInputOnChange)target.value=""})},destroy:function(){if(this.timer)clearTimeout(this.timer);$.each(this.files,function(){this.destroy()});this.files=this.fileStack=null},createFileOptions:function(counter){var self=this,options=$.extend({},this.fileUpload.options,{finalize:function(success){var innerSelf=this;self.fileUpload.finalizeSend(this.info,success,function(isError,response,onComplete){if(!isError&&success){if(!innerSelf.aborted){debug("Deleting file with counter",innerSelf.options.counter);delete self.files[innerSelf.options.counter]}}else if(self.fileUpload.options.deleteOnFailure)delete self.files[innerSelf.options.counter]});self.filesUploading--},progress:function(percentage,bytesLoaded,progressEvent,xhrOptions){self.percentLoaded[this.info.fuid]=percentage;var percentTotal=0;$.each(self.percentLoaded,function(){percentTotal+=this});self.fileUpload.triggerEvent("totalprogress",Math.min(100,Math.ceil(percentTotal/self.stackCount)));self.fileUpload.triggerEvent("fileprogress",this.info,percentage)},counter:counter});var defaultEventHandler=function(eventName){return function(chunk){self.fileUpload.triggerEvent(eventName,this.info,chunk)}};$.each(["beforeStart","beforeSend","success","error"],function(){options[this]=defaultEventHandler("file"+this.toLowerCase())});return options},uploading:function(){return!!this.timeout},send:function(fileId){if(!this.uploading()){this.stackLoaded=0;this.percentLoaded={};this.stackSize=0;this.stackCount=0;this.fileStack=[]}var self=this;if(!fileId){$.each(this.files,function(counter){if($.inArray(counter,self.fileStack)===-1&&!self.files[counter].isUploading()){self.fileStack.push(counter);self.stackSize+=this.file.size;self.stackCount++}})}else if(this.files[fileId]&&!this.files[fileId].isUploading()){this.fileStack.push(fileId);this.stackSize+=this.files[fileId].file.size;this.stackCount++}debug("Total stack size: ",this.stackSize);this.fileUpload.triggerEvent("beforestart",{fileStack:this.fileStack,stackSize:this.stackSize,fileId:fileId,running:this.uploading()});this.fileStack=this.fileStack.reverse();if(!this.uploading())this.timeout=setInterval(function(){if(self.fileStack.length===0){clearInterval(self.timeout);self.timeout=null}else if(self.filesUploading<self.fileUpload.options.numberOfSimultaneousFileUploads){var counter=self.fileStack.pop();if(self.files[counter]){debug("Uploading file: ",counter,self.fileStack,self.files);self.files[counter].upload();self.filesUploading++}}},500)},supports:function(){if(typeof File===undef||typeof Blob===undef)return false;var isFn=$.isFunction;return isFn(Blob.prototype.webkitSlice)||isFn(Blob.prototype.mozSlice)||isFn(Blob.prototype.slice)}});$.ajaxPrefilter(function(options){options.xhr=function createStandardXhrWithUpload(){var xhr=$.ajaxSettings.xhr();if(xhr.upload)$.each(options.upload||{},function(event,listener){var optionsWrapper=function(e){return listener.call(this,e,options)};xhr.upload.addEventListener(event,optionsWrapper,false)});return xhr}})})(jQuery,"undefined",FileUpload_Debug);(function($,undef,debug){"use strict";var default_options={method:"post",chunkEndpoint:"",dataType:"html",numberOfSimultaneousChunkUploads:1,numberOfRetriesBeforeFailure:1e3,chunkSize:5242880,beforeStart:$.noop,beforeSend:$.noop,success:$.noop,error:$.noop,finalize:$.noop,progress:$.noop};function File(file,options){this.options=$.extend({},default_options,options||{});this.file=file;this.info=new FileUpload.File(this.options.counter,file.name,file.size,file.type);this.totalChunks=Math.ceil(file.size/this.options.chunkSize);this.chunksUploading=0;this.chunksUploaded=0}File.prototype.destroy=function(){if(this.timer)clearTimeout(this.timer);this.chunks=this.xhr=null};File.prototype.slice=function(start,end){if(this.file.slice)return this.file.slice(start,end);if(this.file.mozSlice)return this.file.mozSlice(start,end);return this.file.webkitSlice(start,end)};File.prototype.isUploading=function(){return!!this.timeout};File.prototype.upload=function(){debug("Starting upload process for file");if(this.isUploading()){debug("File is in uploading state, exit");return false}this.chunks=[];this.chunksLoaded=[];this.xhr={};this.uploaded=0;var startPosition=0,endPosition=this.options.chunkSize,index=0;while(startPosition<this.file.size){if(endPosition>this.file.size)endPosition=this.file.size;this.chunks.push({id:index,start:startPosition,end:endPosition,failures:0});index++;startPosition=endPosition;endPosition+=this.options.chunkSize}this.chunks=this.chunks.reverse();this.options.beforeStart.call(this);var self=this;this.percentage=0;this.aborted=false;this.timeout=setInterval(function(){if(self.chunks.length===0&&self.chunksUploading===0){clearInterval(self.timeout);self.timeout=null;self.finalize(self.chunksUploaded===self.totalChunks)}else if(!self.aborted)if(self.chunksUploading<self.options.numberOfSimultaneousChunkUploads&&self.chunks.length!==0)self.send()},500);return true};File.prototype.progressHandler=function(e,options){var self=this;setTimeout(function(){var bytesLoaded=0;$.each(self.chunksLoaded,function(){bytesLoaded+=this.end-this.start});bytesLoaded+=e.loaded;self.percentage=Math.max(self.percentage,Math.min(100,Math.ceil(bytesLoaded/self.file.size*100)));self.options.progress.call(self,self.percentage,bytesLoaded,e,options);debug("File progress: ",self.file.name," = ",self.percentage,"% (chunk:",options.chunk.id,")")},0)};File.prototype.send=function(){var chunk=this.chunks.pop(),blob=this.slice(chunk.start,chunk.end);debug("Sending a new file chunk",chunk);var options=this.options,self=this;var ajaxOptions={dataType:options.dataType,type:options.method,data:blob,timeout:3e4*(chunk.failures+1),contentType:"application/octet-stream",processData:false,chunk:chunk,upload:{progress:$.proxy(this.progressHandler,this),load:$.proxy(this.progressHandler,this)},beforeSend:function(xhr,settings){xhr.setRequestHeader("X-File-Chunk",settings.chunk.id);xhr.setRequestHeader("X-File-Start",settings.chunk.start);xhr.setRequestHeader("X-File-End",settings.chunk.end);xhr.setRequestHeader("X-File-Id",self.info.fuid);xhr.setRequestHeader("X-File-Name",encodeURIComponent(self.info.name));xhr.setRequestHeader("X-File-Size",self.info.size);xhr.setRequestHeader("X-File-Type",self.info.type);self.xhr[settings.chunk.id]=xhr;self.options.beforeSend.apply(self,$.merge([this.chunk],arguments))},success:function(){self.chunksUploaded++;self.chunksUploading--;self.chunksLoaded.push(this.chunk);delete self.xhr[this.chunk.id];self.options.success.apply(self,$.merge([this.chunk],arguments))},error:function(e,statusText){var errorChunk=this.chunk;debug("Failed to upload chunk",errorChunk,statusText);if(statusText!=="abort"&&errorChunk.failures<options.numberOfRetriesBeforeFailure){errorChunk.failures++;self.chunks.push(errorChunk);debug("Retrying to upload chunk",errorChunk)}self.chunksUploading--;delete self.xhr[errorChunk.id];self.options.error.apply(self,$.merge([this.chunk],arguments))}};$.ajax(options.chunkEndpoint,ajaxOptions);this.chunksUploading++};File.prototype.abort=function(){debug("Aborting file upload");this.aborted=true;this.chunks=[];this.chunksUploaded=0;$.each(this.xhr||[],function(){this.abort()})};File.prototype.finalize=function(success){debug("Finalizing file upload, success state: ",success);this.chunksUploading=0;this.options.finalize.apply(this,arguments)};window.FileUpload.Runtime.HTMLRuntime.File=File})(jQuery,"undefined",FileUpload_Debug);(function($,undef,debug){"use strict";var instanceCounter=0;var instances={};FileUpload.Runtime.create("FlashRuntime",{create:function(){var instanceId=this.instanceId=++instanceCounter;var options=this.fileUpload.options;this.fileUpload.options.numberOfRetriesBeforeFailure=1e3;var wrapElement=this.wrapElement=this.fileUpload.element.find(options.flashWrapper||":file");$("<div />").attr("id","runtime_"+this.instanceId).insertAfter(wrapElement);$(window).on("resize.FileUpload scroll.FileUpload DOMNodeInserted.FileUpload",$.proxy(this.positionAndResize,this));instances[instanceId]=this;this.embedSWF()},destroy:function(){this.getMovieObject().remove();$(window).unbind(".FileUpload")},init:function(){this.getMovie().setOptions(this.fileUpload.options);this.positionAndResize()},send:function(fileId){this.getMovie().upload(fileId||-1)},abort:function(fileId){this.getMovie().abort(fileId||-1)},remove:function(fileId){this.getMovie().remove(fileId||-1)},uploading:function(){return this.getMovie().uploading()},embedSWF:function(){var flashPath=this.fileUpload.options.flashPath;var flashvars={id:this.instanceId};var params={menu:"false",scale:"noScale",allowFullscreen:"true",allowNetworking:"all",allowScriptAccess:"always",bgcolor:"",wmode:"transparent"};var attributes={id:"flash_runtime_"+this.instanceId};swfobject.embedSWF(flashPath+"fileupload.swf","runtime_"+this.instanceId,"100%","100%","11.1.0",flashPath+"expressInstall.swf",flashvars,params,attributes)},handleFlashEvent:function(eventName,eventArgs){if(eventName==="filefinish"){var self=this;this.fileUpload.finalizeSend.call(this.fileUpload,eventArgs[0],eventArgs[1],function(isError,response,onComplete){if(eventArgs[1]&&!isError||self.fileUpload.options.deleteOnFailure)self.getMovie().deleteFile(eventArgs[0].fuid)})}else this.fileUpload.triggerEvent.apply(this.fileUpload,$.merge([eventName],eventArgs))},positionAndResize:function(){this.getMovieObject().css($.extend(this.wrapElement.position(),{position:"absolute",outline:0})).width(this.wrapElement.outerWidth()).height(this.wrapElement.outerHeight())},getMovieObject:function(){return $("#flash_runtime_"+this.instanceId)},getMovie:function(){var name="flash_runtime_"+this.instanceId;return document[name]||window[name]},supports:function(){return swfobject.hasFlashPlayerVersion("10")}});FileUpload.Runtime.FlashRuntime.EventHandler=function(instanceId,args){var instance=instances[instanceId],safeCall="handleFlashEvent";var eventName=args[0],eventArgs=[];if(args.length>1)eventArgs=args.slice(1);debug("Flash event:",eventName,eventArgs);if(eventName!=="abort")if($.isFunction(instance[eventName]))instance[eventName].apply(instance,eventArgs);else if($.isFunction(instance[safeCall]))instance[safeCall].call(instance,eventName,eventArgs)}})(jQuery,"undefined",FileUpload_Debug);(function($,undef,debug){"use strict";FileUpload.Runtime.create("FrameRuntime",{create:function(){if(!this.fileUpload.options.multipartEndpoint)throw"Unable to use FrameRuntime, define multipartEndpoint in options";this.filesUploading=0;this.counter=0;this.files={};this.percentLoaded={};var self=this,FrameFile=FileUpload.Runtime.FrameRuntime.File;this.fileUpload.element.on("change.FileUpload",":file",function(e){var target=$(e.target);target.clone(true).insertBefore(target).val("");var file=new FrameFile(target,self.createFileOptions(self.counter));self.files[self.counter]=file;self.counter++;self.fileUpload.triggerEvent("select",[file.info]);if(self.fileUpload.options.autoUpload)self.fileUpload.send()})},destroy:function(){if(this.timer)clearTimeout(this.timer);$.each(this.files,function(){this.destroy()});this.files=null},send:function(fileId){if(!this.uploading()){this.fileStack=[];this.stackComplete=0;this.stackCount=0;this.percentLoaded={}}var self=this;if(!fileId){$.each(this.files,function(counter){if($.inArray(counter,self.fileStack)===-1&&!self.files[counter].isUploading()){self.fileStack.push(counter);self.stackCount++}})}else if(this.files[fileId]){this.fileStack.push(fileId);this.stackCount++}debug("Total stack count: ",this.stackCount);this.fileUpload.triggerEvent("beforestart",{fileStack:this.fileStack,stackSize:0,fileId:fileId,running:this.uploading()});this.fileStack=this.fileStack.reverse();if(!this.uploading())this.timeout=setInterval(function(){if(self.fileStack.length===0){clearInterval(self.timeout);self.timeout=null}else if(self.filesUploading<self.fileUpload.options.numberOfSimultaneousFileUploads){var counter=self.fileStack.pop();debug("Uploading file: ",counter,self.fileStack,self.files);self.files[counter].upload();self.filesUploading++}},500)},uploading:function(){return!!this.timeout},createFileOptions:function(counter){var self=this;function handleSuccessOrError(success){return function(){var innerSelf=this;self.fileUpload.finalizeSend(this.info,success,function(isError,response,onComplete){if(!isError&&success){var c=innerSelf.options.counter;debug("Deleting file with counter",c);self.files[c].destroy();delete self.files[c]}});self.filesUploading--;self.stackComplete++}}return $.extend({},this.fileUpload.options,{counter:counter,beforeStart:function(){self.fileUpload.triggerEvent("filebeforestart",this.info)},progress:function(percentage){self.percentLoaded[this.info.fuid]=percentage;var percentTotal=0;$.each(self.percentLoaded,function(){percentTotal+=this});self.fileUpload.triggerEvent("totalprogress",Math.min(100,Math.ceil(percentTotal/self.stackCount)));self.fileUpload.triggerEvent("fileprogress",this.info,percentage)},success:handleSuccessOrError(true),error:handleSuccessOrError(false)})},supports:function(){return true}})})(jQuery,"undefined",FileUpload_Debug);(function($,undef,debug){"use strict";var default_options={beforeStart:$.noop,success:$.noop,progress:$.noop};function File(fileElement,options){this.options=$.extend({},default_options,options);var path=fileElement.val(),tokens=path.split(/\\|\//),name=tokens[tokens.length-1];this.info=new FileUpload.File(this.options.counter,name);this.createFormWrapper(fileElement);this.uploading=false}File.prototype.upload=function(){if(this.isUploading()){debug("File already in upload state");return false}this.options.beforeStart.call(this);this.uploading=true;this.frameElement.removeClass("abort");this.formElement.submit();return true};File.prototype.isUploading=function(){return false};File.prototype.abort=function(){this.frameElement.attr("src","about:blank").addClass("abort")};File.prototype.destroy=function(){this.frameElement.add(this.formElement).remove()};File.prototype.handleFrameComplete=function(){try{var response=this.frameElement[0].contentWindow.document.body.innerHTML,type="success";debug("Frame Loaded");debug(response);try{response=$.parseJSON($("<span />").append(response).text())||{}}catch(e){debug("Failed to parse JSON response",e.message);type="error";response={}}if(response.error||response.exception||this.frameElement.hasClass("abort"))type="error";if(response.request){this.info.size=response.request.fileSize;this.info.type=response.request.fileType}this.options.progress.call(this,100);this.options[type].call(this,response)}catch(ad){debug("Failed to get frame contents (Access Denied?): ",ad)}this.uploading=false};File.prototype.createFormWrapper=function(domElement){var hash="Form_"+Math.round(Math.random()*1e5);var endpoint=this.options.multipartEndpoint;var form=this.formElement=$("<form />").append(domElement).attr({action:endpoint,enctype:"multipart/form-data",method:"post",id:hash,target:hash}).addClass("fileupload-frame");form.insertBefore("body").hide();form.append($('<input type="text" name="X-File-Id" />').val(this.info.fuid));form.append($('<input type="text" name="X-File-Name" />').val(this.info.name));form.append($('<input type="text" name="X-File-Type" />').val(this.info.type));form.append($('<input type="text" name="X-File-Size" />').val(this.info.size));var frame=this.frameElement=$('<iframe src="javascript:;" name="'+hash+'" />').on("load",$.proxy(this.handleFrameComplete,this)).attr({id:"IFrame_"+hash}).hide().insertBefore(form)};window.FileUpload.Runtime.FrameRuntime.File=File})(jQuery,"undefined",FileUpload_Debug);(function($,undef,debug){"use strict";FileUpload.Layout.create("Simple",{create:function(){this.progressBar=$("<div />").insertAfter(this.fileUpload.element.find(":file")).addClass("progress").append($("<div/>").addClass("progress-bar progress-bar-striped"));if(this.fileUpload.runtimeName==="FlashRuntime"){this.flashContainer=this.fileUpload.element.find("#simple-flash-wrapper");if(this.flashContainer.size()!==0){this.fileUpload.options.flashWrapper="#simple-flash-wrapper :button";this.fileUpload.element.find(":file").hide();this.flashContainer.show()}}var self=this;this.fileUpload.element.on("submit.FileUpload",function(e){e.preventDefault();self.progressBar.find(".progress-bar").text("");self.fileUpload.send()});this.fileUpload.on("select",function(e,files){if(self.flashContainer){var fileArray=[];$.each(files,function(){fileArray.push(this.name)});self.flashContainer.find(".selection").text(fileArray.join(", "))}});this.fileUpload.on("filebebeforeloading",function(){self.appendLoadingIfNotPresent()});this.fileUpload.on("fileloading",function(e,file,percentage){var bar=self.progressBar.find(".progress-bar").text(self.fileUpload.options.fileLoading+" ("+percentage+"%)");if(bar.width()<120)bar.width(120)});this.fileUpload.on("filesizeerror",function(e,file){self.progressBar.find(".progress-bar").addClass("progress-bar-danger").removeClass("active").width("100%").text(self.fileUpload.options.fileSize)});this.fileUpload.on("beforestart totalprogress",function(e,ui){var isStart=e.type==="FileUpload_beforestart";if(isStart){self.stackFileFailures=0;self.stackFileCount=0;self.stackSizeCount=ui.fileStack.length;if(self.stackSizeCount>0){self.appendLoadingIfNotPresent();self.fileUpload.element.find(":submit").addClass("disabled")}}self.handleProgress(isStart?0:ui)});this.fileUpload.on("filefinish",$.proxy(this.handleFileFinalize,this));this.fileUpload.on("abort",$.proxy(this.handleAbort,this));this.fileUpload.element.find("button.abort, input.abort").on("click.FileUpload",function(){self.fileUpload.element.find(":submit").removeClass("disabled");self.fileUpload.abort()})},destroy:function(){this.progressBar.remove();if(this.flashContainer&&this.flashContainer.size()!==0){this.flashContainer.hide();this.fileUpload.element.find(":file").show()}this.fileUpload.element.find("button.abort, input.abort").unbind(".FileUpload")},handleProgress:function(width){this.width=Math.max(this.width||0,width);var bar=this.progressBar.find(".progress-bar").width(width+"%");if(width===0)bar.addClass("active").removeClass("progress-bar-danger progress-bar-warning progress-bar-success");else bar.text(width+"%")},handleAbort:function(){this.progressBar.find(".progress-bar").addClass("progress-bar-danger").removeClass("active")},handleFileFinalize:function(e,file,success,isError,response){this.progressBar.removeClass("active");if(!success)this.stackFileFailures++;this.stackFileCount++;if(this.stackFileCount===this.stackSizeCount){this.fileUpload.element.find(".ajax-loading").remove();this.fileUpload.element.find(":submit").removeClass("disabled");var className="progress-bar-success";if(isError||this.stackFileFailures===this.stackSizeCount)className="progress-bar-danger";else if(this.stackFileFailures>0)className="progress-bar-warning";this.progressBar.find(".progress-bar").text(this.fileUpload.options.fileComplete).addClass(className).removeClass("active")}},appendLoadingIfNotPresent:function(){var loader=$("<img />").addClass("ajax-loading").attr("src",this.fileUpload.options.ajaxLoader);if(this.flashContainer&&this.flashContainer.size()!==0&&this.flashContainer.find(".ajax-loading").size()===0)loader.appendTo(this.flashContainer);else if(this.fileUpload.element.find(".ajax-loading").size()===0)loader.insertAfter(this.fileUpload.element.find(":file"))}})})(jQuery,"undefined",FileUpload_Debug);(function($,undef,debug){"use strict";FileUpload.Layout.create("Complex",{create:function(){if(this.fileUpload.runtimeName==="FlashRuntime"){this.fileUpload.options.flashWrapper="#complex-flash-wrapper";this.fileUpload.element.find(":file").hide()}this.table=this.fileUpload.element.find("table");this.tbody=this.table.find("tbody");this.fileUpload.on("select",$.proxy(this.handleFileSelect,this));this.fileUpload.on("filebebeforeloading",$.proxy(this.handleFileStart,this));this.fileUpload.on("filebeforestart",$.proxy(this.handleFileStart,this));this.fileUpload.on("filefinish",$.proxy(this.handleFileComplete,this));this.fileUpload.on("fileprogress",$.proxy(this.handleFileProgress,this));this.fileUpload.on("fileloading",$.proxy(this.handleFileLoading,this));this.fileUpload.on("filesizeerror",$.proxy(this.handleFileSizeError,this));var self=this;this.table.on("click.FileUpload",".btn",function(e){var target=$(e.target),row=target.parents("tr:first"),id=row.attr("id").substring(5);if(target.hasClass("submit")||target.hasClass("retry")){debug("Uploading new file: ",id);self.fileUpload.send(id)}if(target.hasClass("cancel"))self.fileUpload.abort(id);if(target.hasClass("remove")){self.fileUpload.remove(id);row.fadeOut("fast",function(){row.remove()})}});this.fileUpload.element.find(".upload-all").on("click.FileUpload",function(){self.fileUpload.send()});this.fileUpload.element.find(".cancel-all").on("click.FileUpload",function(){self.fileUpload.abort()})},destroy:function(){this.fileUpload.element.find(".upload-all, .cancel-all").unbind(".FileUpload");this.table.unbind(".FileUpload");this.table.find("tr").not(".template").remove();if(this.fileUpload.runtimeName==="FlashRuntime")this.fileUpload.element.find(":file").show()},getFileRow:function(file,selector){var row=this.tbody.find("#file_"+file.fuid);if(selector)return row.find(selector);return row},handleFileSelect:function(e,files){var template=this.fileUpload.element.find(".template"),i;for(i=0;i<files.length;i++){var file=files[i],newTemplate=template.clone();newTemplate.removeClass("template").attr("id","file_"+file.fuid);newTemplate.find(".name").html(file.name);newTemplate.find(".size").html(FileUpload.formatBytes(file.size));newTemplate.appendTo(this.tbody);newTemplate.find(".submit, .remove").show()}},handleFileProgress:function(e,file,progress){this.getFileRow(file,".progress .progress-bar").data("progress",progress).width(progress+"%").text(progress+"%")},handleFileBeforeLoad:function(e,file){this.appendLoadingIfNotPresent(file)},handleFileLoading:function(e,file,percentage){var tableRow=this.getFileRow(file);var msg=this.fileUpload.options.fileLoading+" ("+percentage+"%)";var bar=this.getFileRow(file,".progress .progress-bar").text(msg);if(bar.width()<120)bar.width(120)},handleFileStart:function(e,file){var tableRow=this.getFileRow(file);var selector=".submit, .retry";if(e.type!=="FileUpload_filebeforestart")selector+=", .cancel";else tableRow.find(".cancel").removeClass("disabled");var buttons=tableRow.find(selector);setTimeout(function(){buttons.addClass("disabled")},0);tableRow.find(".remove").hide();tableRow.find(".cancel").show();this.appendLoadingIfNotPresent(file);tableRow.find(".progress-bar").removeClass("progress-bar-success progress-bar-danger").addClass("active");tableRow.addClass("is-loading")},handleFileComplete:function(e,file,success,isError){var tableRow=this.getFileRow(file);var failure=isError||!success,bar=tableRow.find(".progress .progress-bar");if(failure){tableRow.find(".retry").button("reset").removeClass("disabled").show();tableRow.find(".submit").button("reset").hide()}else bar.text(this.fileUpload.options.fileComplete);tableRow.find(".cancel").hide();tableRow.find(".remove").show();tableRow.find(".progress-bar").addClass(!failure?"progress-bar-success":"progress-bar-danger").removeClass("active");tableRow.find(".ajax-loading").remove();tableRow.removeClass("is-loading error").addClass("complete")},handleFileSizeError:function(e,info){$("<div />").addClass("alert alert-error").text(info.name+" "+this.fileUpload.options.fileSize).prepend($('<button type="button" class="close" data-dismiss="alert">×</button>')).prependTo(this.fileUpload.element)},appendLoadingIfNotPresent:function(file){var tableRow=this.getFileRow(file);var loader=$("<img />").addClass("ajax-loading").attr("src",this.fileUpload.options.ajaxLoader);if(tableRow.find(".ajax-loading").size()===0)tableRow.find("td:last").append(loader)}})})(jQuery,"undefined",FileUpload_Debug);(function($,undef){"use strict";var default_options={layout:"Simple"};$.fn.extend({fileupload:function(options){var args=Array.prototype.slice.call(arguments);return $.each(this,function(){var element=$(this),instance=element.data("fileupload");if(instance){if(typeof options==="string"&&$.isFunction(instance[options])){instance[options].apply(instance,args.slice(1));if(options==="destroy")element.removeData("fileupload")}}else element.data("fileupload",new FileUpload(this,$.extend({},default_options,options||{})))})}})})(jQuery,"undefined");(function($){$.timeago=function(timestamp){if(timestamp instanceof Date)return inWords(timestamp);else if(typeof timestamp=="string")return inWords($.timeago.parse(timestamp));else return inWords($.timeago.datetime(timestamp))};var $t=$.timeago;$.extend($.timeago,{settings:{refreshMillis:6e4,allowFuture:false,strings:{prefixAgo:null,prefixFromNow:null,suffixAgo:"ago",suffixFromNow:"from now",seconds:"less than a minute",minute:"about a minute",minutes:"%d minutes",hour:"about an hour",hours:"about %d hours",day:"a day",days:"%d days",month:"about a month",months:"%d months",year:"about a year",years:"%d years",numbers:[]}},inWords:function(distanceMillis){var $l=this.settings.strings;var prefix=$l.prefixAgo;var suffix=$l.suffixAgo;if(this.settings.allowFuture){if(distanceMillis<0){prefix=$l.prefixFromNow;
suffix=$l.suffixFromNow}distanceMillis=Math.abs(distanceMillis)}var seconds=distanceMillis/1e3;var minutes=seconds/60;var hours=minutes/60;var days=hours/24;var years=days/365;function substitute(stringOrFunction,number){var string=$.isFunction(stringOrFunction)?stringOrFunction(number,distanceMillis):stringOrFunction;var value=$l.numbers&&$l.numbers[number]||number;return string.replace(/%d/i,value)}var words=seconds<45&&substitute($l.seconds,Math.round(seconds))||seconds<90&&substitute($l.minute,1)||minutes<45&&substitute($l.minutes,Math.round(minutes))||minutes<90&&substitute($l.hour,1)||hours<24&&substitute($l.hours,Math.round(hours))||hours<48&&substitute($l.day,1)||days<30&&substitute($l.days,Math.floor(days))||days<60&&substitute($l.month,1)||days<365&&substitute($l.months,Math.floor(days/30))||years<2&&substitute($l.year,1)||substitute($l.years,Math.floor(years));return $.trim([prefix,words,suffix].join(" "))},parse:function(iso8601){var s=$.trim(iso8601);s=s.replace(/\.\d\d\d+/,"");s=s.replace(/-/,"/").replace(/-/,"/");s=s.replace(/T/," ").replace(/Z/," UTC");s=s.replace(/([\+-]\d\d)\:?(\d\d)/," $1$2");return new Date(s)},datetime:function(elem){var isTime=$(elem).get(0).tagName.toLowerCase()=="time";var iso8601=isTime?$(elem).attr("datetime"):$(elem).attr("title");return $t.parse(iso8601)}});$.fn.timeago=function(){var self=this;self.each(refresh);var $s=$t.settings;if($s.refreshMillis>0){setInterval(function(){self.each(refresh)},$s.refreshMillis)}return self};function refresh(){var data=prepareData(this);if(!isNaN(data.datetime)){$(this).text(inWords(data.datetime))}return this}function prepareData(element){element=$(element);if(!element.data("timeago")){element.data("timeago",{datetime:$t.datetime(element)});var text=$.trim(element.text());if(text.length>0)element.attr("title",text)}return element.data("timeago")}function inWords(date){return $t.inWords(distance(date))}function distance(date){return(new Date).getTime()-date.getTime()}document.createElement("abbr");document.createElement("time")})(jQuery);(function($){$.timeago.regional={};$.timeago.regional["es"]={prefixAgo:"hace",prefixFromNow:"dentro de",suffixAgo:"",suffixFromNow:"",seconds:"menos de un minuto",minute:"un minuto",minutes:"unos %d minutos",hour:"una hora",hours:"%d horas",day:"un día",days:"%d días",month:"un mes",months:"%d meses",year:"un año",years:"%d años"};$.timeago.regional["fr"]={prefixAgo:"il y a",prefixFromNow:"d'ici",seconds:"moins d'une minute",minute:"environ une minute",minutes:"environ %d minutes",hour:"environ une heure",hours:"environ %d heures",day:"environ un jour",days:"environ %d jours",month:"environ un mois",months:"environ %d mois",year:"un an",years:"%d ans"};$.timeago.regional["pt"]={suffixAgo:"atrás",suffixFromNow:"a partir de agora",seconds:"menos de um minuto",minute:"cerca de um minuto",minutes:"%d minutos",hour:"cerca de uma hora",hours:"cerca de %d horas",day:"um dia",days:"%d dias",month:"cerca de um mês",months:"%d meses",year:"cerca de um ano",years:"%d anos"};$.timeago.regional["sv"]={prefixAgo:"för",prefixFromNow:"om",suffixAgo:"sedan",suffixFromNow:"",seconds:"mindre än en minut",minute:"ungefär en minut",minutes:"%d minuter",hour:"ungefär en timme",hours:"ungefär %d timmar",day:"en dag",days:"%d dagar",month:"ungefär en månad",months:"%d månader",year:"ungefär ett år",years:"%d år"};$.timeago.regional["zh"]={prefixAgo:null,prefixFromNow:"从现在开始",suffixAgo:"之前",suffixFromNow:null,seconds:"不到 1 分钟",minute:"大约 1 分钟",minutes:"%d 分钟",hour:"大约 1 小时",hours:"大约 %d 小时",day:"1 天",days:"%d 天",month:"大约 1 个月",months:"%d 月",year:"大约 1 年",years:"%d 年",numbers:[]};$.timeago.regional["ja"]={prefixAgo:"",prefixFromNow:"今から",suffixAgo:"前",suffixFromNow:"後",seconds:"ほんの数秒",minute:"約一分",minutes:"%d 分",hour:"大体一時間",hours:"大体 %d 時間位",day:"一日",days:"%d 日ほど",month:"大体一ヶ月",months:"%d ヶ月ほど",year:"丁度一年（虎舞流ｗ）",years:"%d 年"};function numpf(n,f,s,t){var n10=n%10;if(n10==1&&(n==1||n>20)){return f}else if(n10>1&&n10<5&&(n>20||n<10)){return s}else{return t}}$.timeago.regional["ru"]={prefixAgo:null,prefixFromNow:"через",suffixAgo:"назад",suffixFromNow:null,seconds:"меньше минуты",minute:"минуту",minutes:function(value){return numpf(value,"%d минута","%d минуты","%d минут")},hour:"час",hours:function(value){return numpf(value,"%d час","%d часа","%d часов")},day:"день",days:function(value){return numpf(value,"%d день","%d дня","%d дней")},month:"месяц",months:function(value){return numpf(value,"%d месяц","%d месяца","%d месяцев")},year:"год",years:function(value){return numpf(value,"%d год","%d года","%d лет")}};$.timeago.regional["tr"]={suffixAgo:"önce",suffixFromNow:null,seconds:"1 dakikadan",minute:"1 dakika",minutes:"%d dakika",hour:"1 saat",hours:"%d saat",day:"1 gün",days:"%d gün",month:"1 ay",months:"%d ay",year:"1 yıl",years:"%d yıl"};$.timeago.regional["ca"]={prefixAgo:"fa",prefixFromNow:"d'aqui a",suffixAgo:null,suffixFromNow:null,seconds:"menys d'un minut",minute:"un minut",minutes:"uns %d minuts",hour:"una hora",hours:"unes %d hores",day:"1 dia",days:"%d dies",month:"aproximadament un mes",months:"%d mesos",year:"aproximadament un any",years:"%d anys"};$.timeago.regional["de"]={prefixAgo:"vor",prefixFromNow:"in",suffixAgo:"",suffixFromNow:"",seconds:"wenigen Sekunden",minute:"etwa einer Minute",minutes:"%d Minuten",hour:"etwa einer Stunde",hours:"%d Stunden",day:"etwa einem Tag",days:"%d Tagen",month:"etwa einem Monat",months:"%d Monaten",year:"etwa einem Jahr",years:"%d Jahren"}})(jQuery);(function(c){function p(){var d,a={height:h.innerHeight,width:h.innerWidth};if(!a.height&&((d=i.compatMode)||!c.support.boxModel))d=d==="CSS1Compat"?k:i.body,a={height:d.clientHeight,width:d.clientWidth};return a}var m={},e,a,i=document,h=window,k=i.documentElement,j=c.expando;c.event.special.inview={add:function(a){m[a.guid+"-"+this[j]]={data:a,$element:c(this)}},remove:function(a){try{delete m[a.guid+"-"+this[j]]}catch(c){}}};c(h).bind("scroll resize",function(){e=a=null});setInterval(function(){var d=c(),j,l=0;c.each(m,function(a,b){var c=b.data.selector,e=b.$element;d=d.add(c?e.find(c):e)});if(j=d.length){e=e||p();for(a=a||{top:h.pageYOffset||k.scrollTop||i.body.scrollTop,left:h.pageXOffset||k.scrollLeft||i.body.scrollLeft};l<j;l++)if(c.contains(k,d[l])){var g=c(d[l]),f={height:g.height(),width:g.width()},b=g.offset(),n=g.data("inview"),o;if(!a||!e)break;b.top+f.height>a.top&&b.top<a.top+e.height&&b.left+f.width>a.left&&b.left<a.left+e.width?(o=a.left>b.left?"right":a.left+e.width<b.left+f.width?"left":"both",f=a.top>b.top?"bottom":a.top+e.height<b.top+f.height?"top":"both",b=o+"-"+f,(!n||n!==b)&&g.data("inview",b).trigger("inview",[!0,o,f])):n&&g.data("inview",!1).trigger("inview",[!1])}}},250)})(jQuery);(function($){var b64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a256="",r64=[256],r256=[256],i=0;var UTF8={encode:function(strUni){var strUtf=strUni.replace(/[\u0080-\u07ff]/g,function(c){var cc=c.charCodeAt(0);return String.fromCharCode(192|cc>>6,128|cc&63)}).replace(/[\u0800-\uffff]/g,function(c){var cc=c.charCodeAt(0);return String.fromCharCode(224|cc>>12,128|cc>>6&63,128|cc&63)});return strUtf},decode:function(strUtf){var strUni=strUtf.replace(/[\u00e0-\u00ef][\u0080-\u00bf][\u0080-\u00bf]/g,function(c){var cc=(c.charCodeAt(0)&15)<<12|(c.charCodeAt(1)&63)<<6|c.charCodeAt(2)&63;return String.fromCharCode(cc)}).replace(/[\u00c0-\u00df][\u0080-\u00bf]/g,function(c){var cc=(c.charCodeAt(0)&31)<<6|c.charCodeAt(1)&63;return String.fromCharCode(cc)});return strUni}};while(i<256){var c=String.fromCharCode(i);a256+=c;r256[i]=i;r64[i]=b64.indexOf(c);++i}function code(s,discard,alpha,beta,w1,w2){s=String(s);var buffer=0,i=0,length=s.length,result="",bitsInBuffer=0;while(i<length){var c=s.charCodeAt(i);c=c<256?alpha[c]:-1;buffer=(buffer<<w1)+c;bitsInBuffer+=w1;while(bitsInBuffer>=w2){bitsInBuffer-=w2;var tmp=buffer>>bitsInBuffer;result+=beta.charAt(tmp);buffer^=tmp<<bitsInBuffer}++i}if(!discard&&bitsInBuffer>0)result+=beta.charAt(buffer<<w2-bitsInBuffer);return result}var Plugin=$.base64=function(dir,input,encode){return input?Plugin[dir](input,encode):dir?null:this};Plugin.btoa=Plugin.encode=function(plain,utf8encode){plain=Plugin.raw===false||Plugin.utf8encode||utf8encode?UTF8.encode(plain):plain;plain=code(plain,false,r256,b64,8,6);return plain+"====".slice(plain.length%4||4)};Plugin.atob=Plugin.decode=function(coded,utf8decode){coded=String(coded).split("=");var i=coded.length;do{--i;coded[i]=code(coded[i],true,r64,a256,6,8)}while(i>0);coded=coded.join("");return Plugin.raw===false||Plugin.utf8decode||utf8decode?UTF8.decode(coded):coded}})(jQuery);+function($){"use strict";var Modal=function(element,options){this.options=options;this.$body=$(document.body);this.$element=$(element);this.$backdrop=this.isShown=null;this.scrollbarWidth=0;if(this.options.remote){this.$element.find("#clinked-portal .modal-content").load(this.options.remote,$.proxy(function(){this.$element.trigger("loaded.bs.modal")},this))}};Modal.VERSION="3.3.2";Modal.TRANSITION_DURATION=300;Modal.BACKDROP_TRANSITION_DURATION=150;Modal.DEFAULTS={backdrop:true,keyboard:true,show:true};Modal.prototype.toggle=function(_relatedTarget){return this.isShown?this.hide():this.show(_relatedTarget)};Modal.prototype.show=function(_relatedTarget){var that=this;var e=$.Event("show.bs.modal",{relatedTarget:_relatedTarget});this.$element.trigger(e);if(this.isShown||e.isDefaultPrevented())return;this.isShown=true;this.checkScrollbar();this.setScrollbar();this.$body.addClass("modal-open");this.escape();this.resize();this.$element.on("click.dismiss.bs.modal",'[data-dismiss="modal"]',$.proxy(this.hide,this));this.backdrop(function(){var transition=$.support.transition&&that.$element.hasClass("fade");if(!that.$element.parent().length){that.$element.appendTo(that.$body)}that.$element.show().scrollTop(0);if(that.options.backdrop)that.adjustBackdrop();that.adjustDialog();if(transition){that.$element[0].offsetWidth}that.$element.addClass("in").attr("aria-hidden",false);that.enforceFocus();var e=$.Event("shown.bs.modal",{relatedTarget:_relatedTarget});transition?that.$element.find("#clinked-portal .modal-dialog").one("bsTransitionEnd",function(){that.$element.trigger("focus").trigger(e)}).emulateTransitionEnd(Modal.TRANSITION_DURATION):that.$element.trigger("focus").trigger(e)})};Modal.prototype.hide=function(e){if(e)e.preventDefault();e=$.Event("hide.bs.modal");this.$element.trigger(e);if(!this.isShown||e.isDefaultPrevented())return;this.isShown=false;this.escape();this.resize();$(document).off("focusin.bs.modal");this.$element.removeClass("in").attr("aria-hidden",true).off("click.dismiss.bs.modal");$.support.transition&&this.$element.hasClass("fade")?this.$element.one("bsTransitionEnd",$.proxy(this.hideModal,this)).emulateTransitionEnd(Modal.TRANSITION_DURATION):this.hideModal()};Modal.prototype.enforceFocus=function(){$(document).off("focusin.bs.modal").on("focusin.bs.modal",$.proxy(function(e){if(this.$element[0]!==e.target&&!this.$element.has(e.target).length){this.$element.trigger("focus")}},this))};Modal.prototype.escape=function(){if(this.isShown&&this.options.keyboard){this.$element.on("keydown.dismiss.bs.modal",$.proxy(function(e){e.which==27&&this.hide()},this))}else if(!this.isShown){this.$element.off("keydown.dismiss.bs.modal")}};Modal.prototype.resize=function(){if(this.isShown){$(window).on("resize.bs.modal",$.proxy(this.handleUpdate,this))}else{$(window).off("resize.bs.modal")}};Modal.prototype.hideModal=function(){var that=this;this.$element.hide();this.backdrop(function(){that.$body.removeClass("modal-open");that.resetAdjustments();that.resetScrollbar();that.$element.trigger("hidden.bs.modal")})};Modal.prototype.removeBackdrop=function(){this.$backdrop&&this.$backdrop.remove();this.$backdrop=null};Modal.prototype.backdrop=function(callback){var that=this;var animate=this.$element.hasClass("fade")?"fade":"";if(this.isShown&&this.options.backdrop){var doAnimate=$.support.transition&&animate;this.$backdrop=$('<div class="modal-backdrop '+animate+'" />').prependTo(this.$element).on("click.dismiss.bs.modal",$.proxy(function(e){if(e.target!==e.currentTarget)return;this.options.backdrop=="static"?this.$element[0].focus.call(this.$element[0]):this.hide.call(this)},this));if(doAnimate)this.$backdrop[0].offsetWidth;this.$backdrop.addClass("in");if(!callback)return;doAnimate?this.$backdrop.one("bsTransitionEnd",callback).emulateTransitionEnd(Modal.BACKDROP_TRANSITION_DURATION):callback()}else if(!this.isShown&&this.$backdrop){this.$backdrop.removeClass("in");var callbackRemove=function(){that.removeBackdrop();callback&&callback()};$.support.transition&&this.$element.hasClass("fade")?this.$backdrop.one("bsTransitionEnd",callbackRemove).emulateTransitionEnd(Modal.BACKDROP_TRANSITION_DURATION):callbackRemove()}else if(callback){callback()}};Modal.prototype.handleUpdate=function(){if(this.options.backdrop)this.adjustBackdrop();this.adjustDialog()};Modal.prototype.adjustBackdrop=function(){this.$backdrop.css("height",0).css("height",this.$element[0].scrollHeight)};Modal.prototype.adjustDialog=function(){var modalIsOverflowing=this.$element[0].scrollHeight>document.documentElement.clientHeight;this.$element.css({paddingLeft:!this.bodyIsOverflowing&&modalIsOverflowing?this.scrollbarWidth:"",paddingRight:this.bodyIsOverflowing&&!modalIsOverflowing?this.scrollbarWidth:""})};Modal.prototype.resetAdjustments=function(){this.$element.css({paddingLeft:"",paddingRight:""})};Modal.prototype.checkScrollbar=function(){this.bodyIsOverflowing=document.body.scrollHeight>document.documentElement.clientHeight;this.scrollbarWidth=this.measureScrollbar()};Modal.prototype.setScrollbar=function(){var bodyPad=parseInt(this.$body.css("padding-right")||0,10);if(this.bodyIsOverflowing)this.$body.css("padding-right",bodyPad+this.scrollbarWidth)};Modal.prototype.resetScrollbar=function(){this.$body.css("padding-right","")};Modal.prototype.measureScrollbar=function(){var scrollDiv=document.createElement("div");scrollDiv.className="modal-scrollbar-measure";this.$body.append(scrollDiv);var scrollbarWidth=scrollDiv.offsetWidth-scrollDiv.clientWidth;this.$body[0].removeChild(scrollDiv);return scrollbarWidth};function Plugin(option,_relatedTarget){return this.each(function(){var $this=$(this);var data=$this.data("bs.modal");var options=$.extend({},Modal.DEFAULTS,$this.data(),typeof option=="object"&&option);if(!data)$this.data("bs.modal",data=new Modal(this,options));if(typeof option=="string")data[option](_relatedTarget);else if(options.show)data.show(_relatedTarget)})}var old=$.fn.modal;$.fn.modal=Plugin;$.fn.modal.Constructor=Modal;$.fn.modal.noConflict=function(){$.fn.modal=old;return this};$(document).on("click.bs.modal.data-api",'[data-toggle="modal"]',function(e){var $this=$(this);var href=$this.attr("href");var $target=$($this.attr("data-target")||href&&href.replace(/.*(?=#[^\s]+$)/,""));var option=$target.data("bs.modal")?"toggle":$.extend({remote:!/#/.test(href)&&href},$target.data(),$this.data());if($this.is("a"))e.preventDefault();$target.one("show.bs.modal",function(showEvent){if(showEvent.isDefaultPrevented())return;$target.one("hidden.bs.modal",function(){$this.is(":visible")&&$this.trigger("focus")})});Plugin.call($target,option,this)})}(jQuery);(function(){var n=this,t=n._,r={},e=Array.prototype,u=Object.prototype,i=Function.prototype,a=e.push,o=e.slice,c=e.concat,l=u.toString,f=u.hasOwnProperty,s=e.forEach,p=e.map,h=e.reduce,v=e.reduceRight,g=e.filter,d=e.every,m=e.some,y=e.indexOf,b=e.lastIndexOf,x=Array.isArray,w=Object.keys,_=i.bind,j=function(n){return n instanceof j?n:this instanceof j?void(this._wrapped=n):new j(n)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=j),exports._=j):n._=j,j.VERSION="1.6.0";var A=j.each=j.forEach=function(n,t,e){if(null==n)return n;if(s&&n.forEach===s)n.forEach(t,e);else if(n.length===+n.length){for(var u=0,i=n.length;i>u;u++)if(t.call(e,n[u],u,n)===r)return}else for(var a=j.keys(n),u=0,i=a.length;i>u;u++)if(t.call(e,n[a[u]],a[u],n)===r)return;return n};j.map=j.collect=function(n,t,r){var e=[];return null==n?e:p&&n.map===p?n.map(t,r):(A(n,function(n,u,i){e.push(t.call(r,n,u,i))}),e)};var O="Reduce of empty array with no initial value";j.reduce=j.foldl=j.inject=function(n,t,r,e){var u=arguments.length>2;if(null==n&&(n=[]),h&&n.reduce===h)return e&&(t=j.bind(t,e)),u?n.reduce(t,r):n.reduce(t);if(A(n,function(n,i,a){u?r=t.call(e,r,n,i,a):(r=n,u=!0)}),!u)throw new TypeError(O);return r},j.reduceRight=j.foldr=function(n,t,r,e){var u=arguments.length>2;if(null==n&&(n=[]),v&&n.reduceRight===v)return e&&(t=j.bind(t,e)),u?n.reduceRight(t,r):n.reduceRight(t);var i=n.length;if(i!==+i){var a=j.keys(n);i=a.length}if(A(n,function(o,c,l){c=a?a[--i]:--i,u?r=t.call(e,r,n[c],c,l):(r=n[c],u=!0)}),!u)throw new TypeError(O);return r},j.find=j.detect=function(n,t,r){var e;return k(n,function(n,u,i){return t.call(r,n,u,i)?(e=n,!0):void 0}),e},j.filter=j.select=function(n,t,r){var e=[];return null==n?e:g&&n.filter===g?n.filter(t,r):(A(n,function(n,u,i){t.call(r,n,u,i)&&e.push(n)}),e)},j.reject=function(n,t,r){return j.filter(n,function(n,e,u){return!t.call(r,n,e,u)},r)},j.every=j.all=function(n,t,e){t||(t=j.identity);var u=!0;return null==n?u:d&&n.every===d?n.every(t,e):(A(n,function(n,i,a){return(u=u&&t.call(e,n,i,a))?void 0:r}),!!u)};var k=j.some=j.any=function(n,t,e){t||(t=j.identity);var u=!1;return null==n?u:m&&n.some===m?n.some(t,e):(A(n,function(n,i,a){return u||(u=t.call(e,n,i,a))?r:void 0}),!!u)};j.contains=j.include=function(n,t){return null==n?!1:y&&n.indexOf===y?n.indexOf(t)!=-1:k(n,function(n){return n===t})},j.invoke=function(n,t){var r=o.call(arguments,2),e=j.isFunction(t);return j.map(n,function(n){return(e?t:n[t]).apply(n,r)})},j.pluck=function(n,t){return j.map(n,j.property(t))},j.where=function(n,t){return j.filter(n,j.matches(t))},j.findWhere=function(n,t){return j.find(n,j.matches(t))},j.max=function(n,t,r){if(!t&&j.isArray(n)&&n[0]===+n[0]&&n.length<65535)return Math.max.apply(Math,n);var e=-1/0,u=-1/0;return A(n,function(n,i,a){var o=t?t.call(r,n,i,a):n;o>u&&(e=n,u=o)}),e},j.min=function(n,t,r){if(!t&&j.isArray(n)&&n[0]===+n[0]&&n.length<65535)return Math.min.apply(Math,n);var e=1/0,u=1/0;return A(n,function(n,i,a){var o=t?t.call(r,n,i,a):n;u>o&&(e=n,u=o)}),e},j.shuffle=function(n){var t,r=0,e=[];return A(n,function(n){t=j.random(r++),e[r-1]=e[t],e[t]=n}),e},j.sample=function(n,t,r){return null==t||r?(n.length!==+n.length&&(n=j.values(n)),n[j.random(n.length-1)]):j.shuffle(n).slice(0,Math.max(0,t))};var E=function(n){return null==n?j.identity:j.isFunction(n)?n:j.property(n)};j.sortBy=function(n,t,r){return t=E(t),j.pluck(j.map(n,function(n,e,u){return{value:n,index:e,criteria:t.call(r,n,e,u)}}).sort(function(n,t){var r=n.criteria,e=t.criteria;if(r!==e){if(r>e||r===void 0)return 1;if(e>r||e===void 0)return-1}return n.index-t.index}),"value")};var F=function(n){return function(t,r,e){var u={};return r=E(r),A(t,function(i,a){var o=r.call(e,i,a,t);n(u,o,i)}),u}};j.groupBy=F(function(n,t,r){j.has(n,t)?n[t].push(r):n[t]=[r]}),j.indexBy=F(function(n,t,r){n[t]=r}),j.countBy=F(function(n,t){j.has(n,t)?n[t]++:n[t]=1}),j.sortedIndex=function(n,t,r,e){r=E(r);for(var u=r.call(e,t),i=0,a=n.length;a>i;){var o=i+a>>>1;r.call(e,n[o])<u?i=o+1:a=o}return i},j.toArray=function(n){return n?j.isArray(n)?o.call(n):n.length===+n.length?j.map(n,j.identity):j.values(n):[]},j.size=function(n){return null==n?0:n.length===+n.length?n.length:j.keys(n).length},j.first=j.head=j.take=function(n,t,r){return null==n?void 0:null==t||r?n[0]:0>t?[]:o.call(n,0,t)},j.initial=function(n,t,r){return o.call(n,0,n.length-(null==t||r?1:t))},j.last=function(n,t,r){return null==n?void 0:null==t||r?n[n.length-1]:o.call(n,Math.max(n.length-t,0))},j.rest=j.tail=j.drop=function(n,t,r){return o.call(n,null==t||r?1:t)},j.compact=function(n){return j.filter(n,j.identity)};var M=function(n,t,r){return t&&j.every(n,j.isArray)?c.apply(r,n):(A(n,function(n){j.isArray(n)||j.isArguments(n)?t?a.apply(r,n):M(n,t,r):r.push(n)}),r)};j.flatten=function(n,t){return M(n,t,[])},j.without=function(n){return j.difference(n,o.call(arguments,1))},j.partition=function(n,t){var r=[],e=[];return A(n,function(n){(t(n)?r:e).push(n)}),[r,e]},j.uniq=j.unique=function(n,t,r,e){j.isFunction(t)&&(e=r,r=t,t=!1);var u=r?j.map(n,r,e):n,i=[],a=[];return A(u,function(r,e){(t?e&&a[a.length-1]===r:j.contains(a,r))||(a.push(r),i.push(n[e]))}),i},j.union=function(){return j.uniq(j.flatten(arguments,!0))},j.intersection=function(n){var t=o.call(arguments,1);return j.filter(j.uniq(n),function(n){return j.every(t,function(t){return j.contains(t,n)})})},j.difference=function(n){var t=c.apply(e,o.call(arguments,1));return j.filter(n,function(n){return!j.contains(t,n)})},j.zip=function(){for(var n=j.max(j.pluck(arguments,"length").concat(0)),t=new Array(n),r=0;n>r;r++)t[r]=j.pluck(arguments,""+r);return t},j.object=function(n,t){if(null==n)return{};for(var r={},e=0,u=n.length;u>e;e++)t?r[n[e]]=t[e]:r[n[e][0]]=n[e][1];return r},j.indexOf=function(n,t,r){if(null==n)return-1;var e=0,u=n.length;if(r){if("number"!=typeof r)return e=j.sortedIndex(n,t),n[e]===t?e:-1;e=0>r?Math.max(0,u+r):r}if(y&&n.indexOf===y)return n.indexOf(t,r);for(;u>e;e++)if(n[e]===t)return e;return-1},j.lastIndexOf=function(n,t,r){if(null==n)return-1;var e=null!=r;if(b&&n.lastIndexOf===b)return e?n.lastIndexOf(t,r):n.lastIndexOf(t);for(var u=e?r:n.length;u--;)if(n[u]===t)return u;return-1},j.range=function(n,t,r){arguments.length<=1&&(t=n||0,n=0),r=arguments[2]||1;for(var e=Math.max(Math.ceil((t-n)/r),0),u=0,i=new Array(e);e>u;)i[u++]=n,n+=r;return i};var R=function(){};j.bind=function(n,t){var r,e;if(_&&n.bind===_)return _.apply(n,o.call(arguments,1));if(!j.isFunction(n))throw new TypeError;return r=o.call(arguments,2),e=function(){if(!(this instanceof e))return n.apply(t,r.concat(o.call(arguments)));R.prototype=n.prototype;var u=new R;R.prototype=null;var i=n.apply(u,r.concat(o.call(arguments)));return Object(i)===i?i:u}},j.partial=function(n){var t=o.call(arguments,1);return function(){for(var r=0,e=t.slice(),u=0,i=e.length;i>u;u++)e[u]===j&&(e[u]=arguments[r++]);for(;r<arguments.length;)e.push(arguments[r++]);return n.apply(this,e)}},j.bindAll=function(n){var t=o.call(arguments,1);if(0===t.length)throw new Error("bindAll must be passed function names");return A(t,function(t){n[t]=j.bind(n[t],n)}),n},j.memoize=function(n,t){var r={};return t||(t=j.identity),function(){var e=t.apply(this,arguments);return j.has(r,e)?r[e]:r[e]=n.apply(this,arguments)}},j.delay=function(n,t){var r=o.call(arguments,2);return setTimeout(function(){return n.apply(null,r)},t)},j.defer=function(n){return j.delay.apply(j,[n,1].concat(o.call(arguments,1)))},j.throttle=function(n,t,r){var e,u,i,a=null,o=0;r||(r={});var c=function(){o=r.leading===!1?0:j.now(),a=null,i=n.apply(e,u),e=u=null};return function(){var l=j.now();o||r.leading!==!1||(o=l);var f=t-(l-o);return e=this,u=arguments,0>=f?(clearTimeout(a),a=null,o=l,i=n.apply(e,u),e=u=null):a||r.trailing===!1||(a=setTimeout(c,f)),i}},j.debounce=function(n,t,r){var e,u,i,a,o,c=function(){var l=j.now()-a;t>l?e=setTimeout(c,t-l):(e=null,r||(o=n.apply(i,u),i=u=null))};return function(){i=this,u=arguments,a=j.now();var l=r&&!e;return e||(e=setTimeout(c,t)),l&&(o=n.apply(i,u),i=u=null),o}},j.once=function(n){var t,r=!1;return function(){return r?t:(r=!0,t=n.apply(this,arguments),n=null,t)}},j.wrap=function(n,t){return j.partial(t,n)},j.compose=function(){var n=arguments;return function(){for(var t=arguments,r=n.length-1;r>=0;r--)t=[n[r].apply(this,t)];return t[0]}},j.after=function(n,t){return function(){return--n<1?t.apply(this,arguments):void 0}},j.keys=function(n){if(!j.isObject(n))return[];if(w)return w(n);var t=[];for(var r in n)j.has(n,r)&&t.push(r);return t},j.values=function(n){for(var t=j.keys(n),r=t.length,e=new Array(r),u=0;r>u;u++)e[u]=n[t[u]];return e},j.pairs=function(n){for(var t=j.keys(n),r=t.length,e=new Array(r),u=0;r>u;u++)e[u]=[t[u],n[t[u]]];return e},j.invert=function(n){for(var t={},r=j.keys(n),e=0,u=r.length;u>e;e++)t[n[r[e]]]=r[e];return t},j.functions=j.methods=function(n){var t=[];for(var r in n)j.isFunction(n[r])&&t.push(r);return t.sort()},j.extend=function(n){return A(o.call(arguments,1),function(t){if(t)for(var r in t)n[r]=t[r]}),n},j.pick=function(n){var t={},r=c.apply(e,o.call(arguments,1));return A(r,function(r){r in n&&(t[r]=n[r])}),t},j.omit=function(n){var t={},r=c.apply(e,o.call(arguments,1));for(var u in n)j.contains(r,u)||(t[u]=n[u]);return t},j.defaults=function(n){return A(o.call(arguments,1),function(t){if(t)for(var r in t)n[r]===void 0&&(n[r]=t[r])}),n},j.clone=function(n){return j.isObject(n)?j.isArray(n)?n.slice():j.extend({},n):n},j.tap=function(n,t){return t(n),n};var S=function(n,t,r,e){if(n===t)return 0!==n||1/n==1/t;if(null==n||null==t)return n===t;n instanceof j&&(n=n._wrapped),t instanceof j&&(t=t._wrapped);var u=l.call(n);if(u!=l.call(t))return!1;switch(u){case"[object String]":return n==String(t);case"[object Number]":return n!=+n?t!=+t:0==n?1/n==1/t:n==+t;case"[object Date]":case"[object Boolean]":return+n==+t;case"[object RegExp]":return n.source==t.source&&n.global==t.global&&n.multiline==t.multiline&&n.ignoreCase==t.ignoreCase}if("object"!=typeof n||"object"!=typeof t)return!1;for(var i=r.length;i--;)if(r[i]==n)return e[i]==t;var a=n.constructor,o=t.constructor;if(a!==o&&!(j.isFunction(a)&&a instanceof a&&j.isFunction(o)&&o instanceof o)&&"constructor"in n&&"constructor"in t)return!1;r.push(n),e.push(t);var c=0,f=!0;if("[object Array]"==u){if(c=n.length,f=c==t.length)for(;c--&&(f=S(n[c],t[c],r,e)););}else{for(var s in n)if(j.has(n,s)&&(c++,!(f=j.has(t,s)&&S(n[s],t[s],r,e))))break;if(f){for(s in t)if(j.has(t,s)&&!c--)break;f=!c}}return r.pop(),e.pop(),f};j.isEqual=function(n,t){return S(n,t,[],[])},j.isEmpty=function(n){if(null==n)return!0;if(j.isArray(n)||j.isString(n))return 0===n.length;for(var t in n)if(j.has(n,t))return!1;return!0},j.isElement=function(n){return!(!n||1!==n.nodeType)},j.isArray=x||function(n){return"[object Array]"==l.call(n)},j.isObject=function(n){return n===Object(n)},A(["Arguments","Function","String","Number","Date","RegExp"],function(n){j["is"+n]=function(t){return l.call(t)=="[object "+n+"]"}}),j.isArguments(arguments)||(j.isArguments=function(n){return!(!n||!j.has(n,"callee"))}),"function"!=typeof/./&&(j.isFunction=function(n){return"function"==typeof n}),j.isFinite=function(n){return isFinite(n)&&!isNaN(parseFloat(n))},j.isNaN=function(n){return j.isNumber(n)&&n!=+n},j.isBoolean=function(n){return n===!0||n===!1||"[object Boolean]"==l.call(n)},j.isNull=function(n){return null===n},j.isUndefined=function(n){return n===void 0},j.has=function(n,t){return f.call(n,t)},j.noConflict=function(){return n._=t,this},j.identity=function(n){return n},j.constant=function(n){return function(){return n}},j.property=function(n){return function(t){return t[n]}},j.matches=function(n){return function(t){if(t===n)return!0;for(var r in n)if(n[r]!==t[r])return!1;return!0}},j.times=function(n,t,r){for(var e=Array(Math.max(0,n)),u=0;n>u;u++)e[u]=t.call(r,u);return e},j.random=function(n,t){return null==t&&(t=n,n=0),n+Math.floor(Math.random()*(t-n+1))},j.now=Date.now||function(){return(new Date).getTime()};var T={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"}};T.unescape=j.invert(T.escape);var I={escape:new RegExp("["+j.keys(T.escape).join("")+"]","g"),unescape:new RegExp("("+j.keys(T.unescape).join("|")+")","g")};j.each(["escape","unescape"],function(n){j[n]=function(t){return null==t?"":(""+t).replace(I[n],function(t){return T[n][t]})}}),j.result=function(n,t){if(null==n)return void 0;var r=n[t];return j.isFunction(r)?r.call(n):r},j.mixin=function(n){A(j.functions(n),function(t){var r=j[t]=n[t];j.prototype[t]=function(){var n=[this._wrapped];return a.apply(n,arguments),z.call(this,r.apply(j,n))}})};var N=0;j.uniqueId=function(n){var t=++N+"";return n?n+t:t},j.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var q=/(.)^/,B={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},D=/\\|'|\r|\n|\t|\u2028|\u2029/g;j.template=function(n,t,r){var e;r=j.defaults({},r,j.templateSettings);var u=new RegExp([(r.escape||q).source,(r.interpolate||q).source,(r.evaluate||q).source].join("|")+"|$","g"),i=0,a="__p+='";n.replace(u,function(t,r,e,u,o){return a+=n.slice(i,o).replace(D,function(n){return"\\"+B[n]}),r&&(a+="'+\n((__t=("+r+"))==null?'':_.escape(__t))+\n'"),e&&(a+="'+\n((__t=("+e+"))==null?'':__t)+\n'"),u&&(a+="';\n"+u+"\n__p+='"),i=o+t.length,t}),a+="';\n",r.variable||(a="with(obj||{}){\n"+a+"}\n"),a="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+a+"return __p;\n";try{e=new Function(r.variable||"obj","_",a)}catch(o){throw o.source=a,o}if(t)return e(t,j);var c=function(n){return e.call(this,n,j)};return c.source="function("+(r.variable||"obj")+"){\n"+a+"}",c},j.chain=function(n){return j(n).chain()};var z=function(n){return this._chain?j(n).chain():n};j.mixin(j),A(["pop","push","reverse","shift","sort","splice","unshift"],function(n){var t=e[n];j.prototype[n]=function(){var r=this._wrapped;return t.apply(r,arguments),"shift"!=n&&"splice"!=n||0!==r.length||delete r[0],z.call(this,r)}}),A(["concat","join","slice"],function(n){var t=e[n];j.prototype[n]=function(){return z.call(this,t.apply(this._wrapped,arguments))}}),j.extend(j.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}}),"function"==typeof define&&define.amd&&define("underscore",[],function(){return j})}).call(this);(function(root,factory){if(typeof define==="function"&&define.amd){define(["underscore","jquery","exports"],function(_,$,exports){root.Backbone=factory(root,exports,_,$)})}else if(typeof exports!=="undefined"){var _=require("underscore");factory(root,exports,_)}else{root.Backbone=factory(root,{},root._,root.jQuery||root.Zepto||root.ender||root.$)}})(this,function(root,Backbone,_,$){var previousBackbone=root.Backbone;var array=[];var push=array.push;var slice=array.slice;var splice=array.splice;Backbone.VERSION="1.1.2";Backbone.$=$;Backbone.noConflict=function(){root.Backbone=previousBackbone;return this};Backbone.emulateHTTP=false;Backbone.emulateJSON=false;var Events=Backbone.Events={on:function(name,callback,context){if(!eventsApi(this,"on",name,[callback,context])||!callback)return this;this._events||(this._events={});var events=this._events[name]||(this._events[name]=[]);events.push({callback:callback,context:context,ctx:context||this});return this},once:function(name,callback,context){if(!eventsApi(this,"once",name,[callback,context])||!callback)return this;var self=this;var once=_.once(function(){self.off(name,once);callback.apply(this,arguments)});once._callback=callback;return this.on(name,once,context)},off:function(name,callback,context){var retain,ev,events,names,i,l,j,k;if(!this._events||!eventsApi(this,"off",name,[callback,context]))return this;if(!name&&!callback&&!context){this._events=void 0;return this}names=name?[name]:_.keys(this._events);for(i=0,l=names.length;i<l;i++){name=names[i];if(events=this._events[name]){this._events[name]=retain=[];if(callback||context){for(j=0,k=events.length;j<k;j++){ev=events[j];if(callback&&callback!==ev.callback&&callback!==ev.callback._callback||context&&context!==ev.context){retain.push(ev)}}}if(!retain.length)delete this._events[name]}}return this},trigger:function(name){if(!this._events)return this;var args=slice.call(arguments,1);if(!eventsApi(this,"trigger",name,args))return this;var events=this._events[name];var allEvents=this._events.all;if(events)triggerEvents(events,args);if(allEvents)triggerEvents(allEvents,arguments);return this},stopListening:function(obj,name,callback){var listeningTo=this._listeningTo;if(!listeningTo)return this;var remove=!name&&!callback;if(!callback&&typeof name==="object")callback=this;
if(obj)(listeningTo={})[obj._listenId]=obj;for(var id in listeningTo){obj=listeningTo[id];obj.off(name,callback,this);if(remove||_.isEmpty(obj._events))delete this._listeningTo[id]}return this}};var eventSplitter=/\s+/;var eventsApi=function(obj,action,name,rest){if(!name)return true;if(typeof name==="object"){for(var key in name){obj[action].apply(obj,[key,name[key]].concat(rest))}return false}if(eventSplitter.test(name)){var names=name.split(eventSplitter);for(var i=0,l=names.length;i<l;i++){obj[action].apply(obj,[names[i]].concat(rest))}return false}return true};var triggerEvents=function(events,args){var ev,i=-1,l=events.length,a1=args[0],a2=args[1],a3=args[2];switch(args.length){case 0:while(++i<l)(ev=events[i]).callback.call(ev.ctx);return;case 1:while(++i<l)(ev=events[i]).callback.call(ev.ctx,a1);return;case 2:while(++i<l)(ev=events[i]).callback.call(ev.ctx,a1,a2);return;case 3:while(++i<l)(ev=events[i]).callback.call(ev.ctx,a1,a2,a3);return;default:while(++i<l)(ev=events[i]).callback.apply(ev.ctx,args);return}};var listenMethods={listenTo:"on",listenToOnce:"once"};_.each(listenMethods,function(implementation,method){Events[method]=function(obj,name,callback){var listeningTo=this._listeningTo||(this._listeningTo={});var id=obj._listenId||(obj._listenId=_.uniqueId("l"));listeningTo[id]=obj;if(!callback&&typeof name==="object")callback=this;obj[implementation](name,callback,this);return this}});Events.bind=Events.on;Events.unbind=Events.off;_.extend(Backbone,Events);var Model=Backbone.Model=function(attributes,options){var attrs=attributes||{};options||(options={});this.cid=_.uniqueId("c");this.attributes={};if(options.collection)this.collection=options.collection;if(options.parse)attrs=this.parse(attrs,options)||{};attrs=_.defaults({},attrs,_.result(this,"defaults"));this.set(attrs,options);this.changed={};this.initialize.apply(this,arguments)};_.extend(Model.prototype,Events,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(options){return _.clone(this.attributes)},sync:function(){return Backbone.sync.apply(this,arguments)},get:function(attr){return this.attributes[attr]},escape:function(attr){return _.escape(this.get(attr))},has:function(attr){return this.get(attr)!=null},set:function(key,val,options){var attr,attrs,unset,changes,silent,changing,prev,current;if(key==null)return this;if(typeof key==="object"){attrs=key;options=val}else{(attrs={})[key]=val}options||(options={});if(!this._validate(attrs,options))return false;unset=options.unset;silent=options.silent;changes=[];changing=this._changing;this._changing=true;if(!changing){this._previousAttributes=_.clone(this.attributes);this.changed={}}current=this.attributes,prev=this._previousAttributes;if(this.idAttribute in attrs)this.id=attrs[this.idAttribute];for(attr in attrs){val=attrs[attr];if(!_.isEqual(current[attr],val))changes.push(attr);if(!_.isEqual(prev[attr],val)){this.changed[attr]=val}else{delete this.changed[attr]}unset?delete current[attr]:current[attr]=val}if(!silent){if(changes.length)this._pending=options;for(var i=0,l=changes.length;i<l;i++){this.trigger("change:"+changes[i],this,current[changes[i]],options)}}if(changing)return this;if(!silent){while(this._pending){options=this._pending;this._pending=false;this.trigger("change",this,options)}}this._pending=false;this._changing=false;return this},unset:function(attr,options){return this.set(attr,void 0,_.extend({},options,{unset:true}))},clear:function(options){var attrs={};for(var key in this.attributes)attrs[key]=void 0;return this.set(attrs,_.extend({},options,{unset:true}))},hasChanged:function(attr){if(attr==null)return!_.isEmpty(this.changed);return _.has(this.changed,attr)},changedAttributes:function(diff){if(!diff)return this.hasChanged()?_.clone(this.changed):false;var val,changed=false;var old=this._changing?this._previousAttributes:this.attributes;for(var attr in diff){if(_.isEqual(old[attr],val=diff[attr]))continue;(changed||(changed={}))[attr]=val}return changed},previous:function(attr){if(attr==null||!this._previousAttributes)return null;return this._previousAttributes[attr]},previousAttributes:function(){return _.clone(this._previousAttributes)},fetch:function(options){options=options?_.clone(options):{};if(options.parse===void 0)options.parse=true;var model=this;var success=options.success;options.success=function(resp){if(!model.set(model.parse(resp,options),options))return false;if(success)success(model,resp,options);model.trigger("sync",model,resp,options)};wrapError(this,options);return this.sync("read",this,options)},save:function(key,val,options){var attrs,method,xhr,attributes=this.attributes;if(key==null||typeof key==="object"){attrs=key;options=val}else{(attrs={})[key]=val}options=_.extend({validate:true},options);if(attrs&&!options.wait){if(!this.set(attrs,options))return false}else{if(!this._validate(attrs,options))return false}if(attrs&&options.wait){this.attributes=_.extend({},attributes,attrs)}if(options.parse===void 0)options.parse=true;var model=this;var success=options.success;options.success=function(resp){model.attributes=attributes;var serverAttrs=model.parse(resp,options);if(options.wait)serverAttrs=_.extend(attrs||{},serverAttrs);if(_.isObject(serverAttrs)&&!model.set(serverAttrs,options)){return false}if(success)success(model,resp,options);model.trigger("sync",model,resp,options)};wrapError(this,options);method=this.isNew()?"create":options.patch?"patch":"update";if(method==="patch")options.attrs=attrs;xhr=this.sync(method,this,options);if(attrs&&options.wait)this.attributes=attributes;return xhr},destroy:function(options){options=options?_.clone(options):{};var model=this;var success=options.success;var destroy=function(){model.trigger("destroy",model,model.collection,options)};options.success=function(resp){if(options.wait||model.isNew())destroy();if(success)success(model,resp,options);if(!model.isNew())model.trigger("sync",model,resp,options)};if(this.isNew()){options.success();return false}wrapError(this,options);var xhr=this.sync("delete",this,options);if(!options.wait)destroy();return xhr},url:function(){var base=_.result(this,"urlRoot")||_.result(this.collection,"url")||urlError();if(this.isNew())return base;return base.replace(/([^\/])$/,"$1/")+encodeURIComponent(this.id)},parse:function(resp,options){return resp},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.has(this.idAttribute)},isValid:function(options){return this._validate({},_.extend(options||{},{validate:true}))},_validate:function(attrs,options){if(!options.validate||!this.validate)return true;attrs=_.extend({},this.attributes,attrs);var error=this.validationError=this.validate(attrs,options)||null;if(!error)return true;this.trigger("invalid",this,error,_.extend(options,{validationError:error}));return false}});var modelMethods=["keys","values","pairs","invert","pick","omit"];_.each(modelMethods,function(method){Model.prototype[method]=function(){var args=slice.call(arguments);args.unshift(this.attributes);return _[method].apply(_,args)}});var Collection=Backbone.Collection=function(models,options){options||(options={});if(options.model)this.model=options.model;if(options.comparator!==void 0)this.comparator=options.comparator;this._reset();this.initialize.apply(this,arguments);if(models)this.reset(models,_.extend({silent:true},options))};var setOptions={add:true,remove:true,merge:true};var addOptions={add:true,remove:false};_.extend(Collection.prototype,Events,{model:Model,initialize:function(){},toJSON:function(options){return this.map(function(model){return model.toJSON(options)})},sync:function(){return Backbone.sync.apply(this,arguments)},add:function(models,options){return this.set(models,_.extend({merge:false},options,addOptions))},remove:function(models,options){var singular=!_.isArray(models);models=singular?[models]:_.clone(models);options||(options={});var i,l,index,model;for(i=0,l=models.length;i<l;i++){model=models[i]=this.get(models[i]);if(!model)continue;delete this._byId[model.id];delete this._byId[model.cid];index=this.indexOf(model);this.models.splice(index,1);this.length--;if(!options.silent){options.index=index;model.trigger("remove",model,this,options)}this._removeReference(model,options)}return singular?models[0]:models},set:function(models,options){options=_.defaults({},options,setOptions);if(options.parse)models=this.parse(models,options);var singular=!_.isArray(models);models=singular?models?[models]:[]:_.clone(models);var i,l,id,model,attrs,existing,sort;var at=options.at;var targetModel=this.model;var sortable=this.comparator&&at==null&&options.sort!==false;var sortAttr=_.isString(this.comparator)?this.comparator:null;var toAdd=[],toRemove=[],modelMap={};var add=options.add,merge=options.merge,remove=options.remove;var order=!sortable&&add&&remove?[]:false;for(i=0,l=models.length;i<l;i++){attrs=models[i]||{};if(attrs instanceof Model){id=model=attrs}else{id=attrs[targetModel.prototype.idAttribute||"id"]}if(existing=this.get(id)){if(remove)modelMap[existing.cid]=true;if(merge){attrs=attrs===model?model.attributes:attrs;if(options.parse)attrs=existing.parse(attrs,options);existing.set(attrs,options);if(sortable&&!sort&&existing.hasChanged(sortAttr))sort=true}models[i]=existing}else if(add){model=models[i]=this._prepareModel(attrs,options);if(!model)continue;toAdd.push(model);this._addReference(model,options)}model=existing||model;if(order&&(model.isNew()||!modelMap[model.id]))order.push(model);modelMap[model.id]=true}if(remove){for(i=0,l=this.length;i<l;++i){if(!modelMap[(model=this.models[i]).cid])toRemove.push(model)}if(toRemove.length)this.remove(toRemove,options)}if(toAdd.length||order&&order.length){if(sortable)sort=true;this.length+=toAdd.length;if(at!=null){for(i=0,l=toAdd.length;i<l;i++){this.models.splice(at+i,0,toAdd[i])}}else{if(order)this.models.length=0;var orderedModels=order||toAdd;for(i=0,l=orderedModels.length;i<l;i++){this.models.push(orderedModels[i])}}}if(sort)this.sort({silent:true});if(!options.silent){for(i=0,l=toAdd.length;i<l;i++){(model=toAdd[i]).trigger("add",model,this,options)}if(sort||order&&order.length)this.trigger("sort",this,options)}return singular?models[0]:models},reset:function(models,options){options||(options={});for(var i=0,l=this.models.length;i<l;i++){this._removeReference(this.models[i],options)}options.previousModels=this.models;this._reset();models=this.add(models,_.extend({silent:true},options));if(!options.silent)this.trigger("reset",this,options);return models},push:function(model,options){return this.add(model,_.extend({at:this.length},options))},pop:function(options){var model=this.at(this.length-1);this.remove(model,options);return model},unshift:function(model,options){return this.add(model,_.extend({at:0},options))},shift:function(options){var model=this.at(0);this.remove(model,options);return model},slice:function(){return slice.apply(this.models,arguments)},get:function(obj){if(obj==null)return void 0;return this._byId[obj]||this._byId[obj.id]||this._byId[obj.cid]},at:function(index){return this.models[index]},where:function(attrs,first){if(_.isEmpty(attrs))return first?void 0:[];return this[first?"find":"filter"](function(model){for(var key in attrs){if(attrs[key]!==model.get(key))return false}return true})},findWhere:function(attrs){return this.where(attrs,true)},sort:function(options){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");options||(options={});if(_.isString(this.comparator)||this.comparator.length===1){this.models=this.sortBy(this.comparator,this)}else{this.models.sort(_.bind(this.comparator,this))}if(!options.silent)this.trigger("sort",this,options);return this},pluck:function(attr){return _.invoke(this.models,"get",attr)},fetch:function(options){options=options?_.clone(options):{};if(options.parse===void 0)options.parse=true;var success=options.success;var collection=this;options.success=function(resp){var method=options.reset?"reset":"set";collection[method](resp,options);if(success)success(collection,resp,options);collection.trigger("sync",collection,resp,options)};wrapError(this,options);return this.sync("read",this,options)},create:function(model,options){options=options?_.clone(options):{};if(!(model=this._prepareModel(model,options)))return false;if(!options.wait)this.add(model,options);var collection=this;var success=options.success;options.success=function(model,resp){if(options.wait)collection.add(model,options);if(success)success(model,resp,options)};model.save(null,options);return model},parse:function(resp,options){return resp},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0;this.models=[];this._byId={}},_prepareModel:function(attrs,options){if(attrs instanceof Model)return attrs;options=options?_.clone(options):{};options.collection=this;var model=new this.model(attrs,options);if(!model.validationError)return model;this.trigger("invalid",this,model.validationError,options);return false},_addReference:function(model,options){this._byId[model.cid]=model;if(model.id!=null)this._byId[model.id]=model;if(!model.collection)model.collection=this;model.on("all",this._onModelEvent,this)},_removeReference:function(model,options){if(this===model.collection)delete model.collection;model.off("all",this._onModelEvent,this)},_onModelEvent:function(event,model,collection,options){if((event==="add"||event==="remove")&&collection!==this)return;if(event==="destroy")this.remove(model,options);if(model&&event==="change:"+model.idAttribute){delete this._byId[model.previous(model.idAttribute)];if(model.id!=null)this._byId[model.id]=model}this.trigger.apply(this,arguments)}});var methods=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain","sample"];_.each(methods,function(method){Collection.prototype[method]=function(){var args=slice.call(arguments);args.unshift(this.models);return _[method].apply(_,args)}});var attributeMethods=["groupBy","countBy","sortBy","indexBy"];_.each(attributeMethods,function(method){Collection.prototype[method]=function(value,context){var iterator=_.isFunction(value)?value:function(model){return model.get(value)};return _[method](this.models,iterator,context)}});var View=Backbone.View=function(options){this.cid=_.uniqueId("view");options||(options={});_.extend(this,_.pick(options,viewOptions));this._ensureElement();this.initialize.apply(this,arguments);this.delegateEvents()};var delegateEventSplitter=/^(\S+)\s*(.*)$/;var viewOptions=["model","collection","el","id","attributes","className","tagName","events"];_.extend(View.prototype,Events,{tagName:"div",$:function(selector){return this.$el.find(selector)},initialize:function(){},render:function(){return this},remove:function(){this.$el.remove();this.stopListening();return this},setElement:function(element,delegate){if(this.$el)this.undelegateEvents();this.$el=element instanceof Backbone.$?element:Backbone.$(element);this.el=this.$el[0];if(delegate!==false)this.delegateEvents();return this},delegateEvents:function(events){if(!(events||(events=_.result(this,"events"))))return this;this.undelegateEvents();for(var key in events){var method=events[key];if(!_.isFunction(method))method=this[events[key]];if(!method)continue;var match=key.match(delegateEventSplitter);var eventName=match[1],selector=match[2];method=_.bind(method,this);eventName+=".delegateEvents"+this.cid;if(selector===""){this.$el.on(eventName,method)}else{this.$el.on(eventName,selector,method)}}return this},undelegateEvents:function(){this.$el.off(".delegateEvents"+this.cid);return this},_ensureElement:function(){if(!this.el){var attrs=_.extend({},_.result(this,"attributes"));if(this.id)attrs.id=_.result(this,"id");if(this.className)attrs["class"]=_.result(this,"className");var $el=Backbone.$("<"+_.result(this,"tagName")+">").attr(attrs);this.setElement($el,false)}else{this.setElement(_.result(this,"el"),false)}}});Backbone.sync=function(method,model,options){var type=methodMap[method];_.defaults(options||(options={}),{emulateHTTP:Backbone.emulateHTTP,emulateJSON:Backbone.emulateJSON});var params={type:type,dataType:"json"};if(!options.url){params.url=_.result(model,"url")||urlError()}if(options.data==null&&model&&(method==="create"||method==="update"||method==="patch")){params.contentType="application/json";params.data=JSON.stringify(options.attrs||model.toJSON(options))}if(options.emulateJSON){params.contentType="application/x-www-form-urlencoded";params.data=params.data?{model:params.data}:{}}if(options.emulateHTTP&&(type==="PUT"||type==="DELETE"||type==="PATCH")){params.type="POST";if(options.emulateJSON)params.data._method=type;var beforeSend=options.beforeSend;options.beforeSend=function(xhr){xhr.setRequestHeader("X-HTTP-Method-Override",type);if(beforeSend)return beforeSend.apply(this,arguments)}}if(params.type!=="GET"&&!options.emulateJSON){params.processData=false}if(params.type==="PATCH"&&noXhrPatch){params.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")}}var xhr=options.xhr=Backbone.ajax(_.extend(params,options));model.trigger("request",model,xhr,options);return xhr};var noXhrPatch=typeof window!=="undefined"&&!!window.ActiveXObject&&!(window.XMLHttpRequest&&(new XMLHttpRequest).dispatchEvent);var methodMap={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};Backbone.ajax=function(){return Backbone.$.ajax.apply(Backbone.$,arguments)};var Router=Backbone.Router=function(options){options||(options={});if(options.routes)this.routes=options.routes;this._bindRoutes();this.initialize.apply(this,arguments)};var optionalParam=/\((.*?)\)/g;var namedParam=/(\(\?)?:\w+/g;var splatParam=/\*\w+/g;var escapeRegExp=/[\-{}\[\]+?.,\\\^$|#\s]/g;_.extend(Router.prototype,Events,{initialize:function(){},route:function(route,name,callback){if(!_.isRegExp(route))route=this._routeToRegExp(route);if(_.isFunction(name)){callback=name;name=""}if(!callback)callback=this[name];var router=this;Backbone.history.route(route,function(fragment){var args=router._extractParameters(route,fragment);router.execute(callback,args);router.trigger.apply(router,["route:"+name].concat(args));router.trigger("route",name,args);Backbone.history.trigger("route",router,name,args)});return this},execute:function(callback,args){if(callback)callback.apply(this,args)},navigate:function(fragment,options){Backbone.history.navigate(fragment,options);return this},_bindRoutes:function(){if(!this.routes)return;this.routes=_.result(this,"routes");var route,routes=_.keys(this.routes);while((route=routes.pop())!=null){this.route(route,this.routes[route])}},_routeToRegExp:function(route){route=route.replace(escapeRegExp,"\\$&").replace(optionalParam,"(?:$1)?").replace(namedParam,function(match,optional){return optional?match:"([^/?]+)"}).replace(splatParam,"([^?]*?)");return new RegExp("^"+route+"(?:\\?([\\s\\S]*))?$")},_extractParameters:function(route,fragment){var params=route.exec(fragment).slice(1);return _.map(params,function(param,i){if(i===params.length-1)return param||null;return param?decodeURIComponent(param):null})}});var History=Backbone.History=function(){this.handlers=[];_.bindAll(this,"checkUrl");if(typeof window!=="undefined"){this.location=window.location;this.history=window.history}};var routeStripper=/^[#\/]|\s+$/g;var rootStripper=/^\/+|\/+$/g;var isExplorer=/msie [\w.]+/;var trailingSlash=/\/$/;var pathStripper=/#.*$/;History.started=false;_.extend(History.prototype,Events,{interval:50,atRoot:function(){return this.location.pathname.replace(/[^\/]$/,"$&/")===this.root},getHash:function(window){var match=(window||this).location.href.match(/#(.*)$/);return match?match[1]:""},getFragment:function(fragment,forcePushState){if(fragment==null){if(this._hasPushState||!this._wantsHashChange||forcePushState){fragment=decodeURI(this.location.pathname+this.location.search);var root=this.root.replace(trailingSlash,"");if(!fragment.indexOf(root))fragment=fragment.slice(root.length)}else{fragment=this.getHash()}}return fragment.replace(routeStripper,"")},start:function(options){if(History.started)throw new Error("Backbone.history has already been started");History.started=true;this.options=_.extend({root:"/"},this.options,options);this.root=this.options.root;this._wantsHashChange=this.options.hashChange!==false;this._wantsPushState=!!this.options.pushState;this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var fragment=this.getFragment();var docMode=document.documentMode;var oldIE=isExplorer.exec(navigator.userAgent.toLowerCase())&&(!docMode||docMode<=7);this.root=("/"+this.root+"/").replace(rootStripper,"/");if(oldIE&&this._wantsHashChange){var frame=Backbone.$('<iframe src="javascript:0" tabindex="-1">');this.iframe=frame.hide().appendTo("body")[0].contentWindow;this.navigate(fragment)}if(this._hasPushState){Backbone.$(window).on("popstate",this.checkUrl)}else if(this._wantsHashChange&&"onhashchange"in window&&!oldIE){Backbone.$(window).on("hashchange",this.checkUrl)}else if(this._wantsHashChange){this._checkUrlInterval=setInterval(this.checkUrl,this.interval)}this.fragment=fragment;var loc=this.location;if(this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!this.atRoot()){this.fragment=this.getFragment(null,true);this.location.replace(this.root+"#"+this.fragment);return true}else if(this._hasPushState&&this.atRoot()&&loc.hash){this.fragment=this.getHash().replace(routeStripper,"");this.history.replaceState({},document.title,this.root+this.fragment)}}if(!this.options.silent)return this.loadUrl()},stop:function(){Backbone.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl);if(this._checkUrlInterval)clearInterval(this._checkUrlInterval);History.started=false},route:function(route,callback){this.handlers.unshift({route:route,callback:callback})},checkUrl:function(e){var current=this.getFragment();if(current===this.fragment&&this.iframe){current=this.getFragment(this.getHash(this.iframe))}if(current===this.fragment)return false;if(this.iframe)this.navigate(current);this.loadUrl()},loadUrl:function(fragment){fragment=this.fragment=this.getFragment(fragment);return _.any(this.handlers,function(handler){if(handler.route.test(fragment)){handler.callback(fragment);return true}})},navigate:function(fragment,options){if(!History.started)return false;if(!options||options===true)options={trigger:!!options};var url=this.root+(fragment=this.getFragment(fragment||""));fragment=fragment.replace(pathStripper,"");if(this.fragment===fragment)return;this.fragment=fragment;if(fragment===""&&url!=="/")url=url.slice(0,-1);if(this._hasPushState){this.history[options.replace?"replaceState":"pushState"]({},document.title,url)}else if(this._wantsHashChange){this._updateHash(this.location,fragment,options.replace);if(this.iframe&&fragment!==this.getFragment(this.getHash(this.iframe))){if(!options.replace)this.iframe.document.open().close();this._updateHash(this.iframe.location,fragment,options.replace)}}else{return this.location.assign(url)}if(options.trigger)return this.loadUrl(fragment)},_updateHash:function(location,fragment,replace){if(replace){var href=location.href.replace(/(javascript:|#).*$/,"");location.replace(href+"#"+fragment)}else{location.hash="#"+fragment}}});Backbone.history=new History;var extend=function(protoProps,staticProps){var parent=this;var child;if(protoProps&&_.has(protoProps,"constructor")){child=protoProps.constructor}else{child=function(){return parent.apply(this,arguments)}}_.extend(child,parent,staticProps);var Surrogate=function(){this.constructor=child};Surrogate.prototype=parent.prototype;child.prototype=new Surrogate;if(protoProps)_.extend(child.prototype,protoProps);child.__super__=parent.prototype;return child};Model.extend=Collection.extend=Router.extend=View.extend=History.extend=extend;var urlError=function(){throw new Error('A "url" property or function must be specified')};var wrapError=function(model,options){var error=options.error;options.error=function(resp){if(error)error(model,resp,options);model.trigger("error",model,resp,options)}};return Backbone});var requirejs,require,define;(function(ba){function G(b){return"[object Function]"===K.call(b)}function H(b){return"[object Array]"===K.call(b)}function v(b,c){if(b){var d;for(d=0;d<b.length&&(!b[d]||!c(b[d],d,b));d+=1);}}function T(b,c){if(b){var d;for(d=b.length-1;-1<d&&(!b[d]||!c(b[d],d,b));d-=1);}}function t(b,c){return fa.call(b,c)}function m(b,c){return t(b,c)&&b[c]}function B(b,c){for(var d in b)if(t(b,d)&&c(b[d],d))break}function U(b,c,d,e){c&&B(c,function(c,g){if(d||!t(b,g))e&&"object"===typeof c&&c&&!H(c)&&!G(c)&&!(c instanceof RegExp)?(b[g]||(b[g]={}),U(b[g],c,d,e)):b[g]=c});return b}function u(b,c){return function(){return c.apply(b,arguments)}}function ca(b){throw b}function da(b){if(!b)return b;var c=ba;v(b.split("."),function(b){c=c[b]});return c}function C(b,c,d,e){c=Error(c+"\nhttp://requirejs.org/docs/errors.html#"+b);c.requireType=b;c.requireModules=e;d&&(c.originalError=d);return c}function ga(b){function c(a,k,b){var f,l,c,d,e,g,i,p,k=k&&k.split("/"),h=j.map,n=h&&h["*"];if(a){a=a.split("/");l=a.length-1;j.nodeIdCompat&&Q.test(a[l])&&(a[l]=a[l].replace(Q,""));"."===a[0].charAt(0)&&k&&(l=k.slice(0,k.length-1),a=l.concat(a));l=a;for(c=0;c<l.length;c++)if(d=l[c],"."===d)l.splice(c,1),c-=1;else if(".."===d&&!(0===c||1==c&&".."===l[2]||".."===l[c-1])&&0<c)l.splice(c-1,2),c-=2;a=a.join("/")}if(b&&h&&(k||n)){l=a.split("/");c=l.length;a:for(;0<c;c-=1){e=l.slice(0,c).join("/");if(k)for(d=k.length;0<d;d-=1)if(b=m(h,k.slice(0,d).join("/")))if(b=m(b,e)){f=b;g=c;break a}!i&&(n&&m(n,e))&&(i=m(n,e),p=c)}!f&&i&&(f=i,g=p);f&&(l.splice(0,g,f),a=l.join("/"))}return(f=m(j.pkgs,a))?f:a}function d(a){z&&v(document.getElementsByTagName("script"),function(k){if(k.getAttribute("data-requiremodule")===a&&k.getAttribute("data-requirecontext")===i.contextName)return k.parentNode.removeChild(k),!0})}function e(a){var k=m(j.paths,a);if(k&&H(k)&&1<k.length)return k.shift(),i.require.undef(a),i.makeRequire(null,{skipMap:!0})([a]),!0}function n(a){var k,c=a?a.indexOf("!"):-1;-1<c&&(k=a.substring(0,c),a=a.substring(c+1,a.length));return[k,a]}function p(a,k,b,f){var l,d,e=null,g=k?k.name:null,j=a,p=!0,h="";a||(p=!1,a="_@r"+(K+=1));a=n(a);e=a[0];a=a[1];e&&(e=c(e,g,f),d=m(r,e));a&&(e?h=d&&d.normalize?d.normalize(a,function(a){return c(a,g,f)}):-1===a.indexOf("!")?c(a,g,f):a:(h=c(a,g,f),a=n(h),e=a[0],h=a[1],b=!0,l=i.nameToUrl(h)));b=e&&!d&&!b?"_unnormalized"+(O+=1):"";return{prefix:e,name:h,parentMap:k,unnormalized:!!b,url:l,originalName:j,isDefine:p,id:(e?e+"!"+h:h)+b}}function s(a){var k=a.id,b=m(h,k);b||(b=h[k]=new i.Module(a));return b}function q(a,k,b){var f=a.id,c=m(h,f);if(t(r,f)&&(!c||c.defineEmitComplete))"defined"===k&&b(r[f]);else if(c=s(a),c.error&&"error"===k)b(c.error);else c.on(k,b)}function w(a,b){var c=a.requireModules,f=!1;if(b)b(a);else if(v(c,function(b){if(b=m(h,b))b.error=a,b.events.error&&(f=!0,b.emit("error",a))}),!f)g.onError(a)}function x(){R.length&&(ha.apply(A,[A.length,0].concat(R)),R=[])}function y(a){delete h[a];delete V[a]}function F(a,b,c){var f=a.map.id;a.error?a.emit("error",a.error):(b[f]=!0,v(a.depMaps,function(f,d){var e=f.id,g=m(h,e);g&&(!a.depMatched[d]&&!c[e])&&(m(b,e)?(a.defineDep(d,r[e]),a.check()):F(g,b,c))}),c[f]=!0)}function D(){var a,b,c=(a=1e3*j.waitSeconds)&&i.startTime+a<(new Date).getTime(),f=[],l=[],g=!1,h=!0;if(!W){W=!0;B(V,function(a){var i=a.map,j=i.id;if(a.enabled&&(i.isDefine||l.push(a),!a.error))if(!a.inited&&c)e(j)?g=b=!0:(f.push(j),d(j));else if(!a.inited&&(a.fetched&&i.isDefine)&&(g=!0,!i.prefix))return h=!1});if(c&&f.length)return a=C("timeout","Load timeout for modules: "+f,null,f),a.contextName=i.contextName,w(a);h&&v(l,function(a){F(a,{},{})});if((!c||b)&&g)if((z||ea)&&!X)X=setTimeout(function(){X=0;D()},50);W=!1}}function E(a){t(r,a[0])||s(p(a[0],null,!0)).init(a[1],a[2])}function I(a){var a=a.currentTarget||a.srcElement,b=i.onScriptLoad;a.detachEvent&&!Y?a.detachEvent("onreadystatechange",b):a.removeEventListener("load",b,!1);b=i.onScriptError;(!a.detachEvent||Y)&&a.removeEventListener("error",b,!1);return{node:a,id:a&&a.getAttribute("data-requiremodule")}}function J(){var a;for(x();A.length;){a=A.shift();if(null===a[0])return w(C("mismatch","Mismatched anonymous define() module: "+a[a.length-1]));E(a)}}var W,Z,i,L,X,j={waitSeconds:7,baseUrl:"./",paths:{},bundles:{},pkgs:{},shim:{},config:{}},h={},V={},$={},A=[],r={},S={},aa={},K=1,O=1;L={require:function(a){return a.require?a.require:a.require=i.makeRequire(a.map)},exports:function(a){a.usingExports=!0;if(a.map.isDefine)return a.exports?r[a.map.id]=a.exports:a.exports=r[a.map.id]={}},module:function(a){return a.module?a.module:a.module={id:a.map.id,uri:a.map.url,config:function(){return m(j.config,a.map.id)||{}},exports:a.exports||(a.exports={})}}};Z=function(a){this.events=m($,a.id)||{};this.map=a;this.shim=m(j.shim,a.id);this.depExports=[];this.depMaps=[];this.depMatched=[];this.pluginMaps={};this.depCount=0};Z.prototype={init:function(a,b,c,f){f=f||{};if(!this.inited){this.factory=b;if(c)this.on("error",c);else this.events.error&&(c=u(this,function(a){this.emit("error",a)}));this.depMaps=a&&a.slice(0);this.errback=c;this.inited=!0;this.ignore=f.ignore;f.enabled||this.enabled?this.enable():this.check()}},defineDep:function(a,b){this.depMatched[a]||(this.depMatched[a]=!0,this.depCount-=1,this.depExports[a]=b)},fetch:function(){if(!this.fetched){this.fetched=!0;i.startTime=(new Date).getTime();var a=this.map;if(this.shim)i.makeRequire(this.map,{enableBuildCallback:!0})(this.shim.deps||[],u(this,function(){return a.prefix?this.callPlugin():this.load()}));else return a.prefix?this.callPlugin():this.load()}},load:function(){var a=this.map.url;S[a]||(S[a]=!0,i.load(this.map.id,a))},check:function(){if(this.enabled&&!this.enabling){var a,b,c=this.map.id;b=this.depExports;var f=this.exports,l=this.factory;if(this.inited)if(this.error)this.emit("error",this.error);else{if(!this.defining){this.defining=!0;if(1>this.depCount&&!this.defined){if(G(l)){if(this.events.error&&this.map.isDefine||g.onError!==ca)try{f=i.execCb(c,l,b,f)}catch(d){a=d}else f=i.execCb(c,l,b,f);this.map.isDefine&&void 0===f&&((b=this.module)?f=b.exports:this.usingExports&&(f=this.exports));if(a)return a.requireMap=this.map,a.requireModules=this.map.isDefine?[this.map.id]:null,a.requireType=this.map.isDefine?"define":"require",w(this.error=a)}else f=l;this.exports=f;if(this.map.isDefine&&!this.ignore&&(r[c]=f,g.onResourceLoad))g.onResourceLoad(i,this.map,this.depMaps);y(c);this.defined=!0}this.defining=!1;this.defined&&!this.defineEmitted&&(this.defineEmitted=!0,this.emit("defined",this.exports),this.defineEmitComplete=!0)}}else this.fetch()}},callPlugin:function(){var a=this.map,b=a.id,d=p(a.prefix);this.depMaps.push(d);q(d,"defined",u(this,function(f){var l,d;d=m(aa,this.map.id);var e=this.map.name,P=this.map.parentMap?this.map.parentMap.name:null,n=i.makeRequire(a.parentMap,{enableBuildCallback:!0});if(this.map.unnormalized){if(f.normalize&&(e=f.normalize(e,function(a){return c(a,P,!0)})||""),f=p(a.prefix+"!"+e,this.map.parentMap),q(f,"defined",u(this,function(a){this.init([],function(){return a},null,{enabled:!0,ignore:!0})})),d=m(h,f.id)){this.depMaps.push(f);if(this.events.error)d.on("error",u(this,function(a){this.emit("error",a)}));d.enable()}}else d?(this.map.url=i.nameToUrl(d),this.load()):(l=u(this,function(a){this.init([],function(){return a},null,{enabled:!0})}),l.error=u(this,function(a){this.inited=!0;this.error=a;a.requireModules=[b];B(h,function(a){0===a.map.id.indexOf(b+"_unnormalized")&&y(a.map.id)});w(a)}),l.fromText=u(this,function(f,c){var d=a.name,e=p(d),P=M;c&&(f=c);P&&(M=!1);
s(e);t(j.config,b)&&(j.config[d]=j.config[b]);try{g.exec(f)}catch(h){return w(C("fromtexteval","fromText eval for "+b+" failed: "+h,h,[b]))}P&&(M=!0);this.depMaps.push(e);i.completeLoad(d);n([d],l)}),f.load(a.name,n,l,j))}));i.enable(d,this);this.pluginMaps[d.id]=d},enable:function(){V[this.map.id]=this;this.enabling=this.enabled=!0;v(this.depMaps,u(this,function(a,b){var c,f;if("string"===typeof a){a=p(a,this.map.isDefine?this.map:this.map.parentMap,!1,!this.skipMap);this.depMaps[b]=a;if(c=m(L,a.id)){this.depExports[b]=c(this);return}this.depCount+=1;q(a,"defined",u(this,function(a){this.defineDep(b,a);this.check()}));this.errback&&q(a,"error",u(this,this.errback))}c=a.id;f=h[c];!t(L,c)&&(f&&!f.enabled)&&i.enable(a,this)}));B(this.pluginMaps,u(this,function(a){var b=m(h,a.id);b&&!b.enabled&&i.enable(a,this)}));this.enabling=!1;this.check()},on:function(a,b){var c=this.events[a];c||(c=this.events[a]=[]);c.push(b)},emit:function(a,b){v(this.events[a],function(a){a(b)});"error"===a&&delete this.events[a]}};i={config:j,contextName:b,registry:h,defined:r,urlFetched:S,defQueue:A,Module:Z,makeModuleMap:p,nextTick:g.nextTick,onError:w,configure:function(a){a.baseUrl&&"/"!==a.baseUrl.charAt(a.baseUrl.length-1)&&(a.baseUrl+="/");var b=j.shim,c={paths:!0,bundles:!0,config:!0,map:!0};B(a,function(a,b){c[b]?(j[b]||(j[b]={}),U(j[b],a,!0,!0)):j[b]=a});a.bundles&&B(a.bundles,function(a,b){v(a,function(a){a!==b&&(aa[a]=b)})});a.shim&&(B(a.shim,function(a,c){H(a)&&(a={deps:a});if((a.exports||a.init)&&!a.exportsFn)a.exportsFn=i.makeShimExports(a);b[c]=a}),j.shim=b);a.packages&&v(a.packages,function(a){var b,a="string"===typeof a?{name:a}:a;b=a.name;a.location&&(j.paths[b]=a.location);j.pkgs[b]=a.name+"/"+(a.main||"main").replace(ia,"").replace(Q,"")});B(h,function(a,b){!a.inited&&!a.map.unnormalized&&(a.map=p(b))});if(a.deps||a.callback)i.require(a.deps||[],a.callback)},makeShimExports:function(a){return function(){var b;a.init&&(b=a.init.apply(ba,arguments));return b||a.exports&&da(a.exports)}},makeRequire:function(a,e){function j(c,d,m){var n,q;e.enableBuildCallback&&(d&&G(d))&&(d.__requireJsBuild=!0);if("string"===typeof c){if(G(d))return w(C("requireargs","Invalid require call"),m);if(a&&t(L,c))return L[c](h[a.id]);if(g.get)return g.get(i,c,a,j);n=p(c,a,!1,!0);n=n.id;return!t(r,n)?w(C("notloaded",'Module name "'+n+'" has not been loaded yet for context: '+b+(a?"":". Use require([])"))):r[n]}J();i.nextTick(function(){J();q=s(p(null,a));q.skipMap=e.skipMap;q.init(c,d,m,{enabled:!0});D()});return j}e=e||{};U(j,{isBrowser:z,toUrl:function(b){var d,e=b.lastIndexOf("."),k=b.split("/")[0];if(-1!==e&&(!("."===k||".."===k)||1<e))d=b.substring(e,b.length),b=b.substring(0,e);return i.nameToUrl(c(b,a&&a.id,!0),d,!0)},defined:function(b){return t(r,p(b,a,!1,!0).id)},specified:function(b){b=p(b,a,!1,!0).id;return t(r,b)||t(h,b)}});a||(j.undef=function(b){x();var c=p(b,a,!0),e=m(h,b);d(b);delete r[b];delete S[c.url];delete $[b];T(A,function(a,c){a[0]===b&&A.splice(c,1)});e&&(e.events.defined&&($[b]=e.events),y(b))});return j},enable:function(a){m(h,a.id)&&s(a).enable()},completeLoad:function(a){var b,c,d=m(j.shim,a)||{},g=d.exports;for(x();A.length;){c=A.shift();if(null===c[0]){c[0]=a;if(b)break;b=!0}else c[0]===a&&(b=!0);E(c)}c=m(h,a);if(!b&&!t(r,a)&&c&&!c.inited){if(j.enforceDefine&&(!g||!da(g)))return e(a)?void 0:w(C("nodefine","No define call for "+a,null,[a]));E([a,d.deps||[],d.exportsFn])}D()},nameToUrl:function(a,b,c){var d,e,h;(d=m(j.pkgs,a))&&(a=d);if(d=m(aa,a))return i.nameToUrl(d,b,c);if(g.jsExtRegExp.test(a))d=a+(b||"");else{d=j.paths;a=a.split("/");for(e=a.length;0<e;e-=1)if(h=a.slice(0,e).join("/"),h=m(d,h)){H(h)&&(h=h[0]);a.splice(0,e,h);break}d=a.join("/");d+=b||(/^data\:|\?/.test(d)||c?"":".js");d=("/"===d.charAt(0)||d.match(/^[\w\+\.\-]+:/)?"":j.baseUrl)+d}return j.urlArgs?d+((-1===d.indexOf("?")?"?":"&")+j.urlArgs):d},load:function(a,b){g.load(i,a,b)},execCb:function(a,b,c,d){return b.apply(d,c)},onScriptLoad:function(a){if("load"===a.type||ja.test((a.currentTarget||a.srcElement).readyState))N=null,a=I(a),i.completeLoad(a.id)},onScriptError:function(a){var b=I(a);if(!e(b.id))return w(C("scripterror","Script error for: "+b.id,a,[b.id]))}};i.require=i.makeRequire();return i}var g,x,y,D,I,E,N,J,s,O,ka=/(\/\*([\s\S]*?)\*\/|([^:]|^)\/\/(.*)$)/gm,la=/[^.]\s*require\s*\(\s*["']([^'"\s]+)["']\s*\)/g,Q=/\.js$/,ia=/^\.\//;x=Object.prototype;var K=x.toString,fa=x.hasOwnProperty,ha=Array.prototype.splice,z=!!("undefined"!==typeof window&&"undefined"!==typeof navigator&&window.document),ea=!z&&"undefined"!==typeof importScripts,ja=z&&"PLAYSTATION 3"===navigator.platform?/^complete$/:/^(complete|loaded)$/,Y="undefined"!==typeof opera&&"[object Opera]"===opera.toString(),F={},q={},R=[],M=!1;if("undefined"===typeof define){if("undefined"!==typeof requirejs){if(G(requirejs))return;q=requirejs;requirejs=void 0}"undefined"!==typeof require&&!G(require)&&(q=require,require=void 0);g=requirejs=function(b,c,d,e){var n,p="_";!H(b)&&"string"!==typeof b&&(n=b,H(c)?(b=c,c=d,d=e):b=[]);n&&n.context&&(p=n.context);(e=m(F,p))||(e=F[p]=g.s.newContext(p));n&&e.configure(n);return e.require(b,c,d)};g.config=function(b){return g(b)};g.nextTick="undefined"!==typeof setTimeout?function(b){setTimeout(b,4)}:function(b){b()};require||(require=g);g.version="2.1.15";g.jsExtRegExp=/^\/|:|\?|\.js$/;g.isBrowser=z;x=g.s={contexts:F,newContext:ga};g({});v(["toUrl","undef","defined","specified"],function(b){g[b]=function(){var c=F._;return c.require[b].apply(c,arguments)}});if(z&&(y=x.head=document.getElementsByTagName("head")[0],D=document.getElementsByTagName("base")[0]))y=x.head=D.parentNode;g.onError=ca;g.createNode=function(b){var c=b.xhtml?document.createElementNS("http://www.w3.org/1999/xhtml","html:script"):document.createElement("script");c.type=b.scriptType||"text/javascript";c.charset="utf-8";c.async=!0;return c};g.load=function(b,c,d){var e=b&&b.config||{};if(z)return e=g.createNode(e,c,d),e.setAttribute("data-requirecontext",b.contextName),e.setAttribute("data-requiremodule",c),e.attachEvent&&!(e.attachEvent.toString&&0>e.attachEvent.toString().indexOf("[native code"))&&!Y?(M=!0,e.attachEvent("onreadystatechange",b.onScriptLoad)):(e.addEventListener("load",b.onScriptLoad,!1),e.addEventListener("error",b.onScriptError,!1)),e.src=d,J=e,D?y.insertBefore(e,D):y.appendChild(e),J=null,e;if(ea)try{importScripts(d),b.completeLoad(c)}catch(m){b.onError(C("importscripts","importScripts failed for "+c+" at "+d,m,[c]))}};z&&!q.skipDataMain&&T(document.getElementsByTagName("script"),function(b){y||(y=b.parentNode);if(I=b.getAttribute("data-main"))return s=I,q.baseUrl||(E=s.split("/"),s=E.pop(),O=E.length?E.join("/")+"/":"./",q.baseUrl=O),s=s.replace(Q,""),g.jsExtRegExp.test(s)&&(s=I),q.deps=q.deps?q.deps.concat(s):[s],!0});define=function(b,c,d){var e,g;"string"!==typeof b&&(d=c,c=b,b=null);H(c)||(d=c,c=null);!c&&G(d)&&(c=[],d.length&&(d.toString().replace(ka,"").replace(la,function(b,d){c.push(d)}),c=(1===d.length?["require"]:["require","exports","module"]).concat(c)));if(M){if(!(e=J))N&&"interactive"===N.readyState||T(document.getElementsByTagName("script"),function(b){if("interactive"===b.readyState)return N=b}),e=N;e&&(b||(b=e.getAttribute("data-requiremodule")),g=F[e.getAttribute("data-requirecontext")])}(g?g.defQueue:R).push([b,c,d])};define.amd={jQuery:!0};g.exec=function(b){return eval(b)};g(q)}})(this);!function(root,String){var nativeTrim=String.prototype.trim;var nativeTrimRight=String.prototype.trimRight;var nativeTrimLeft=String.prototype.trimLeft;var parseNumber=function(source){return source*1||0};var strRepeat=function(str,qty){if(qty<1)return"";var result="";while(qty>0){if(qty&1)result+=str;qty>>=1,str+=str}return result};var slice=[].slice;var defaultToWhiteSpace=function(characters){if(characters==null)return"\\s";else if(characters.source)return characters.source;else return"["+_s.escapeRegExp(characters)+"]"};var escapeChars={lt:"<",gt:">",quot:'"',amp:"&",apos:"'"};var reversedEscapeChars={};for(var key in escapeChars)reversedEscapeChars[escapeChars[key]]=key;reversedEscapeChars["'"]="#39";var sprintf=function(){function get_type(variable){return Object.prototype.toString.call(variable).slice(8,-1).toLowerCase()}var str_repeat=strRepeat;var str_format=function(){if(!str_format.cache.hasOwnProperty(arguments[0])){str_format.cache[arguments[0]]=str_format.parse(arguments[0])}return str_format.format.call(null,str_format.cache[arguments[0]],arguments)};str_format.format=function(parse_tree,argv){var cursor=1,tree_length=parse_tree.length,node_type="",arg,output=[],i,k,match,pad,pad_character,pad_length;for(i=0;i<tree_length;i++){node_type=get_type(parse_tree[i]);if(node_type==="string"){output.push(parse_tree[i])}else if(node_type==="array"){match=parse_tree[i];if(match[2]){arg=argv[cursor];for(k=0;k<match[2].length;k++){if(!arg.hasOwnProperty(match[2][k])){throw new Error(sprintf('[_.sprintf] property "%s" does not exist',match[2][k]))}arg=arg[match[2][k]]}}else if(match[1]){arg=argv[match[1]]}else{arg=argv[cursor++]}if(/[^s]/.test(match[8])&&get_type(arg)!="number"){throw new Error(sprintf("[_.sprintf] expecting number but found %s",get_type(arg)))}switch(match[8]){case"b":arg=arg.toString(2);break;case"c":arg=String.fromCharCode(arg);break;case"d":arg=parseInt(arg,10);break;case"e":arg=match[7]?arg.toExponential(match[7]):arg.toExponential();break;case"f":arg=match[7]?parseFloat(arg).toFixed(match[7]):parseFloat(arg);break;case"o":arg=arg.toString(8);break;case"s":arg=(arg=String(arg))&&match[7]?arg.substring(0,match[7]):arg;break;case"u":arg=Math.abs(arg);break;case"x":arg=arg.toString(16);break;case"X":arg=arg.toString(16).toUpperCase();break}arg=/[def]/.test(match[8])&&match[3]&&arg>=0?"+"+arg:arg;pad_character=match[4]?match[4]=="0"?"0":match[4].charAt(1):" ";pad_length=match[6]-String(arg).length;pad=match[6]?str_repeat(pad_character,pad_length):"";output.push(match[5]?arg+pad:pad+arg)}}return output.join("")};str_format.cache={};str_format.parse=function(fmt){var _fmt=fmt,match=[],parse_tree=[],arg_names=0;while(_fmt){if((match=/^[^\x25]+/.exec(_fmt))!==null){parse_tree.push(match[0])}else if((match=/^\x25{2}/.exec(_fmt))!==null){parse_tree.push("%")}else if((match=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(_fmt))!==null){if(match[2]){arg_names|=1;var field_list=[],replacement_field=match[2],field_match=[];if((field_match=/^([a-z_][a-z_\d]*)/i.exec(replacement_field))!==null){field_list.push(field_match[1]);while((replacement_field=replacement_field.substring(field_match[0].length))!==""){if((field_match=/^\.([a-z_][a-z_\d]*)/i.exec(replacement_field))!==null){field_list.push(field_match[1])}else if((field_match=/^\[(\d+)\]/.exec(replacement_field))!==null){field_list.push(field_match[1])}else{throw new Error("[_.sprintf] huh?")}}}else{throw new Error("[_.sprintf] huh?")}match[2]=field_list}else{arg_names|=2}if(arg_names===3){throw new Error("[_.sprintf] mixing positional and named placeholders is not (yet) supported")}parse_tree.push(match)}else{throw new Error("[_.sprintf] huh?")}_fmt=_fmt.substring(match[0].length)}return parse_tree};return str_format}();var _s={VERSION:"2.3.0",isBlank:function(str){if(str==null)str="";return/^\s*$/.test(str)},stripTags:function(str){if(str==null)return"";return String(str).replace(/<\/?[^>]+>/g,"")},capitalize:function(str){str=str==null?"":String(str);return str.charAt(0).toUpperCase()+str.slice(1)},chop:function(str,step){if(str==null)return[];str=String(str);step=~~step;return step>0?str.match(new RegExp(".{1,"+step+"}","g")):[str]},clean:function(str){return _s.strip(str).replace(/\s+/g," ")},count:function(str,substr){if(str==null||substr==null)return 0;str=String(str);substr=String(substr);var count=0,pos=0,length=substr.length;while(true){pos=str.indexOf(substr,pos);if(pos===-1)break;count++;pos+=length}return count},chars:function(str){if(str==null)return[];return String(str).split("")},swapCase:function(str){if(str==null)return"";return String(str).replace(/\S/g,function(c){return c===c.toUpperCase()?c.toLowerCase():c.toUpperCase()})},escapeHTML:function(str){if(str==null)return"";return String(str).replace(/[&<>"']/g,function(m){return"&"+reversedEscapeChars[m]+";"})},unescapeHTML:function(str){if(str==null)return"";return String(str).replace(/\&([^;]+);/g,function(entity,entityCode){var match;if(entityCode in escapeChars){return escapeChars[entityCode]}else if(match=entityCode.match(/^#x([\da-fA-F]+)$/)){return String.fromCharCode(parseInt(match[1],16))}else if(match=entityCode.match(/^#(\d+)$/)){return String.fromCharCode(~~match[1])}else{return entity}})},escapeRegExp:function(str){if(str==null)return"";return String(str).replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1")},splice:function(str,i,howmany,substr){var arr=_s.chars(str);arr.splice(~~i,~~howmany,substr);return arr.join("")},insert:function(str,i,substr){return _s.splice(str,i,0,substr)},include:function(str,needle){if(needle==="")return true;if(str==null)return false;return String(str).indexOf(needle)!==-1},join:function(){var args=slice.call(arguments),separator=args.shift();if(separator==null)separator="";return args.join(separator)},lines:function(str){if(str==null)return[];return String(str).split("\n")},reverse:function(str){return _s.chars(str).reverse().join("")},startsWith:function(str,starts){if(starts==="")return true;if(str==null||starts==null)return false;str=String(str);starts=String(starts);return str.length>=starts.length&&str.slice(0,starts.length)===starts},endsWith:function(str,ends){if(ends==="")return true;if(str==null||ends==null)return false;str=String(str);ends=String(ends);return str.length>=ends.length&&str.slice(str.length-ends.length)===ends},succ:function(str){if(str==null)return"";str=String(str);return str.slice(0,-1)+String.fromCharCode(str.charCodeAt(str.length-1)+1)},titleize:function(str){if(str==null)return"";return String(str).replace(/(?:^|\s)\S/g,function(c){return c.toUpperCase()})},camelize:function(str){return _s.trim(str).replace(/[-_\s]+(.)?/g,function(match,c){return c.toUpperCase()})},underscored:function(str){return _s.trim(str).replace(/([a-z\d])([A-Z]+)/g,"$1_$2").replace(/[-\s]+/g,"_").toLowerCase()},dasherize:function(str){return _s.trim(str).replace(/([A-Z])/g,"-$1").replace(/[-_\s]+/g,"-").toLowerCase()},classify:function(str){return _s.titleize(String(str).replace(/_/g," ")).replace(/\s/g,"")},humanize:function(str){return _s.capitalize(_s.underscored(str).replace(/_id$/,"").replace(/_/g," "))},trim:function(str,characters){if(str==null)return"";if(!characters&&nativeTrim)return nativeTrim.call(str);characters=defaultToWhiteSpace(characters);return String(str).replace(new RegExp("^"+characters+"+|"+characters+"+$","g"),"")},ltrim:function(str,characters){if(str==null)return"";if(!characters&&nativeTrimLeft)return nativeTrimLeft.call(str);characters=defaultToWhiteSpace(characters);return String(str).replace(new RegExp("^"+characters+"+"),"")},rtrim:function(str,characters){if(str==null)return"";if(!characters&&nativeTrimRight)return nativeTrimRight.call(str);characters=defaultToWhiteSpace(characters);return String(str).replace(new RegExp(characters+"+$"),"")},truncate:function(str,length,truncateStr){if(str==null)return"";str=String(str);truncateStr=truncateStr||"...";length=~~length;return str.length>length?str.slice(0,length)+truncateStr:str},prune:function(str,length,pruneStr){if(str==null)return"";str=String(str);length=~~length;pruneStr=pruneStr!=null?String(pruneStr):"...";if(str.length<=length)return str;var tmpl=function(c){return c.toUpperCase()!==c.toLowerCase()?"A":" "},template=str.slice(0,length+1).replace(/.(?=\W*\w*$)/g,tmpl);if(template.slice(template.length-2).match(/\w\w/))template=template.replace(/\s*\S+$/,"");else template=_s.rtrim(template.slice(0,template.length-1));return(template+pruneStr).length>str.length?str:str.slice(0,template.length)+pruneStr},words:function(str,delimiter){if(_s.isBlank(str))return[];return _s.trim(str,delimiter).split(delimiter||/\s+/)},pad:function(str,length,padStr,type){str=str==null?"":String(str);length=~~length;var padlen=0;if(!padStr)padStr=" ";else if(padStr.length>1)padStr=padStr.charAt(0);switch(type){case"right":padlen=length-str.length;return str+strRepeat(padStr,padlen);case"both":padlen=length-str.length;return strRepeat(padStr,Math.ceil(padlen/2))+str+strRepeat(padStr,Math.floor(padlen/2));default:padlen=length-str.length;return strRepeat(padStr,padlen)+str}},lpad:function(str,length,padStr){return _s.pad(str,length,padStr)},rpad:function(str,length,padStr){return _s.pad(str,length,padStr,"right")},lrpad:function(str,length,padStr){return _s.pad(str,length,padStr,"both")},sprintf:sprintf,vsprintf:function(fmt,argv){argv.unshift(fmt);return sprintf.apply(null,argv)},toNumber:function(str,decimals){if(!str)return 0;str=_s.trim(str);if(!str.match(/^-?\d+(?:\.\d+)?$/))return NaN;return parseNumber(parseNumber(str).toFixed(~~decimals))},numberFormat:function(number,dec,dsep,tsep){if(isNaN(number)||number==null)return"";number=number.toFixed(~~dec);tsep=typeof tsep=="string"?tsep:",";var parts=number.split("."),fnums=parts[0],decimals=parts[1]?(dsep||".")+parts[1]:"";return fnums.replace(/(\d)(?=(?:\d{3})+$)/g,"$1"+tsep)+decimals},strRight:function(str,sep){if(str==null)return"";str=String(str);sep=sep!=null?String(sep):sep;var pos=!sep?-1:str.indexOf(sep);return~pos?str.slice(pos+sep.length,str.length):str},strRightBack:function(str,sep){if(str==null)return"";str=String(str);sep=sep!=null?String(sep):sep;var pos=!sep?-1:str.lastIndexOf(sep);return~pos?str.slice(pos+sep.length,str.length):str},strLeft:function(str,sep){if(str==null)return"";str=String(str);sep=sep!=null?String(sep):sep;var pos=!sep?-1:str.indexOf(sep);return~pos?str.slice(0,pos):str},strLeftBack:function(str,sep){if(str==null)return"";str+="";sep=sep!=null?""+sep:sep;var pos=str.lastIndexOf(sep);return~pos?str.slice(0,pos):str},toSentence:function(array,separator,lastSeparator,serial){separator=separator||", ";lastSeparator=lastSeparator||" and ";var a=array.slice(),lastMember=a.pop();if(array.length>2&&serial)lastSeparator=_s.rtrim(separator)+lastSeparator;return a.length?a.join(separator)+lastSeparator+lastMember:lastMember},toSentenceSerial:function(){var args=slice.call(arguments);args[3]=true;return _s.toSentence.apply(_s,args)},slugify:function(str){if(str==null)return"";var from="ąàáäâãåæćęèéëêìíïîłńòóöôõøùúüûñçżź",to="aaaaaaaaceeeeeiiiilnoooooouuuunczz",regex=new RegExp(defaultToWhiteSpace(from),"g");str=String(str).toLowerCase().replace(regex,function(c){var index=from.indexOf(c);return to.charAt(index)||"-"});return _s.dasherize(str.replace(/[^\w\s-]/g,""))},surround:function(str,wrapper){return[wrapper,str,wrapper].join("")},quote:function(str){return _s.surround(str,'"')},exports:function(){var result={};for(var prop in this){if(!this.hasOwnProperty(prop)||prop.match(/^(?:include|contains|reverse)$/))continue;result[prop]=this[prop]}return result},repeat:function(str,qty,separator){if(str==null)return"";qty=~~qty;if(separator==null)return strRepeat(String(str),qty);for(var repeat=[];qty>0;repeat[--qty]=str){}return repeat.join(separator)},levenshtein:function(str1,str2){if(str1==null&&str2==null)return 0;if(str1==null)return String(str2).length;if(str2==null)return String(str1).length;str1=String(str1);str2=String(str2);var current=[],prev,value;for(var i=0;i<=str2.length;i++)for(var j=0;j<=str1.length;j++){if(i&&j)if(str1.charAt(j-1)===str2.charAt(i-1))value=prev;else value=Math.min(current[j],current[j-1],prev)+1;else value=i+j;prev=current[j];current[j]=value}return current.pop()}};_s.strip=_s.trim;_s.lstrip=_s.ltrim;_s.rstrip=_s.rtrim;_s.center=_s.lrpad;_s.rjust=_s.lpad;_s.ljust=_s.rpad;_s.contains=_s.include;_s.q=_s.quote;if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports)module.exports=_s;exports._s=_s}if(typeof define==="function"&&define.amd)define("underscore.string",[],function(){return _s});root._=root._||{};root._.string=root._.str=_s}(this,String);define("ext/underscore",["underscore.string"],function(_s){var self=_;_.mixin(_s.exports());_.mixin({assert:function(outcome,description){if(!outcome){throw description||"assertion failed"}},getProperty:function(object,property){if(object&&object[property]){if(self.isFunction(object[property])){return object[property].apply(object)}return object[property]}return null},bindToMethods:function(obj){var funcs=self.functions(obj);self.each(funcs,function(f){obj[f]=self.bind(obj[f],obj)});return obj}});return _.noConflict()});define("jquery",[],function(){return jQuery});!function(a){"function"==typeof define&&define.amd?define("picker",["jquery"],a):"object"==typeof exports?module.exports=a(require("jquery")):this.Picker=a(jQuery)}(function(a){function b(f,g,i,m){function n(){return b._.node("div",b._.node("div",b._.node("div",b._.node("div",B.component.nodes(w.open),y.box),y.wrap),y.frame),y.holder,'tabindex="-1"')}function o(){z.data(g,B).addClass(y.input).val(z.data("value")?B.get("select",x.format):f.value),x.editable||z.on("focus."+w.id+" click."+w.id,function(a){a.preventDefault(),B.open()}).on("keydown."+w.id,u),e(f,{haspopup:!0,expanded:!1,readonly:!1,owns:f.id+"_root"})}function p(){e(B.$root[0],"hidden",!0)}function q(){B.$holder.on({keydown:u,"focus.toOpen":t,blur:function(){z.removeClass(y.target)},focusin:function(a){B.$root.removeClass(y.focused),a.stopPropagation()},"mousedown click":function(b){var c=b.target;c!=B.$holder[0]&&(b.stopPropagation(),"mousedown"!=b.type||a(c).is("input, select, textarea, button, option")||(b.preventDefault(),B.$holder[0].focus()))}}).on("click","[data-pick], [data-nav], [data-clear], [data-close]",function(){var b=a(this),c=b.data(),d=b.hasClass(y.navDisabled)||b.hasClass(y.disabled),e=h();e=e&&(e.type||e.href),(d||e&&!a.contains(B.$root[0],e))&&B.$holder[0].focus(),!d&&c.nav?B.set("highlight",B.component.item.highlight,{nav:c.nav}):!d&&"pick"in c?(B.set("select",c.pick),x.closeOnSelect&&B.close(!0)):c.clear?(B.clear(),x.closeOnClear&&B.close(!0)):c.close&&B.close(!0)})}function r(){var b;x.hiddenName===!0?(b=f.name,f.name=""):(b=["string"==typeof x.hiddenPrefix?x.hiddenPrefix:"","string"==typeof x.hiddenSuffix?x.hiddenSuffix:"_submit"],b=b[0]+f.name+b[1]),B._hidden=a('<input type=hidden name="'+b+'"'+(z.data("value")||f.value?' value="'+B.get("select",x.formatSubmit)+'"':"")+">")[0],z.on("change."+w.id,function(){B._hidden.value=f.value?B.get("select",x.formatSubmit):""})}function s(){v&&l?B.$holder.find("."+y.frame).one("transitionend",function(){B.$holder[0].focus()}):B.$holder[0].focus()}function t(a){a.stopPropagation(),z.addClass(y.target),B.$root.addClass(y.focused),B.open()}function u(a){var b=a.keyCode,c=/^(8|46)$/.test(b);return 27==b?(B.close(!0),!1):void((32==b||c||!w.open&&B.component.key[b])&&(a.preventDefault(),a.stopPropagation(),c?B.clear().close():B.open()))}if(!f)return b;var v=!1,w={id:f.id||"P"+Math.abs(~~(Math.random()*new Date))},x=i?a.extend(!0,{},i.defaults,m):m||{},y=a.extend({},b.klasses(),x.klass),z=a(f),A=function(){return this.start()},B=A.prototype={constructor:A,$node:z,start:function(){return w&&w.start?B:(w.methods={},w.start=!0,w.open=!1,w.type=f.type,f.autofocus=f==h(),f.readOnly=!x.editable,f.id=f.id||w.id,"text"!=f.type&&(f.type="text"),B.component=new i(B,x),B.$root=a('<div class="'+y.picker+'" id="'+f.id+'_root" />'),p(),B.$holder=a(n()).appendTo(B.$root),q(),x.formatSubmit&&r(),o(),x.containerHidden?a(x.containerHidden).append(B._hidden):z.after(B._hidden),x.container?a(x.container).append(B.$root):z.after(B.$root),B.on({start:B.component.onStart,render:B.component.onRender,stop:B.component.onStop,open:B.component.onOpen,close:B.component.onClose,set:B.component.onSet}).on({start:x.onStart,render:x.onRender,stop:x.onStop,open:x.onOpen,close:x.onClose,set:x.onSet}),v=c(B.$holder[0]),f.autofocus&&B.open(),B.trigger("start").trigger("render"))},render:function(a){return a?(B.$holder=n(),B.$root.html(B.$holder)):B.$root.find("."+y.box).html(B.component.nodes(w.open)),B.trigger("render")},stop:function(){return w.start?(B.close(),B._hidden&&B._hidden.parentNode.removeChild(B._hidden),B.$root.remove(),z.removeClass(y.input).removeData(g),setTimeout(function(){z.off("."+w.id)},0),f.type=w.type,f.readOnly=!1,B.trigger("stop"),w.methods={},w.start=!1,B):B},open:function(c){return w.open?B:(z.addClass(y.active),e(f,"expanded",!0),setTimeout(function(){B.$root.addClass(y.opened),e(B.$root[0],"hidden",!1)},0),c!==!1&&(w.open=!0,v&&k.css("overflow","hidden").css("padding-right","+="+d()),s(),j.on("click."+w.id+" focusin."+w.id,function(a){var b=a.target;b!=f&&b!=document&&3!=a.which&&B.close(b===B.$holder[0])}).on("keydown."+w.id,function(c){var d=c.keyCode,e=B.component.key[d],f=c.target;27==d?B.close(!0):f!=B.$holder[0]||!e&&13!=d?a.contains(B.$root[0],f)&&13==d&&(c.preventDefault(),f.click()):(c.preventDefault(),e?b._.trigger(B.component.key.go,B,[b._.trigger(e)]):B.$root.find("."+y.highlighted).hasClass(y.disabled)||(B.set("select",B.component.item.highlight),x.closeOnSelect&&B.close(!0)))})),B.trigger("open"))},close:function(a){return a&&(x.editable?f.focus():(B.$holder.off("focus.toOpen").focus(),setTimeout(function(){B.$holder.on("focus.toOpen",t)},0))),z.removeClass(y.active),e(f,"expanded",!1),setTimeout(function(){B.$root.removeClass(y.opened+" "+y.focused),e(B.$root[0],"hidden",!0)},0),w.open?(w.open=!1,v&&k.css("overflow","").css("padding-right","-="+d()),j.off("."+w.id),B.trigger("close")):B},clear:function(a){return B.set("clear",null,a)},set:function(b,c,d){var e,f,g=a.isPlainObject(b),h=g?b:{};if(d=g&&a.isPlainObject(c)?c:d||{},b){g||(h[b]=c);for(e in h)f=h[e],e in B.component.item&&(void 0===f&&(f=null),B.component.set(e,f,d)),("select"==e||"clear"==e)&&z.val("clear"==e?"":B.get(e,x.format)).trigger("change");B.render()}return d.muted?B:B.trigger("set",h)},get:function(a,c){if(a=a||"value",null!=w[a])return w[a];if("valueSubmit"==a){if(B._hidden)return B._hidden.value;a="value"}if("value"==a)return f.value;if(a in B.component.item){if("string"==typeof c){var d=B.component.get(a);return d?b._.trigger(B.component.formats.toString,B.component,[c,d]):""}return B.component.get(a)}},on:function(b,c,d){var e,f,g=a.isPlainObject(b),h=g?b:{};if(b){g||(h[b]=c);for(e in h)f=h[e],d&&(e="_"+e),w.methods[e]=w.methods[e]||[],w.methods[e].push(f)}return B},off:function(){var a,b,c=arguments;for(a=0,namesCount=c.length;a<namesCount;a+=1)b=c[a],b in w.methods&&delete w.methods[b];return B},trigger:function(a,c){var d=function(a){var d=w.methods[a];d&&d.map(function(a){b._.trigger(a,B,[c])})};return d("_"+a),d(a),B}};return new A}function c(a){var b,c="position";return a.currentStyle?b=a.currentStyle[c]:window.getComputedStyle&&(b=getComputedStyle(a)[c]),"fixed"==b}function d(){if(k.height()<=i.height())return 0;var b=a('<div style="visibility:hidden;width:100px" />').appendTo("body"),c=b[0].offsetWidth;b.css("overflow","scroll");var d=a('<div style="width:100%" />').appendTo(b),e=d[0].offsetWidth;return b.remove(),c-e}function e(b,c,d){if(a.isPlainObject(c))for(var e in c)f(b,e,c[e]);else f(b,c,d)}function f(a,b,c){a.setAttribute(("role"==b?"":"aria-")+b,c)}function g(b,c){a.isPlainObject(b)||(b={attribute:c}),c="";for(var d in b){var e=("role"==d?"":"aria-")+d,f=b[d];c+=null==f?"":e+'="'+b[d]+'"'}return c}function h(){try{return document.activeElement}catch(a){}}var i=a(window),j=a(document),k=a(document.documentElement),l=null!=document.body.style.transition;return b.klasses=function(a){return a=a||"picker",{picker:a,opened:a+"--opened",focused:a+"--focused",input:a+"__input",active:a+"__input--active",target:a+"__input--target",holder:a+"__holder",frame:a+"__frame",wrap:a+"__wrap",box:a+"__box"}},b._={group:function(a){for(var c,d="",e=b._.trigger(a.min,a);e<=b._.trigger(a.max,a,[e]);e+=a.i)c=b._.trigger(a.item,a,[e]),d+=b._.node(a.node,c[0],c[1],c[2]);return d},node:function(b,c,d,e){return c?(c=a.isArray(c)?c.join(""):c,d=d?' class="'+d+'"':"",e=e?" "+e:"","<"+b+d+e+">"+c+"</"+b+">"):""},lead:function(a){return(10>a?"0":"")+a},trigger:function(a,b,c){return"function"==typeof a?a.apply(b,c||[]):a},digits:function(a){return/\d/.test(a[1])?2:1},isDate:function(a){return{}.toString.call(a).indexOf("Date")>-1&&this.isInteger(a.getDate())},isInteger:function(a){return{}.toString.call(a).indexOf("Number")>-1&&a%1===0},ariaAttr:g},b.extend=function(c,d){a.fn[c]=function(e,f){var g=this.data(c);return"picker"==e?g:g&&"string"==typeof e?b._.trigger(g[e],g,[f]):this.each(function(){var f=a(this);f.data(c)||new b(this,c,d,e)})},a.fn[c].defaults=d.defaults},b});!function(a){"function"==typeof define&&define.amd?define("lib/pickadate.min",["picker","jquery"],a):"object"==typeof exports?module.exports=a(require("./picker.js"),require("jquery")):a(Picker,jQuery)}(function(a,b){function c(a,b){var c=this,d=a.$node[0],e=d.value,f=a.$node.data("value"),g=f||e,h=f?b.formatSubmit:b.format,i=function(){return d.currentStyle?"rtl"==d.currentStyle.direction:"rtl"==getComputedStyle(a.$root[0]).direction};c.settings=b,c.$node=a.$node,c.queue={min:"measure create",max:"measure create",now:"now create",select:"parse create validate",highlight:"parse navigate create validate",view:"parse create validate viewset",disable:"deactivate",enable:"activate"},c.item={},c.item.clear=null,c.item.disable=(b.disable||[]).slice(0),c.item.enable=-function(a){return a[0]===!0?a.shift():-1}(c.item.disable),c.set("min",b.min).set("max",b.max).set("now"),g?c.set("select",g,{format:h,defaultValue:!0}):c.set("select",null).set("highlight",c.item.now),c.key={40:7,38:-7,39:function(){return i()?-1:1},37:function(){return i()?1:-1},go:function(a){var b=c.item.highlight,d=new Date(b.year,b.month,b.date+a);c.set("highlight",d,{interval:a}),this.render()}},a.on("render",function(){a.$root.find("."+b.klass.selectMonth).on("change",function(){var c=this.value;c&&(a.set("highlight",[a.get("view").year,c,a.get("highlight").date]),a.$root.find("."+b.klass.selectMonth).trigger("focus"))}),a.$root.find("."+b.klass.selectYear).on("change",function(){var c=this.value;c&&(a.set("highlight",[c,a.get("view").month,a.get("highlight").date]),a.$root.find("."+b.klass.selectYear).trigger("focus"))})},1).on("open",function(){var d="";c.disabled(c.get("now"))&&(d=":not(."+b.klass.buttonToday+")"),a.$root.find("button"+d+", select").attr("disabled",!1)},1).on("close",function(){a.$root.find("button, select").attr("disabled",!0)},1)}var d=7,e=6,f=a._;c.prototype.set=function(a,b,c){var d=this,e=d.item;return null===b?("clear"==a&&(a="select"),e[a]=b,d):(e["enable"==a?"disable":"flip"==a?"enable":a]=d.queue[a].split(" ").map(function(e){return b=d[e](a,b,c)}).pop(),"select"==a?d.set("highlight",e.select,c):"highlight"==a?d.set("view",e.highlight,c):a.match(/^(flip|min|max|disable|enable)$/)&&(e.select&&d.disabled(e.select)&&d.set("select",e.select,c),e.highlight&&d.disabled(e.highlight)&&d.set("highlight",e.highlight,c)),d)},c.prototype.get=function(a){return this.item[a]},c.prototype.create=function(a,c,d){var e,g=this;return c=void 0===c?a:c,c==-1/0||1/0==c?e=c:b.isPlainObject(c)&&f.isInteger(c.pick)?c=c.obj:b.isArray(c)?(c=new Date(c[0],c[1],c[2]),c=f.isDate(c)?c:g.create().obj):c=f.isInteger(c)||f.isDate(c)?g.normalize(new Date(c),d):g.now(a,c,d),{year:e||c.getFullYear(),month:e||c.getMonth(),date:e||c.getDate(),day:e||c.getDay(),obj:e||c,pick:e||c.getTime()}},c.prototype.createRange=function(a,c){var d=this,e=function(a){return a===!0||b.isArray(a)||f.isDate(a)?d.create(a):a};return f.isInteger(a)||(a=e(a)),f.isInteger(c)||(c=e(c)),f.isInteger(a)&&b.isPlainObject(c)?a=[c.year,c.month,c.date+a]:f.isInteger(c)&&b.isPlainObject(a)&&(c=[a.year,a.month,a.date+c]),{from:e(a),to:e(c)}},c.prototype.withinRange=function(a,b){return a=this.createRange(a.from,a.to),b.pick>=a.from.pick&&b.pick<=a.to.pick},c.prototype.overlapRanges=function(a,b){var c=this;return a=c.createRange(a.from,a.to),b=c.createRange(b.from,b.to),c.withinRange(a,b.from)||c.withinRange(a,b.to)||c.withinRange(b,a.from)||c.withinRange(b,a.to)
},c.prototype.now=function(a,b,c){return b=new Date,c&&c.rel&&b.setDate(b.getDate()+c.rel),this.normalize(b,c)},c.prototype.navigate=function(a,c,d){var e,f,g,h,i=b.isArray(c),j=b.isPlainObject(c),k=this.item.view;if(i||j){for(j?(f=c.year,g=c.month,h=c.date):(f=+c[0],g=+c[1],h=+c[2]),d&&d.nav&&k&&k.month!==g&&(f=k.year,g=k.month),e=new Date(f,g+(d&&d.nav?d.nav:0),1),f=e.getFullYear(),g=e.getMonth();new Date(f,g,h).getMonth()!==g;)h-=1;c=[f,g,h]}return c},c.prototype.normalize=function(a){return a.setHours(0,0,0,0),a},c.prototype.measure=function(a,b){var c=this;return b?"string"==typeof b?b=c.parse(a,b):f.isInteger(b)&&(b=c.now(a,b,{rel:b})):b="min"==a?-1/0:1/0,b},c.prototype.viewset=function(a,b){return this.create([b.year,b.month,1])},c.prototype.validate=function(a,c,d){var e,g,h,i,j=this,k=c,l=d&&d.interval?d.interval:1,m=-1===j.item.enable,n=j.item.min,o=j.item.max,p=m&&j.item.disable.filter(function(a){if(b.isArray(a)){var d=j.create(a).pick;d<c.pick?e=!0:d>c.pick&&(g=!0)}return f.isInteger(a)}).length;if((!d||!d.nav&&!d.defaultValue)&&(!m&&j.disabled(c)||m&&j.disabled(c)&&(p||e||g)||!m&&(c.pick<=n.pick||c.pick>=o.pick)))for(m&&!p&&(!g&&l>0||!e&&0>l)&&(l*=-1);j.disabled(c)&&(Math.abs(l)>1&&(c.month<k.month||c.month>k.month)&&(c=k,l=l>0?1:-1),c.pick<=n.pick?(h=!0,l=1,c=j.create([n.year,n.month,n.date+(c.pick===n.pick?0:-1)])):c.pick>=o.pick&&(i=!0,l=-1,c=j.create([o.year,o.month,o.date+(c.pick===o.pick?0:1)])),!h||!i);)c=j.create([c.year,c.month,c.date+l]);return c},c.prototype.disabled=function(a){var c=this,d=c.item.disable.filter(function(d){return f.isInteger(d)?a.day===(c.settings.firstDay?d:d-1)%7:b.isArray(d)||f.isDate(d)?a.pick===c.create(d).pick:b.isPlainObject(d)?c.withinRange(d,a):void 0});return d=d.length&&!d.filter(function(a){return b.isArray(a)&&"inverted"==a[3]||b.isPlainObject(a)&&a.inverted}).length,-1===c.item.enable?!d:d||a.pick<c.item.min.pick||a.pick>c.item.max.pick},c.prototype.parse=function(a,b,c){var d=this,e={};return b&&"string"==typeof b?(c&&c.format||(c=c||{},c.format=d.settings.format),d.formats.toArray(c.format).map(function(a){var c=d.formats[a],g=c?f.trigger(c,d,[b,e]):a.replace(/^!/,"").length;c&&(e[a]=b.substr(0,g)),b=b.substr(g)}),[e.yyyy||e.yy,+(e.mm||e.m)-1,e.dd||e.d]):b},c.prototype.formats=function(){function a(a,b,c){var d=a.match(/[^\x00-\x7F]+|\w+/)[0];return c.mm||c.m||(c.m=b.indexOf(d)+1),d.length}function b(a){return a.match(/\w+/)[0].length}return{d:function(a,b){return a?f.digits(a):b.date},dd:function(a,b){return a?2:f.lead(b.date)},ddd:function(a,c){return a?b(a):this.settings.weekdaysShort[c.day]},dddd:function(a,c){return a?b(a):this.settings.weekdaysFull[c.day]},m:function(a,b){return a?f.digits(a):b.month+1},mm:function(a,b){return a?2:f.lead(b.month+1)},mmm:function(b,c){var d=this.settings.monthsShort;return b?a(b,d,c):d[c.month]},mmmm:function(b,c){var d=this.settings.monthsFull;return b?a(b,d,c):d[c.month]},yy:function(a,b){return a?2:(""+b.year).slice(2)},yyyy:function(a,b){return a?4:b.year},toArray:function(a){return a.split(/(d{1,4}|m{1,4}|y{4}|yy|!.)/g)},toString:function(a,b){var c=this;return c.formats.toArray(a).map(function(a){return f.trigger(c.formats[a],c,[0,b])||a.replace(/^!/,"")}).join("")}}}(),c.prototype.isDateExact=function(a,c){var d=this;return f.isInteger(a)&&f.isInteger(c)||"boolean"==typeof a&&"boolean"==typeof c?a===c:(f.isDate(a)||b.isArray(a))&&(f.isDate(c)||b.isArray(c))?d.create(a).pick===d.create(c).pick:b.isPlainObject(a)&&b.isPlainObject(c)?d.isDateExact(a.from,c.from)&&d.isDateExact(a.to,c.to):!1},c.prototype.isDateOverlap=function(a,c){var d=this,e=d.settings.firstDay?1:0;return f.isInteger(a)&&(f.isDate(c)||b.isArray(c))?(a=a%7+e,a===d.create(c).day+1):f.isInteger(c)&&(f.isDate(a)||b.isArray(a))?(c=c%7+e,c===d.create(a).day+1):b.isPlainObject(a)&&b.isPlainObject(c)?d.overlapRanges(a,c):!1},c.prototype.flipEnable=function(a){var b=this.item;b.enable=a||(-1==b.enable?1:-1)},c.prototype.deactivate=function(a,c){var d=this,e=d.item.disable.slice(0);return"flip"==c?d.flipEnable():c===!1?(d.flipEnable(1),e=[]):c===!0?(d.flipEnable(-1),e=[]):c.map(function(a){for(var c,g=0;g<e.length;g+=1)if(d.isDateExact(a,e[g])){c=!0;break}c||(f.isInteger(a)||f.isDate(a)||b.isArray(a)||b.isPlainObject(a)&&a.from&&a.to)&&e.push(a)}),e},c.prototype.activate=function(a,c){var d=this,e=d.item.disable,g=e.length;return"flip"==c?d.flipEnable():c===!0?(d.flipEnable(1),e=[]):c===!1?(d.flipEnable(-1),e=[]):c.map(function(a){var c,h,i,j;for(i=0;g>i;i+=1){if(h=e[i],d.isDateExact(h,a)){c=e[i]=null,j=!0;break}if(d.isDateOverlap(h,a)){b.isPlainObject(a)?(a.inverted=!0,c=a):b.isArray(a)?(c=a,c[3]||c.push("inverted")):f.isDate(a)&&(c=[a.getFullYear(),a.getMonth(),a.getDate(),"inverted"]);break}}if(c)for(i=0;g>i;i+=1)if(d.isDateExact(e[i],a)){e[i]=null;break}if(j)for(i=0;g>i;i+=1)if(d.isDateOverlap(e[i],a)){e[i]=null;break}c&&e.push(c)}),e.filter(function(a){return null!=a})},c.prototype.nodes=function(a){var b=this,c=b.settings,g=b.item,h=g.now,i=g.select,j=g.highlight,k=g.view,l=g.disable,m=g.min,n=g.max,o=function(a,b){return c.firstDay&&(a.push(a.shift()),b.push(b.shift())),f.node("thead",f.node("tr",f.group({min:0,max:d-1,i:1,node:"th",item:function(d){return[a[d],c.klass.weekdays,'scope=col title="'+b[d]+'"']}})))}((c.showWeekdaysFull?c.weekdaysFull:c.weekdaysShort).slice(0),c.weekdaysFull.slice(0)),p=function(a){return f.node("div"," ",c.klass["nav"+(a?"Next":"Prev")]+(a&&k.year>=n.year&&k.month>=n.month||!a&&k.year<=m.year&&k.month<=m.month?" "+c.klass.navDisabled:""),"data-nav="+(a||-1)+" "+f.ariaAttr({role:"button",controls:b.$node[0].id+"_table"})+' title="'+(a?c.labelMonthNext:c.labelMonthPrev)+'"')},q=function(){var d=c.showMonthsShort?c.monthsShort:c.monthsFull;return c.selectMonths?f.node("select",f.group({min:0,max:11,i:1,node:"option",item:function(a){return[d[a],0,"value="+a+(k.month==a?" selected":"")+(k.year==m.year&&a<m.month||k.year==n.year&&a>n.month?" disabled":"")]}}),c.klass.selectMonth,(a?"":"disabled")+" "+f.ariaAttr({controls:b.$node[0].id+"_table"})+' title="'+c.labelMonthSelect+'"'):f.node("div",d[k.month],c.klass.month)},r=function(){var d=k.year,e=c.selectYears===!0?5:~~(c.selectYears/2);if(e){var g=m.year,h=n.year,i=d-e,j=d+e;if(g>i&&(j+=g-i,i=g),j>h){var l=i-g,o=j-h;i-=l>o?o:l,j=h}return f.node("select",f.group({min:i,max:j,i:1,node:"option",item:function(a){return[a,0,"value="+a+(d==a?" selected":"")]}}),c.klass.selectYear,(a?"":"disabled")+" "+f.ariaAttr({controls:b.$node[0].id+"_table"})+' title="'+c.labelYearSelect+'"')}return f.node("div",d,c.klass.year)};return f.node("div",(c.selectYears?r()+q():q()+r())+p()+p(1),c.klass.header)+f.node("table",o+f.node("tbody",f.group({min:0,max:e-1,i:1,node:"tr",item:function(a){var e=c.firstDay&&0===b.create([k.year,k.month,1]).day?-7:0;return[f.group({min:d*a-k.day+e+1,max:function(){return this.min+d-1},i:1,node:"td",item:function(a){a=b.create([k.year,k.month,a+(c.firstDay?1:0)]);var d=i&&i.pick==a.pick,e=j&&j.pick==a.pick,g=l&&b.disabled(a)||a.pick<m.pick||a.pick>n.pick,o=f.trigger(b.formats.toString,b,[c.format,a]);return[f.node("div",a.date,function(b){return b.push(k.month==a.month?c.klass.infocus:c.klass.outfocus),h.pick==a.pick&&b.push(c.klass.now),d&&b.push(c.klass.selected),e&&b.push(c.klass.highlighted),g&&b.push(c.klass.disabled),b.join(" ")}([c.klass.day]),"data-pick="+a.pick+" "+f.ariaAttr({role:"gridcell",label:o,selected:d&&b.$node.val()===o?!0:null,activedescendant:e?!0:null,disabled:g?!0:null})),"",f.ariaAttr({role:"presentation"})]}})]}})),c.klass.table,'id="'+b.$node[0].id+'_table" '+f.ariaAttr({role:"grid",controls:b.$node[0].id,readonly:!0}))+f.node("div",f.node("button",c.today,c.klass.buttonToday,"type=button data-pick="+h.pick+(a&&!b.disabled(h)?"":" disabled")+" "+f.ariaAttr({controls:b.$node[0].id}))+f.node("button",c.clear,c.klass.buttonClear,"type=button data-clear=1"+(a?"":" disabled")+" "+f.ariaAttr({controls:b.$node[0].id}))+f.node("button",c.close,c.klass.buttonClose,"type=button data-close=true "+(a?"":" disabled")+" "+f.ariaAttr({controls:b.$node[0].id})),c.klass.footer)},c.defaults=function(a){return{labelMonthNext:"Next month",labelMonthPrev:"Previous month",labelMonthSelect:"Select a month",labelYearSelect:"Select a year",monthsFull:["January","February","March","April","May","June","July","August","September","October","November","December"],monthsShort:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],weekdaysFull:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],weekdaysShort:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],today:"Today",clear:"Clear",close:"Close",closeOnSelect:!0,closeOnClear:!0,format:"d mmmm, yyyy",klass:{table:a+"table",header:a+"header",navPrev:a+"nav--prev",navNext:a+"nav--next",navDisabled:a+"nav--disabled",month:a+"month",year:a+"year",selectMonth:a+"select--month",selectYear:a+"select--year",weekdays:a+"weekday",day:a+"day",disabled:a+"day--disabled",selected:a+"day--selected",highlighted:a+"day--highlighted",now:a+"day--today",infocus:a+"day--infocus",outfocus:a+"day--outfocus",footer:a+"footer",buttonClear:a+"button--clear",buttonToday:a+"button--today",buttonClose:a+"button--close"}}}(a.klasses().picker+"__"),a.extend("pickadate",c)});define("native",["ext/underscore","lib/pickadate.min"],function(_,pickadate){var $=jQuery;var $root=$("#clinked-portal");var _native={thirdPartySignin:true,popupPreview:true,searchBarAdjust:0,navigate:function(hash){Backbone.history.loadUrl(hash);window.localStorage.setItem("native_location",hash)},height:function(){return $root.height()},width:function(){return $root.width()},resumeAt:function(callback){callback(window.localStorage.getItem("native_location"))},preview:function(link){$(".loader").addClass("hidden");var $iframe=$("<iframe>").css({margin:"0 auto",display:"block",height:"600px"}).attr("src",link);$(".modal-dialog").css("width","800px");$(".modal-title").html("Document Preview");$(".modal-body").html($iframe);$(".modal").modal("show");$(".modal-dialog").css("margin-left",function(){return($(window).width()-$(this).width())/2})},setHeader:function(options){var message=_.pick(options,"title","nosearch");if(options.back){message.back=_.pick(options.back,"text","link")}if(options.action){message.action=_.pick(options.action,"text","link","target")}handleHeader(message)},list:true,datepicker:function($el){$(".date",$el).pickadate({today:"",klass:{buttonClear:"btn",buttonClose:"btn"},onSet:function(context){var $dueTime=$(".time",$el);if(context.select){$dueTime.attr("disabled",false)}else{$dueTime.attr("disabled",true).val("")}}})}};var createLink=function(text,data){return $("<a>").attr("href","javascript:void(0);").html(text).data("target",data)};var $header=$(">.header",$root).removeClass("hidden").on("click","a",function(e){e.preventDefault();var data=$(this).data("target");if(data){if(data.target){$(data.target).trigger("action")}else{_native.navigate(data.link)}}else{$buttons.addClass("hidden");$search.removeClass("hidden").focus()}});var $buttons=$("span",$header);var $search=$("input",$header).keyup(function(e){if(e.keyCode==27){$buttons.removeClass("hidden");$search.addClass("hidden")}else if(e.keyCode==13){_native.navigate("#search/"+encodeURIComponent($search.val()));$buttons.removeClass("hidden");$search.addClass("hidden").val("")}});var handleHeader=function(options){var $left=$(".left",$header).empty();if(options.back){$left.append(createLink(options.back.text,options.back))}$left.append("<strong>"+options.title+"</strong>");var $action=$(".right",$header).empty();if(options.action){$action.append(createLink(options.action.text,options.action))}if(!options.nosearch){$("<a>").attr("href","javascript:void(0);").addClass("glyphicon glyphicon-search").appendTo($action)}};$root.on("click","a",function(e){if(this.href!="javascript:void(0)"&&!_.isBlank(this.hash)){e.preventDefault();_native.navigate(this.hash)}});$(">.wrapper",$root).data("marginals",1).height(_native.height()-44);return _native});define("messages",["ext/underscore"],function(_){var messages={m_last_updated:"Last updated",m_said:"said",m_comments:"Comments",m_comment:"Comment",m_new:"New",m_reply:"Reply",m_back:"Back",m_cancel:"Cancel",m_file:"File",m_page:"Page",m_discussion:"Discussion",m_event:"Event",m_task:"Task",m_edit:"Edit",m_post:"Post",m_save:"Save",m_preview:"Preview",m_download:"Download",m_search:"Search",m_on:"On",m_by:"by",m_all_day:"All day",m_to:"to",m_at:"at",m_version:"Version",m_size:"Size",m_today:"Today",m_tomorrow:"Tomorrow",m_assign:"Assign",m_mention:"Mention",m_mention_title:"Select A Person",m_make_comment:"Make A Comment",m_create_reply:"Create A Reply",m_create_discussion:"Create A Discussion",m_discussion_topic:"Enter Discussion Topic",m_discussion_first:"Enter First Comment",m_create_task:"Create A Task",m_update_task:"Update Task",m_task_title:"Enter Task Title",m_task_description:"Enter Task Description",m_task_duedate:"Select Due Date and Time, if applicable",m_task_status_NOT_STARTED:"Not Started",m_task_status_IN_PROGRESS:"In Progress",m_task_status_DEFERRED:"Deferred",m_task_status_WAITING:"Waiting",m_task_status_COMPLETED:"Complete",m_create_event:"Create An Event",m_update_event:"Update Event",m_event_title:"Enter Event Title",m_event_location:"Enter Event Location",m_event_startdate:"Select Start Date and Time, if applicable",m_event_enddate:"Select End Date and Time, if applicable",m_event_description:"Enter Event Description",m_actions_filter:"Filter",m_actions_sort:"Sort",m_actions_upload:"Upload",m_btn_context:"Groups",m_btn_updates:"Activity",m_btn_files:"Files",m_btn_pages:"Pages",m_btn_discussions:"Disc..",m_btn_events:"Events",m_btn_tasks:"Tasks",m_context_select_header:"Select group or account",m_context_signout:"Sign out",m_context_dashboard:"Dashboard",m_context_personal:"Personal",m_page_loading:"Loading..",m_updates_nothing:"Nothing yet..",m_files_nothing:"No files",m_pages_nothing:"No Pages",m_discussions_nothing:"No Discussions",m_events_nothing:"No Events",m_tasks_nothing:"No Tasks",m_comments_nothing:"No Comments",m_search_nothing:"No Results",m_search_suggestions:"Did you mean",m_type_here:"Start typing here",m_file_uploader:"Uploaded by",m_file_preview_waiting:"Preview Generating ..",m_file_preview_failed:"No Preview Available",m_file_upload_header:"Upload A File",m_file_upload_failure:"Failed",m_file_upload_success:"Complete!",m_file_upload_add:"Add Files...",m_file_upload_start:"Start Upload",m_file_upload_cancel:"Cancel",m_file_upload_upload:"Upload",m_file_upload_retry:"Retry",m_file_upload_stop:"Stop",m_file_upload_remove:"Remove",m_file_native_header:"Select A File",m_file_native_failure:"There has been an error. Click to retry.",m_file_native_success:" has been uploaded",m_no_groups:"You do not have any groups",m_actions_sort_header:"Choose Sorting Option",m_actions_sort_latest:"Sort by most recent",m_actions_sort_name:"Sort by name",m_update_unknown:"Unknown Message",m_tasks_actions_header:"Choose Task Filter",m_tasks_actions_tbc:"Uncompleted",m_tasks_actions_all:"All Tasks",m_tasks_overdue:"Overdue",m_tasks_no_due_date:"No due date",m_tasks_requested_by:"Requested by",m_signin_title:"Sign in to Clinked",m_signin_domain:"Private Cloud Users Click Here",m_signin_username:"Enter username or email",m_signin_password:"Enter password",m_signin_signin:"Sign in",m_signin_linkedin:"Sign in using LinkedIn",m_signin_google:"Sign in using Google",m_signin_forgotten:"Forgotten Password?",m_signin_invalid:"Invalid username or password. Please try again.",m_signup_header:"Sign up to Clinked",m_signup_signup:"Sign up",m_reset_header:"Reset your Password",m_reset_reset:"Reset",m_input_signup:"Sign up",m_input_name:"Enter full name",m_input_error_name:"Please provide your full name",m_input_username:"Enter username",m_input_error_username:"Provide username",m_input_error_taken:"Username is taken, please choose again",m_input_password:"Enter password",m_input_error_password:"Provide password",m_input_error_minimum_6:"Minimum password length is 6 characters",m_input_confirm:"Re-enter password",m_input_error_mismatch:"Passwords do not match",m_input_error_confirm:"Confirm your password",m_input_telephone:"Enter phone number",m_input_organisation:"Enter organisation name",m_error_title:"Error",m_error_unexpected:"An unexpected error has occurred.",m_error_not_found:"The requested resource cannot be found.",m_error_dashboard:"Go To Dashboard",m_error_invite:"This invitation has not been recognised.",m_error_startdate:"A start date must be given.",m_error_enddate:"An end date must be given.",m_error_time:"The time should be between 00:00 and 23:59.",m_error_date_range:'The date must be after "{0}"',m_domain_title:"Change Domain",m_domain_value:"Enter new domain",m_domain_change:"Change",m_domain_reset:"Reset",m_forgotten_title:"Forgotten Password Request",m_forgotten_email:"Please enter your email address",m_forgotten_request:"Request",m_forgotten_request_sent:"Password reset instructions have been sent to your email address.",m_forgotten_request_fail:"Sorry, there is no account registered with that email address.",m_list_pull_to_refresh:"Pull and release to refresh",m_event_location:"Location",m_event_places:"Places Taken",m_event_of:"out of",m_event_DECLINE:"Not attending",m_event_MAYBE:"Maybe attending",m_event_ACCEPT:"Attending",m_task_due:"Due",m_task_no_due:"No due date",m_task_progress:"Progress",m_task_REJECT:"Reject",m_task_ACCEPT:"Accept",m_request_event_NONE:"Awaiting reply",m_request_event_DECLINE:"Not attending",m_request_event_MAYBE:"Maybe attending",m_request_event_ACCEPT:"Attending",m_request_task_NONE:"Awaiting reply",m_request_task_REJECT:"Rejected",m_request_task_ACCEPT:"Accepted",m_message_placeholder:"Enter message","update.organisation.create":"{0} created account {1}","update.organisation.disable":"{0} disabled account {1}","update.organisation.enabled":"{0} enabled account {1}","update.user.private":"{0} said","update.user.profile":"{0} said to {4}","update.organisation.private":"{0} in {1} said","update.organisation.join":"{0} joined {1}","update.space.private":"{0} in {2} said","update.following.start":"{0} started following {3} in {2}","update.following.stop":"{0} stopped following {3} in {2}","update.discussion.create":"{0} created new discussion {3} in {2}","update.discussion.update":"{0} updated discussion {3} in {2}","update.discussion.createreply":"{0} replied to discussion {3} in {2}","update.space.create":"{0} created a new group {2}","update.space.join":"{0} joined {2} group","update.trash.remove":"{0} deleted group {2}","update.trash.restore":"{0} restored group {2}","update.trash.delete":"{0} deleted group {2} from {1} trash","update.filestore.create":"{0} uploaded file {3} in {2}","update.filestore.update":"{0} updated file {3} in {2}","update.filestore.folder":"{0} created folder {3} in {2}","update.filestore.rename":'{0} renamed folder "{5}" to {3} in {2}',"update.filestore.move":'{0} moved {3} to "{5}" in {2}',"update.filestore.copy":'{0} copied {3} to "{5}" in {2}',"update.filestore.approval.accept":"{0} approved file {3} in {2}","update.filestore.approval.reject":"{0} rejected file {3} in {2} ","update.event.create":"{0} created event {3} in {2}","update.event.createandassign":"{0} created event {3} in {2}","update.event.update":"{0} updated event {3} in {2}","update.event.updateandassign":"{0} updated event {3} in {2}","update.task.create":"{0} created task {3} in {2}","update.task.createandassign":"{0} created task {3} in {2}","update.task.update":"{0} updated task {3} in {2}","update.task.updateandassign":"{0} updated task {3} in {2}","update.task.complete":"{0} completed task {3} in {2}","update.task.reopen":"{0} marked task {3} as incomplete in {2}","update.attachment.create":"{0} attached file {5} to {3} in {2}","update.attachment.update":"{0} updated attachment {5} in {3}","update.comment.create":"{0} commented on {3} in {2}","update.comment.delete":"{0} deleted comment from {3} in {2}","update.comment.reply":"{0} replied on {3} in {2}","update.page.create":"{0} created new page {3} in {2}","update.page.update":"{0} updated page {3} in {2}","update.page.restore":"{0} restored page {3} version {5} in {2}","update.page.renameandupdate":"{0} moved page {5} to {3} in {2}","update.space.trash.filerecord.create":"{0} deleted file {3} in {2}","update.space.trash.filerecord.attemptRestore":"{0} restored file {3} in {2}","update.space.trash.filerecord.delete":"{0} permanently deleted file {3} from {2} trash","update.space.trash.page.create":"{0} deleted page {3} in {2}","update.space.trash.page.attemptRestore":"{0} restored page {3} in {2}","update.space.trash.page.delete":"{0} permanently deleted page {3} from {2} trash","update.space.trash.discussion.create":"{0} deleted discussion {3} in {2}","update.space.trash.discussion.attemptRestore":"{0} restored discussion {3} in {2}","update.space.trash.discussion.delete":"{0} permanently deleted discussion {3} from {2} trash","update.space.trash.event.create":"{0} deleted event {3} in {2}","update.space.trash.event.attemptRestore":"{0} restored event {3} in {2}","update.space.trash.event.delete":"{0} permanently deleted event {3} from {2} trash","update.space.trash.task.create":"{0} deleted task {3} in {2}","update.space.trash.task.attemptRestore":"{0} restored task {3} in {2}","update.space.trash.task.delete":"{0} permanently deleted task {3} from {2} trash","update.space.rename":"{0} renamed group {5} to {2}","update.space.move":"{0} moved group {2} from {3}","update.space.remove":"{0} removed group {2}","update.space.restore":"{0} restored group {2} from trash","update.attachment.create.notify":"{0} attached the file {2} to {1} ","update.attachment.update.notify":"{0} updated the attachment {2} to {1}","update.discussion.createreply.notify":"{0} replied to discussion {1}","update.event.update.notify":"{0} edited the event {1}","update.event.updateandassign.notify":"{0} edited the event {1}","update.filestore.update.notify":"{0} edited the file {1}","update.filestore.folder.notify":"{0} created folder {1}","update.filestore.create.notify":"{0} created a new file {1}","update.page.update.notify":"{0} changed the page {1} ","update.page.renameandupdate.notify":"{0} changed the page {1}","update.space.trash.discussion.create.notify":"{0} deleted the discussion {1}","update.space.trash.event.create.notify":"{0} deleted the event {1}","update.space.trash.filerecord.create.notify":"{0} deleted the file {1}","update.space.trash.page.create.notify":"{0} deleted the page {1}","update.space.trash.task.create.notify":"{0} deleted the task {1}","update.space.trash.discussion.attemptRestore.notify":"{0} restored the discussion {1}","update.space.trash.event.attemptRestore.notify":"{0} restored the event {1}","update.space.trash.filerecord.attemptRestore.notify":"{0} restored the file {1}","update.space.trash.page.attemptRestore.notify":"{0} restored the page {1}","update.space.trash.task.attemptRestore.notify":"{0} restored the task {1}","update.task.complete.notify":"{0} completed the task {1}","update.task.reopen.notify":"{0} marked the task {1} as uncompleted ","update.task.update.notify":"{0} changed the task {1}","update.task.updateandassign.notify":"{0} changed the task {1}","update.comment.create.notify":"{0} commented on {1}","update.comment.reply.notify":"{0} commented on {1}"};var regional={};regional["tr"]={"update.user.private":"{0} söyledi","update.user.profile":"{0} {4} 'e söyledi","update.organisation.private":"{0} {1}'da söyledi","update.organisation.join":"{0} {1}'e katıldı","update.space.private":"{0} {2} grubunda söyledi","update.discussion.create":"{0} {2} grubunda {3} tartışmasını yarattı","update.discussion.update":"{0} {2} grubunda {3} tartışmasını güncelledi","update.discussion.createreply":"{0} {2} grubunda {3} tartışmasına yanıt verdi","update.space.create":"{0} {2} grubunu yarattı","update.space.join":"{0} {2} grubuna katıldı","update.trash.remove":"{0} {2} grubunu sildi","update.trash.restore":"{0} {2} grubunu geri getirdi","update.trash.delete":"{0} {2} grubunu {1} 'den sildi","update.filestore.create":"{0} {2} grubuna {3} dosyasını yükledi","update.filestore.update":"{0} {2} grubuna {3} dosyasını güncelledi","update.filestore.approval.accept":"{0} {2} grubunda {3} dosyasını onayladı","update.filestore.approval.reject":"{0} {2} grubunda {3} dosyasını reddetti ","update.event.create":"{0} {2} grubunda {3} etkinliğini yarattı","update.event.createandassign":"{0} {2} grubunda {3} etkinliğini yarattı","update.event.update":"{0} {2} grubunda {3} etkinliğini güncelledi","update.event.updateandassign":"{0} {2} grubunda {3} etkinliğini güncelledi","update.task.create":"{0} {2} grubunda {3} görevini yarattı","update.task.createandassign":"{0} {2} grubunda {3} görevini yarattı","update.task.update":"{0} {2} grubunda {3} görevini güncelledi","update.task.updateandassign":"{0} {2} grubunda {3} görevini güncelledi","update.task.complete":"{0} {2} grubunda {3} görevini tamamladı","update.task.reopen":"{0} {2} grubunda {3} görevini tamamladı","update.attachment.create":"{0} {5} dosyasını {2} grubunda {3} sayfasına ekledi ","update.attachment.update":"{0} {5} dosyasını {3}'de güncelledi","update.comment.create":"{0} {2} grubunda {3} sayfasına yorum yazdı ","update.comment.reply":"{0} {2} grubunda {3} yorumunu yanıtladı","update.page.create":"{0} {2} grubunda {3} sayfasını yarattı","update.page.update":"{0} {2} grubundaki {3} sayfasını güncelledi","update.page.restore":"{0} {2} grubundaki {3} sayfasının {5}. sürümünü geri yükledi","update.page.renameandupdate":"{0} {2} grubundaki {5} sayfasını {3} olarak değiştirdi","update.space.trash.filerecord.create":"{0} {3} dosyasını {2} grubundan sildi ","update.space.trash.filerecord.attemptRestore":"{0} {3} dosyasını {2} grubuna geri getirdi ","update.space.trash.filerecord.delete":"{0} {2} grubunda {3} dosyasını çöp kutusundan kalıcı olarak sildi","update.space.trash.page.create":"{0} {2} grubunda {3} sayfasını sildi","update.space.trash.page.attemptRestore":"{0} {2} grubunda {3} sayfasını geri getirdi ","update.space.trash.page.delete":"{0} {2} grubunda {3} sayfasını çöp kutusundan kalıcı olarak sildi","update.space.trash.discussion.create":"{0} {2} grubunda {3} tartışmasını sildi","update.space.trash.discussion.attemptRestore":"{0} {2} grubunda {3} tartışmasını geri getirdi","update.space.trash.discussion.delete":"{0} {2} grubunda {3} tartışmasını çöp kutusundan kalıcı olarak sildi","update.space.trash.event.create":"{0} {2} grubunda {3} etkinliğini sildi","update.space.trash.event.attemptRestore":"{0} {2} grubunda {3} etkinliğini geri getirdi","update.space.trash.event.delete":"{0} {2} grubunda {3} etkinliğini çöp kutusundan kalıcı olarak sildi","update.space.trash.task.create":"{0} {2} grubunda {3} görevini sildi","update.space.trash.task.attemptRestore":"{0} {2} grubunda {3} görevini geri getirdi","update.space.trash.task.delete":"{0} {2} grubunda {3} görevini çöp kutusundan kalıcı olarak sildi"};regional["ru"]={"update.user.private":"{0}сказал","update.user.profile":"{0}сказал{4}","update.organisation.private":"{0}в{1} указанном","update.organisation.join":"{0}регистрация {1}","update.space.private":"{0}в{2} указанном","update.discussion.create":"создал новую дискуссию {3} в","update.discussion.update":"обновление обсуждения {3} в {2}","update.discussion.createreply":"{0} ответил на обсуждении {3} в {2}","update.space.create":"{0} создана новая группа {2}","update.space.join":"{0} присоединился к {2} группе","update.trash.remove":"{0} удален из группы {2}","update.trash.restore":"{0} восстановлено группы {2}","update.trash.delete":"{0} удален группы {2} из {1} корзины","update.filestore.create":"{0} загруженный файл {3} в {2}","update.filestore.update":"{0} обновленный файл {3} в {2}","update.filestore.approval.accept":"утвержденный файл {3} в {2}","update.filestore.approval.reject":"{0} отклонил файл {3} в {2} ","update.event.create":"{0} создано событие {3} в {2}","update.event.createandassign":"{0} создано событие {3} в {2}","update.event.update":"{0} обновленно событие {3} в {2}","update.event.updateandassign":"обновленно событие {3} в {2}","update.task.create":"{0} созданной задачи {3} в {2}","update.task.createandassign":"{0} созданной задачи {3} в {2}","update.task.update":"обновленно задачи {3} в {2}","update.task.updateandassign":"обновленно задачи {3} в {2}","update.task.complete":"выполненная задача {3} в {2}","update.task.reopen":"отмечены задачи {3}, как неполное в {2}","update.attachment.create":"{0} прикрепленный файл {5} до {3} в {2}","update.attachment.update":"{0} обновленно вложение {5} в {3}","update.comment.create":"{0} прокомментировал {3} в {2}","update.comment.reply":"{0} ответил на {3} в {2}","update.page.create":"{0} создана новая страница {3} в {2}","update.page.update":"{0} обновленна страница {3} в {2}","update.page.restore":"{0} восстановлена страница {3} версии {5} в {2}","update.page.renameandupdate":"{0} переехала страница {5} в {3} в {2}","update.space.trash.filerecord.create":"{0} удаленный файл {3} в {2}","update.space.trash.filerecord.attemptRestore":"{0} восстановленный файл {3} в {2}","update.space.trash.filerecord.delete":"{0} постоянно удаляется файл {3} из {2} корзины","update.space.trash.page.create":"{0} удаленная страница {3} в {2}","update.space.trash.page.attemptRestore":"{0} восстановлена страница {3} в {2}","update.space.trash.page.delete":"{0} удалена страница {3} из {2} корзины","update.space.trash.discussion.create":"{0} удалена страница {3} из {2} корзины","update.space.trash.discussion.attemptRestore":"{0} восстановлено обсуждение {3} в {2}","update.space.trash.discussion.delete":"{0} постоянно удалено обсуждение {3} из {2} корзины","update.space.trash.event.create":"{0} удалено событие {3} в {2}","update.space.trash.event.attemptRestore":"{0} восстановлено событие {3} в {2}","update.space.trash.event.delete":"{0} постоянно удалено событие {3} из {2} корзины","update.space.trash.task.create":"удалена задача {3} в {2}","update.space.trash.task.attemptRestore":"{0} восстановлена задача {3} в {2}","update.space.trash.task.delete":"{0} постоянно удалена задача {3} из {2} корзины"};regional["it"]={"update.attachment.create":"{0} file allegati {5} di {3} in {2}","update.attachment.create.notify":"{0} ha allegato il file {2} di {1}","update.attachment.update":"{0} aggiornato file {5} di {3}","update.attachment.update.notify":"{0} aggiornato file {5} di {2}","update.comment.create":"{0} ha commentato su {3} di {2}","update.comment.create.notify":"{0} ha commentato su {1}","update.comment.delete":"{0} cancella commenti da {3} in {2}","update.comment.reply":"{0} risposte a {3} di {2}","update.comment.reply.notify":"{0} commenti su {1}","update.discussion.create":"{0} ha creato una nuova discussion {3} in {2}","update.discussion.createreply":"{0} ha risposto alla discussion {3} in {2}","update.discussion.createreply.notify":"{0} ha risposto alla discussion {1}","update.discussion.update":"{0} ha aggiornato la discussion {3} di {2}","update.event.create":"{0} ha creato l` event {3} in {2}","update.event.createandassign":"{0} {0} ha creato l` event {3} in {2}","update.event.update":"{0} event aggiornato {3} in {2}","update.event.update.notify":"{0} event modificati {1}","update.event.updateandassign":"{0} event aggiornato {3} in {2}","update.event.updateandassign.notify":"{0} event modificati {1}","update.filestore.approval.accept":"{0} file approvati {3} in {2}","update.filestore.approval.reject":"{0} file rifiutati {3} in {2}","update.filestore.copy":'{0} copiati {3} da "{5}" in {2}',"update.filestore.create":"{0} file caricati {3} in {2}","update.filestore.create.notify":"{0} nuovi file creati {3} in {2}","update.filestore.folder":"{0} cartelle create {3} in {2}","update.filestore.folder.notify":"{0} cartelle create {1}","update.filestore.move":'{0} spostato {3} da "{5}" a {2}',"update.filestore.rename":'{0} cartella rinominata "{5}" da {3} in {2}',"update.filestore.update":"{0} file caricati {3} in {2}","update.filestore.update.notify":"{0} modifca i file {1}","update.following.start":"{0} comincia a seguire {3} in {2}","update.following.stop":"{0} smette di seguire {3} in {2}","update.organisation.create":"{0} ha creato l`account {1} ","update.organisation.disable":"{0} ha disabilitato l`account {1}","update.organisation.enabled":"{0} ha abilitato l`account {1}","update.organisation.join":"{0} partecipa {1}","update.organisation.private":"{0} ha detto in {1} ","update.page.create":"{0} nuove page create {3} in {2}","update.page.renameandupdate":"{0} page spostate {5} da {3} in {2}","update.page.renameandupdate.notify":"{0} page cambiate {1}","update.page.restore":"{0} page aggiornate {3} in {2}","update.page.update":"{0} page aggiornate {3} in {2}","update.page.update.notify":"{0} page cambiate {1}","update.space.create":"{0} ha creato un nuovo gruppo {2}","update.space.join":"{0} si è unito al {2} gruppo","update.space.move":"{0} ha spostato il gruppo {2} da {3}","update.space.private":"{0} ha detto in {2}","update.space.remove":"{0} ha rimosso il gruppo {2}","update.space.rename":"{0} ha rinominato il gruppo {5} a {2}","update.space.restore":"{0} ha ripristinato il gruppo {2} dal cestino","update.space.trash.discussion.attemptRestore":"{0} ha ripristinato discussion  {3} in {2}","update.space.trash.discussion.attemptRestore.notify":"{0} ha ripristinato discussion  {1}","update.space.trash.discussion.create":"{0} ha cancellato la discussion {3} in {2}","update.space.trash.discussion.create.notify":"{0} ha cancellato la discussion {3} da {2} cestino","update.space.trash.discussion.delete":"{0} ha cancellato permanentemente la discussion {3} da {2} cestino","update.space.trash.event.attemptRestore":"{0} ha rispristinato event {3} di {2}","update.space.trash.event.attemptRestore.notify":"{0} ha ripristinato l` event {3} in {2}","update.space.trash.event.create":"{0} event ha cancellato {3} in {2}","update.space.trash.event.create.notify":"{0} ha cancellato l` event {1}","update.space.trash.event.delete":"{0} ha cancellato permanentemente event {3} da {2} cestino","update.space.trash.filerecord.attemptRestore":"{0} ha ripristinato file {3} in {2} ","update.space.trash.filerecord.attemptRestore.notify":"{0} ha ripristinato il file {1}","update.space.trash.filerecord.create":"{0} ha cancellato file {3} in {2}","update.space.trash.filerecord.create.notify":"{0} ha cancellato il file {1}","update.space.trash.filerecord.delete":"{0} ha cancellato permanentemente il/i file {3} da {2} cestino","update.space.trash.page.attemptRestore":"{0} ha ripristinato la/le page  {3} in {2}","update.space.trash.page.attemptRestore.notify":"{0} ha ripristinato la page {1}","update.space.trash.page.create":"{0} ha cancellato le page {3} in {2}","update.space.trash.page.create.notify":"{0} ha cancellato la page {1}","update.space.trash.page.delete":"{0} ha cancellato permanentemente le page {3} da {2} cestino","update.space.trash.task.attemptRestore":"{0} task ripristinato {3} in {2}","update.space.trash.task.attemptRestore.notify":"{0} ha ripristinato il compito task {1}","update.space.trash.task.create":"{0} task cancellati {3} in {2}","update.space.trash.task.create.notify":"{0} ha cancellato il compito task {1}","update.space.trash.task.delete":"{0} Cancellato permanentemente task {3} da {2}","update.task.complete":"{0} task completato {3} in {2}","update.task.complete.notify":"{0} completato il task {1}","update.task.create":"{0} task creati {3} in {2}","update.task.createandassign":"{0} task creati {3} in {2}","update.task.reopen":"{0} task segnati {3} come incompleti in {2}","update.task.reopen.notify":"{0} segnato il task come incompleto {1}","update.task.update":"{0} task aggiornati {3} in {2}","update.task.update.notify":"{0} ha cambiato il compito task {1}","update.task.updateandassign":"{0} task aggiornati {3} in {2}","update.task.updateandassign.notify":"{0} ha cambiato il compito task {1}","update.trash.delete":"{0} ha cancellato il gruppo {2} da {1} cestino","update.trash.remove":"{0} ha cancellato gruppo {2} da {1} cestino","update.trash.restore":"{0} ha cancellato gruppo {2}","update.user.private":"{0} ha detto","update.user.profile":"{0} ha detto a {4}"};
return{messages:messages,template:function(template,data){return _.template(template,_.extend({},data,messages))},setLocale:function(locale){var regionalMessages=regional[locale];if(regionalMessages){this.messages=_.extend(messages,regionalMessages)}else{this.messages=messages}}}});define("app-context",["ext/underscore","native","messages"],function(_,_native,messages){var $=jQuery;var _credentials=null;var $root=$("#clinked-portal");var _getAppUrl=function(){return $root.data("appurl")};var appContext=_.extend({version:6,defaultThumb:_getAppUrl()+"/styles/images/default_thumbnail.png",environments:{prod:["https://api-p1.clinked.com","https://app.clinked.com","https://pubsub.clinked.com"],test:["https://test-api.clinked.com","https://test-app.clinked.com","https://test-pubsub.clinked.com"],dev:["http://localhost:18080/ROOT","http://localhost.localdomain:8080/ROOT","http://localhost:2222"],ip:["http://192.168.126.12:18080/ROOT","http://192.168.126.12:8080/ROOT","http://192.168.126.12:2222"],office4twenty:["https://api.office4twenty.com","https://app.office4twenty.com","https://pubsub.office4twenty.com"]},clientId:"clinked-mobile",pageSize:25,notificationUrls:{},getAppUrl:_getAppUrl,getCredentials:function(callback){return _credentials},setCredentials:function(credentials){_credentials=credentials},removeCredentials:function(){_credentials=null},setAccessToken:function(token){if(token.expires_in){token.expires=(new Date).getTime()+token.expires_in*1e3}window.localStorage.setItem("accessToken",JSON.stringify(token));this.trigger("accessToken")},getAccessToken:function(){var json=window.localStorage.getItem("accessToken");if(json){var token=JSON.parse(json);var now=(new Date).getTime();if(!token.expires||token.expires>now){return token}}return null},removeAccessToken:function(){window.localStorage.removeItem("accessToken")},setTaskCompletedFilter:function(completed){window.localStorage.setItem("taskCompletedFilter",completed)},getTaskCompletedFilter:function(){return window.localStorage.getItem("taskCompletedFilter")=="true"},setFileSort:function(field){window.localStorage.setItem("fileSortField",field)},getFileSort:function(){var field=window.localStorage.getItem("fileSortField");return field?field:"lastModified"},setNoteSort:function(field){window.localStorage.setItem("noteSortField",field)},getNoteSort:function(){var field=window.localStorage.getItem("noteSortField");return field?field:"lastModified"},setPrinciple:function(principle){window.localStorage.setItem("me",JSON.stringify(principle));_updateLocale(principle.locale)},getPrinciple:function(){var principle=window.localStorage.getItem("me");if(principle){return JSON.parse(principle)}return null},removePrinciple:function(){window.localStorage.removeItem("me")},setDashboard:function(dashboard){window.localStorage.setItem("dashboard",dashboard)},getDashboard:function(){var dashboard=window.localStorage.getItem("dashboard");if(dashboard&&dashboard.indexOf(":@")==-1){dashboard=dashboard.replace(":",":@")}return dashboard},removeDashboard:function(){window.localStorage.removeItem("dashboard")},setEnvironment:function(environment){if(environment in this.environments){window.localStorage.setItem("environment",environment);_updateConfig()}},getEnvironment:function(){var environment=window.localStorage.getItem("environment");return environment?environment:_.keys(this.environments)[0]},resolveEndPoint:function(){return this.environments[this.getEnvironment()][0]},resolveAppEndPoint:function(){return this.environments[this.getEnvironment()][1]},resolvePubsubEndPoint:function(){return this.environments[this.getEnvironment()][2]},fullUrl:function(path){path+="?version="+this.version;var token=this.getAccessToken();if(token){path+="&access_token="+token.access_token}return this.resolveEndPoint()+path},preview:function(file,sessionNeeded){this.loading("show");if(sessionNeeded){$.get(this.fullUrl(file.url()+"session"),function(url){_native.preview(url,"text/html")})}else{_native.preview(this.fullUrl(file.url()+"preview"),file.get("contentType"),file.id+"."+file.get("versions"))}},loading:function(action){var $loader=$(".loader",$root);if(action=="show"){$loader.removeClass("hidden")}else if(action=="hide"){$loader.addClass("hidden")}},setHeader:function(options){if(options.back){options.back.text=messages.messages[options.back.code]}if(options.action){options.action.text=messages.messages[options.action.code]}_native.setHeader(options)},navigate:function(hash,force){if(window.location.hash==hash){force&&Backbone.history.loadUrl(hash)}else if(_native.navigate){_native.navigate(hash)}else{window.location.hash=hash}},addNotification:function(url){this.notificationUrls[url]=true;$(".notifications",$root).removeClass("hidden").find("span").html(_.keys(this.notificationUrls).length)}},Backbone.Events);$(".notifications",$root).off().click(function(e){e.preventDefault();var keys=_.keys(appContext.notificationUrls);var nextUrl=keys.pop();delete appContext.notificationUrls[nextUrl];appContext.navigate(nextUrl,true);var $notifications=$(".notifications",$root);if(keys.length==0){$notifications.addClass("hidden")}else{$notifications.find("span").html(keys.length)}});var _updateLocale=function(locale){messages.setLocale(locale);var timeagoStrings=$.timeago.regional[locale];if(timeagoStrings){$.timeago.settings.strings=timeagoStrings}};var principle=appContext.getPrinciple();if(principle){_updateLocale(principle.locale)}var _updateConfig=function(){$.ajax({url:appContext.fullUrl("/config"),success:function(config){_.extend(appContext,config)},error:function(){appContext.navigate("#error",true)}})};_updateConfig();return appContext});(function(a){function E(a,b,c,d){var e=c.lang();return e[a].call?e[a](c,d):e[a][b]}function F(a,b){return function(c){return K(a.call(this,c),b)}}function G(a){return function(b){var c=a.call(this,b);return c+this.lang().ordinal(c)}}function H(a,b,c){this._d=a,this._isUTC=!!b,this._a=a._a||null,this._lang=c||!1}function I(a){var b=this._data={},c=a.years||a.y||0,d=a.months||a.M||0,e=a.weeks||a.w||0,f=a.days||a.d||0,g=a.hours||a.h||0,h=a.minutes||a.m||0,i=a.seconds||a.s||0,j=a.milliseconds||a.ms||0;this._milliseconds=j+i*1e3+h*6e4+g*36e5,this._days=f+e*7,this._months=d+c*12,b.milliseconds=j%1e3,i+=J(j/1e3),b.seconds=i%60,h+=J(i/60),b.minutes=h%60,g+=J(h/60),b.hours=g%24,f+=J(g/24),f+=e*7,b.days=f%30,d+=J(f/30),b.months=d%12,c+=J(d/12),b.years=c,this._lang=!1}function J(a){return a<0?Math.ceil(a):Math.floor(a)}function K(a,b){var c=a+"";while(c.length<b)c="0"+c;return c}function L(a,b,c){var d=b._milliseconds,e=b._days,f=b._months,g;d&&a._d.setTime(+a+d*c),e&&a.date(a.date()+e*c),f&&(g=a.date(),a.date(1).month(a.month()+f*c).date(Math.min(g,a.daysInMonth())))}function M(a){return Object.prototype.toString.call(a)==="[object Array]"}function N(a,b){var c=Math.min(a.length,b.length),d=Math.abs(a.length-b.length),e=0,f;for(f=0;f<c;f++)~~a[f]!==~~b[f]&&e++;return e+d}function O(a,b,c,d){var e,f,g=[];for(e=0;e<7;e++)g[e]=a[e]=a[e]==null?e===2?1:0:a[e];return a[7]=g[7]=b,a[8]!=null&&(g[8]=a[8]),a[3]+=c||0,a[4]+=d||0,f=new Date(0),b?(f.setUTCFullYear(a[0],a[1],a[2]),f.setUTCHours(a[3],a[4],a[5],a[6])):(f.setFullYear(a[0],a[1],a[2]),f.setHours(a[3],a[4],a[5],a[6])),f._a=g,f}function P(a,c){var d,e,g=[];!c&&h&&(c=require("./lang/"+a));for(d=0;d<i.length;d++)c[i[d]]=c[i[d]]||f.en[i[d]];for(d=0;d<12;d++)e=b([2e3,d]),g[d]=new RegExp("^"+(c.months[d]||c.months(e,""))+"|^"+(c.monthsShort[d]||c.monthsShort(e,"")).replace(".",""),"i");return c.monthsParse=c.monthsParse||g,f[a]=c,c}function Q(a){var c=typeof a=="string"&&a||a&&a._lang||null;return c?f[c]||P(c):b}function R(a){return a.match(/\[.*\]/)?a.replace(/^\[|\]$/g,""):a.replace(/\\/g,"")}function S(a){var b=a.match(k),c,d;for(c=0,d=b.length;c<d;c++)D[b[c]]?b[c]=D[b[c]]:b[c]=R(b[c]);return function(e){var f="";for(c=0;c<d;c++)f+=typeof b[c].call=="function"?b[c].call(e,a):b[c];return f}}function T(a,b){function d(b){return a.lang().longDateFormat[b]||b}var c=5;while(c--&&l.test(b))b=b.replace(l,d);return A[b]||(A[b]=S(b)),A[b](a)}function U(a){switch(a){case"DDDD":return p;case"YYYY":return q;case"S":case"SS":case"SSS":case"DDD":return o;case"MMM":case"MMMM":case"dd":case"ddd":case"dddd":case"a":case"A":return r;case"Z":case"ZZ":return s;case"T":return t;case"MM":case"DD":case"YY":case"HH":case"hh":case"mm":case"ss":case"M":case"D":case"d":case"H":case"h":case"m":case"s":return n;default:return new RegExp(a.replace("\\",""))}}function V(a,b,c,d){var e,f;switch(a){case"M":case"MM":c[1]=b==null?0:~~b-1;break;case"MMM":case"MMMM":for(e=0;e<12;e++)if(Q().monthsParse[e].test(b)){c[1]=e,f=!0;break}f||(c[8]=!1);break;case"D":case"DD":case"DDD":case"DDDD":b!=null&&(c[2]=~~b);break;case"YY":c[0]=~~b+(~~b>70?1900:2e3);break;case"YYYY":c[0]=~~Math.abs(b);break;case"a":case"A":d.isPm=(b+"").toLowerCase()==="pm";break;case"H":case"HH":case"h":case"hh":c[3]=~~b;break;case"m":case"mm":c[4]=~~b;break;case"s":case"ss":c[5]=~~b;break;case"S":case"SS":case"SSS":c[6]=~~(("0."+b)*1e3);break;case"Z":case"ZZ":d.isUTC=!0,e=(b+"").match(x),e&&e[1]&&(d.tzh=~~e[1]),e&&e[2]&&(d.tzm=~~e[2]),e&&e[0]==="+"&&(d.tzh=-d.tzh,d.tzm=-d.tzm)}b==null&&(c[8]=!1)}function W(a,b){var c=[0,0,1,0,0,0,0],d={tzh:0,tzm:0},e=b.match(k),f,g;for(f=0;f<e.length;f++)g=(U(e[f]).exec(a)||[])[0],g&&(a=a.slice(a.indexOf(g)+g.length)),D[e[f]]&&V(e[f],g,c,d);return d.isPm&&c[3]<12&&(c[3]+=12),d.isPm===!1&&c[3]===12&&(c[3]=0),O(c,d.isUTC,d.tzh,d.tzm)}function X(a,b){var c,d=a.match(m)||[],e,f=99,g,h,i;for(g=0;g<b.length;g++)h=W(a,b[g]),e=T(new H(h),b[g]).match(m)||[],i=N(d,e),i<f&&(f=i,c=h);return c}function Y(a){var b="YYYY-MM-DDT",c;if(u.exec(a)){for(c=0;c<4;c++)if(w[c][1].exec(a)){b+=w[c][0];break}return s.exec(a)?W(a,b+" Z"):W(a,b)}return new Date(a)}function Z(a,b,c,d,e){var f=e.relativeTime[a];return typeof f=="function"?f(b||1,!!c,a,d):f.replace(/%d/i,b||1)}function $(a,b,c){var e=d(Math.abs(a)/1e3),f=d(e/60),g=d(f/60),h=d(g/24),i=d(h/365),j=e<45&&["s",e]||f===1&&["m"]||f<45&&["mm",f]||g===1&&["h"]||g<22&&["hh",g]||h===1&&["d"]||h<=25&&["dd",h]||h<=45&&["M"]||h<345&&["MM",d(h/30)]||i===1&&["y"]||["yy",i];return j[2]=b,j[3]=a>0,j[4]=c,Z.apply({},j)}function _(a,c){b.fn[a]=function(a){var b=this._isUTC?"UTC":"";return a!=null?(this._d["set"+b+c](a),this):this._d["get"+b+c]()}}function ab(a){b.duration.fn[a]=function(){return this._data[a]}}function bb(a,c){b.duration.fn["as"+a]=function(){return+this/c}}var b,c="1.7.2",d=Math.round,e,f={},g="en",h=typeof module!="undefined"&&module.exports,i="months|monthsShort|weekdays|weekdaysShort|weekdaysMin|longDateFormat|calendar|relativeTime|ordinal|meridiem".split("|"),j=/^\/?Date\((\-?\d+)/i,k=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|YYYY|YY|a|A|hh?|HH?|mm?|ss?|SS?S?|zz?|ZZ?|.)/g,l=/(\[[^\[]*\])|(\\)?(LT|LL?L?L?)/g,m=/([0-9a-zA-Z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+)/gi,n=/\d\d?/,o=/\d{1,3}/,p=/\d{3}/,q=/\d{1,4}/,r=/[0-9a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+/i,s=/Z|[\+\-]\d\d:?\d\d/i,t=/T/i,u=/^\s*\d{4}-\d\d-\d\d(T(\d\d(:\d\d(:\d\d(\.\d\d?\d?)?)?)?)?([\+\-]\d\d:?\d\d)?)?/,v="YYYY-MM-DDTHH:mm:ssZ",w=[["HH:mm:ss.S",/T\d\d:\d\d:\d\d\.\d{1,3}/],["HH:mm:ss",/T\d\d:\d\d:\d\d/],["HH:mm",/T\d\d:\d\d/],["HH",/T\d\d/]],x=/([\+\-]|\d\d)/gi,y="Month|Date|Hours|Minutes|Seconds|Milliseconds".split("|"),z={Milliseconds:1,Seconds:1e3,Minutes:6e4,Hours:36e5,Days:864e5,Months:2592e6,Years:31536e6},A={},B="DDD w M D d".split(" "),C="M D H h m s w".split(" "),D={M:function(){return this.month()+1},MMM:function(a){return E("monthsShort",this.month(),this,a)},MMMM:function(a){return E("months",this.month(),this,a)},D:function(){return this.date()},DDD:function(){var a=new Date(this.year(),this.month(),this.date()),b=new Date(this.year(),0,1);return~~((a-b)/864e5+1.5)},d:function(){return this.day()},dd:function(a){return E("weekdaysMin",this.day(),this,a)},ddd:function(a){return E("weekdaysShort",this.day(),this,a)},dddd:function(a){return E("weekdays",this.day(),this,a)},w:function(){var a=new Date(this.year(),this.month(),this.date()-this.day()+5),b=new Date(a.getFullYear(),0,4);return~~((a-b)/864e5/7+1.5)},YY:function(){return K(this.year()%100,2)},YYYY:function(){return K(this.year(),4)},a:function(){return this.lang().meridiem(this.hours(),this.minutes(),!0)},A:function(){return this.lang().meridiem(this.hours(),this.minutes(),!1)},H:function(){return this.hours()},h:function(){return this.hours()%12||12},m:function(){return this.minutes()},s:function(){return this.seconds()},S:function(){return~~(this.milliseconds()/100)},SS:function(){return K(~~(this.milliseconds()/10),2)},SSS:function(){return K(this.milliseconds(),3)},Z:function(){var a=-this.zone(),b="+";return a<0&&(a=-a,b="-"),b+K(~~(a/60),2)+":"+K(~~a%60,2)},ZZ:function(){var a=-this.zone(),b="+";return a<0&&(a=-a,b="-"),b+K(~~(10*a/6),4)}};while(B.length)e=B.pop(),D[e+"o"]=G(D[e]);while(C.length)e=C.pop(),D[e+e]=F(D[e],2);D.DDDD=F(D.DDD,3),b=function(c,d){if(c===null||c==="")return null;var e,f;return b.isMoment(c)?new H(new Date(+c._d),c._isUTC,c._lang):(d?M(d)?e=X(c,d):e=W(c,d):(f=j.exec(c),e=c===a?new Date:f?new Date(+f[1]):c instanceof Date?c:M(c)?O(c):typeof c=="string"?Y(c):new Date(c)),new H(e))},b.utc=function(a,c){return M(a)?new H(O(a,!0),!0):(typeof a=="string"&&!s.exec(a)&&(a+=" +0000",c&&(c+=" Z")),b(a,c).utc())},b.unix=function(a){return b(a*1e3)},b.duration=function(a,c){var d=b.isDuration(a),e=typeof a=="number",f=d?a._data:e?{}:a,g;return e&&(c?f[c]=a:f.milliseconds=a),g=new I(f),d&&(g._lang=a._lang),g},b.humanizeDuration=function(a,c,d){return b.duration(a,c===!0?null:c).humanize(c===!0?!0:d)},b.version=c,b.defaultFormat=v,b.lang=function(a,c){var d;if(!a)return g;(c||!f[a])&&P(a,c);if(f[a]){for(d=0;d<i.length;d++)b[i[d]]=f[a][i[d]];b.monthsParse=f[a].monthsParse,g=a}},b.langData=Q,b.isMoment=function(a){return a instanceof H},b.isDuration=function(a){return a instanceof I},b.lang("en",{months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),longDateFormat:{LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D YYYY",LLL:"MMMM D YYYY LT",LLLL:"dddd, MMMM D YYYY LT"},meridiem:function(a,b,c){return a>11?c?"pm":"PM":c?"am":"AM"},calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[last] dddd [at] LT",sameElse:"L"},relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},ordinal:function(a){var b=a%10;return~~(a%100/10)===1?"th":b===1?"st":b===2?"nd":b===3?"rd":"th"}}),b.fn=H.prototype={clone:function(){return b(this)},valueOf:function(){return+this._d},unix:function(){return Math.floor(+this._d/1e3)},toString:function(){return this._d.toString()},toDate:function(){return this._d},toArray:function(){var a=this;return[a.year(),a.month(),a.date(),a.hours(),a.minutes(),a.seconds(),a.milliseconds(),!!this._isUTC]},isValid:function(){return this._a?this._a[8]!=null?!!this._a[8]:!N(this._a,(this._a[7]?b.utc(this._a):b(this._a)).toArray()):!isNaN(this._d.getTime())},utc:function(){return this._isUTC=!0,this},local:function(){return this._isUTC=!1,this},format:function(a){return T(this,a?a:b.defaultFormat)},add:function(a,c){var d=c?b.duration(+c,a):b.duration(a);return L(this,d,1),this},subtract:function(a,c){var d=c?b.duration(+c,a):b.duration(a);return L(this,d,-1),this},diff:function(a,c,e){var f=this._isUTC?b(a).utc():b(a).local(),g=(this.zone()-f.zone())*6e4,h=this._d-f._d-g,i=this.year()-f.year(),j=this.month()-f.month(),k=this.date()-f.date(),l;return c==="months"?l=i*12+j+k/30:c==="years"?l=i+(j+k/30)/12:l=c==="seconds"?h/1e3:c==="minutes"?h/6e4:c==="hours"?h/36e5:c==="days"?h/864e5:c==="weeks"?h/6048e5:h,e?l:d(l)},from:function(a,c){return b.duration(this.diff(a)).lang(this._lang).humanize(!c)},fromNow:function(a){return this.from(b(),a)},calendar:function(){var a=this.diff(b().sod(),"days",!0),c=this.lang().calendar,d=c.sameElse,e=a<-6?d:a<-1?c.lastWeek:a<0?c.lastDay:a<1?c.sameDay:a<2?c.nextDay:a<7?c.nextWeek:d;return this.format(typeof e=="function"?e.apply(this):e)},isLeapYear:function(){var a=this.year();return a%4===0&&a%100!==0||a%400===0},isDST:function(){return this.zone()<b([this.year()]).zone()||this.zone()<b([this.year(),5]).zone()},day:function(a){var b=this._isUTC?this._d.getUTCDay():this._d.getDay();return a==null?b:this.add({d:a-b})},startOf:function(a){switch(a.replace(/s$/,"")){case"year":this.month(0);case"month":this.date(1);case"day":this.hours(0);case"hour":this.minutes(0);case"minute":this.seconds(0);case"second":this.milliseconds(0)}return this},endOf:function(a){return this.startOf(a).add(a.replace(/s?$/,"s"),1).subtract("ms",1)},sod:function(){return this.clone().startOf("day")},eod:function(){return this.clone().endOf("day")},zone:function(){return this._isUTC?0:this._d.getTimezoneOffset()},daysInMonth:function(){return b.utc([this.year(),this.month()+1,0]).date()},lang:function(b){return b===a?Q(this):(this._lang=b,this)}};for(e=0;e<y.length;e++)_(y[e].toLowerCase(),y[e]);_("year","FullYear"),b.duration.fn=I.prototype={weeks:function(){return J(this.days()/7)},valueOf:function(){return this._milliseconds+this._days*864e5+this._months*2592e6},humanize:function(a){var b=+this,c=this.lang().relativeTime,d=$(b,!a,this.lang()),e=b<=0?c.past:c.future;return a&&(typeof e=="function"?d=e(d):d=e.replace(/%s/i,d)),d},lang:b.fn.lang};for(e in z)z.hasOwnProperty(e)&&(bb(e,z[e]),ab(e.toLowerCase()));bb("Weeks",6048e5),h&&(module.exports=b),typeof ender=="undefined"&&(this.moment=b),typeof define=="function"&&define.amd&&define("moment",[],function(){return b})}).call(this);define("ext/moment",["moment"],function(moment){moment.fn.isToday=function(){var now=new Date;now.setHours(0,0,0,0);var date=new Date(this._d.getTime());date.setHours(0,0,0,0);return now.getTime()==date.getTime()};moment.fn.isTomorrow=function(){var now=new Date;now.setHours(0,0,0,0);var date=new Date(this._d.getTime());date.setHours(0,0,0,0);return now.getTime()+864e5==date.getTime()};moment.fn.isThisWeek=function(){return moment().format("ww")==this.format("ww")};moment.fn.isThisYear=function(){return moment().format("YYYY")==this.format("YYYY")};return moment});define("router/base",["ext/underscore","ext/moment"],function(_,moment){return Backbone.Router.extend({initialize:function(){_.bindToMethods(this)}})});define("api/cache",["ext/underscore"],function(_){return{defaultExpireIn:10,cache:{},putModel:function(model,expireIn){model._expiry=this.calcExpiry(expireIn);this.cache[model.getKey()]=model},calcExpiry:function(expireIn){if(!expireIn){expireIn=this.defaultExpireIn}return(new Date).getTime()+expireIn*6e4},get:function(contextKey){var model=this.cache[contextKey];if(model&&model._expiry>(new Date).getTime()){return model}return null},getFrom:function(model){var cached=this.get(model.getKey());return cached?cached:model},clear:function(pattern){if(pattern){_.each(_.keys(this.cache),function(key){if(key.indexOf(pattern)==0){delete this.cache[key]}},this)}else{this.cache={}}}}});define("api/sync",["ext/underscore","app-context"],function(_,appContext){var $=jQuery;var ajax=function(request){appContext.loading("show");var token=appContext.getAccessToken();if(token){request["headers"]={Authorization:"Bearer "+token.access_token}}var jqXHR=$.ajax(request);jqXHR.request=request};var requestTokenAndRetry=function(credentials,request){var grantType=credentials.session?"session":credentials.password?"password":"refresh_token";$.ajax({type:"POST",url:appContext.resolveEndPoint()+"/oauth/token?grant_type="+grantType+"&client_id="+appContext.clientId,data:credentials,success:function(data,textStatus,jqXHR){appContext.setAccessToken(data);ajax(request)},error:function(jqXHR,textStatus,errorThrown){console.log(JSON.stringify(jqXHR));console.log(JSON.stringify(textStatus));console.log(JSON.stringify(errorThrown));appContext.removeCredentials();appContext.navigate("#public/signin/m_signin_invalid",true)}})};var getCredentials=function(){var credentials=appContext.getCredentials();if(credentials){return credentials}else{var token=appContext.getAccessToken();if(token&&token.refresh_token){return{refresh_token:token.refresh_token}}}return null};var error=function(_error,jqXHR,textStatus,errorThrown){appContext.loading("hide");if(errorThrown=="Unauthorized"){var credentials=getCredentials();if(credentials){requestTokenAndRetry(credentials,jqXHR.request)}else{appContext.navigate("#public/signin",true)}}else{_error(jqXHR,textStatus,errorThrown);appContext.navigate("#error",true)}};var success=function(_success,data,textStatus,jqXHR){appContext.loading("hide");_success(data,textStatus,jqXHR)};var methodMap={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};return{getKey:function(){var key=_.result(this,"url").replace(/\//g,":").substr(1);return this._getKey?this._getKey(key):key},sync:function(method,model,options){var params={type:methodMap[method],dataType:"json",cache:false,url:appContext.resolveEndPoint()+_.getProperty(model,"url")+"?version="+appContext.version};options.success=_.wrap(options.success,success);options.error=_.wrap(options.error,error);if(model.params){params.url+="&"+$.param(model.params,true)}if(model&&(method=="create"||method=="update")){params.contentType="application/json";params.data=JSON.stringify(model.toJSON())}if(params.type!=="GET"){params.processData=false}ajax(_.extend(params,options))}}});define("api/collection/base",["api/sync"],function(sync){return Backbone.Collection.extend(sync)});define("api/model/base",["ext/underscore","api/sync"],function(_,sync){return Backbone.Model.extend(sync)});define("api/model/user",["api/model/base"],function(BaseModel){return BaseModel.extend({})});define("api/collection/users",["api/collection/base","api/model/user"],function(BaseCollection,User){return BaseCollection.extend({model:User,url:"/users",initialize:function(models,options){this.context=options.context;this.params={};this.params[this.context.type+"Id"]=this.context.id;this.params["allowSelf"]=options.allowSelf},_getKey:function(key){return key+":"+this.context.getKey()}})});define("api/model/account",["api/model/base"],function(BaseModel){return BaseModel.extend({initialize:function(){this.type="account"},url:function(){return"/accounts/@"+this.id},isUser:function(){return this.get("name").indexOf("@")==0}})});define("api/collection/accounts",["api/collection/base","api/model/account"],function(BaseCollection,Account){return BaseCollection.extend({model:Account,url:"/accounts"})});define("api/model/group",["api/model/base"],function(BaseModel){return BaseModel.extend({initialize:function(){this.type="group"},url:function(){var id=this.id?"@"+this.id:this.get("name");return"/groups/"+id}})});define("api/collection/groups",["api/collection/base","api/model/group"],function(BaseCollection,Group){return BaseCollection.extend({model:Group,url:"/groups"})});define("api/collection/search",["ext/underscore","api/collection/base"],function(_,BaseCollection){return BaseCollection.extend({url:"/search",initialize:function(models,options){if(options){this.params=options.params}},parse:function(response){if(response instanceof Array){var suggestions=[];_.each(response,function(suggestion){suggestions.push({suggestion:suggestion})});this.suggestions=true;return suggestions}this.more=response.nextPage;return response.page}})});define("api/model/principle",["api/model/user"],function(User){return User.extend({url:"/me"})});define("api/service/general",["ext/underscore","app-context","api/cache","api/collection/users","api/collection/accounts","api/collection/groups","api/collection/search","api/model/principle","api/model/account","api/model/group"],function(_,appContext,cache,Users,Accounts,Groups,Search,Principle,Account,Group){var $=jQuery;var _cacheIfNew=function(model){if(!model._expiry){cache.putModel(model)}};var _attachGroupsToAccounts=function(handler,accounts,groups){var catchall=new Account;accounts.unshift(catchall);var accountMap={};_cacheIfNew(accounts);accounts.each(function(account){_cacheIfNew(account);accountMap[account.getKey()]=account;account.groups=[]},this);_cacheIfNew(groups);groups.each(function(group){_cacheIfNew(group);var account=new Account(group.get("account"));account=accountMap[account.getKey()];if(!account){account=catchall}account.groups.push(group)},this);handler(accounts)};var _getSearchResults=function(query,currentPage,handler){var search=new Search([],{params:{currentPage:currentPage,pageSize:appContext.pageSize,query:query}});search.once("sync",handler);search.fetch()};return{getUsers:function(context,handler,allowSelf){var users=cache.getFrom(new Users([],{context:context,allowSelf:allowSelf}));if(users._expiry){handler(users);return}users.once("sync",function(){cache.putModel(users);handler(users)});users.fetch()},fetchPrinciple:function(handler){var principle=new Principle;principle.once("change",function(){handler(principle)});principle.fetch()},getSearchResults:function(query,handler){_getSearchResults(query,1,handler)},getNextSearchResults:function(search,handler){_getSearchResults(search.params.query,search.params.currentPage+1,function(next){search.add(next.models);search.params.currentPage=next.params.currentPage;search.more=next.more;handler(next)})},getAccountsWithGroups:function(handler){var accounts=cache.getFrom(new Accounts);var groups=cache.getFrom(new Groups);var attachGroupsToAccounts=_.bind(_.after(2,_attachGroupsToAccounts),this,handler,accounts,groups);if(accounts._expiry){attachGroupsToAccounts()}else{accounts.once("sync",attachGroupsToAccounts);accounts.fetch()}if(groups._expiry){attachGroupsToAccounts()}else{groups.once("sync",attachGroupsToAccounts);groups.fetch()}},getContext:function(contextKey,handler){var parts=contextKey.split(":@");var id=parseInt(parts[1]);if(parts[0]=="groups"){this.getGroup(id,handler)}else{this.getAccount(id,handler)}},getAccount:function(id,handler){var account=cache.getFrom(new Account({id:id}));if(account._expiry){handler(account)}else{account.once("change",function(){cache.putModel(account);handler(account)});account.fetch()}},getGroup:function(id,handler){var group=cache.getFrom(new Group({id:id}));if(group._expiry&&group.get("components")){handler(group)}else{group.once("change",function(){cache.putModel(group);handler(group)});group.fetch()}},getEmailFromInviteKey:function(inviteKey,handler){$.ajax({url:appContext.resolveAppEndPoint()+"/signup/invited",data:{inviteKey:inviteKey},success:function(response){if(response.form){handler(response.form.user.email)}else{handler()}},error:function(){handler()},dataType:"json"})},isUsernameTaken:function(username,handler){$.get(appContext.resolveAppEndPoint()+"/signup/taken",{username:username},function(response){handler(response.status)},"json")},createUser:function(user,handler){appContext.loading("show");$.ajax({type:"POST",url:appContext.resolveAppEndPoint()+"/signup/invited",data:user,success:function(){appContext.loading("hide");handler(true)},error:function(){appContext.loading("hide");handler(false)},dataType:"json"})},requestPasswordReset:function(email,handler){appContext.loading("show");$.ajax({type:"POST",url:appContext.resolveAppEndPoint()+"/password/forgotten",data:{email:email},success:function(response){appContext.loading("hide");handler(response._viewName=="organisation/password_forgotten_success")},error:function(){appContext.loading("hide");handler(false)},dataType:"json"})},resetPassword:function(username,tokenKey,password,handler){appContext.loading("show");$.ajax({type:"POST",url:appContext.resolveAppEndPoint()+"/password/reset/"+username+"/"+tokenKey,data:password,success:function(response){appContext.loading("hide");handler(true)},error:function(){appContext.loading("hide");handler(false)},dataType:"json"})},deleteModel:function(model,handler){model.destroy({wait:true});model.once("destroy",handler)}}});define("api/model/request",["api/model/base"],function(BaseModel){return BaseModel.extend({url:function(){var id="";if(this.id){id="/"+this.id}if(this.collection){return this.collection.url()+id}return"/requests"+id}})});define("view/base",["ext/underscore","app-context","messages"],function(_,appContext,messages){var _message=function(code,args){var message=messages.messages[code];if(args){if(args.constructor!==Array){args=[args]}var parts=message.split(/[\{\}]+/);for(var i=1;i<parts.length;i+=2){parts[i]=args[parseInt(parts[i])]}return parts.join("")}return message};return Backbone.View.extend({initialize:function(options){_.bindToMethods(this);this.options=options},template:function(template,data){},template:function(template,data){if(data){var args=_.extend({messages:messages.messages,$:jQuery,appurl:appContext.getAppUrl()},data,messages.messages);return _.template(template,args)}return _.template(template,messages.messages)},message:_message},{message:_message})});define("lib/pull",["ext/underscore"],function(_){var $=jQuery;var $wrapper,viewStartY,startY,track=false,refresh=false;return{clear:function(settings){if($wrapper){$wrapper.off("touchstart touchmove touchend");$(">.refresh",$wrapper).empty()}},init:function(settings){var success=settings.success?settings.success:function(){};var top=settings.top?settings.top:0;$wrapper=settings.$wrapper?settings.$wrapper:$();var $refresh=$(">.refresh",$wrapper);var threshold=$refresh.height();settings.text&&$refresh.html(settings.text);var $view=$(">.view",$wrapper);var $pullable=$("ul.list-unstyled",$view);$wrapper.on("touchstart",function(e){viewStartY=-$pullable.position().top;startY=e.originalEvent.touches[0].screenY});$wrapper.on("touchend",function(e){if(refresh||track){$view.css("top",top+"px");if(refresh){success();refresh=false}track=false}});$wrapper.on("touchmove",function(e){var moveTo=viewStartY+(startY-e.originalEvent.targetTouches[0].screenY);if(moveTo<0){track=true;e.preventDefault();$view.css("top",top-moveTo+"px")}if(moveTo<-threshold){refresh=true}else{refresh=false}})}}});define("view/page",["ext/underscore","view/base","lib/pull","native","app-context","api/service/general"],function(_,BaseView,PULL,_native,appContext,service){var $=jQuery;var views={};return BaseView.extend({title:"Clinked",initialize:function(options){_.bindToMethods(this);this.options=options;this.$root=$("#clinked-portal");this.$wrapper=$(">.wrapper",this.$root)},render:function(){PULL.clear();var id=(new Date).getTime();views[id]=this;this.$view=$("<div>").addClass("view").attr("id",id).append(this.el);var $current=$(".view",this.$root);var viewId=$current.attr("id");if(viewId){views[viewId].remove();views[viewId]=null}$current.replaceWith(this.$view);if(this.navbar){this.$navigation=$("<div>").addClass("navigation");var self=this;this.navbar(function(navbar){self.$navigation.html(navbar.render().el);self.addFooter(self.$navigation)})}if(appContext.alert){this.$alert=$("<div>").addClass("alert alert-warning").html(appContext.alert);self.addHeader(this.$alert)}if(this.branded){this.$wrapper.addClass("branded")}else{this.$wrapper.removeClass("branded")}if(_native.refreshable&&this.handleRefresh){PULL.init({text:this.message("m_list_pull_to_refresh"),$wrapper:this.$wrapper,success:this.handleRefresh})}if(this.action&&!this.action.link){this.action.target="#"+this.$view.attr("id");this.$view.on("action",this.action.view.doAction)}appContext.setHeader(this);return this},remove:function(){BaseView.prototype.remove.apply(this,arguments);if(this.$navigation){this.removeMarginal(this.$navigation)}if(this.$alert){this.removeMarginal(this.$alert)}},scroll:function(position){this.$view.animate({scrollTop:position},"fast")},addHeader:function($header){$(">.header",this.$root).after($header.addClass("marginal"));
this.updateMarginalCount(+1)},addFooter:function($footer){this.$wrapper.after($footer.addClass("marginal"));this.updateMarginalCount(+1)},removeMarginal:function($marginal){$marginal.remove();this.updateMarginalCount(-1)},updateMarginalCount:function(sign){var marginalCount=this.$wrapper.data("marginals")+sign;var height=_native.height()-marginalCount*44;this.$wrapper.data("marginals",marginalCount).height(height)}})});define("view/extending-list",["ext/underscore","view/page"],function(_,PageView){var $=jQuery;return PageView.extend({tagName:"ul",className:"list-unstyled",initialize:function(options){PageView.prototype.initialize.apply(this,arguments);_(this.emptyMsgCode,"empty list message code required").assert();_(this.itemViewClass,"list item view class required").assert();_(this.handleEndOfList,"end of list handler required").assert();this.$loading=$("<li>").addClass("thin").html(this.message("m_page_loading"))},render:function(){PageView.prototype.render.apply(this,arguments);if(this.collection.length==0){$("<li>").addClass("thin").html(this.message(this.emptyMsgCode)).appendTo(this.$el)}else{this._renderPage(this.collection)}return this},refresh:function(){this.$el.empty();if(this.collection.length==0){$("<li>").addClass("thin").html(this.message(this.emptyMsgCode)).appendTo(this.$el)}else{this._renderPage(this.collection)}},renderPage:function(page){this.$loading.remove();this._renderPage(page)},_renderPage:function(page){page.each(function(model){var itemView=new this.itemViewClass({model:model});this.$el.append(itemView.render().el)},this);if(page.more){this.$loading.one("inview",this.handleEndOfList).appendTo(this.$el)}},extractDateLabel:function(date){date=moment(date);var label;if(date.isToday()){label=this.message("m_today")}else if(date.isTomorrow()){label=this.message("m_tomorrow")}else{var format;if(date.isThisWeek(date)){format="dddd"}else if(date.isThisYear(date)){format="DD MMMM"}else{format="DD MMMM YYYY"}label=date.format(format)}return label}})});define("api/model/content",["api/model/base","api/model/group"],function(BaseModel,Group){return BaseModel.extend({url:function(){var id="";if(this.id){id="@"+this.id+"/"}else{var name=this.get("name");if(name){id=name+"/"}}return"/groups/@"+this.get("group").id+"/"+this.type+"s/"+id},getGroup:function(){return new Group(this.get("group"))}})});define("api/model/file",["api/model/content"],function(Content){return Content.extend({initialize:function(){this.type="file"},isFolder:function(){return this.get("contentType")=="@folder"},getExtension:function(){if(this.isFolder()){return"folder"}var filename=this.get("friendlyName");var extensionPos=filename.lastIndexOf(".");if(filename.lastIndexOf("/")>extensionPos){return""}return filename.substring(extensionPos+1).toLowerCase()}},{type:"file"})});define("api/model/note",["api/model/content"],function(Content){return Content.extend({initialize:function(){this.type="page"}},{type:"page"})});define("api/model/discussion",["ext/underscore","api/model/content"],function(_,Content){return Content.extend({initialize:function(){this.type="discussion"}},{type:"discussion"})});define("api/model/event",["api/model/content"],function(Content){return Content.extend({initialize:function(){this.type="event"},isSameDay:function(){var start=new Date(this.get("startDate"));start.setHours(0,0,0,0);var end=new Date(this.get("endDate"));end.setHours(0,0,0,0);return start.getTime()==end.getTime()}},{type:"event"})});define("api/model/task",["api/model/content"],function(Content){return Content.extend({initialize:function(){this.type="task"},isOverdue:function(){return this.get("overdue")&&!this.get("completed")}},{type:"task"})});define("api/factory",["api/model/file","api/model/note","api/model/discussion","api/model/event","api/model/task"],function(File,Note,Discussion,Event,Task){return{createEntity:function(attributes){if(attributes.type=="page"){return new Note(attributes)}else if(attributes.type=="file"){return new File(attributes)}else if(attributes.type=="discussion"){return new Discussion(attributes)}else if(attributes.type=="event"){return new Event(attributes)}else if(attributes.type=="task"){return new Task(attributes)}return null}}});define("text",["module"],function(module){var text,fs,progIds=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],xmlRegExp=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,bodyRegExp=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,hasLocation=typeof location!=="undefined"&&location.href,defaultProtocol=hasLocation&&location.protocol&&location.protocol.replace(/\:/,""),defaultHostName=hasLocation&&location.hostname,defaultPort=hasLocation&&(location.port||undefined),buildMap=[],masterConfig=module.config&&module.config()||{};text={version:"2.0.3",strip:function(content){if(content){content=content.replace(xmlRegExp,"");var matches=content.match(bodyRegExp);if(matches){content=matches[1]}}else{content=""}return content},jsEscape:function(content){return content.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r").replace(/[\u2028]/g,"\\u2028").replace(/[\u2029]/g,"\\u2029")},createXhr:masterConfig.createXhr||function(){var xhr,i,progId;if(typeof XMLHttpRequest!=="undefined"){return new XMLHttpRequest}else if(typeof ActiveXObject!=="undefined"){for(i=0;i<3;i+=1){progId=progIds[i];try{xhr=new ActiveXObject(progId)}catch(e){}if(xhr){progIds=[progId];break}}}return xhr},parseName:function(name){var strip=false,index=name.indexOf("."),modName=name.substring(0,index),ext=name.substring(index+1,name.length);index=ext.indexOf("!");if(index!==-1){strip=ext.substring(index+1,ext.length);strip=strip==="strip";ext=ext.substring(0,index)}return{moduleName:modName,ext:ext,strip:strip}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(url,protocol,hostname,port){var uProtocol,uHostName,uPort,match=text.xdRegExp.exec(url);if(!match){return true}uProtocol=match[2];uHostName=match[3];uHostName=uHostName.split(":");uPort=uHostName[1];uHostName=uHostName[0];return(!uProtocol||uProtocol===protocol)&&(!uHostName||uHostName.toLowerCase()===hostname.toLowerCase())&&(!uPort&&!uHostName||uPort===port)},finishLoad:function(name,strip,content,onLoad){content=strip?text.strip(content):content;if(masterConfig.isBuild){buildMap[name]=content}onLoad(content)},load:function(name,req,onLoad,config){if(config.isBuild&&!config.inlineText){onLoad();return}masterConfig.isBuild=config.isBuild;var parsed=text.parseName(name),nonStripName=parsed.moduleName+"."+parsed.ext,url=req.toUrl(nonStripName),useXhr=masterConfig.useXhr||text.useXhr;if(!hasLocation||useXhr(url,defaultProtocol,defaultHostName,defaultPort)){text.get(url,function(content){text.finishLoad(name,parsed.strip,content,onLoad)},function(err){if(onLoad.error){onLoad.error(err)}})}else{req([nonStripName],function(content){text.finishLoad(parsed.moduleName+"."+parsed.ext,parsed.strip,content,onLoad)})}},write:function(pluginName,moduleName,write,config){if(buildMap.hasOwnProperty(moduleName)){var content=text.jsEscape(buildMap[moduleName]);write.asModule(pluginName+"!"+moduleName,"define(function () { return '"+content+"';});\n")}},writeFile:function(pluginName,moduleName,req,write,config){var parsed=text.parseName(moduleName),nonStripName=parsed.moduleName+"."+parsed.ext,fileName=req.toUrl(parsed.moduleName+"."+parsed.ext)+".js";text.load(nonStripName,req,function(value){var textWrite=function(contents){return write(fileName,contents)};textWrite.asModule=function(moduleName,contents){return write.asModule(moduleName,fileName,contents)};text.write(pluginName,nonStripName,textWrite,config)},config)}};if(masterConfig.env==="node"||!masterConfig.env&&typeof process!=="undefined"&&process.versions&&!!process.versions.node){fs=require.nodeRequire("fs");text.get=function(url,callback){var file=fs.readFileSync(url,"utf8");if(file.indexOf("﻿")===0){file=file.substring(1)}callback(file)}}else if(masterConfig.env==="xhr"||!masterConfig.env&&text.createXhr()){text.get=function(url,callback,errback){var xhr=text.createXhr();xhr.open("GET",url,true);if(masterConfig.onXhr){masterConfig.onXhr(xhr,url)}xhr.onreadystatechange=function(evt){var status,err;if(xhr.readyState===4){status=xhr.status;if(status>399&&status<600){err=new Error(url+" HTTP status: "+status);err.xhr=xhr;errback(err)}else{callback(xhr.responseText)}}};xhr.send(null)}}else if(masterConfig.env==="rhino"||!masterConfig.env&&typeof Packages!=="undefined"&&typeof java!=="undefined"){text.get=function(url,callback){var stringBuffer,line,encoding="utf-8",file=new java.io.File(url),lineSeparator=java.lang.System.getProperty("line.separator"),input=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(file),encoding)),content="";try{stringBuffer=new java.lang.StringBuffer;line=input.readLine();if(line&&line.length()&&line.charAt(0)===65279){line=line.substring(1)}stringBuffer.append(line);while((line=input.readLine())!==null){stringBuffer.append(lineSeparator);stringBuffer.append(line)}content=String(stringBuffer.toString())}finally{input.close()}callback(content)}}return text});define("text!text/search/item.html",[],function(){return"<a href=\"<%= link %>\">\n	<img src=\"<%= appurl %>/svg/<%= extension %>.svg\" onerror='this.onerror = null; this.src=\"<%= appurl %>/svg/file.svg\"'>\n	<p><b><%= get('name') %></b></p>\n	<abbr><%= m_last_updated %>: <%= $.timeago(new Date(get('timestamp'))) %></abbr>\n</a>\n"});define("view/search/item",["ext/underscore","view/base","api/factory","text!text/search/item.html"],function(_,BaseView,factory,template){return BaseView.extend({tagName:"li",className:"fat",render:function(){var extension=this.model.get("type");if(extension=="file"){var parts=this.model.get("name").split(".");extension=parts[parts.length-1]}this.model.set("group",{id:this.model.get("space")});var entity=factory.createEntity(this.model.toJSON());var args=_.extend({link:"#"+this.model.get("type")+"/"+entity.getKey(),extension:extension},this.model);this.$el.html(this.template(template,args));return this}})});define("view/search/list",["api/service/general","view/extending-list","view/search/item"],function(service,ExtendingListView,SearchItemView){var view=ExtendingListView.extend({back:{code:"m_context_dashboard",link:"#updates/dashboard"},title:ExtendingListView.message("m_search"),emptyMsgCode:"m_search_nothing",itemViewClass:SearchItemView,handleEndOfList:function(){service.getNextSearchResults(this.collection,this.renderPage)}});return view});define("text!text/search/suggestions.html",[],function(){return'&nbsp;&nbsp;<%= m_search_suggestions %>\n<% _.each(suggestions, function(suggestion, index) { %><!--\n \n --><% if (index != 0) { %>,<% } %>\n	<a href="#search/<%= suggestion.suggestion %>"><%= suggestion.suggestion %></a><!-- \n	\n --><% }); %>?\n'});define("view/search/suggestions",["ext/underscore","view/page","text!text/search/suggestions.html"],function(_,PageView,template){return PageView.extend({tagName:"h4",back:{code:"m_context_dashboard",link:"#updates/dashboard"},title:PageView.message("m_search_nothing"),render:function(){PageView.prototype.render.apply(this,arguments);if(this.collection.length>0){var args={suggestions:this.collection.toJSON()};this.$el.html(this.template(template,args))}return this}})});define("view/dialog",["ext/underscore","native","view/base"],function(_,_native,BaseView){var $=jQuery;return BaseView.extend({initialize:function(options){_.assert(options.callback,"callback required");_.assert(this.title,"title required");_.bindToMethods(this);this.options=options},render:function(){$(".modal-title").html(this.title);$(".modal-body").html(this.el);var $dialog=$(".modal-dialog").css({width:this.options.width?this.options.width:_native.width()-20+"px"});$(".modal").modal("show");$dialog.css("margin-left",function(){return($(window).width()-$(this).width())/2});return this},callback:function(){$(".modal").modal("hide");this.remove();this.options.callback.apply(this,arguments)}})});define("text!text/public/forgotten.html",[],function(){return'<input class="form-control" type="text" name="email" placeholder="<%= m_forgotten_email %>" autocorrect="off" autocapitalize="off">\n<a href="javascript:void(0)" class="btn btn-primary">\n	<%= m_forgotten_request %>\n</a>\n'});define("view/public/forgotten",["view/dialog","text!text/public/forgotten.html"],function(DialogView,template){var $=jQuery;return DialogView.extend({tagName:"fieldset",title:DialogView.message("m_forgotten_title"),events:{"click a":"request"},render:function(){DialogView.prototype.render.apply(this,arguments);this.$el.html(this.template(template));return this},request:function(){var $email=$("input[name=email]",this.$el);this.callback($email.val())}})});define("text!text/public/signin.html",[],function(){return'<% if (error) { %>\n	<div class="alert alert-danger"><%= error %></div>\n<% } %>\n<input class="form-control" name="username" placeholder="<%= m_signin_username %>" type="text" autocorrect="off" autocapitalize="off">\n<input class="form-control" name="password" placeholder="<%= m_signin_password %>" type="password">\n<a href="javascript:void(0)" id="signin" class="btn btn-primary">\n	<%= m_signin_signin %>\n</a>\n<a href="javascript:void(0)" id="forgotten-link">\n	<%= m_signin_forgotten %>\n</a>\n<% if (!thirdPartySignin) { %>\n	<a data-external class="btn btn-default linkedin" href="<%= appRoot %>/linkedin?referrer=mobile" >\n		<i class="fa fa-linkedin"></i>\n		<%= m_signin_linkedin %>\n	</a>\n	<a data-external class="btn btn-default google" href="<%= appRoot %>/google/oauth2?referrer=mobile" >\n		<i class="fa fa-google-plus"></i>\n		<%= m_signin_google %>\n	</a>\n<% } %>\n<% if (env != \'prod\') { %>\n	<div class="alert alert-success"><%= env %></div>\n<% } %>\n'});define("view/public/signin",["ext/underscore","view/page","native","app-context","api/service/general","view/public/forgotten","text!text/public/signin.html"],function(_,PageView,native,appContext,service,ForgottenView,template){return PageView.extend({tagName:"fieldset",events:{"click #signin":"signin","click #forgotten-link":"openForgotten"},branded:true,title:PageView.message("m_signin_title"),nosearch:true,render:function(){PageView.prototype.render.apply(this,arguments);var args={error:this.message(this.options.error),appRoot:appContext.resolveAppEndPoint(),env:appContext.getEnvironment(),thirdPartySignin:native.thirdPartySignin};this.$el.html(this.template(template,args));return this},openForgotten:function(){var forgotten=new ForgottenView({callback:this.handleForgotten});forgotten.render()},handleForgotten:function(email){service.requestPasswordReset(email,function(success){success=success?"sent":"fail";appContext.navigate("#public/signin/m_forgotten_request_"+success,true)})},signin:function(){var $username=this.$el.find("input[name=username]");var $password=this.$el.find("input[name=password]");var credentials={username:$username.val(),password:$password.val()};if(credentials.username.indexOf("@")==0){appContext.removeDashboard();appContext.setEnvironment(credentials.username.substr(1));appContext.navigate("#public/signin",true)}else{this.options.authenticate(credentials)}}})});define("text!text/public/validated_input.html",[],function(){return'<input class="form-control" type="<%= type %>" name="<%= name %>" value="<%= value %>"   \n	<% if (maxlength) { print(\'maxlength=\' + maxlength) } %>\n	placeholder="<%= label ? messages[label] : \'\' %>"\n    autocorrect="<%= autocomplete ? \'on\' : \'off\' %>"\n    autocapitalize="<%= autocomplete ? \'on\' : \'off\' %>" >\n<p class="hidden invalid"></p>\n'});define("view/public/validated-input",["ext/underscore","view/base","text!text/public/validated_input.html"],function(_,BaseView,template){var $=jQuery;return BaseView.extend({events:{"keyup input":"keyup","blur input":"blur"},initialize:function(options){_.assert(options.name,"name required");_.bindToMethods(this);this.options=_.extend({validate:function(text,handler){handler()}},options)},render:function(){var defs={type:"text",value:"",maxlength:null,autocomplete:true};this.$el.html(this.template(template,_.extend(defs,this.options)));return this},keyup:function(){if(this.options.keyup){this.options.keyup.call(this,$("input",this.$el).val())}},blur:function(){this.options.validate.call(this,$("input",this.$el).val(),this.displayValidation)},val:function(){return $("input",this.$el).val()},displayValidation:function(error){var $error=$("p",this.$el).html(this.message(error));if(error){$error.removeClass("hidden")}else{$error.addClass("hidden")}}})});define("text!text/public/signup.html",[],function(){return'<p><b>Your Email: <%= email %></b></p>\n<a href="javascript:void(0)" id="signup" class="btn btn-primary">\n	<%= m_signup_signup %>\n</a>\n'});define("view/public/signup",["ext/underscore","view/page","app-context","api/service/general","view/public/validated-input","text!text/public/signup.html"],function(_,PageView,appContext,service,ValidatedInput,template){var $=jQuery;var _formatUsername=function(name){name=name.toLowerCase();var result=[];for(var i=0;i<name.length;i++){result.push(!name.charAt(i).match(/[a-z0-9_]/)?".":name.charAt(i))}return result.join("")};return PageView.extend({tagName:"fieldset",events:{"click #signup":"validate"},title:PageView.message("m_signup_header"),branded:true,nosearch:true,initialize:function(options){PageView.prototype.initialize.apply(this,arguments);var usernameView=new ValidatedInput({autocomplete:false,name:"user.username",label:"m_input_username",maxlength:32,validate:function(text,handler){if(!text){handler("m_input_error_username")}else if(text.length>2){service.isUsernameTaken(text,function(status){handler(status?"m_input_error_taken":null)})}else{handler()}},keyup:function(text){var name=$("input",nameView.$el).val();this.manual=_formatUsername(name)!=text}});var nameView=new ValidatedInput({name:"user.name",label:"m_input_name",maxlength:32,validate:function(text,handler){_.defer(usernameView.blur);handler(text?null:"m_input_error_name")},keyup:function(text){if(!usernameView.manual){var username=_formatUsername(text);$("input",usernameView.$el).val(username)}}});var passwordView=new ValidatedInput({type:"password",name:"user.password",label:"m_input_password",validate:function(text,handler){if(!text){handler("m_input_error_password")}else if(text.length<6){handler("m_input_error_minimum_6")}else{handler()}}});this.inputs=[nameView,usernameView,passwordView,new ValidatedInput({type:"password",name:"passwordConfirm",label:"m_input_confirm",validate:function(text,handler){if(!text){handler("m_input_error_confirm")}else{var password=$("input",passwordView.$el).val();handler(text==password?null:"m_input_error_mismatch")}}}),new ValidatedInput({name:"user.telephone",label:"m_input_telephone",maxlength:20}),new ValidatedInput({name:"user.organisation",label:"m_input_organisation",maxlength:100})]},render:function(){PageView.prototype.render.apply(this,arguments);this.$el.html(this.template(template,this.options));var $signup=$("#signup",this.$el);_.each(this.inputs,function(input){$signup.before(input.render().el)});return this},validate:function(){var allValid=true;var inputCount=this.inputs.length;var self=this;_.each(this.inputs,function(input){input.options.validate(input.val(),function(error){inputCount--;input.displayValidation(error);!error||(allValid=false);if(inputCount==0&&allValid){self.signup()}})})},signup:function(){var user=$("input",this.$el).serializeArray();user.push({name:"inviteKey",value:this.options.inviteKey});user.push({name:"user.email",value:this.options.email});var currentYear=(new Date).getFullYear();var rawOffset=Date.UTC(currentYear,0,1)-new Date(currentYear,0,1).getTime();user.push({name:"rawOffset",value:rawOffset});user.push({name:"dstSavings",value:Date.UTC(currentYear,6,1)-new Date(currentYear,6,1).getTime()-rawOffset});service.createUser(user,this.signupComplete)},signupComplete:function(success){if(success){var credentials={username:$("[name='user.username']",this.$el).val(),password:$("[name='user.password']",this.$el).val()};this.options.authenticate(credentials)}else{appContext.navigate("#public/signin/m_error_unexpected",true)}}})});define("text!text/public/reset.html",[],function(){return'<a href="javascript:void(0)" id="reset" class="btn btn-primary">\n	<%= m_reset_reset %>\n</a>\n'});define("view/public/reset",["ext/underscore","view/page","app-context","api/service/general","view/public/validated-input","text!text/public/reset.html"],function(_,PageView,appContext,service,ValidatedInput,template){var $=jQuery;return PageView.extend({tagName:"fieldset",events:{"click #reset":"validate"},title:PageView.message("m_reset_header"),branded:true,nosearch:true,initialize:function(options){PageView.prototype.initialize.apply(this,arguments);var passwordView=this.passwordView=new ValidatedInput({type:"password",name:"password",label:"m_input_password",validate:function(text,handler){if(!text){handler("m_input_error_password")}else if(text.length<6){handler("m_input_error_minimum_6")}else{handler()}}});this.confirmView=new ValidatedInput({type:"password",name:"confirmedPassword",label:"m_input_confirm",validate:function(text,handler){if(!text){handler("m_input_error_confirm")}else{var password=$("input",passwordView.$el).val();handler(text==password?null:"m_input_error_mismatch")}}})},render:function(){PageView.prototype.render.apply(this,arguments);this.$el.html(this.template(template,this.options));var $reset=$("#reset",this.$el);$reset.before(this.passwordView.render().el);$reset.before(this.confirmView.render().el);return this},validate:function(){var self=this;var valid=0,count=0;var check=function(error){count++;if(!error){valid++}if(count==2&&valid==2){self.reset()}};this.passwordView.options.validate(this.passwordView.val(),function(error){self.passwordView.displayValidation(error);check(error)});this.confirmView.options.validate(this.confirmView.val(),function(error){self.confirmView.displayValidation(error);check(error)})},reset:function(){service.resetPassword(this.options.username,this.options.tokenKey,$("input",this.$el).serializeArray(),this.resetComplete)},resetComplete:function(success){if(success){var credentials={username:this.options.username,password:$("[name=password]",this.$el).val()};this.options.authenticate(credentials)}else{appContext.navigate("#public/signin/m_error_unexpected",true)}}})});define("text!text/context_item.html",[],function(){return"<a href=\"#updates/<%= model.getKey() %>\">\n	<% if (model.type == 'group') { %>\n		<img src=\"<%= cdn %>/customise/<%= model.get('hash') %>/@logo?_=<%= model.get('lastModified') %>\">\n	<% } %>\n	<%= _.escape(model.get('friendlyName')) %>\n</a>\n"});define("view/context/item",["ext/underscore","app-context","text!text/context_item.html"],function(_,appContext,template){return Backbone.View.extend({tagName:"li",className:"context-item",render:function(){if(!this.model.id){this.$el.addClass("hidden")}else if(this.model.type=="account"){this.$el.addClass("list-header")}var args={cdn:appContext.cdn,model:this.model};this.$el.html(_.template(template,args));return this}})});define("view/context/select",["ext/underscore","view/page","view/context/item"],function(_,PageView,ContextItemView){return PageView.extend({title:PageView.message("m_context_select_header"),action:{code:"m_context_signout",link:"#signout"},tagName:"ul",className:"list-unstyled",append:function(model){var view=new ContextItemView({model:model});this.$el.append(view.render().el)},render:function(){PageView.prototype.render.apply(this,arguments);this.collection.each(function(account){this.append(account);_.each(account.groups,function(group){this.append(group)},this)},this);return this}})});define("text!text/error.html",[],function(){return'<div class="alert alert-danger">\n	<%= code %>\n</div>\n<a href="#updates/dashboard" class="btn btn-primary">\n	<%= m_error_dashboard %>\n</a>\n'});define("view/error",["ext/underscore","view/page","text!text/error.html"],function(_,PageView,template){return PageView.extend({tagName:"fieldset",title:PageView.message("m_error_title"),nosearch:true,render:function(){PageView.prototype.render.apply(this,arguments);var args={code:this.options.code?this.message(this.options.code):this.message("m_error_unexpected")};this.$el.html(this.template(template,args));return this}})});define("router/default",["router/base","app-context","api/cache","api/service/general","api/model/group","api/model/request","view/search/list","view/search/suggestions","view/public/signin","view/public/signup","view/public/reset","view/context/select","view/error"],function(BaseRouter,appContext,cache,service,Group,Request,SearchListView,SearchSuggestionsView,SigninView,SignupView,ResetView,ContextSelectView,ErrorView){return BaseRouter.extend({routes:{"search/:query":"getSearch","defer/:organisation/requests/:id/:answer":"handleDeferredRequest","defer/:organisation/:group":"handleDeferredContent","defer/:organisation/:group/:type/:id":"handleDeferredContent","public/signup/:inviteKey":"showSignup","public/signin":"showSignin","public/signin/:error":"showSignin","public/reset/:username%2F:tokenKey":"showReset","public/auth/:session":"authenticateWithSession",signout:"actionSignout",context:"getAccounts",error:"showError","error/:code":"showError","*splat":"splat"},getSearch:function(query){service.getSearchResults(decodeURIComponent(query),this.showSearch)},showSearch:function(results){if(results.suggestions){new SearchSuggestionsView({collection:results}).render()}else{new SearchListView({collection:results}).render()}},handleDeferredRequest:function(organisation,id,answer){var request=new Request({id:id});request.answer=answer;request.once("sync",this.answerRequest);request.fetch()},answerRequest:function(request){request.set("status",request.answer.toUpperCase());request.once("sync",function(){var key=request.get("contextKey");type=key.objectType.split(".")[4].toLowerCase();if(type=="space"){if(request.answer=="accept"){appContext.navigate("#updates/groups:@"+key.objectId,true)}else{appContext.navigate("#updates/dashboard",true)}}else{appContext.navigate("#"+type+"/"+type+":"+key.parent.objectId+":@"+key.objectId,true)}});request.save()},handleDeferredContent:function(organisation,group,type,id){group=new Group({name:organisation+":"+group});if(type){group.entity={type:type,id:id}}group.once("sync",this.redirectToGroupContent);group.fetch()},redirectToGroupContent:function(group){if(group.entity){var type=group.entity.type.substr(0,group.entity.type.length-1);appContext.navigate("#"+type+"/"+type+":"+group.id+":"+group.entity.id,true)}else{appContext.navigate("#updates/groups:@"+group.id,true)}},showSignin:function(error){var self=this;if(appContext.getCredentials()){appContext.navigate("#updates/dashboard",true)}else{new SigninView({authenticate:self.authenticate,error:error}).render()}},actionSignout:function(){appContext.removeAccessToken();appContext.removePrinciple();cache.clear();appContext.removeCredentials();appContext.navigate("#public/signin",true)},getAccounts:function(){service.getAccountsWithGroups(this.showContextSelect)},showContextSelect:function(accounts){new ContextSelectView({collection:accounts}).render()},showError:function(code){new ErrorView({code:code}).render()},splat:function(){new ErrorView({code:"m_error_not_found"}).render()},showSignup:function(inviteKey){var self=this;service.getEmailFromInviteKey(inviteKey,function(email){if(email){appContext.removeAccessToken();appContext.removePrinciple();cache.clear();new SignupView({authenticate:self.authenticate,email:email,inviteKey:inviteKey}).render()}else{appContext.navigate("#error/m_error_invite",true)}})},showReset:function(username,tokenKey){appContext.removeAccessToken();appContext.removePrinciple();cache.clear();new ResetView({authenticate:this.authenticate,username:username,tokenKey:tokenKey}).render()},authenticateWithSession:function(session){this.authenticate({session:session})},authenticate:function(credentials){appContext.setCredentials(credentials);service.fetchPrinciple(function(principle){appContext.setPrinciple(principle.toJSON());appContext.navigate("#updates/dashboard",true)})}})});define("api/model/update",["ext/underscore","api/model/base","api/model/account","api/model/group","api/factory"],function(_,BaseModel,Account,Group,factory){return BaseModel.extend({initialize:function(attributes){if(attributes.component){this.component=factory.createEntity(attributes.component)}},urlRoot:"/updates",isMicroblog:function(){return this.get("messageCode").search(/\.private$/)!=-1},getComponent:function(){return this.component},getAccount:function(){if(!this.account){this.account=this.get("account");if(this.account){this.account=new Account(this.account)}}return this.account},getGroup:function(){if(!this.group){this.group=this.get("group");if(this.group){this.group=new Group(this.group)}}return this.group},getContext:function(){if(this.getGroup()){return this.getGroup()}else if(this.getAccount()){return this.getAccount()}},format:function(template){var user=this.get("user");var account=this.get("account");var group=this.get("group");var args=[user?user.name:this.get("userName"),account?account.friendlyName:this.get("accountName"),group?group.friendlyName:this.get("groupName"),_.escape(this.get("componentName")),null,this.get("reservedName")];var parts=template.split(/[\{\}]+/);for(var i=1;i<parts.length;i+=2){parts[i]=args[parseInt(parts[i])]}var control={max:80};var description="";for(var i=0;i<parts.length&&!control.truncate;i++){var part=this.truncate(control,parts[i]);description+=i%2?part.bold():part}return description},truncate:function(control,part){if(!part){part=""}if(!control.current){control.current=0}control.current+=part.length;if(control.current>control.max){control.truncate=true;return part.substr(0,control.current-control.max)+".."}return part}})});define("api/collection/updates",["api/collection/base","api/model/update"],function(BaseCollection,Update){return BaseCollection.extend({model:Update,url:"/updates",initialize:function(models,options){this.context=options.context;this.params={currentPage:1,pageSize:25};if(options.current){if(options.current.offset){this.params.offset=options.current.offset}else{this.params.currentPage+=options.current.params.currentPage}}this.params[this.context.type+"Id"]=this.context.id},parse:function(response){if(response.page){this.more=response.nextPage;return response.page}this.offset=response.offset;this.more=response.more;return response.items},addPage:function(page){this.add(page.models);if(page.offset){this.offset=page.offset}else{this.params.currentPage=page.params.currentPage}this.more=page.more},_getKey:function(key){return key+":"+this.context.getKey()}})});define("api/model/microblog-reply",["api/model/base"],function(BaseModel){return BaseModel.extend({initialize:function(){this.reply=true},getComment:function(){return this.get("comment")},getCommenter:function(){return this.get("commenter")},getDateCreated:function(){return new Date(this.get("dateCreated"))}})});define("api/collection/microblog-replies",["api/collection/base","api/model/microblog-reply"],function(BaseCollection,Reply){return BaseCollection.extend({model:Reply,initialize:function(models,options){this.parent=options.parent},url:function(){return this.parent.url()+"/comments"}})});define("api/model/microblog",["ext/underscore","api/collection/microblog-replies","api/model/update"],function(_,Replies,Update){return Update.extend({getComment:function(){return this.get("message")},getCommenter:function(){return this.get("user")},getDateCreated:function(){return new Date(this.get("lastModified"))},getReplies:function(){if(!this.replies){this.replies=new Replies(this.get("replies"),{parent:this})}return this.replies},_getKey:function(key){return key+":microblog"
}})});define("api/model/base-comment",["api/model/base"],function(BaseModel){return BaseModel.extend({url:function(){var id=this.id?"/@"+this.id:"";return this.collection.url()+id},getComment:function(){return this.get("comment")},getCommenter:function(){var commenter=this.get("commenter");return commenter?commenter:{name:this.get("commenterName")}},getDateCreated:function(){return new Date(this.get("dateCreated"))}})});define("api/model/reply",["api/model/base-comment"],function(BaseComment){return BaseComment.extend({initialize:function(){this.reply=true}})});define("api/service/update",["ext/underscore","api/cache","api/service/general","api/collection/updates","api/model/microblog","api/model/reply"],function(_,cache,service,Updates,Microblog,Reply){var _getUpdatesPage=function(updates,handler){updates.once("sync",function(){updates.each(function(update){var component=update.getComponent();if(component){cache.putModel(component)}});handler(updates)});updates.fetch()};return{getUpdates:function(contextKey,handler,force){service.getContext(contextKey,function(context){var updates=new Updates([],{context:context});if(!force){updates=cache.getFrom(updates);if(updates._expiry){handler(updates);return}}_getUpdatesPage(updates,function(updates){cache.putModel(updates);handler(updates)})})},getCachedUpdates:function(contextKey,handler){service.getContext(contextKey,function(context){var updates=new Updates([],{context:context});handler(cache.getFrom(updates))})},getNextUpdates:function(updates,handler){_getUpdatesPage(new Updates([],{context:updates.context,current:updates}),function(next){updates.addPage(next);handler(next)})},getMicroblog:function(id,handler,force){var microblog=new Microblog({id:id});if(!force){microblog=cache.getFrom(microblog);if(microblog._expiry){handler(microblog);return}}microblog.once("change",function(){handler(microblog)});microblog.fetch()},createMicroblog:function(context,text,handler){var attributes={message:text};attributes[context.type]={id:context.id};var microblog=new Microblog(attributes);microblog.save();microblog.once("change",_.bind(handler,this,microblog))},createMicroblogReply:function(microblog,text,handler){var replies=microblog.getReplies();var reply=new Reply({comment:text});replies.once("change",_.bind(handler,this,reply));replies.add(reply);reply.save()}}});define("text!text/navbar.html",[],function(){return"<% _.each(btns, function(btn, i) { %>\n	<div class=\"btn-group\">\n		<a href=\"<%= btn.link %>\" class=\"btn btn-default <%= btn.name == focus ? 'selected' : '' %>\">\n			<img src=\"<%= appurl %>/svg/components/<%= btn.name %><%= btn.name == focus ? '-white' : '' %>.svg\" />\n		</a>\n	</div>\n<% }); %>\n"});define("view/navbar",["ext/underscore","view/base","text!text/navbar.html"],function(_,BaseView,template){return BaseView.extend({className:"btn-group btn-group-justified",initialize:function(options){_.assert(options.btns,"btns required");_.assert(options.focus,"focus required");this.options=options},render:function(){this.$el.html(this.template(template,this.options));return this}})});define("view/navbar-factory",["ext/underscore","api/service/general","view/navbar"],function(_,service,NavBar){return{navbarCreate:function(focus,groupId,callback){service.getGroup(groupId,function(group){var choiceMap={pages:{name:"pages",link:"#pages/"+group.getKey()},files:{name:"files",link:"#files/"+group.getKey()},discussions:{name:"discussions",link:"#discussions/"+group.getKey()},events:{name:"events",link:"#events/"+group.getKey()},tasks:{name:"tasks",link:"#tasks/"+group.getKey()}};var btns=[{name:"overview",link:"#updates/"+group.getKey()}];_.each(group.get("components"),function(component){if(choiceMap[component]){btns.push(choiceMap[component])}});btns.push({name:"messages",link:"#messages/"+group.getKey()});callback(new NavBar({focus:focus,btns:btns}))})}}});define("text!text/update_item.html",[],function(){return"<img class=\"svg-1default <%= sprite %>\" src=\"<%= image %>\" \n	onerror='this.onerror = null; this.src=\"<%= appurl %>/styles/images/default_thumbnail.png\"'>\n<% var template = messages[model.get('messageCode')]; %>\n<p><%= template ? model.format(template) : m_update_unknown %></p>\n<abbr><%= $.timeago(new Date(model.get('lastModified'))) %></abbr>\n"});define("view/update/item",["ext/underscore","view/base","app-context","api/cache","text!text/update_item.html"],function(_,BaseView,appContext,cache,template){var $=jQuery;return BaseView.extend({tagName:"li",className:"fat update-item",render:function(){var args=this.addImageArgs({model:this.model});var parent=null;var link=this.createLink();if(link){parent=$("<a>").attr("href",link).appendTo(this.el)}else{parent=this.$el}parent.addClass("list-parent").append(this.template(template,args));return this},createLink:function(){if(this.model.isMicroblog()){cache.putModel(this.model);return"#microblog/"+this.model.getKey()}else if(this.model.get("component")){var component=this.model.getComponent();if(component){if(this.model.get("message")){var root="#comments/";if(this.model.get("messageCode")=="update.discussion.createreply"){root="#discussion/"}return root+component.getKey()+"/"+this.model.get("lastModified")}return"#"+component.type+"/"+component.getKey()}}else if(this.model.getContext()){var contextKey=this.model.getContext().getKey();if(contextKey!=this.model.collection.context.getKey()){return"#updates/"+contextKey}}return null},addImageArgs:function(args){if(this.model.isMicroblog()){args.sprite="";var blogger=this.model.get("user");if(blogger.logo){args.image=appContext.cdn+"/users/"+blogger.id+"/thumbnail"}else{args.image=appContext.defaultThumb}}else{args.sprite="svg-"+this.model.get("messageCode").replace(/\./g,"");var component=this.model.getComponent();if(component&&component.isFolder&&component.isFolder()){args.sprite+=" folder"}args.image=appContext.getAppUrl()+"/styles/images/transparent.gif"}return args}})});define("view/update/list",["ext/underscore","api/service/update","view/navbar-factory","view/extending-list","view/update/item"],function(_,service,navbarFactory,ExtendingListView,UpdateItemView){return ExtendingListView.extend({back:{code:"m_btn_context",link:"#context"},initialize:function(){ExtendingListView.prototype.initialize.apply(this,arguments);this.title=_.escape(this.options.context.get("friendlyName"));this.action={code:"m_comment",link:"#updates/"+this.options.context.getKey()+"/create"};if(this.options.context.type=="group"){this.navbar=this._navbar}},emptyMsgCode:"m_updates_nothing",itemViewClass:UpdateItemView,handleEndOfList:function(){service.getNextUpdates(this.collection,this.renderPage)},handleRefresh:function(){var self=this;service.getUpdates(this.collection.context.getKey(),function(updates){self.collection=updates;self.refresh()},true)},_navbar:function(callback){this.navbarCreate("overview",this.options.context.id,callback)}}).extend(navbarFactory)});define("text!text/people_item.html",[],function(){return'<a class="item-with-icon" href="javascript:void(0)">\n	<img src="<%= thumb %>">\n	<h4><%= name %></h4>\n</a>\n'});define("view/people/item",["ext/underscore","app-context","text!text/people_item.html"],function(_,appContext,template){return Backbone.View.extend({tagName:"li",className:"fat",events:{"click a":"select"},initialize:function(options){_.assert(options.callback,"callback required");this.options=options},render:function(){var thumb=appContext.getAppUrl()+"/styles/images/default_thumbnail.png";if(this.model.get("logo")){thumb=appContext.cdn+"/users/"+this.model.id+"/thumbnail"}var args={name:this.model.get("name"),thumb:thumb};this.$el.html(_.template(template,args));return this},select:function(){this.options.callback(this.model)}})});define("view/people/list",["ext/underscore","view/dialog","view/people/item"],function(_,DialogView,PeopleItemView){return DialogView.extend({tagName:"ul",className:"list-unstyled",title:DialogView.message("m_mention_title"),render:function(){DialogView.prototype.render.apply(this,arguments);var keys={};this.options.filter&&_.each(this.options.filter,function(id){keys[id]=true});this.collection.each(function(user){if(!keys[user.id]){var view=new PeopleItemView({model:user,callback:this.callback});this.$el.append(view.render().el)}},this);return this}})});define("view/editor",["ext/underscore","native","api/service/general","view/people/list"],function(_,native,generalService,PeopleListView){var $=jQuery;return Backbone.View.extend({tagName:"iframe",attributes:{scrolling:"no",frameBorder:"0"},initialize:function(options){_.bindToMethods(this);this.context=options.context;this.$page=options.$page;this.content=options.content},render:function(){var $target=$("textarea.editor",this.$page);this.placeholder='<span style="color:gray;">'+$target.attr("placeholder")+"</span>";$target.replaceWith(this.el);this.frameWin=this.el.contentWindow;this.frameDoc=this.frameWin.document;this.frameDoc.designMode="on";this.$frameBody=$(this.frameDoc.body);this.$frameBody.css("font-family","Helvetica,Arial,sans-serif");if(_.isBlank(this.content)){this.$frameBody.html(this.placeholder)}else{this.$frameBody.html(this.content)}$(this.frameDoc).keydown(this.onKeydown);var self=this;$(this.frameDoc).keyup(function(e){self.$el.trigger("_change")});$(this.frameWin).focus(this.onFocus).blur(this.onBlur);native.keyboardCancelRequired&&this.frameDoc.body.blur()},render_delayed:function(focus){_.delay(function(self){self.render();focus&&self.frameWin.focus()},100,this)},onFocus:function(){if(this.getText()==""){this.$frameBody.html("")}},onBlur:function(){if(_.isBlank(_.stripTags(this.getText()))){this.$frameBody.html(this.placeholder)}},onKeydown:function(e){if(e.keyCode==13){e.preventDefault();var br=$("<br>").addClass("new-line").appendTo(this.frameDoc.body);var space=$(document.createTextNode(String.fromCharCode(160))).insertAfter(br);var selection=this.frameWin.getSelection();var range=this.frameDoc.createRange();range.selectNode(selection.anchorNode);range.setStartBefore(space[0]);range.collapse(true);selection.removeAllRanges();selection.addRange(range)}},doAction:function(){var self=this;generalService.getUsers(this.context,function(users){self.users=users;var people=new PeopleListView({collection:users,callback:function(user){self.insertMention(user)}});people.render()})},insertMention:function(user){this.frameDoc.body.focus();var anchor=$("<a/>").css({"background-color":"grey"}).text("@"+user.get("username"));anchor.appendTo(this.frameDoc.body);var space=$(document.createTextNode(String.fromCharCode(160))).insertAfter(anchor);var selection=this.frameWin.getSelection();var range=this.frameDoc.createRange();range.selectNode(selection.anchorNode);range.setStartAfter(space[0]);range.collapse(true);selection.removeAllRanges();selection.addRange(range);native.keyboardCancelRequired&&this.frameDoc.body.blur()},getText:function(){var text=this.$frameBody.html();return text==this.placeholder?"":text}})});define("text!text/editor.html",[],function(){return'<textarea class="editor hidden" placeholder="<%= m_type_here %>"></textarea>\n<fieldset>\n	<a href="javascript:void(0)" id="post" class="btn btn-primary" disabled="disabled">\n		<%= m_post %>\n	</a>\n</fieldset>\n'});define("view/editor-page",["ext/underscore","view/page","view/editor","text!text/editor.html"],function(_,PageView,EditorView,template){var $=jQuery;return PageView.extend({events:{"_change iframe":"onChange","click #post":"post"},initialize:function(options){PageView.prototype.initialize.apply(this,arguments);_.assert(this.post,"title post");this.editor=new EditorView({context:this.options.context,$page:this.$el});this.action={code:"m_mention",view:this.editor}},render:function(){PageView.prototype.render.apply(this,arguments);this.$el.html(this.template(template));this.editor.render_delayed(true);return this},onChange:function(){$("#post",this.$el).attr("disabled",_.isBlank(this.editor.getText()))}})});define("view/update/create",["app-context","view/editor-page","api/service/update"],function(appContext,EditorPageView,service){return EditorPageView.extend({title:EditorPageView.message("m_make_comment"),nosearch:true,initialize:function(){EditorPageView.prototype.initialize.apply(this,arguments);this.back={code:"m_btn_updates",link:"#updates/"+this.options.context.getKey()}},post:function(){service.createMicroblog(this.options.context,this.editor.getText(),this.microblogCreated)},microblogCreated:function(microblog){appContext.navigate("#microblog/"+microblog.getKey());service.getUpdates(this.options.context.getKey(),function(updates){updates.unshift(microblog)})}})});define("view/update/reply",["app-context","view/editor-page","api/service/update"],function(appContext,EditorPageView,service){return EditorPageView.extend({title:EditorPageView.message("m_reply"),nosearch:true,initialize:function(){EditorPageView.prototype.initialize.apply(this,arguments);this.back={code:"m_comment",link:"#microblog/"+this.options.update.getKey()}},post:function(){var microblog=this.options.update;service.createMicroblogReply(microblog,this.editor.getText(),function(microblogReply){appContext.navigate("#microblog/"+microblog.getKey())})}})});define("api/collection/replies",["api/collection/base","api/model/reply"],function(BaseCollection,Reply){return BaseCollection.extend({model:Reply,initialize:function(models,options){this.parent=options.parent},url:function(){return this.parent.url()}})});define("api/model/comment",["api/model/base-comment","api/collection/replies"],function(BaseComment,Replies){return BaseComment.extend({initialize:function(attributes){this.replies=new Replies(attributes.replies,{parent:this})},getReplies:function(){return this.replies}})});define("text!text/comment/item.html",[],function(){return'<div>\n	<img src="<%= cdn %>/users/<%= commenter.id %>/thumbnail" \n		onerror=\'this.onerror = null; this.src="<%= appurl %>/styles/images/default_thumbnail.png"\'>\n	<p><%= model.getComment() %></p>\n	<p class="who-when"><%= commenter.name %> (<%= $.timeago(model.getDateCreated()) %>)</p>\n	\n	<% if (!model.reply) { %>\n		<a href="javascript:void(0)" class="comment-reply">\n			<span class="glyphicon glyphicon-repeat"></span>\n		</a>\n	<% } %>\n	<% if (me.id == commenter.id) { %>\n		<a href="javascript:void(0)" class="comment-delete">\n			<span class="glyphicon glyphicon-trash"></span>\n		</a>\n	<% } %>\n</div>\n'});define("view/comment/item",["ext/underscore","view/base","app-context","text!text/comment/item.html"],function(_,BaseView,appContext,template){return BaseView.extend({attributes:{"class":"comment"},events:{"click .comment-delete":"onDelete","click .comment-reply":"onReply"},initialize:function(options){_.bindToMethods(this);this.replyViews=[];this.options=options},render:function(){var args={model:this.model,commenter:this.model.getCommenter(),selected:this.options.selected,cdn:appContext.cdn,me:appContext.getPrinciple()};this.$el.html(this.template(template,args));if(this.options.selected){this.$el.addClass("selected")}if(this.model.reply){this.$el.addClass("reply")}return this},onReply:function(){this.options.onReply(this.model)},onDelete:function(){this.options.onDelete(this.model,this.onDeleted)},onDeleted:function(){this.$el.remove();_.each(this.replyViews,function(view){view.$el.remove()})}})});define("view/comment/list",["ext/underscore","view/page","api/model/comment","view/comment/item"],function(_,PageView,Comment,CommentItemView){var $=jQuery;return PageView.extend({className:"comments",initialize:function(options){PageView.prototype.initialize.apply(this,arguments);this.collection.on("remove",this.onRemove);this.back=this.options.back;this.title=this.options.title;this.action=this.options.action},render:function(){PageView.prototype.render.apply(this,arguments);var selectedId=this.getSelectedComment();this.collection.each(function(comment){var commentView=this.createAndRender(comment,selectedId==comment.id);comment.getReplies().each(function(reply){var replyView=this.createAndRender(reply,selectedId==reply.id);commentView.replyViews.push(replyView)},this)},this);this.onRemove();return this},createAndRender:function(comment,selected){var view=new CommentItemView({model:comment,selected:selected,onDelete:this.options.onDelete,onReply:this.options.onReply});this.$el.append(view.render().el);selected&&this.scroll(view.$el.offset().top-52);return view},getSelectedComment:function(){if(!this.options.dateOfSelection){return-1}var flattened=[];this.collection.each(function(comment){flattened.push(comment);comment.getReplies().each(function(reply){flattened.push(reply)})});flattened=_.sortBy(flattened,function(comment){return-comment.get("dateCreated")});var selected=_.find(flattened,function(comment){return comment.get("dateCreated")<=this.options.dateOfSelection},this);return selected?selected.id:-1},remove:function(){this.collection.off("remove",this.onRemove);this.$el.remove();return this},onRemove:function(){if(this.collection.length==0){$("<div>").addClass("no-comments ui-body-d ui-corner-all").html(this.message("m_comments_nothing")).appendTo(this.el)}}})});define("router/update",["app-context","router/base","api/service/general","api/service/update","view/update/list","view/update/create","view/update/reply","view/comment/list","messages"],function(appContext,BaseRouter,generalService,updateService,UpdateListView,UpdateCreateView,UpdateReplyView,CommentListView,messages){return BaseRouter.extend({routes:{"updates/:contextKey/create":"createMicroblog","updates/dashboard":"getDashboardUpdates","updates/:contextKey":"getUpdates","microblog/:microblogKey/create":"createMicroblogReply","microblog/:microblogKey":"getMicroblog"},getDashboardUpdates:function(){var contextKey=appContext.getDashboard();if(contextKey){this.getUpdates(contextKey)}else{appContext.navigate("#context",true)}},getUpdates:function(contextKey){appContext.setDashboard(contextKey);updateService.getCachedUpdates(contextKey,this.showUpdates)},showUpdates:function(updates){var view=new UpdateListView({context:updates.context,collection:updates});view.render();view.handleRefresh()},createMicroblog:function(contextKey){generalService.getContext(contextKey,this.showCreateMicroblog)},showCreateMicroblog:function(context){new UpdateCreateView({context:context}).render()},getMicroblog:function(microblogKey){var parts=microblogKey.split(":");updateService.getMicroblog(parts[1],this.showMicroblog,true)},showMicroblog:function(microblog){var view=new CommentListView({back:{code:"m_btn_updates",link:"#updates/"+microblog.getContext().getKey()},title:microblog.format(messages.messages[microblog.get("messageCode")]),collection:new Backbone.Collection([microblog]),onDelete:function(target,onDeleted){generalService.deleteModel(target,onDeleted);if(!target.reply){updateService.getUpdates(target.getContext().getKey(),function(updates){updates.remove(target,{silent:true})})}},onReply:function(microblog){appContext.navigate("#microblog/"+microblog.getKey()+"/create")}});view.render()},createMicroblogReply:function(microblogKey){var parts=microblogKey.split(":");updateService.getMicroblog(parts[1],this.showCreateMicroblogReply)},showCreateMicroblogReply:function(microblog){new UpdateReplyView({context:microblog.getContext(),update:microblog}).render()}})});define("api/model/permission",["api/model/base"],function(BaseModel){return BaseModel.extend({initialize:function(attributes,options){this.context=options.context},url:function(){return this.context.url()+"/permission"},canEdit:function(){return(18&this.get("mask"))>0},canCreate:function(){return(20&this.get("mask"))>0}})});define("api/service/base",["ext/underscore","api/model/permission"],function(_,Permission){return{getCollection:function(collection,handler){collection.once("sync",function(){handler(collection)});collection.fetch()},getPermission:function(model,handler){if(model.permission){handler(model)}else{var permission=new Permission({},{context:model});permission.once("sync",function(){model.permission=permission;handler(model)});permission.fetch()}}}});define("api/collection/more",["ext/underscore","api/collection/base"],function(_,BaseCollection){return BaseCollection.extend({initialize:function(models,options){if(options){this.params=options.params}this.params=this.params||{}},parse:function(response){this.more=response.nextPage;return response.page}})});define("api/collection/files",["api/collection/more","api/model/file"],function(MoreCollection,File){return MoreCollection.extend({model:File,initialize:function(models,options){MoreCollection.prototype.initialize.apply(this,arguments);if(options){this.context=options.context}},url:function(){var base="/groups/@"+this.getGroup().id+"/files";if(this.context.type=="group"){return base}var id=this.context.id?"@"+this.context.id:this.context.get("name");return base+"/"+id},_getKey:function(key){return key+":"+this.params.orderBy},parse:function(response){if(this.context.type=="file"){response=response.children}this.more=response.nextPage;return response.page},getGroup:function(){if(this.context.type=="group"){return this.context}return this.context.get("group")}})});define("api/service/file",["ext/underscore","app-context","api/cache","api/service/base","api/service/general","api/collection/files","api/model/file"],function(_,appContext,cache,base,service,Files,File){return _.extend({getFiles:function(contextKey,handler,force){var self=this;this.getContextWithPermission(contextKey,function(context){var files=new Files([],{context:context,params:self.createFileParams(1)});if(!force){files=cache.getFrom(files);if(files){handler(files);return}}self.getCollection(files,function(files){cache.putModel(files);files.each(function(file){cache.putModel(file)});handler(files)})})},getCachedFiles:function(contextKey,handler){var self=this;this.getContextWithPermission(contextKey,function(context){var files=new Files([],{context:context,params:self.createFileParams(1)});handler(cache.getFrom(files))})},getContextWithPermission:function(contextKey,handler){var self=this;this.getContext(contextKey,function(context){self.getPermission(context,handler)})},getContext:function(contextKey,handler){var parts=contextKey.split(":");if(parts.length==2){service.getGroup(parseInt(parts[1].substr(1)),handler)}else{this.getFile({id:parts[1].substr(1)},parts[3],handler)}},getNextFiles:function(files,handler){var next=new Files([],{context:files.context,params:this.createFileParams(files.params.currentPage+1)});this.getCollection(next,function(next){files.add(next.models);files.params.currentPage=next.params.currentPage;files.more=next.more;handler(next)})},getFile:function(group,id,handler){var file=new File({name:id});if(id.charAt(0)=="@"){file=new File({id:parseInt(id.slice(1))})}file.set("group",group);file.params=this.createFileParams(1);file=cache.getFrom(file);if(file._expiry){handler(file);return}var self=this;file.once("change",function(){cache.putModel(file);if(file.isFolder()){self.getPermission(file,handler)}else{handler(file)}});file.fetch()},createFileParams:function(currentPage){var orderBy=appContext.getFileSort();return{currentPage:currentPage,pageSize:appContext.pageSize,orderBy:orderBy,ascending:orderBy=="name"}}},base)});define("text!text/file/item.html",[],function(){return"<a href=\"#file/<%= getKey() %>\">\n	<img src=\"<%= appurl %>/svg/<%= getExtension() %>.svg\" onerror='this.onerror = null; this.src=\"<%= appurl %>/svg/file.svg\"'>\n	<p><b><%= get('friendlyName') %></b></p>\n	<abbr><%= m_last_updated %>: <%= $.timeago(new Date(get('lastModified'))) %></abbr>\n</a>\n"});define("view/file/item",["view/base","text!text/file/item.html"],function(BaseView,template){return BaseView.extend({tagName:"li",className:"fat",render:function(){this.$el.html(this.template(template,this.model));return this}})});define("view/file/list",["ext/underscore","api/service/file","view/navbar-factory","view/extending-list","view/file/item"],function(_,service,navbarFactory,ExtendingListView,FileItemView){return ExtendingListView.extend({initialize:function(){ExtendingListView.prototype.initialize.apply(this,arguments);this.title=_.escape(this.collection.context.get("friendlyName"));this.back=this.options.back;this.action=this.options.action},emptyMsgCode:"m_files_nothing",itemViewClass:FileItemView,handleEndOfList:function(){service.getNextFiles(this.collection,this.renderPage)},handleRefresh:function(){var self=this;service.getFiles(this.collection.context.getKey(),function(files){self.collection=files;self.refresh()},true)},navbar:function(callback){this.navbarCreate("files",this.collection.getGroup().id,callback)}}).extend(navbarFactory)});define("text!text/sort_action.html",[],function(){return'<div>\n	<input type="radio" name="sort_by" id="lastModified" value="lastModified" \n		<% if (sort == \'lastModified\') { print(\'checked\') } %> >\n	<label for="lastModified"><%= m_actions_sort_latest %></label>\n</div>\n<div>\n	<input type="radio" name="sort_by" id="name" value="name" \n		<% if (sort == \'name\') { print(\'checked\') } %> >\n	<label for="name"><%= m_actions_sort_name %></label>\n</div>\n'});define("view/sort_action",["view/dialog","text!text/sort_action.html"],function(DialogView,template){return DialogView.extend({className:"choice-list",title:DialogView.message("m_actions_sort_header"),events:{"change input[type=radio]":"select"},render:function(){DialogView.prototype.render.apply(this,arguments);this.$el.html(this.template(template,this.options));return this},doAction:function(){this.render()},select:function(event){this.callback(this.options.context,event.target.value)}})});define("text!text/file/upload.html",[],function(){return'<ul>\n	<li>\n		<span class="btn btn-success add" id="complex-flash-wrapper">\n			<%= m_file_upload_add %>\n		</span>\n		<input type="file" name="file" multiple />\n	</li>\n	<li><a href="javascript:void(0)" class="btn btn-primary upload-all"><%= m_file_upload_start %></a></li>\n	<li><a href="javascript:void(0)" class="btn btn-default cancel-all"><%= m_file_upload_cancel %></a></li>\n</ul>\n<table class="table">\n	<tbody>\n		<tr class="template">\n			<td class="name">&nbsp;</td>\n			<td class="size">&nbsp;</td>\n			<td class="progress-container">\n				<div class="progress progress-striped">\n					<div class="progress-bar">&nbsp;</div>\n				</div>\n			</td>\n			<td class="buttons">\n				<a href="javascript:void(0)" class="btn btn-xs btn-primary submit"><%= m_file_upload_upload %></a>\n				<a href="javascript:void(0)" class="btn btn-xs btn-primary retry"><%= m_file_upload_retry %></a>\n				<a href="javascript:void(0)" class="btn btn-xs btn-danger cancel"><%= m_file_upload_stop %></a>\n				<a href="javascript:void(0)" class="btn btn-xs btn-default remove"><%= m_file_upload_remove %></a>\n			</td>\n		</tr>\n	</tbody>\n</table>\n'});define("view/file/upload",["view/dialog","app-context","text!text/file/upload.html"],function(DialogView,appContext,template){var $=jQuery;return DialogView.extend({tagName:"form",className:"upload-container",title:DialogView.message("m_file_upload_header"),events:{"click a.cancel-all":"cancel"},initialize:function(options){DialogView.prototype.initialize.apply(this,arguments);this.options.width="600px"},doAction:function(){$(".modal").on("hidden.bs.modal",this.close);var endpoint=this.getEndpoint();if(this.options.context.type=="file"){endpoint+="/"+this.options.context.id}$.get(appContext.fullUrl(endpoint+"/index"),this.retrievePath)},retrievePath:function(index){this.index=JSON.parse($.base64.atob(index));if(this.options.context.type=="file"){if(this.index.fileSystem.length==0){var endpoint=this.options.context.url()+"path";$.get(appContext.fullUrl(endpoint),this.setPath)}else{var aFile=this.index.fileSystem[0];this.setPath(aFile.substring(1,aFile.lastIndexOf("/")))}}else{this.render()}},setPath:function(path){this.path=path;this.render()},render:function(){DialogView.prototype.render.apply(this,arguments);this.$el.html(this.template(template));var endpoint=appContext.resolveEndPoint()+this.getEndpoint();var path="";if(this.path){path="&path="+encodeURIComponent(this.path)}var token=appContext.getAccessToken().access_token;this.$el.fileupload({beforeFinalSend:this.beforeFinalSend,chunkEndpoint:endpoint+"/upload/data?access_token="+token,finalEndpoint:endpoint+"/upload/complete?success=True&access_token="+token+"&forwardContext="+encodeURIComponent(endpoint)+path,layout:"Complex",ajaxLoader:appContext.getAppUrl()+"/styles/images/ajax-loader.gif",defaultContentType:"application/json; charset=UTF-8",fileComplete:this.message("m_file_upload_success"),filefinish:this.filefinish});return this},beforeFinalSend:function(xhr,options){xhr.setRequestHeader("X-File-Id",options.file.fuid);xhr.setRequestHeader("X-File-Name",options.file.name);xhr.setRequestHeader("X-File-Size",options.file.size);xhr.setRequestHeader("X-File-Type",options.file.type);var data={sharing:"MEMBERS",memberPermission:8};var file=this.index.metadata["/"+(this.path?this.path+"/":"")+options.file.name];if(file){data.id=file.ID}options.data=JSON.stringify(data)},filefinish:function(file,success,isError){if(isError){var bar=$("tr#file_"+file.fuid+" .progress-bar",this.$el);bar.text(this.message("m_file_upload_failure"))}},getEndpoint:function(){var context=this.options.context;var group=context.toJSON();if(context.type=="file"){group=context.get("group")}var accountId=group.contextKey.parent.objectId;return"/v2/accounts/"+accountId+"/groups/"+group.id+"/files"},cancel:function(){$(".modal").modal("hide")},close:function(){$(".modal").off("hidden.bs.modal",this.close);this.options.callback(this.options.context)}})});define("text!text/file/native-item.html",[],function(){return"<a class='item' href=\"javascript:void(0)\">\n	<img src=\"<%= appurl %>/svg/<%= extension %>.svg\" onerror='this.onerror = null; this.src=\"<%= appurl %>/svg/file.svg\"'>\n	<%= _.escape(file.name) %>\n</a>\n<div class='item progress hidden'>\n	<div class='progress-bar progress-bar-striped progress-bar-info'></div>\n</div>\n<div class='item failure hidden'>\n	<div class='progress-bar progress-bar-striped progress-bar-danger'>\n		<span><%= m_file_native_failure %></span>\n	</div>\n</div>\n<div class='item success hidden'>\n	<div class='progress-bar progress-bar-striped progress-bar-success'>\n		<span><b><%= _.escape(file.name) %></b><%= m_file_native_success %></span>\n	</div>\n</div>\n"});define("view/file/native-item",["ext/underscore","view/base","native","app-context","api/service/file","text!text/file/native-item.html"],function(_,BaseView,native,appContext,service,template){return BaseView.extend({tagName:"li",className:"native-item",events:{"click .failure, a":"select","click .success":"dismiss"},initialize:function(options){_.bindToMethods(this);this.options=options},render:function(){var args=_.extend({extension:this.getExtension(this.options.file)},this.options);this.$el.html(this.template(template,args));return this},getExtension:function(file){if(file.folder){return"folder"}var extensionPos=file.name.lastIndexOf(".");if(file.name.lastIndexOf("/")>extensionPos){return""}return file.name.substring(extensionPos+1).toLowerCase()},dismiss:function(){$(".item",this.$el).addClass("hidden");$("a",this.$el).removeClass("hidden")},select:function(){if(this.options.list.uploading){return}if(this.options.file.folder){var path=(this.options.path?this.options.path+"/":"")+this.options.file.name;var link="#native/"+this.options.context.getKey()+"/"+encodeURIComponent(path);appContext.navigate(link,true)}else{var self=this;this.retrievePath(function(path){self.retrieveFileId(path,function(fileId){self.upload(path,fileId)})});$(".item",this.$el).addClass("hidden");$(".progress",this.$el).removeClass("hidden")}},retrievePath:function(handler){if(this.options.context.type=="file"){$.get(appContext.fullUrl(this.options.context.url()+"path"),handler)}else{handler(null)}},retrieveFileId:function(path,handler){var endpoint=this.getEndpoint();
if(this.options.context.type=="file"){endpoint+="/"+this.options.context.id}var self=this;$.get(appContext.fullUrl(endpoint+"/index"),function(index){index=JSON.parse($.base64.atob(index));var existing=index.metadata["/"+(path?path+"/":"")+self.options.file.name];var fileId=null;if(existing){fileId=existing.ID}handler(fileId)})},upload:function(path,fileId){var file=(this.options.path?this.options.path+"/":"")+this.options.file.name;this.options.list.uploading=true;var token=appContext.getAccessToken().access_token;var endpoint=appContext.resolveEndPoint()+this.getEndpoint();native.upload(file,endpoint,token,path,fileId,this.progress)},getEndpoint:function(){var context=this.options.context;var group=context.toJSON();if(context.type=="file"){group=context.get("group")}var accountId=group.contextKey.parent.objectId;return"/v2/accounts/"+accountId+"/groups/"+group.id+"/files"},progress:function(percent){if(percent==-1){this.finish();$(".failure",this.$el).removeClass("hidden")}else if(percent==100){this.finish();$(".success",this.$el).removeClass("hidden")}else{$(".progress-bar-info",this.$el).css("width",percent+"%").html("<span>"+percent+"%</span>")}},finish:function(){this.options.list.uploading=false;$(".item",this.$el).addClass("hidden");$(".progress-bar-info",this.$el).css("width",0).html("")}})});define("view/file/native-list",["ext/underscore","view/page","view/file/native-item"],function(_,PageView,NativeItemView){return PageView.extend({tagName:"ul",className:"list-unstyled",title:PageView.message("m_file_native_header"),nosearch:true,initialize:function(options){PageView.prototype.initialize.apply(this,arguments);this.action={code:"m_cancel",link:"#files/"+this.options.context.getKey()};if(this.options.path){this.title=this.options.path;var path="";var last=this.options.path.lastIndexOf("/");if(last!=-1){path=this.options.path.substr(0,last);path="/"+encodeURIComponent(path);this.title=this.options.path.substr(last+1)}this.back={code:"m_back",link:"#native/"+this.options.context.getKey()+path}}},render:function(){PageView.prototype.render.apply(this,arguments);_.each(this.options.files,function(file){var view=new NativeItemView({list:this,context:this.options.context,path:this.options.path,file:file});this.$el.append(view.render().el)},this);return this}})});define("text!text/file/view.html",[],function(){return"<% if (type == 'image') { %>\n	<img class=\"sized\" src=\"<%= preview %>\">\n<% } %>\n<div class=\"entity-info\" >\n	<p><%= m_file_uploader %>: <%= model.get('uploaded').name %></p>\n	<p>\n		<img src=\"<%= cdn %>/users/<%= model.get('uploaded').id %>/thumbnail\" \n			onerror='this.onerror = null; this.src=\"<%= appurl %>/styles/images/default_thumbnail.png\"'>\n	</p>\n	<p><%= m_on %>: <%= moment(model.get('lastModified')).format('ddd, DD MMM YYYY, HH:mm') %></p>\n	<p><%= m_version %>: <%= model.get('versions') %></p>\n	<p><%= m_size %>: <%= size %></p>\n	<p>\n		<img src=\"<%= appurl %>/svg/<%= model.getExtension() %>.svg\" \n			onerror='this.onerror = null; this.src=\"<%= appurl %>/svg/file.svg\"'>\n	</p>\n	<% if (type != 'document' && type != 'image') { %>\n		<p><%= m_file_preview_failed %></p>\n	<% } %>\n</div>\n<% if (download) { %>\n	<a href=\"<%= download %>\" class=\"btn btn-primary download\">\n		<%= m_download %>\n	</a>\n<% } %>\n<% if (type == 'document') { %>\n	<a href=\"javascript:void(0)\" class=\"btn btn-primary preview\">\n		<%= m_preview %>\n	</a>\n<% } %>\n"});define("view/file/view",["ext/underscore","native","view/page","moment","app-context","view/navbar-factory","text!text/file/view.html"],function(_,native,PageView,moment,appContext,navbarFactory,template){return PageView.extend({KB:1024,MB:1024*1024,GB:1024*1024*1024,tagName:"fieldset",events:{"click a.preview":"preview"},initialize:function(options){PageView.prototype.initialize.apply(this,arguments);this.back=this.options.back;this.title=this.model.get("friendlyName");this.action={code:"m_comments",link:"#comments/"+this.model.getKey()}},render:function(){PageView.prototype.render.apply(this,arguments);var args={type:this.options.type,model:this.model,size:this.formatSize(),cdn:appContext.cdn,download:native.list&&!native.upload?appContext.fullUrl(this.model.url()+"download"):null,preview:appContext.fullUrl(this.model.url()+"preview")};this.$el.html(this.template(template,args));return this},formatSize:function(){var size=this.model.get("size");var unit="bytes";var divisor=1;if(size>this.GB){unit="GB";divisor=this.GB}else if(size>this.MB){unit="MB";divisor=this.MB}else if(size>this.KB){unit="KB";divisor=this.KB}return Math.round(size*10/divisor)/10+" "+unit},navbar:function(callback){this.navbarCreate("files",this.model.getGroup().id,callback)},preview:function(){appContext.preview(this.model,this.options.type=="document")}}).extend(navbarFactory)});define("router/file",["ext/underscore","app-context","api/cache","native","router/base","api/service/file","api/collection/files","view/file/list","view/sort_action","view/file/upload","view/file/native-list","view/file/view"],function(_,appContext,cache,native,BaseRouter,service,Files,FileListView,SortActionView,FileUploadView,NativeListView,FileViewView){return BaseRouter.extend({routes:{"files/:contextKey":"getFiles","file/:fileKey":"getFile","native/:contextKey/:path":"getNative","native/:contextKey":"getNative"},getFiles:function(contextKey){service.getCachedFiles(contextKey,this.showFiles)},showFiles:function(files){var view=this.createFileListView(files.context,files);view.render();view.handleRefresh()},getFile:function(fileKey){var parts=fileKey.split(":");var group={id:parseInt(parts[1].substr(1))};service.getFile(group,parts[3],this.handleFile)},handleFile:function(file){if(file.isFolder()){var children=file.get("children");if(children){var files=new Files(children.page,{context:file,params:service.createFileParams(1)});files.more=children.nextPage;cache.putModel(files);files.each(function(file){cache.putModel(file)});var view=this.createFileListView(file,files);view.render()}else{this.getFiles(file.getKey())}}else{this.showFile(file)}},showFile:function(file){var type=this.getFileType(file);var view=new FileViewView({back:this.createFileBack(file),model:file,type:type});if(type=="unknown"||type=="image"||native.popupPreview){view.render()}else{appContext.setHeader(view);_.defer(function(){appContext.preview(file,type=="document")})}},getFileType:function(file){var contentType=file.get("contentType");if(_.startsWith(contentType,"image/")){return"image"}if(_.startsWith(contentType,"video/")){return"video"}if(_.startsWith(contentType,"audio/")&&native.audioPreview){return"video"}if(_.find(appContext.mimetypes,function(mimetype){return this==mimetype},contentType)){return"document"}return"unknown"},createFileListView:function(context,collection){var canCreate=context.permission.canCreate();if(native.upload&&canCreate){var action={code:"m_actions_upload",link:"#native/"+context.getKey()}}else if(native.list&&canCreate){var action={code:"m_actions_upload",view:new FileUploadView({context:context,callback:this.refresh})}}else{var action={code:"m_actions_sort",view:new SortActionView({context:context,sort:appContext.getFileSort(),callback:this.sortFiles})}}return new FileListView({back:this.createFileBack(context),action:action,collection:collection})},sortFiles:function(context,field){appContext.setFileSort(field);this.refresh(context)},refresh:function(context){appContext.navigate("#files/"+context.getKey(),true)},createFileBack:function(context){if(context.type=="group"){return{code:"m_btn_context",link:"#context"}}var parent=context.get("parent");if(parent.type=="group"){return{code:"m_btn_files",link:"#files/groups:@"+parent.id}}return{code:"m_back",link:"#file/groups:@"+context.get("group").id+":files:@"+parent.id}},getNative:function(contextKey,path){service.getContext(contextKey,function(context){native.list(path,function(files){var view=new NativeListView({context:context,path:path,files:files});view.render()})})}})});define("router/group",["router/base","api/cache","api/model/group","api/model/permission"],function(BaseRouter,cache,Group,Permission){return BaseRouter.extend({execute:function(callback,args){var groupId=this.getGroupId(args);if(groupId){args.unshift(cache.getFrom(new Group({id:groupId})));this.retrieveGroupWithPermission(callback,args)}else{callback.apply(this,args)}},getGroupId:function(args){if(args.length>0){var key=args[0].split(":");if(key.length==2&&key[0]=="groups"){return key[1].substr(1)}}return null},retrieveGroupWithPermission:function(callback,args){var group=args[0];this.retrieveGroup(group,function(){if(group.permission){callback.apply(self,args)}else{var permission=new Permission({},{context:group});permission.once("sync",function(){group.permission=permission;callback.apply(self,args)});permission.fetch()}})},retrieveGroup:function(group,handler){if(group.get("components")){handler()}else{group.once("change",function(){cache.putModel(group);handler()});group.fetch()}}})});define("api/collection/content",["api/collection/more","api/model/file"],function(MoreCollection,File){return MoreCollection.extend({initialize:function(models,options){MoreCollection.prototype.initialize.apply(this,arguments);if(options){this.group=options.group}},url:function(){return"/groups/@"+this.group.id+"/"+this.model.type+"s"}})});define("api/collection/notes",["api/collection/content","api/model/note"],function(ContentCollection,Note){return ContentCollection.extend({model:Note,_getKey:function(key){return key+":"+this.params.orderBy}})});define("api/service/note",["ext/underscore","app-context","api/cache","api/service/base","api/collection/notes","api/model/note"],function(_,appContext,cache,base,Notes,Note){return _.extend({getPages:function(group,handler){var pages=this.createPages(group,1);cache.putModel(pages);this.getCollection(pages,handler)},getNextPages:function(pages,handler){var next=this.createPages(pages.group,pages.params.currentPage+1);this.getCollection(next,function(next){pages.add(next.models);pages.params.currentPage=next.params.currentPage;pages.more=next.more;handler(next)})},getPage:function(group,id,handler){var page=new Note({name:id});if(id.charAt(0)=="@"){page=new Note({id:parseInt(id.slice(1))})}page.set("group",group);page=cache.getFrom(page);if(page._expiry&&page.get("content")){handler(page);return}cache.putModel(page);page.once("change",handler);page.fetch()},createPages:function(group,currentPage){var orderBy=appContext.getNoteSort();return new Notes([],{group:group,params:{type:"page",currentPage:currentPage,pageSize:appContext.pageSize,orderBy:orderBy,ascending:orderBy=="name"}})}},base)});define("text!text/note_item.html",[],function(){return"<a class=\"no-icon\" href=\"#page/<%= getKey() %>\">\n	<p><b><%= _.escape(get('friendlyName')) %></b></p>\n	<abbr><%= m_last_updated %>: <%= $.timeago(new Date(get('lastModified'))) %></abbr>\n</a>\n"});define("view/note/item",["view/base","text!text/note_item.html"],function(BaseView,template){return BaseView.extend({tagName:"li",className:"fat",render:function(){this.$el.html(this.template(template,this.model));return this}})});define("view/note/list",["ext/underscore","app-context","view/navbar-factory","view/extending-list","view/sort_action","view/note/item","api/service/note"],function(_,appContext,navbarFactory,ExtendingListView,SortActionView,NoteItemView,service){return ExtendingListView.extend({back:{code:"m_btn_context",link:"#context"},initialize:function(){ExtendingListView.prototype.initialize.apply(this,arguments);this.title=_.escape(this.collection.group.get("friendlyName"));this.action={code:"m_actions_sort",view:new SortActionView({context:this.collection.group,sort:appContext.getNoteSort(),callback:this.sortNotes})}},sortNotes:function(context,field){appContext.setNoteSort(field);appContext.navigate("#pages/"+context.getKey(),true)},emptyMsgCode:"m_pages_nothing",itemViewClass:NoteItemView,handleEndOfList:function(){service.getNextPages(this.collection,this.renderPage)},handleRefresh:function(){var self=this;service.getPages(this.collection.group,function(pages){self.collection=pages;self.refresh()})},navbar:function(callback){this.navbarCreate("pages",this.collection.group.id,callback)}}).extend(navbarFactory)});define("api/model/attachment",["api/model/base"],function(BaseModel){return BaseModel.extend({url:function(){var container=this.get("parent");var id=this.id?"@"+this.id:this.get("name");return"/groups/@"+container.group.id+"/"+container.type+"s/@"+container.id+"/attachments/"+id+"/"}})});define("view/link-resolver",["ext/underscore","app-context","api/factory","api/model/attachment"],function(_,appContext,factory,Attachment){var $=jQuery;var linkResolver={handleImage:function(element,parts){element.src=appContext.fullUrl("/groups/@"+this.model.getGroup().id+"/pages/"+this.model.get("name")+"/attachments/"+parts[0]+"/preview")},handleDocument:function(element,parts){var link=$("<a>").attr("href","javascript:void(0)").html(parts[0]).click(_.bind(this.showAttachment,this,parts[0]));$(element).replaceWith(link)},showAttachment:function(fileName){var attachment=new Attachment({name:fileName,parent:this.model.toJSON()});attachment.on("change",function(){appContext.preview(this)});attachment.fetch()},handleVideo:function(element){element.src=appContext.getAppUrl()+"/styles/images/video_preview.png"},handleLinks:function(element,parts){if(parts[0]=="url"){$(element).attr("data-external",true);return}var entity=factory.createEntity({type:parts[0],group:this.model.getGroup().toJSON(),name:parts[1]});if(entity){element.href="#"+parts[0]+"/"+entity.getKey()}else{$(element).removeAttr("href")}},resolveLinks:function(){_.each($("[media_link]",this.$el),function(element){var parts=$(element).attr("media_link").split(":");var handler=this.handlers[parts[0]];handler&&handler.apply(this,[element,_.rest(parts)])},this)}};linkResolver.handlers={attachment:linkResolver.handleImage,attachment_document:linkResolver.handleDocument,video:linkResolver.handleVideo,attachment_video:linkResolver.handleVideo,link:linkResolver.handleLinks};return linkResolver});(function(window,doc){var m=Math,dummyStyle=doc.createElement("div").style,vendor=function(){var vendors="t,webkitT,MozT,msT,OT".split(","),t,i=0,l=vendors.length;for(;i<l;i++){t=vendors[i]+"ransform";if(t in dummyStyle){return vendors[i].substr(0,vendors[i].length-1)}}return false}(),cssVendor=vendor?"-"+vendor.toLowerCase()+"-":"",transform=prefixStyle("transform"),transitionProperty=prefixStyle("transitionProperty"),transitionDuration=prefixStyle("transitionDuration"),transformOrigin=prefixStyle("transformOrigin"),transitionTimingFunction=prefixStyle("transitionTimingFunction"),transitionDelay=prefixStyle("transitionDelay"),isAndroid=/android/gi.test(navigator.appVersion),isIDevice=/iphone|ipad/gi.test(navigator.appVersion),isTouchPad=/hp-tablet/gi.test(navigator.appVersion),has3d=prefixStyle("perspective")in dummyStyle,hasTouch="ontouchstart"in window&&!isTouchPad,hasTransform=vendor!==false,hasTransitionEnd=prefixStyle("transition")in dummyStyle,RESIZE_EV="onorientationchange"in window?"orientationchange":"resize",START_EV=hasTouch?"touchstart":"mousedown",MOVE_EV=hasTouch?"touchmove":"mousemove",END_EV=hasTouch?"touchend":"mouseup",CANCEL_EV=hasTouch?"touchcancel":"mouseup",WHEEL_EV=vendor=="Moz"?"DOMMouseScroll":"mousewheel",TRNEND_EV=function(){if(vendor===false)return false;var transitionEnd={"":"transitionend",webkit:"webkitTransitionEnd",Moz:"transitionend",O:"otransitionend",ms:"MSTransitionEnd"};return transitionEnd[vendor]}(),nextFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){return setTimeout(callback,1)}}(),cancelFrame=function(){return window.cancelRequestAnimationFrame||window.webkitCancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||clearTimeout}(),translateZ=has3d?" translateZ(0)":"",iScroll=function(el,options){var that=this,i;that.wrapper=typeof el=="object"?el:doc.getElementById(el);that.wrapper.style.overflow="hidden";that.scroller=that.wrapper.children[0];that.options={hScroll:true,vScroll:true,x:0,y:0,bounce:true,bounceLock:false,momentum:true,lockDirection:true,useTransform:true,useTransition:false,topOffset:0,checkDOMChanges:false,handleClick:true,hScrollbar:true,vScrollbar:true,fixedScrollbar:isAndroid,hideScrollbar:isIDevice,fadeScrollbar:isIDevice&&has3d,scrollbarClass:"",zoom:false,zoomMin:1,zoomMax:4,doubleTapZoom:2,wheelAction:"scroll",snap:false,snapThreshold:1,onRefresh:null,onBeforeScrollStart:function(e){e.preventDefault()},onScrollStart:null,onBeforeScrollMove:null,onScrollMove:null,onBeforeScrollEnd:null,onScrollEnd:null,onTouchEnd:null,onDestroy:null,onZoomStart:null,onZoom:null,onZoomEnd:null};for(i in options)that.options[i]=options[i];that.x=that.options.x;that.y=that.options.y;that.options.useTransform=hasTransform&&that.options.useTransform;that.options.hScrollbar=that.options.hScroll&&that.options.hScrollbar;that.options.vScrollbar=that.options.vScroll&&that.options.vScrollbar;that.options.zoom=that.options.useTransform&&that.options.zoom;that.options.useTransition=hasTransitionEnd&&that.options.useTransition;if(that.options.zoom&&isAndroid){translateZ=""}that.scroller.style[transitionProperty]=that.options.useTransform?cssVendor+"transform":"top left";that.scroller.style[transitionDuration]="0";that.scroller.style[transformOrigin]="0 0";if(that.options.useTransition)that.scroller.style[transitionTimingFunction]="cubic-bezier(0.33,0.66,0.66,1)";if(that.options.useTransform)that.scroller.style[transform]="translate("+that.x+"px,"+that.y+"px)"+translateZ;else that.scroller.style.cssText+=";position:absolute;top:"+that.y+"px;left:"+that.x+"px";if(that.options.useTransition)that.options.fixedScrollbar=true;that.refresh();that._bind(RESIZE_EV,window);that._bind(START_EV);if(!hasTouch){if(that.options.wheelAction!="none")that._bind(WHEEL_EV)}if(that.options.checkDOMChanges)that.checkDOMTime=setInterval(function(){that._checkDOMChanges()},500)};iScroll.prototype={enabled:true,x:0,y:0,steps:[],scale:1,currPageX:0,currPageY:0,pagesX:[],pagesY:[],aniTime:null,wheelZoomCount:0,handleEvent:function(e){var that=this;switch(e.type){case START_EV:if(!hasTouch&&e.button!==0)return;that._start(e);break;case MOVE_EV:that._move(e);break;case END_EV:case CANCEL_EV:that._end(e);break;case RESIZE_EV:that._resize();break;case WHEEL_EV:that._wheel(e);break;case TRNEND_EV:that._transitionEnd(e);break}},_checkDOMChanges:function(){if(this.moved||this.zoomed||this.animating||this.scrollerW==this.scroller.offsetWidth*this.scale&&this.scrollerH==this.scroller.offsetHeight*this.scale)return;this.refresh()},_scrollbar:function(dir){var that=this,bar;if(!that[dir+"Scrollbar"]){if(that[dir+"ScrollbarWrapper"]){if(hasTransform)that[dir+"ScrollbarIndicator"].style[transform]="";that[dir+"ScrollbarWrapper"].parentNode.removeChild(that[dir+"ScrollbarWrapper"]);that[dir+"ScrollbarWrapper"]=null;that[dir+"ScrollbarIndicator"]=null}return}if(!that[dir+"ScrollbarWrapper"]){bar=doc.createElement("div");if(that.options.scrollbarClass)bar.className=that.options.scrollbarClass+dir.toUpperCase();else bar.style.cssText="position:absolute;z-index:100;"+(dir=="h"?"height:7px;bottom:1px;left:2px;right:"+(that.vScrollbar?"7":"2")+"px":"width:7px;bottom:"+(that.hScrollbar?"7":"2")+"px;top:2px;right:1px");bar.style.cssText+=";pointer-events:none;"+cssVendor+"transition-property:opacity;"+cssVendor+"transition-duration:"+(that.options.fadeScrollbar?"350ms":"0")+";overflow:hidden;opacity:"+(that.options.hideScrollbar?"0":"1");that.wrapper.appendChild(bar);that[dir+"ScrollbarWrapper"]=bar;bar=doc.createElement("div");if(!that.options.scrollbarClass){bar.style.cssText="position:absolute;z-index:100;background:rgba(0,0,0,0.5);border:1px solid rgba(255,255,255,0.9);"+cssVendor+"background-clip:padding-box;"+cssVendor+"box-sizing:border-box;"+(dir=="h"?"height:100%":"width:100%")+";"+cssVendor+"border-radius:3px;border-radius:3px"}bar.style.cssText+=";pointer-events:none;"+cssVendor+"transition-property:"+cssVendor+"transform;"+cssVendor+"transition-timing-function:cubic-bezier(0.33,0.66,0.66,1);"+cssVendor+"transition-duration:0;"+cssVendor+"transform: translate(0,0)"+translateZ;if(that.options.useTransition)bar.style.cssText+=";"+cssVendor+"transition-timing-function:cubic-bezier(0.33,0.66,0.66,1)";that[dir+"ScrollbarWrapper"].appendChild(bar);that[dir+"ScrollbarIndicator"]=bar}if(dir=="h"){that.hScrollbarSize=that.hScrollbarWrapper.clientWidth;that.hScrollbarIndicatorSize=m.max(m.round(that.hScrollbarSize*that.hScrollbarSize/that.scrollerW),8);that.hScrollbarIndicator.style.width=that.hScrollbarIndicatorSize+"px";that.hScrollbarMaxScroll=that.hScrollbarSize-that.hScrollbarIndicatorSize;that.hScrollbarProp=that.hScrollbarMaxScroll/that.maxScrollX}else{that.vScrollbarSize=that.vScrollbarWrapper.clientHeight;that.vScrollbarIndicatorSize=m.max(m.round(that.vScrollbarSize*that.vScrollbarSize/that.scrollerH),8);that.vScrollbarIndicator.style.height=that.vScrollbarIndicatorSize+"px";that.vScrollbarMaxScroll=that.vScrollbarSize-that.vScrollbarIndicatorSize;that.vScrollbarProp=that.vScrollbarMaxScroll/that.maxScrollY}that._scrollbarPos(dir,true)},_resize:function(){var that=this;setTimeout(function(){that.refresh()},isAndroid?200:0)},_pos:function(x,y){if(this.zoomed)return;x=this.hScroll?x:0;y=this.vScroll?y:0;if(this.options.useTransform){this.scroller.style[transform]="translate("+x+"px,"+y+"px) scale("+this.scale+")"+translateZ}else{x=m.round(x);y=m.round(y);this.scroller.style.left=x+"px";this.scroller.style.top=y+"px"}this.x=x;this.y=y;this._scrollbarPos("h");this._scrollbarPos("v")},_scrollbarPos:function(dir,hidden){var that=this,pos=dir=="h"?that.x:that.y,size;if(!that[dir+"Scrollbar"])return;pos=that[dir+"ScrollbarProp"]*pos;if(pos<0){if(!that.options.fixedScrollbar){size=that[dir+"ScrollbarIndicatorSize"]+m.round(pos*3);if(size<8)size=8;that[dir+"ScrollbarIndicator"].style[dir=="h"?"width":"height"]=size+"px"}pos=0}else if(pos>that[dir+"ScrollbarMaxScroll"]){if(!that.options.fixedScrollbar){size=that[dir+"ScrollbarIndicatorSize"]-m.round((pos-that[dir+"ScrollbarMaxScroll"])*3);if(size<8)size=8;that[dir+"ScrollbarIndicator"].style[dir=="h"?"width":"height"]=size+"px";pos=that[dir+"ScrollbarMaxScroll"]+(that[dir+"ScrollbarIndicatorSize"]-size)}else{pos=that[dir+"ScrollbarMaxScroll"]}}that[dir+"ScrollbarWrapper"].style[transitionDelay]="0";that[dir+"ScrollbarWrapper"].style.opacity=hidden&&that.options.hideScrollbar?"0":"1";that[dir+"ScrollbarIndicator"].style[transform]="translate("+(dir=="h"?pos+"px,0)":"0,"+pos+"px)")+translateZ},_start:function(e){var that=this,point=hasTouch?e.touches[0]:e,matrix,x,y,c1,c2;if(!that.enabled)return;if(that.options.onBeforeScrollStart)that.options.onBeforeScrollStart.call(that,e);if(that.options.useTransition||that.options.zoom)that._transitionTime(0);that.moved=false;that.animating=false;that.zoomed=false;that.distX=0;that.distY=0;that.absDistX=0;that.absDistY=0;that.dirX=0;that.dirY=0;if(that.options.zoom&&hasTouch&&e.touches.length>1){c1=m.abs(e.touches[0].pageX-e.touches[1].pageX);c2=m.abs(e.touches[0].pageY-e.touches[1].pageY);that.touchesDistStart=m.sqrt(c1*c1+c2*c2);that.originX=m.abs(e.touches[0].pageX+e.touches[1].pageX-that.wrapperOffsetLeft*2)/2-that.x;that.originY=m.abs(e.touches[0].pageY+e.touches[1].pageY-that.wrapperOffsetTop*2)/2-that.y;if(that.options.onZoomStart)that.options.onZoomStart.call(that,e)}if(that.options.momentum){if(that.options.useTransform){matrix=getComputedStyle(that.scroller,null)[transform].replace(/[^0-9\-.,]/g,"").split(",");x=+matrix[4];y=+matrix[5]}else{x=+getComputedStyle(that.scroller,null).left.replace(/[^0-9-]/g,"");y=+getComputedStyle(that.scroller,null).top.replace(/[^0-9-]/g,"")}if(x!=that.x||y!=that.y){if(that.options.useTransition)that._unbind(TRNEND_EV);else cancelFrame(that.aniTime);that.steps=[];that._pos(x,y);if(that.options.onScrollEnd)that.options.onScrollEnd.call(that)}}that.absStartX=that.x;that.absStartY=that.y;that.startX=that.x;that.startY=that.y;that.pointX=point.pageX;that.pointY=point.pageY;that.startTime=e.timeStamp||Date.now();if(that.options.onScrollStart)that.options.onScrollStart.call(that,e);that._bind(MOVE_EV,window);that._bind(END_EV,window);that._bind(CANCEL_EV,window)},_move:function(e){var that=this,point=hasTouch?e.touches[0]:e,deltaX=point.pageX-that.pointX,deltaY=point.pageY-that.pointY,newX=that.x+deltaX,newY=that.y+deltaY,c1,c2,scale,timestamp=e.timeStamp||Date.now();if(that.options.onBeforeScrollMove)that.options.onBeforeScrollMove.call(that,e);if(that.options.zoom&&hasTouch&&e.touches.length>1){c1=m.abs(e.touches[0].pageX-e.touches[1].pageX);c2=m.abs(e.touches[0].pageY-e.touches[1].pageY);that.touchesDist=m.sqrt(c1*c1+c2*c2);that.zoomed=true;scale=1/that.touchesDistStart*that.touchesDist*this.scale;if(scale<that.options.zoomMin)scale=.5*that.options.zoomMin*Math.pow(2,scale/that.options.zoomMin);else if(scale>that.options.zoomMax)scale=2*that.options.zoomMax*Math.pow(.5,that.options.zoomMax/scale);that.lastScale=scale/this.scale;newX=this.originX-this.originX*that.lastScale+this.x,newY=this.originY-this.originY*that.lastScale+this.y;this.scroller.style[transform]="translate("+newX+"px,"+newY+"px) scale("+scale+")"+translateZ;if(that.options.onZoom)that.options.onZoom.call(that,e);return}that.pointX=point.pageX;that.pointY=point.pageY;if(newX>0||newX<that.maxScrollX){newX=that.options.bounce?that.x+deltaX/2:newX>=0||that.maxScrollX>=0?0:that.maxScrollX}if(newY>that.minScrollY||newY<that.maxScrollY){newY=that.options.bounce?that.y+deltaY/2:newY>=that.minScrollY||that.maxScrollY>=0?that.minScrollY:that.maxScrollY}that.distX+=deltaX;that.distY+=deltaY;that.absDistX=m.abs(that.distX);that.absDistY=m.abs(that.distY);if(that.absDistX<6&&that.absDistY<6){return}if(that.options.lockDirection){if(that.absDistX>that.absDistY+5){newY=that.y;deltaY=0}else if(that.absDistY>that.absDistX+5){newX=that.x;deltaX=0}}that.moved=true;that._pos(newX,newY);that.dirX=deltaX>0?-1:deltaX<0?1:0;that.dirY=deltaY>0?-1:deltaY<0?1:0;if(timestamp-that.startTime>300){that.startTime=timestamp;that.startX=that.x;that.startY=that.y}if(that.options.onScrollMove)that.options.onScrollMove.call(that,e)},_end:function(e){if(hasTouch&&e.touches.length!==0)return;var that=this,point=hasTouch?e.changedTouches[0]:e,target,ev,momentumX={dist:0,time:0},momentumY={dist:0,time:0},duration=(e.timeStamp||Date.now())-that.startTime,newPosX=that.x,newPosY=that.y,distX,distY,newDuration,snap,scale;that._unbind(MOVE_EV,window);that._unbind(END_EV,window);that._unbind(CANCEL_EV,window);if(that.options.onBeforeScrollEnd)that.options.onBeforeScrollEnd.call(that,e);if(that.zoomed){scale=that.scale*that.lastScale;scale=Math.max(that.options.zoomMin,scale);scale=Math.min(that.options.zoomMax,scale);that.lastScale=scale/that.scale;that.scale=scale;that.x=that.originX-that.originX*that.lastScale+that.x;that.y=that.originY-that.originY*that.lastScale+that.y;that.scroller.style[transitionDuration]="200ms";that.scroller.style[transform]="translate("+that.x+"px,"+that.y+"px) scale("+that.scale+")"+translateZ;that.zoomed=false;that.refresh();if(that.options.onZoomEnd)that.options.onZoomEnd.call(that,e);return}if(!that.moved){if(hasTouch){if(that.doubleTapTimer&&that.options.zoom){clearTimeout(that.doubleTapTimer);that.doubleTapTimer=null;if(that.options.onZoomStart)that.options.onZoomStart.call(that,e);that.zoom(that.pointX,that.pointY,that.scale==1?that.options.doubleTapZoom:1);if(that.options.onZoomEnd){setTimeout(function(){that.options.onZoomEnd.call(that,e)},200)}}else if(this.options.handleClick){that.doubleTapTimer=setTimeout(function(){that.doubleTapTimer=null;target=point.target;while(target.nodeType!=1)target=target.parentNode;if(target.tagName!="SELECT"&&target.tagName!="INPUT"&&target.tagName!="TEXTAREA"){ev=doc.createEvent("MouseEvents");ev.initMouseEvent("click",true,true,e.view,1,point.screenX,point.screenY,point.clientX,point.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,0,null);ev._fake=true;target.dispatchEvent(ev)}},that.options.zoom?250:0)}}that._resetPos(400);if(that.options.onTouchEnd)that.options.onTouchEnd.call(that,e);return}if(duration<300&&that.options.momentum){momentumX=newPosX?that._momentum(newPosX-that.startX,duration,-that.x,that.scrollerW-that.wrapperW+that.x,that.options.bounce?that.wrapperW:0):momentumX;momentumY=newPosY?that._momentum(newPosY-that.startY,duration,-that.y,that.maxScrollY<0?that.scrollerH-that.wrapperH+that.y-that.minScrollY:0,that.options.bounce?that.wrapperH:0):momentumY;newPosX=that.x+momentumX.dist;newPosY=that.y+momentumY.dist;if(that.x>0&&newPosX>0||that.x<that.maxScrollX&&newPosX<that.maxScrollX)momentumX={dist:0,time:0};if(that.y>that.minScrollY&&newPosY>that.minScrollY||that.y<that.maxScrollY&&newPosY<that.maxScrollY)momentumY={dist:0,time:0}}if(momentumX.dist||momentumY.dist){newDuration=m.max(m.max(momentumX.time,momentumY.time),10);if(that.options.snap){distX=newPosX-that.absStartX;distY=newPosY-that.absStartY;if(m.abs(distX)<that.options.snapThreshold&&m.abs(distY)<that.options.snapThreshold){that.scrollTo(that.absStartX,that.absStartY,200)}else{snap=that._snap(newPosX,newPosY);newPosX=snap.x;newPosY=snap.y;newDuration=m.max(snap.time,newDuration)}}that.scrollTo(m.round(newPosX),m.round(newPosY),newDuration);if(that.options.onTouchEnd)that.options.onTouchEnd.call(that,e);return}if(that.options.snap){distX=newPosX-that.absStartX;distY=newPosY-that.absStartY;if(m.abs(distX)<that.options.snapThreshold&&m.abs(distY)<that.options.snapThreshold)that.scrollTo(that.absStartX,that.absStartY,200);else{snap=that._snap(that.x,that.y);if(snap.x!=that.x||snap.y!=that.y)that.scrollTo(snap.x,snap.y,snap.time)}if(that.options.onTouchEnd)that.options.onTouchEnd.call(that,e);return}that._resetPos(200);if(that.options.onTouchEnd)that.options.onTouchEnd.call(that,e)},_resetPos:function(time){var that=this,resetX=that.x>=0?0:that.x<that.maxScrollX?that.maxScrollX:that.x,resetY=that.y>=that.minScrollY||that.maxScrollY>0?that.minScrollY:that.y<that.maxScrollY?that.maxScrollY:that.y;if(resetX==that.x&&resetY==that.y){if(that.moved){that.moved=false;if(that.options.onScrollEnd)that.options.onScrollEnd.call(that)}if(that.hScrollbar&&that.options.hideScrollbar){if(vendor=="webkit")that.hScrollbarWrapper.style[transitionDelay]="300ms";that.hScrollbarWrapper.style.opacity="0"}if(that.vScrollbar&&that.options.hideScrollbar){if(vendor=="webkit")that.vScrollbarWrapper.style[transitionDelay]="300ms";that.vScrollbarWrapper.style.opacity="0"}return}that.scrollTo(resetX,resetY,time||0)},_wheel:function(e){var that=this,wheelDeltaX,wheelDeltaY,deltaX,deltaY,deltaScale;if("wheelDeltaX"in e){wheelDeltaX=e.wheelDeltaX/12;wheelDeltaY=e.wheelDeltaY/12}else if("wheelDelta"in e){wheelDeltaX=wheelDeltaY=e.wheelDelta/12}else if("detail"in e){wheelDeltaX=wheelDeltaY=-e.detail*3}else{return}if(that.options.wheelAction=="zoom"){deltaScale=that.scale*Math.pow(2,1/3*(wheelDeltaY?wheelDeltaY/Math.abs(wheelDeltaY):0));if(deltaScale<that.options.zoomMin)deltaScale=that.options.zoomMin;if(deltaScale>that.options.zoomMax)deltaScale=that.options.zoomMax;if(deltaScale!=that.scale){if(!that.wheelZoomCount&&that.options.onZoomStart)that.options.onZoomStart.call(that,e);that.wheelZoomCount++;that.zoom(e.pageX,e.pageY,deltaScale,400);setTimeout(function(){that.wheelZoomCount--;if(!that.wheelZoomCount&&that.options.onZoomEnd)that.options.onZoomEnd.call(that,e)},400)}return}deltaX=that.x+wheelDeltaX;deltaY=that.y+wheelDeltaY;if(deltaX>0)deltaX=0;else if(deltaX<that.maxScrollX)deltaX=that.maxScrollX;if(deltaY>that.minScrollY)deltaY=that.minScrollY;else if(deltaY<that.maxScrollY)deltaY=that.maxScrollY;
if(that.maxScrollY<0){that.scrollTo(deltaX,deltaY,0)}},_transitionEnd:function(e){var that=this;if(e.target!=that.scroller)return;that._unbind(TRNEND_EV);that._startAni()},_startAni:function(){var that=this,startX=that.x,startY=that.y,startTime=Date.now(),step,easeOut,animate;if(that.animating)return;if(!that.steps.length){that._resetPos(400);return}step=that.steps.shift();if(step.x==startX&&step.y==startY)step.time=0;that.animating=true;that.moved=true;if(that.options.useTransition){that._transitionTime(step.time);that._pos(step.x,step.y);that.animating=false;if(step.time)that._bind(TRNEND_EV);else that._resetPos(0);return}animate=function(){var now=Date.now(),newX,newY;if(now>=startTime+step.time){that._pos(step.x,step.y);that.animating=false;if(that.options.onAnimationEnd)that.options.onAnimationEnd.call(that);that._startAni();return}now=(now-startTime)/step.time-1;easeOut=m.sqrt(1-now*now);newX=(step.x-startX)*easeOut+startX;newY=(step.y-startY)*easeOut+startY;that._pos(newX,newY);if(that.animating)that.aniTime=nextFrame(animate)};animate()},_transitionTime:function(time){time+="ms";this.scroller.style[transitionDuration]=time;if(this.hScrollbar)this.hScrollbarIndicator.style[transitionDuration]=time;if(this.vScrollbar)this.vScrollbarIndicator.style[transitionDuration]=time},_momentum:function(dist,time,maxDistUpper,maxDistLower,size){var deceleration=6e-4,speed=m.abs(dist)/time,newDist=speed*speed/(2*deceleration),newTime=0,outsideDist=0;if(dist>0&&newDist>maxDistUpper){outsideDist=size/(6/(newDist/speed*deceleration));maxDistUpper=maxDistUpper+outsideDist;speed=speed*maxDistUpper/newDist;newDist=maxDistUpper}else if(dist<0&&newDist>maxDistLower){outsideDist=size/(6/(newDist/speed*deceleration));maxDistLower=maxDistLower+outsideDist;speed=speed*maxDistLower/newDist;newDist=maxDistLower}newDist=newDist*(dist<0?-1:1);newTime=speed/deceleration;return{dist:newDist,time:m.round(newTime)}},_offset:function(el){var left=-el.offsetLeft,top=-el.offsetTop;while(el=el.offsetParent){left-=el.offsetLeft;top-=el.offsetTop}if(el!=this.wrapper){left*=this.scale;top*=this.scale}return{left:left,top:top}},_snap:function(x,y){var that=this,i,l,page,time,sizeX,sizeY;page=that.pagesX.length-1;for(i=0,l=that.pagesX.length;i<l;i++){if(x>=that.pagesX[i]){page=i;break}}if(page==that.currPageX&&page>0&&that.dirX<0)page--;x=that.pagesX[page];sizeX=m.abs(x-that.pagesX[that.currPageX]);sizeX=sizeX?m.abs(that.x-x)/sizeX*500:0;that.currPageX=page;page=that.pagesY.length-1;for(i=0;i<page;i++){if(y>=that.pagesY[i]){page=i;break}}if(page==that.currPageY&&page>0&&that.dirY<0)page--;y=that.pagesY[page];sizeY=m.abs(y-that.pagesY[that.currPageY]);sizeY=sizeY?m.abs(that.y-y)/sizeY*500:0;that.currPageY=page;time=m.round(m.max(sizeX,sizeY))||200;return{x:x,y:y,time:time}},_bind:function(type,el,bubble){(el||this.scroller).addEventListener(type,this,!!bubble)},_unbind:function(type,el,bubble){(el||this.scroller).removeEventListener(type,this,!!bubble)},destroy:function(){var that=this;that.scroller.style[transform]="";that.hScrollbar=false;that.vScrollbar=false;that._scrollbar("h");that._scrollbar("v");that._unbind(RESIZE_EV,window);that._unbind(START_EV);that._unbind(MOVE_EV,window);that._unbind(END_EV,window);that._unbind(CANCEL_EV,window);if(!that.options.hasTouch){that._unbind(WHEEL_EV)}if(that.options.useTransition)that._unbind(TRNEND_EV);if(that.options.checkDOMChanges)clearInterval(that.checkDOMTime);if(that.options.onDestroy)that.options.onDestroy.call(that)},refresh:function(){var that=this,offset,i,l,els,pos=0,page=0;if(that.scale<that.options.zoomMin)that.scale=that.options.zoomMin;that.wrapperW=that.wrapper.clientWidth||1;that.wrapperH=that.wrapper.clientHeight||1;that.minScrollY=-that.options.topOffset||0;that.scrollerW=m.round(that.scroller.offsetWidth*that.scale);that.scrollerH=m.round((that.scroller.offsetHeight+that.minScrollY)*that.scale);that.maxScrollX=that.wrapperW-that.scrollerW;that.maxScrollY=that.wrapperH-that.scrollerH+that.minScrollY;that.dirX=0;that.dirY=0;if(that.options.onRefresh)that.options.onRefresh.call(that);that.hScroll=that.options.hScroll&&that.maxScrollX<0;that.vScroll=that.options.vScroll&&(!that.options.bounceLock&&!that.hScroll||that.scrollerH>that.wrapperH);that.hScrollbar=that.hScroll&&that.options.hScrollbar;that.vScrollbar=that.vScroll&&that.options.vScrollbar&&that.scrollerH>that.wrapperH;offset=that._offset(that.wrapper);that.wrapperOffsetLeft=-offset.left;that.wrapperOffsetTop=-offset.top;if(typeof that.options.snap=="string"){that.pagesX=[];that.pagesY=[];els=that.scroller.querySelectorAll(that.options.snap);for(i=0,l=els.length;i<l;i++){pos=that._offset(els[i]);pos.left+=that.wrapperOffsetLeft;pos.top+=that.wrapperOffsetTop;that.pagesX[i]=pos.left<that.maxScrollX?that.maxScrollX:pos.left*that.scale;that.pagesY[i]=pos.top<that.maxScrollY?that.maxScrollY:pos.top*that.scale}}else if(that.options.snap){that.pagesX=[];while(pos>=that.maxScrollX){that.pagesX[page]=pos;pos=pos-that.wrapperW;page++}if(that.maxScrollX%that.wrapperW)that.pagesX[that.pagesX.length]=that.maxScrollX-that.pagesX[that.pagesX.length-1]+that.pagesX[that.pagesX.length-1];pos=0;page=0;that.pagesY=[];while(pos>=that.maxScrollY){that.pagesY[page]=pos;pos=pos-that.wrapperH;page++}if(that.maxScrollY%that.wrapperH)that.pagesY[that.pagesY.length]=that.maxScrollY-that.pagesY[that.pagesY.length-1]+that.pagesY[that.pagesY.length-1]}that._scrollbar("h");that._scrollbar("v");if(!that.zoomed){that.scroller.style[transitionDuration]="0";that._resetPos(400)}},scrollTo:function(x,y,time,relative){var that=this,step=x,i,l;that.stop();if(!step.length)step=[{x:x,y:y,time:time,relative:relative}];for(i=0,l=step.length;i<l;i++){if(step[i].relative){step[i].x=that.x-step[i].x;step[i].y=that.y-step[i].y}that.steps.push({x:step[i].x,y:step[i].y,time:step[i].time||0})}that._startAni()},scrollToElement:function(el,time){var that=this,pos;el=el.nodeType?el:that.scroller.querySelector(el);if(!el)return;pos=that._offset(el);pos.left+=that.wrapperOffsetLeft;pos.top+=that.wrapperOffsetTop;pos.left=pos.left>0?0:pos.left<that.maxScrollX?that.maxScrollX:pos.left;pos.top=pos.top>that.minScrollY?that.minScrollY:pos.top<that.maxScrollY?that.maxScrollY:pos.top;time=time===undefined?m.max(m.abs(pos.left)*2,m.abs(pos.top)*2):time;that.scrollTo(pos.left,pos.top,time)},scrollToPage:function(pageX,pageY,time){var that=this,x,y;time=time===undefined?400:time;if(that.options.onScrollStart)that.options.onScrollStart.call(that);if(that.options.snap){pageX=pageX=="next"?that.currPageX+1:pageX=="prev"?that.currPageX-1:pageX;pageY=pageY=="next"?that.currPageY+1:pageY=="prev"?that.currPageY-1:pageY;pageX=pageX<0?0:pageX>that.pagesX.length-1?that.pagesX.length-1:pageX;pageY=pageY<0?0:pageY>that.pagesY.length-1?that.pagesY.length-1:pageY;that.currPageX=pageX;that.currPageY=pageY;x=that.pagesX[pageX];y=that.pagesY[pageY]}else{x=-that.wrapperW*pageX;y=-that.wrapperH*pageY;if(x<that.maxScrollX)x=that.maxScrollX;if(y<that.maxScrollY)y=that.maxScrollY}that.scrollTo(x,y,time)},disable:function(){this.stop();this._resetPos(0);this.enabled=false;this._unbind(MOVE_EV,window);this._unbind(END_EV,window);this._unbind(CANCEL_EV,window)},enable:function(){this.enabled=true},stop:function(){if(this.options.useTransition)this._unbind(TRNEND_EV);else cancelFrame(this.aniTime);this.steps=[];this.moved=false;this.animating=false},zoom:function(x,y,scale,time){var that=this,relScale=scale/that.scale;if(!that.options.useTransform)return;that.zoomed=true;time=time===undefined?200:time;x=x-that.wrapperOffsetLeft-that.x;y=y-that.wrapperOffsetTop-that.y;that.x=x-x*relScale+that.x;that.y=y-y*relScale+that.y;that.scale=scale;that.refresh();that.x=that.x>0?0:that.x<that.maxScrollX?that.maxScrollX:that.x;that.y=that.y>that.minScrollY?that.minScrollY:that.y<that.maxScrollY?that.maxScrollY:that.y;that.scroller.style[transitionDuration]=time+"ms";that.scroller.style[transform]="translate("+that.x+"px,"+that.y+"px) scale("+scale+")"+translateZ;that.zoomed=false},isReady:function(){return!this.moved&&!this.zoomed&&!this.animating}};function prefixStyle(style){if(vendor==="")return style;style=style.charAt(0).toUpperCase()+style.substr(1);return vendor+style}dummyStyle=null;if(typeof exports!=="undefined")exports.iScroll=iScroll;else window.iScroll=iScroll})(window,document);define("lib/iscroll",function(global){return function(){var ret,fn;return ret||global.iScroll}}(this));define("view/note/view",["ext/underscore","view/page","view/link-resolver","lib/iscroll","view/navbar-factory"],function(_,PageView,linkResolver,iScroll,navbarFactory){var $=jQuery;return PageView.extend({attributes:{id:"scroll-wrapper"},initialize:function(options){PageView.prototype.initialize.apply(this,arguments);this.group=this.model.getGroup();this.back={code:"m_btn_pages",link:"#pages/"+this.group.getKey()};this.title=_.escape(this.model.get("friendlyName")),this.action={code:"m_comments",link:"#comments/"+this.model.getKey()}},render:function(){PageView.prototype.render.apply(this,arguments);$("<div>").addClass("html-content").html(this.model.get("content")).appendTo(this.$el);this.resolveLinks();var fudge=30;var zoomMin=this.$root.width()/($("div.html-content",this.$el).width()+fudge);var iscroll=new iScroll(this.el,{zoom:true,zoomMin:zoomMin});iscroll.zoom(0,0,zoomMin,0);iscroll.refresh();return this},navbar:function(callback){this.navbarCreate("pages",this.group.id,callback)}}).extend(navbarFactory).extend(linkResolver)});define("router/note",["router/group","api/cache","api/service/note","view/note/list","view/note/view"],function(GroupRouter,cache,service,NoteListView,NoteViewView){return GroupRouter.extend({routes:{"pages/:groupKey":"showPages","page/:pageKey":"getPage"},showPages:function(group){var pages=cache.getFrom(service.createPages(group,1));var view=new NoteListView({collection:pages});view.render();view.handleRefresh()},getPage:function(pageKey){var parts=pageKey.split(":");var group={id:parseInt(parts[1].substr(1))};service.getPage(group,parts[3],this.showPage)},showPage:function(page){new NoteViewView({model:page}).render()}})});define("api/collection/discussions",["api/collection/content","api/model/discussion"],function(ContentCollection,Discussion){return ContentCollection.extend({model:Discussion})});define("api/model/discussion-reply",["api/model/base"],function(BaseModel){return BaseModel.extend({url:function(){var id=this.id?"/@"+this.id:"";return this.collection.url()+id}})});define("api/collection/discussion-replies",["api/collection/base","api/model/discussion-reply"],function(BaseCollection,DiscussionReply){return BaseCollection.extend({model:DiscussionReply,initialize:function(models,options){this.discussion=options.discussion},url:function(){return this.discussion.url()+"/replies"}})});define("api/service/discussion",["ext/underscore","app-context","api/cache","api/service/base","api/collection/discussions","api/collection/discussion-replies","api/model/discussion-reply","api/model/discussion"],function(_,appContext,cache,base,Discussions,DiscussionReplies,DiscussionReply,Discussion){return _.extend({getDiscussions:function(group,handler){var discussions=this.createDiscussions(group,1);cache.putModel(discussions);this.getCollection(discussions,handler)},getNextDiscussions:function(discussions,handler){var next=this.createDiscussions(group,discussions.params.currentPage+1);this.getCollection(next,function(next){discussions.add(next.models);discussions.params.currentPage=next.params.currentPage;discussions.more=next.more;handler(next)})},getDiscussion:function(group,id,handler){var discussion=new Discussion({name:id});if(id.charAt(0)=="@"){discussion=new Discussion({id:parseInt(id.slice(1))})}discussion.set("group",group);discussion=cache.getFrom(discussion);if(discussion._expiry){if(discussion.replies){handler(discussion)}else{this._getReplies(discussion,handler)}return}cache.putModel(discussion);var _handler=_.after(2,handler);discussion.once("change",_handler);discussion.fetch();this._getReplies(discussion,_handler)},_getReplies:function(discussion,handler){discussion.replies=new DiscussionReplies([],{discussion:discussion});discussion.replies.once("sync",function(){handler(discussion)});discussion.replies.fetch()},createDiscussion:function(discussions,discussion,handler){discussion["group"]={id:discussions.group.id};var model=new Discussion(discussion);discussions.add(model);model.save();model.once("change",_.bind(handler,this,model))},createReply:function(replies,text,handler){var reply=new DiscussionReply({reply:text});replies.add(reply);reply.save();reply.once("change",_.bind(handler,this,reply))},createDiscussions:function(group,currentPage){return new Discussions([],{group:group,params:{currentPage:currentPage,pageSize:appContext.pageSize}})}},base)});define("text!text/discussion/item.html",[],function(){return"<a class=\"no-icon\" href=\"#discussion/<%= getKey() %>\">\n	<p><b><%= _.escape(get('friendlyName')) %></b></p>\n	<abbr><%= m_last_updated %>: <%= $.timeago(new Date(get('lastModified'))) %></abbr>\n	<span class=\"badge\"><%= get('replies') %></span>\n</a>\n"});define("view/discussion/item",["view/base","text!text/discussion/item.html"],function(BaseView,template){return BaseView.extend({tagName:"li",className:"fat",render:function(){this.$el.html(this.template(template,this.model));return this}})});define("view/discussion/list",["ext/underscore","view/navbar-factory","view/extending-list","view/discussion/item","api/service/discussion"],function(_,navbarFactory,ExtendingListView,DiscussionItemView,service){return ExtendingListView.extend({back:{code:"m_btn_context",link:"#context"},initialize:function(){ExtendingListView.prototype.initialize.apply(this,arguments);var group=this.collection.group;this.title=_.escape(group.get("friendlyName"));if(group.permission.canCreate()){this.action={code:"m_new",link:"#discussions/"+group.getKey()+"/create"}}},emptyMsgCode:"m_discussions_nothing",itemViewClass:DiscussionItemView,handleEndOfList:function(){service.getNextDiscussions(this.collection,this.renderPage)},handleRefresh:function(){var self=this;service.getDiscussions(this.collection.group,function(discussions){self.collection=discussions;self.refresh()})},navbar:function(callback){this.navbarCreate("discussions",this.collection.group.id,callback)}}).extend(navbarFactory)});define("text!text/discussion/create.html",[],function(){return'<input class="form-control" name="topic" placeholder="<%= m_discussion_topic %>" type="text" maxlength="128">\n<textarea class="editor hidden" placeholder="<%= m_discussion_first %>"></textarea>\n<a href="javascript:void(0)" id="post" class="btn btn-primary" disabled="disabled">\n	<%= m_post %>\n</a>\n'});define("view/discussion/create",["ext/underscore","app-context","view/page","view/editor","api/service/discussion","text!text/discussion/create.html"],function(_,appContext,PageView,EditorView,service,template){var $=jQuery;return PageView.extend({tagName:"fieldset",events:{"keyup [name=topic]":"onKeyup","click #post":"post"},title:PageView.message("m_create_discussion"),nosearch:true,initialize:function(options){PageView.prototype.initialize.apply(this,arguments);this.editor=new EditorView({context:this.options.discussions.group,$page:this.$el});this.action={code:"m_mention",view:this.editor};this.back={code:"m_btn_discussions",link:"#discussions/"+this.options.discussions.group.getKey()}},render:function(){PageView.prototype.render.apply(this,arguments);this.$el.html(this.template(template));this.editor.render_delayed();return this},onKeyup:function(){$("#post",this.$el).attr("disabled",_.isBlank($("[name=topic]",this.el).val()))},post:function(){service.createDiscussion(this.options.discussions,{friendlyName:$("[name=topic]",this.el).val(),description:this.editor.getText()},function(discussion){appContext.navigate("#discussion/"+discussion.getKey())})}})});define("text!text/discussion/reply.html",[],function(){return"<div>\n	<img src=\"<%= cdn %>/users/<%= model.get('author').id %>/thumbnail\"\n		onerror='this.onerror = null; this.src=\"<%= appurl %>/styles/images/default_thumbnail.png\"'>\n	<p><%= _.isBlank(model.get('reply')) ? '&nbsp;' : model.get('reply') %></p>\n	<p class=\"who-when\"><%= model.get('author').name %> (<%= $.timeago(new Date(model.get('dateCreated'))) %>)</p>\n	<% if ((me.id == model.get('author').id) && !readonly) { %>\n		<a href=\"javascript:void(0)\" class=\"comment-delete\">\n			<span class=\"glyphicon glyphicon-trash\"></span>\n		</a>\n	<% } %>\n</div>\n"});define("view/discussion/reply",["ext/underscore","view/base","app-context","api/service/general","text!text/discussion/reply.html"],function(_,BaseView,appContext,service,template){return BaseView.extend({attributes:{"class":"comment"},events:{"click .comment-delete":"onDelete"},initialize:function(options){_.bindToMethods(this);this.replyViews=[];this.options=options},render:function(){var args={readonly:this.options.readonly,model:this.model,cdn:appContext.cdn,me:appContext.getPrinciple()};this.$el.html(this.template(template,args));return this},onDelete:function(){service.deleteModel(this.model,this.onDeleted)},onDeleted:function(){this.$el.remove()}})});define("view/discussion/view",["ext/underscore","view/page","api/model/discussion-reply","view/navbar-factory","view/discussion/reply"],function(_,PageView,DiscussionReply,navbarFactory,DiscussionReplyView){return PageView.extend({className:"comments",initialize:function(options){PageView.prototype.initialize.apply(this,arguments);this.group=this.model.getGroup();this.back={code:"m_btn_discussions",link:"#discussions/"+this.group.getKey()};this.title=_.escape(this.model.get("friendlyName"));this.action={code:"m_reply",link:"#discussion/"+this.model.getKey()+"/create"}},render:function(){PageView.prototype.render.apply(this,arguments);var view=new DiscussionReplyView({model:new DiscussionReply({author:this.model.get("author"),reply:this.model.get("description"),dateCreated:this.model.get("dateCreated")}),readonly:true});this.$el.append(view.render().el);var selectedId=this.getSelectedReply();this.model.replies.each(function(reply){var view=new DiscussionReplyView({model:reply});var $item=view.render().$el;this.$el.append($item);if(selectedId==reply.id){$item.addClass("selected");this.scroll($item.offset().top-52)}},this);return this},getSelectedReply:function(){var reversed=_.sortBy(this.model.replies.toJSON(),function(reply){return-reply.dateCreated});var selected=_.find(reversed,function(reply){return reply.dateCreated<=this.options.dateOfSelection},this);return selected?selected.id:-1},navbar:function(callback){this.navbarCreate("discussions",this.group.id,callback)}}).extend(navbarFactory)});define("view/discussion/create-reply",["app-context","view/editor-page","api/service/discussion"],function(appContext,EditorPageView,service){return EditorPageView.extend({title:EditorPageView.message("m_create_reply"),nosearch:true,initialize:function(){EditorPageView.prototype.initialize.apply(this,arguments);this.back={code:"m_discussion",link:"#discussion/"+this.options.replies.discussion.getKey()}},post:function(){var backLink=this.back.link;service.createReply(this.options.replies,this.editor.getText(),function(reply){appContext.navigate(backLink+"/"+reply.get("dateCreated"))})}})});define("router/discussion",["router/group","api/cache","api/service/discussion","view/discussion/list","view/discussion/create","view/discussion/view","view/discussion/create-reply"],function(GroupRouter,cache,service,DiscussionListView,DiscussionCreateView,DiscussionViewView,ReplyCreateView){return GroupRouter.extend({routes:{"discussions/:groupKey/create":"createDiscussion","discussions/:groupKey":"showDiscussions","discussion/:discussionKey/create":"createReply","discussion/:discussionKey/:dateOfSelection":"getDiscussion","discussion/:discussionKey":"getDiscussion"},showDiscussions:function(group){var discussions=cache.getFrom(service.createDiscussions(group,1));var view=new DiscussionListView({collection:discussions});view.render();view.handleRefresh()},createDiscussion:function(group){var discussions=cache.getFrom(service.createDiscussions(group,1));new DiscussionCreateView({discussions:discussions}).render()},getDiscussion:function(discussionKey,dateOfSelection){var parts=discussionKey.split(":");var group={id:parseInt(parts[1].substr(1))};service.getDiscussion(group,parts[3],function(discussion){var options={model:discussion};if(dateOfSelection){options["dateOfSelection"]=parseInt(dateOfSelection)}new DiscussionViewView(options).render()})},createReply:function(discussionKey){var self=this;var parts=discussionKey.split(":");var group={id:parseInt(parts[1].substr(1))};service.getDiscussion(group,parts[3],function(discussion){self.showReplyCreate(discussion.replies)})},showReplyCreate:function(replies){new ReplyCreateView({context:replies.discussion.getGroup(),replies:replies}).render()}})});define("api/collection/requests",["api/collection/base","api/model/request"],function(BaseCollection,Request){return BaseCollection.extend({model:Request,initialize:function(models,options){if(options&&options.context){this.context=options.context}},url:function(){return this.context.url()+"/requests"}})});define("api/service/request",["ext/underscore","app-context","api/service/base","api/collection/requests","api/model/request"],function(_,appContext,base,Requests,Request){return _.extend({getRequests:function(model,handler){model.requests=new Requests([],{context:model});model.requests.once("sync",function(){handler(model)});model.requests.fetch()},saveRequests:function(model,requests,handler){requests["context"]=model;var requestMap={};requests.each(function(request){requestMap[request.get("target").id]=request});model.requests&&model.requests.each(function(request){if(requestMap[request.get("target").id]){delete requestMap[request.get("target").id]}else{request.destroy()}});var newRequests=_.values(requestMap);if(newRequests.length==0){handler()}else{var _handler=_.after(newRequests.length,handler);var me=appContext.getPrinciple();_.each(newRequests,function(request){model.requests&&model.requests.add(request);request.set("source",{id:me.id});request.once("sync",_handler);request.save()})}},createRequests:function(existingRequests){var requests=new Requests;if(existingRequests){existingRequests.each(function(request){requests.add(new Request(request.toJSON()))})}else{requests.add(this.createRequest(appContext.getPrinciple()))}return requests},createRequest:function(user){return new Request({target:user.toJSON?user.toJSON():user,status:appContext.getPrinciple().id==user.id?"ACCEPT":"NONE"})}},base)});define("api/collection/events",["api/collection/content","api/model/event"],function(ContentCollection,Event){return ContentCollection.extend({model:Event})});define("api/service/event",["ext/underscore","app-context","api/cache","api/service/base","api/service/request","api/collection/events","api/model/event"],function(_,appContext,cache,base,requestService,Events,Event){return _.extend({getEvents:function(group,handler){var events=this.createEvents(group,1);cache.putModel(events);this.getCollection(events,handler)},getNextEvents:function(events,handler){var next=this.createEvents(events.group,events.params.currentPage+1);this.getCollection(next,function(next){events.add(next.models);events.params.currentPage=next.params.currentPage;events.more=next.more;handler(next)})},getEvent:function(group,id,handler){var self=this;this.getEventOnly(group,id,function(event){self.getPermission(event,handler)})},getEventOnly:function(group,id,handler){var event=new Event({name:id});if(id.charAt(0)=="@"){event=new Event({id:parseInt(id.slice(1))})}event.set("group",group);event=cache.getFrom(event);if(event._expiry){if(event.requests){handler(event)}else{requestService.getRequests(event,handler)}return}cache.putModel(event);var _handler=_.after(2,handler);event.once("change",_handler);event.fetch();requestService.getRequests(event,_handler)},saveEvent:function(context,attributes,requests,handler){var event;if(context.type){event=context;event.set(attributes)}else{attributes["group"]=context.group;event=new Event(attributes);context.add(event)}var self=this;event.once("sync",function(){requestService.saveRequests(event,requests,_.bind(handler,self,event))});event.save()},createEvents:function(group,currentPage){return new Events([],{group:group,params:{currentPage:currentPage,pageSize:appContext.pageSize}})}},base)});define("text!text/event/item.html",[],function(){return"<a class=\"no-icon\" href=\"#event/<%= getKey() %>\">\n	<p><b><%= _.escape(get('friendlyName')) %></b></p>\n	<abbr><%= when %>, <%= m_by %> <%= get('author').name %></abbr>\n	<span class=\"badge\"><%= get('attendees') %></span>\n</a>\n"});define("view/event/item",["ext/underscore","view/base","text!text/event/item.html"],function(_,BaseView,template){return BaseView.extend({tagName:"li",render:function(){var dateLabel=this.model.get("dateLabel");if(dateLabel){this.$el.addClass("list-divider").html(dateLabel)}else{this.$el.addClass("fat");var args=_.extend({when:this.getTime()},this.model);this.$el.html(this.template(template,args))}return this},getTime:function(){if(this.model.get("allDay")){if(this.model.isSameDay()){return this.message("m_all_day")}else{var endDate=moment(this.model.get("endDate"));return this.message("m_all_day")+" "+this.message("m_to")+endDate.format(" DD/MM/YY")}}else{var startDate=moment(this.model.get("startDate")).format("HH:mm ");var endDate=moment(this.model.get("endDate"));if(this.model.isSameDay()){return startDate+this.message("m_to")+endDate.format(" HH:mm")}else{return startDate+this.message("m_to")+endDate.format(" DD/MM/YY, HH:mm")}}}})});define("view/event/list",["ext/underscore","api/service/event","api/collection/events","api/model/event","view/navbar-factory","view/extending-list","view/event/item"],function(_,service,Events,Event,navbarFactory,ExtendingListView,EventItemView){return ExtendingListView.extend({back:{code:"m_btn_context",link:"#context"},initialize:function(){ExtendingListView.prototype.initialize.apply(this,arguments);var group=this.collection.group;this.title=_.escape(group.get("friendlyName"));this.groupEvents()},groupEvents:function(){var eventMap=_.groupBy(this.collection.models,function(event){return this.extractDateLabel(event.get("startDate"))},this);this.collection=new Events([],{group:this.collection.group});_.each(_.keys(eventMap),function(dateLabel){this.collection.add(new Event({dateLabel:dateLabel}));this.collection.add(eventMap[dateLabel])},this)},emptyMsgCode:"m_events_nothing",itemViewClass:EventItemView,handleEndOfList:function(){service.getNextEvents(this.collection,this.renderPage)},handleRefresh:function(){var self=this;service.getEvents(this.collection.group,function(events){self.collection=events;self.groupEvents();self.refresh()})},navbar:function(callback){this.navbarCreate("events",this.collection.group.id,callback)}}).extend(navbarFactory)});define("text!text/request/item.html",[],function(){return'<% if (request.get(\'target\').logo) { %>\n	<img src="<%= appContext.cdn %>/users/<%= request.get(\'target\').id %>/thumbnail">\n<% } else { %>\n	<img src="<%= appContext.defaultThumb %>">\n<% } %>\n<span><%= request.get(\'target\').name %></span>\n<% if (deletable) { %>\n	<a href="javascript:void(0)" class="comment-delete">\n		<span class="glyphicon glyphicon-trash"></span>\n	</a>\n<% } %>\n'});define("view/request/item",["ext/underscore","app-context","text!text/request/item.html"],function(_,appContext,template){return Backbone.View.extend({tagName:"li",events:{"click .comment-delete":"onDelete"},initialize:function(options){this.options=options},render:function(){var args=_.extend({appContext:appContext,deletable:false},this.options);this.$el.html(_.template(template,args));return this},onDelete:function(){this.options.collection.remove(this.options.request)}})});define("text!text/request/group.html",[],function(){return"<h5 class=\"request-<%= status %>\">\n	<%= messages['m_request_' + type + '_' + status] %>\n</h5>\n<ul class=\"list-unstyled\"></ul>\n"});define("view/request/group",["ext/underscore","view/base","view/request/item","text!text/request/group.html"],function(_,BaseView,RequestItemView,template){var $=jQuery;return BaseView.extend({initialize:function(options){this.options=options},render:function(){this.$el.html(this.template(template,this.options));var $list=$("ul",this.$el);_.each(this.options.requestGroup,function(request){var options=_.extend({request:request},this.options);var view=new RequestItemView(options);$list.append(view.render().el)},this);return this}})});define("view/request/list",["ext/underscore","view/request/group"],function(_,RequestGroupView){return Backbone.View.extend({className:"requests",initialize:function(options){this.options=options},render:function(){var requestMap=_.groupBy(this.collection.models,function(request){return request.get("status")});this.$el.empty();_.each(["ACCEPT","REJECT","DECLINE","MAYBE","NONE"],function(status){if(!requestMap[status]){return}var options=_.extend({status:status,requestGroup:requestMap[status]},this.options);var view=new RequestGroupView(options);this.$el.append(view.render().el)},this);return this}})});define("text!text/date_time.html",[],function(){return"<input name=\"date\" class=\"form-control date\" type=\"text\"\n	placeholder=\"<%= messages[placeholder] %>\" \n	value=\"<%= date ? moment(date).format('DD MMM, YYYY') : '' %>\" >\n\n<% var time = date ? moment(date).format('HH:mm') : ''; %>\n\n<input name=\"time\" class=\"form-control time\" type=\"text\" \n	placeholder=\"<%= time == '00:00' || time == '' ? 'hh:mm' : '' %>\" \n	value=\"<%= time == '00:00' ? '' : time %>\" <%= date ? '' : 'disabled=\"disabled\"' %> >\n\n<p class=\"invalid hidden\"></p>\n"});define("view/date-time",["ext/underscore","native","view/base","moment","text!text/date_time.html"],function(_,_native,BaseView,moment,template){var $=jQuery;return BaseView.extend({className:"date-time",render:function(){BaseView.prototype.render.apply(this,arguments);this.$el.html(this.template(template,this.options));_native.datepicker(this.$el);return this},isTimeSet:function(){var dueTime=$("[name=time]",this.$el).val();return!_.isBlank(dueTime)},val:function(previousDate){this.error();var date=$("[name=date]",this.$el).val();if(_.isBlank(date)){if(this.options.required){this.error(this.message(this.options.required));throw"invalid"}}else{var time=$("[name=time]",this.$el).val();if(!_.isBlank(time)&&time.search(/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/)==-1){this.error(this.message("m_error_time"));throw"invalid"}var format="DD MMM, YYYY HH:mm";var datetime=moment(date+" "+time,format).valueOf();if(previousDate&&previousDate>datetime){this.error(this.message("m_error_date_range",moment(previousDate).format(format)));throw"invalid"}return datetime}return null},error:function(message){var $error=$("p.invalid",this.$el);if(message){$error.html(message).removeClass("hidden")}else{$error.addClass("hidden")}}})});define("text!text/event/save.html",[],function(){return'<input class="form-control" name="friendlyName" placeholder="<%= m_event_title %>" \n	type="text" maxlength="108" value="<%= event ? event.get(\'friendlyName\') : \'\' %>">\n<div id="startDate"></div>\n<div id="endDate"></div>\n<input class="form-control" name="location" placeholder="<%= m_event_location %>" \n	type="text" maxlength="128" value="<%= event ? event.get(\'location\') : \'\' %>">\n<textarea class="editor hidden" placeholder="<%= m_event_description %>"></textarea>\n<div id="requests"></div>\n<a href="javascript:void(0)" id="save" class="btn btn-primary" <%= event ? \'\' : \'disabled="disabled"\' %>>\n	<%= m_save %>\n</a>\n'});define("view/event/save",["ext/underscore","view/page","view/editor","app-context","moment","api/service/general","api/service/request","api/service/event","view/people/list","view/request/list","view/date-time","text!text/event/save.html"],function(_,PageView,EditorView,appContext,moment,generalService,requestService,eventService,PeopleListView,RequestListView,DateTimeView,template){var $=jQuery;
return PageView.extend({tagName:"fieldset",events:{"keyup [name=friendlyName]":"onKeyup","click #save":"save"},initialize:function(options){PageView.prototype.initialize.apply(this,arguments);var group=this.resolveGroup();this.editor=new EditorView({context:group,$page:this.$el,content:options.model?options.model.get("description"):null});this.back={code:options.model?"m_event":"m_btn_events",link:options.model?"#event/"+options.model.getKey():"#events/"+group.getKey()};this.action={code:"m_assign",view:this};this.title=this.message(options.model?"m_update_event":"m_create_event");this.requestList=new RequestListView({collection:requestService.createRequests(options.model?options.model.requests:null),type:"event",deletable:true});this.requestList.collection.on("remove",this.renderRequests);this.startDate=new DateTimeView({date:options.model?options.model.get("startDate"):null,placeholder:"m_event_startdate",required:"m_error_startdate"});this.endDate=new DateTimeView({date:options.model?options.model.get("endDate"):null,placeholder:"m_event_enddate",required:"m_error_enddate"})},resolveGroup:function(){if(this.options.model){return this.options.model.getGroup()}return this.options.collection.group},render:function(){PageView.prototype.render.apply(this,arguments);this.$el.html(this.template(template,{statuses:["NOT_STARTED","IN_PROGRESS","DEFERRED","WAITING","COMPLETED"],event:this.options.model}));$("#startDate",this.$el).replaceWith(this.startDate.render().$el);$("#endDate",this.$el).replaceWith(this.endDate.render().$el);this.renderRequests();this.editor.render_delayed();return this},renderRequests:function(){var $requests=$("#requests",this.$el).empty();if(this.requestList.collection.length>0){$requests.append(this.requestList.render().el)}},onKeyup:function(){$("#save",this.$el).attr("disabled",_.isBlank($("[name=friendlyName]",this.el).val()))},doAction:function(container){var filter=this.requestList.collection.map(function(request){return request.get("target").id});var self=this;generalService.getUsers(this.resolveGroup(),function(users){var people=new PeopleListView({collection:users,callback:self.addRequest,filter:filter});people.render()},true)},addRequest:function(user){this.requestList.collection.add(requestService.createRequest(user));this.renderRequests()},save:function(){this.requestList.collection.off("remove",this.renderRequests);var attributes={friendlyName:$("[name=friendlyName]",this.el).val(),location:$("[name=location]",this.el).val(),description:this.editor.getText(),allDay:!(this.startDate.isTimeSet()||this.endDate.isTimeSet())};var valid=true;try{attributes.startDate=this.startDate.val()}catch(e){valid=false}try{attributes.endDate=this.endDate.val(attributes.startDate)}catch(e){valid=false}if(!attributes.allDay&&!this.endDate.isTimeSet()){attributes.endDate+=8634e4}valid&&eventService.saveEvent(this.options.model?this.options.model:this.options.collection,attributes,this.requestList.collection,function(event){appContext.navigate("#event/"+event.getKey())})}})});define("text!text/event/view.html",[],function(){return"<div class=\"entity-info\" >\n	<% if (!_.isBlank(get('description'))) { %>\n		<div class=\"description\">\n			<%= get('description') %>\n		</div>\n	<% } %>\n	<% if (get('location')) { %>\n		<p>\n			<%= m_event_location %>: <%= _.escape(get('location')) %>\n		</p>\n	<% } %>\n	<%= when %>\n	<% if (get('attendeeLimit')) { %>\n		<p>\n			<%= m_event_places %>: <%= get('attendees') %> <%= m_event_of %> <%= get('attendeeLimit') %>\n		</p>\n	<% } %>\n</div>\n<% if (answer) { %>\n	<a href='javascript:void(0)' class='btn btn-success'>\n		<%= m_event_ACCEPT %>\n	</a>\n	<a href='javascript:void(0)' class='btn btn-danger'>\n		<%= m_event_DECLINE %>\n	</a>\n	<a href='javascript:void(0)' class='btn btn-warning'>\n		<%= m_event_MAYBE %>\n	</a>\n<% } %>\n<div id=\"requests\"></div>\n<% if (permission.canEdit()) { %>\n	<a href=\"#event/<%= getKey() %>/edit\" class=\"btn btn-primary\">\n		<%= m_edit %>\n	</a>\n<% } %>\n"});define("view/event/view",["ext/underscore","view/page","view/link-resolver","app-context","moment","view/navbar-factory","view/request/list","text!text/event/view.html"],function(_,PageView,linkResolver,appContext,moment,navbarFactory,RequestListView,template){var DATEF="dddd, DD MMMM YYYY";var TIMEF="HH:mm";var FULLF=DATEF+", "+TIMEF;return PageView.extend({tagName:"fieldset",events:{"click a.btn-success":function(){this.update("ACCEPT")},"click a.btn-danger":function(){this.update("DECLINE")},"click a.btn-warning":function(){this.update("MAYBE")}},initialize:function(options){PageView.prototype.initialize.apply(this,arguments);this.group=this.model.getGroup();this.back={code:"m_btn_events",link:"#events/"+this.group.getKey()};this.title=_.escape(this.model.get("friendlyName"));this.action={code:"m_comments",link:"#comments-"+this.model.getKey()}},update:function(status){this.answer.set("status",status);this.answer.once("sync",this.success);this.answer.save()},success:function(){appContext.navigate("#event/"+this.model.getKey(),true)},render:function(){PageView.prototype.render.apply(this,arguments);this.answer=this.model.requests.find(function(request){return request.get("target").id==appContext.getPrinciple().id&&request.get("status")=="NONE"});var args=_.extend({answer:this.answer,when:this.getTime()},this.model);this.$el.html(this.template(template,args));this.resolveLinks();if(this.model.requests.size()>0){var view=new RequestListView({collection:this.model.requests,type:"event"});view.render().$el.appendTo($("#requests",this.$el))}return this},getTime:function(){var startDate=moment(this.model.get("startDate"));if(this.model.get("allDay")){if(this.model.isSameDay()){return this.p(startDate.format(DATEF))}else{var endDate=moment(this.model.get("endDate"));return this.p(startDate.format(DATEF))+this.p(this.message("m_to"))+this.p(endDate.format(DATEF))}}else{var endDate=moment(this.model.get("endDate"));if(this.model.isSameDay()){return this.p(startDate.format(DATEF))+this.p(startDate.format(TIMEF)+" "+this.message("m_to")+" "+endDate.format(TIMEF))}else{return this.p(startDate.format(FULLF))+this.p(this.message("m_to"))+this.p(endDate.format(FULLF))}}},p:function(text){return"<p>"+text+"</p>"},navbar:function(callback){this.navbarCreate("events",this.group.id,callback)}}).extend(navbarFactory).extend(linkResolver)});define("router/event",["ext/underscore","router/group","api/cache","api/service/event","view/event/list","view/event/save","view/event/view"],function(_,GroupRouter,cache,service,EventListView,EventSaveView,EventViewView){return GroupRouter.extend({routes:{"events/:groupKey/create":"createEvent","events/:groupKey":"showEvents","event/:eventKey/edit":"editEvent","event/:eventKey":"getEvent"},createEvent:function(group){var events=cache.getFrom(service.createEvents(group,1));new EventSaveView({collection:events}).render()},showEvents:function(group){var events=cache.getFrom(service.createEvents(group,1));var view=new EventListView({collection:events});view.render();view.handleRefresh()},getEvent:function(eventKey){var parts=eventKey.split(":");var group={id:parseInt(parts[1].substr(1))};service.getEvent(group,parts[3],function(event){new EventViewView({model:event}).render()})},editEvent:function(eventKey){var parts=eventKey.split(":");var group={id:parseInt(parts[1].substr(1))};service.getEvent(group,parts[3],function(event){new EventSaveView({model:event}).render()})}})});define("api/collection/tasks",["api/collection/content","api/model/task"],function(ContentCollection,Task){return ContentCollection.extend({model:Task,_getKey:function(key){return key+":"+this.params.completed}})});define("api/service/task",["ext/underscore","app-context","api/cache","api/service/base","api/service/request","api/collection/tasks","api/model/task"],function(_,appContext,cache,base,requestService,Tasks,Task){return _.extend({getTasks:function(group,handler){var tasks=this.createTasks(group,1);cache.putModel(tasks);this.getCollection(tasks,handler)},getNextTasks:function(tasks,handler){var next=this.createTasks(tasks.group,tasks.params.currentPage+1);this.getCollection(next,function(next){tasks.add(next.models);tasks.params.currentPage=next.params.currentPage;tasks.more=next.more;handler(next)})},getTask:function(group,id,handler){var self=this;this.getTaskOnly(group,id,function(task){self.getPermission(task,handler)})},getTaskOnly:function(group,id,handler){var task=new Task({name:id});if(id.charAt(0)=="@"){task=new Task({id:parseInt(id.slice(1))})}task.set("group",group);task=cache.getFrom(task);if(task._expiry){if(task.requests){handler(task)}else{requestService.getRequests(task,handler)}return}cache.putModel(task);var _handler=_.after(2,handler);task.once("change",_handler);task.fetch();requestService.getRequests(task,_handler)},saveTask:function(context,attributes,requests,handler){var task;if(context.type){task=context;task.set(attributes)}else{attributes["group"]=context.group;task=new Task(attributes);context.add(task)}var self=this;task.once("sync",function(){requestService.saveRequests(task,requests,_.bind(handler,self,task))});task.save()},createTasks:function(group,currentPage){return new Tasks([],{group:group,params:{currentPage:currentPage,pageSize:appContext.pageSize,completed:false}})}},base)});define("text!text/task/item.html",[],function(){return"<div class=\"task-status <%= model.isOverdue() ? 'OVERDUE' : model.get('status') %>\">\n	<span><%= messages['m_task_status_' + model.get('status')] %></span>\n</div>\n<a href=\"#task/<%= getKey() %>\" class=\"task-item\">\n	<p><b><%= _.escape(get('friendlyName')) %></b></p>\n	<abbr>\n		<%= m_tasks_requested_by %>\n		<%= get('author').name %><%= when %>\n	</abbr>\n</a>\n"});define("view/task/item",["ext/underscore","view/base","text!text/task/item.html"],function(_,BaseView,template){return BaseView.extend({tagName:"li",render:function(){var dateLabel=this.model.get("dateLabel");if(dateLabel){this.$el.addClass("list-divider").html(dateLabel)}else{this.$el.addClass("fat");var args=_.extend({model:this.model,when:this.getTime()},this.model);this.$el.html(this.template(template,args))}return this},getTime:function(){var dueDate=this.model.get("dueDate");if(!dueDate){return""}var dueDate=moment(dueDate);var dateString=dueDate.format(", DD/MM/YY");if(this.model.get("timeSet")){dateString+=" "+this.message("m_at")+" "+dueDate.format("HH:mm")}return dateString}})});define("view/task/list",["ext/underscore","api/service/task","api/collection/tasks","api/model/task","view/navbar-factory","view/extending-list","view/task/item"],function(_,service,Tasks,Task,navbarFactory,ExtendingListView,TaskItemView){return ExtendingListView.extend({back:{code:"m_btn_context",link:"#context"},initialize:function(){ExtendingListView.prototype.initialize.apply(this,arguments);var group=this.collection.group;this.title=_.escape(group.get("friendlyName"));if(group.permission.canCreate()){this.action={code:"m_new",link:"#tasks/"+group.getKey()+"/create"}}this.groupTasks()},groupTasks:function(){var taskMap=_.groupBy(this.collection.models,this.extractDueDateLabel);this.collection=new Tasks([],{group:this.collection.group});_.each(_.keys(taskMap),function(dateLabel){this.collection.add(new Task({dateLabel:dateLabel}));this.collection.add(taskMap[dateLabel])},this)},extractDueDateLabel:function(task){if(task.isOverdue()){return this.message("m_tasks_overdue")}var dueDate=task.get("dueDate");if(!dueDate){return this.message("m_tasks_no_due_date")}return this.extractDateLabel(dueDate)},emptyMsgCode:"m_tasks_nothing",itemViewClass:TaskItemView,handleEndOfList:function(){service.getNextTasks(this.collection,this.renderPage)},handleRefresh:function(){var self=this;service.getTasks(this.collection.group,function(tasks){self.collection=tasks;self.groupTasks();self.refresh()})},navbar:function(callback){this.navbarCreate("tasks",this.collection.group.id,callback)}}).extend(navbarFactory)});define("text!text/task/save.html",[],function(){return'<input class="form-control" name="friendlyName" placeholder="<%= m_task_title %>" \n	type="text" maxlength="108" value="<%= task ? task.get(\'friendlyName\') : \'\' %>">\n<textarea class="editor hidden" placeholder="<%= m_task_description %>"></textarea>\n<div class="select">\n	<select name="status">\n		<% var status = task ? task.get(\'status\') : "NOT_STARTED"; %>\n		<% for (i = 0; i < statuses.length; i++) { %>\n			<option value="<%= statuses[i] %>" <%= statuses[i] == status ? \'selected="selected"\' : \'\' %> >\n				<%= messages[\'m_task_status_\' + statuses[i]] %>\n			</option>\n		<% } %>\n	</select>\n</div>\n<div id="dueDate"></div>\n<div id="requests"></div>\n<a href="javascript:void(0)" id="save" class="btn btn-primary" <%= task ? \'\' : \'disabled="disabled"\' %>>\n	<%= m_save %>\n</a>\n'});define("view/task/save",["ext/underscore","view/page","view/editor","app-context","api/service/general","api/service/request","api/service/task","view/people/list","view/request/list","view/date-time","text!text/task/save.html"],function(_,PageView,EditorView,appContext,generalService,requestService,taskService,PeopleListView,RequestListView,DateTimeView,template){var $=jQuery;return PageView.extend({tagName:"fieldset",events:{"keyup [name=friendlyName]":"onKeyup","click #save":"save"},initialize:function(options){PageView.prototype.initialize.apply(this,arguments);var group=this.resolveGroup();this.editor=new EditorView({context:group,$page:this.$el,content:options.model?options.model.get("description"):null});this.back={code:options.model?"m_task":"m_btn_tasks",link:options.model?"#task/"+options.model.getKey():"#tasks/"+group.getKey()};this.action={code:"m_assign",view:this};this.title=this.message(options.model?"m_update_task":"m_create_task");this.requestList=new RequestListView({collection:requestService.createRequests(options.model?options.model.requests:null),type:"task",deletable:true});this.requestList.collection.on("remove",this.renderRequests);this.dueDate=new DateTimeView({date:options.model?options.model.get("dueDate"):null,placeholder:"m_task_duedate"})},resolveGroup:function(){if(this.options.model){return this.options.model.getGroup()}return this.options.collection.group},render:function(){PageView.prototype.render.apply(this,arguments);this.$el.html(this.template(template,{statuses:["NOT_STARTED","IN_PROGRESS","DEFERRED","WAITING","COMPLETED"],task:this.options.model}));$("#dueDate",this.$el).replaceWith(this.dueDate.render().$el);this.renderRequests();this.editor.render_delayed();return this},renderRequests:function(){var $requests=$("#requests",this.$el).empty();if(this.requestList.collection.length>0){$requests.append(this.requestList.render().el)}},onKeyup:function(){$("#save",this.$el).attr("disabled",_.isBlank($("[name=friendlyName]",this.el).val()))},doAction:function(container){var filter=this.requestList.collection.map(function(request){return request.get("target").id});var self=this;generalService.getUsers(this.resolveGroup(),function(users){var people=new PeopleListView({collection:users,callback:self.addRequest,filter:filter});people.render()},true)},addRequest:function(user){this.requestList.collection.add(requestService.createRequest(user));this.renderRequests()},save:function(){this.requestList.collection.off("remove",this.renderRequests);try{var attributes={friendlyName:$("[name=friendlyName]",this.el).val(),description:this.editor.getText(),status:$("[name=status]",this.el).val(),dueDate:this.dueDate.val()};taskService.saveTask(this.options.model?this.options.model:this.options.collection,attributes,this.requestList.collection,function(task){appContext.navigate("#task/"+task.getKey())})}catch(e){}}})});define("text!text/task/view.html",[],function(){return"<div></div>\n<div class=\"task-status <%= isOverdue() ? 'OVERDUE' : get('status') %>\">\n	<span><%= messages['m_task_status_' + get('status')] %></span>\n</div>\n<div class=\"entity-info\" >\n	<% if (!_.isBlank(get('description'))) { %>\n		<div class=\"description\">\n			<%= get('description') %>\n		</div>\n	<% } %>\n	<p><%= when %></p>\n	<% if (get('status') == 'IN_PROGRESS') { %>\n		<p><%= m_task_progress %>: <%= get('progress') %>%</p>\n	<% } %>\n</div>\n<% if (answer) { %>\n	<a href='javascript:void(0)' class='btn btn-success'>\n		<%= m_task_ACCEPT %>\n	</a>\n	<a href='javascript:void(0)' class='btn btn-danger'>\n		<%= m_task_REJECT %>\n	</a>\n<% } %>\n<div id=\"requests\"></div>\n<% if (permission.canEdit()) { %>\n	<a href=\"#task/<%= getKey() %>/edit\" class=\"btn btn-primary\">\n		<%= m_edit %>\n	</a>\n<% } %>\n"});define("view/task/view",["ext/underscore","view/page","view/link-resolver","app-context","moment","view/navbar-factory","view/request/list","text!text/task/view.html"],function(_,PageView,linkResolver,appContext,moment,navbarFactory,RequestListView,template){return PageView.extend({tagName:"fieldset",events:{"click a.btn-success":function(){this.update("ACCEPT")},"click a.btn-danger":function(){this.update("REJECT")}},initialize:function(options){PageView.prototype.initialize.apply(this,arguments);this.group=this.model.getGroup();this.back={code:"m_btn_tasks",link:"#tasks/"+this.group.getKey()};this.title=_.escape(this.model.get("friendlyName"));this.action={code:"m_comments",link:"#comments/"+this.model.getKey()}},update:function(status){this.answer.set("status",status);this.answer.once("sync",this.success);this.answer.save()},success:function(){appContext.navigate("#task/"+this.model.getKey(),true)},render:function(){PageView.prototype.render.apply(this,arguments);this.answer=this.model.requests.find(function(request){return request.get("target").id==appContext.getPrinciple().id&&request.get("status")=="NONE"});var args=_.extend({answer:this.answer,when:this.getTime()},this.model);this.$el.html(this.template(template,args));this.resolveLinks();if(this.model.requests.size()>0){var view=new RequestListView({collection:this.model.requests,type:"task"});view.render().$el.appendTo($("#requests",this.$el))}return this},getTime:function(){var dueDate=this.model.get("dueDate");if(!dueDate){return this.message("m_task_no_due")}dueDate=moment(dueDate);var dateString=dueDate.format("DD/MM/YY");if(this.model.get("timeSet")){dateString+=" "+this.message("m_at")+" "+dueDate.format("HH:mm")}return this.message("m_task_due")+": "+dateString},navbar:function(callback){this.navbarCreate("tasks",this.group.id,callback)}}).extend(navbarFactory).extend(linkResolver)});define("router/task",["ext/underscore","router/group","app-context","api/cache","api/service/task","view/task/list","view/task/save","view/task/view"],function(_,GroupRouter,appContext,cache,service,TaskListView,TaskSaveView,TaskViewView){return GroupRouter.extend({routes:{"tasks/:groupKey/create":"createTask","tasks/:groupKey":"showTasks","task/:taskKey/edit":"editTask","task/:taskKey":"getTask"},createTask:function(group){var tasks=cache.getFrom(service.createTasks(group,1));new TaskSaveView({collection:tasks}).render()},showTasks:function(group){var tasks=cache.getFrom(service.createTasks(group,1));var view=new TaskListView({collection:tasks});view.render();view.handleRefresh()},getTask:function(taskKey){var parts=taskKey.split(":");var group={id:parseInt(parts[1].substr(1))};service.getTask(group,parts[3],function(task){new TaskViewView({model:task}).render()})},editTask:function(taskKey){var parts=taskKey.split(":");var group={id:parseInt(parts[1].substr(1))};service.getTask(group,parts[3],function(task){new TaskSaveView({model:task}).render()})}})});define("api/collection/comments",["api/collection/base","api/model/comment"],function(BaseCollection,Comment){return BaseCollection.extend({model:Comment,initialize:function(models,options){this.context=options.context},url:function(){return this.context.url()+"/comments"}})});define("api/service/comment",["ext/underscore","app-context","api/cache","api/service/file","api/service/note","api/service/event","api/service/task","api/collection/comments","api/model/comment","api/model/reply"],function(_,appContext,cache,fileService,noteService,eventService,taskService,Comments,Comment,Reply){return{getComments:function(contextKey,handler){var self=this;var parts=contextKey.split(":");var group={id:parseInt(parts[1].substr(1))};if(parts[2]=="files"){fileService.getFile(group,parts[3],function(file){self._getComments(file,handler)})}else if(parts[2]=="pages"){noteService.getPage(group,parts[3],function(page){self._getComments(page,handler)})}else if(parts[2]=="events"){eventService.getEvent(group,parts[3],function(event){self._getComments(event,handler)})}else if(parts[2]=="tasks"){taskService.getTask(group,parts[3],function(task){self._getComments(task,handler)})}},_getComments:function(context,handler){var comments=cache.getFrom(new Comments([],{context:context}));if(comments._expiry){handler(comments)}else{comments.fetch();comments.once("sync",function(){cache.putModel(comments);handler(comments)})}},createComment:function(comments,text,handler){var comment=new comments.model({comment:text});comments.add(comment);comment.save();comment.once("change",_.bind(handler,this,comment))}}});define("view/comment/create",["app-context","view/editor-page","api/service/comment"],function(appContext,EditorPageView,service){return EditorPageView.extend({title:EditorPageView.message("m_make_comment"),nosearch:true,initialize:function(){EditorPageView.prototype.initialize.apply(this,arguments);this.back={code:"m_comments",link:"#comments/"+this.options.entity.getKey()}},post:function(){var backLink=this.back.link;service.createComment(this.options.comments,this.editor.getText(),function(comment){appContext.navigate(backLink+"/"+comment.get("dateCreated"))})}})});define("router/comment",["ext/underscore","app-context","router/base","api/cache","api/service/general","api/service/comment","view/comment/list","view/comment/create"],function(_,appContext,BaseRouter,cache,generalService,commentService,CommentListView,CommentCreateView){return BaseRouter.extend({routes:{"comments/:contextKey/create":"createComment","comments/:contextKey/:dateOfSelection":"getComments","comments/:contextKey":"getComments","replies/:commentKey/create":"createReply"},getComments:function(contextKey,dateOfSelection){commentService.getComments(contextKey,function(comments){comments.each(function(comment){cache.putModel(comment)});var contextType=comments.context.type;var options={back:{code:"m_"+contextType,link:"#"+contextType+"/"+comments.context.getKey()},title:_.escape(comments.context.get("friendlyName")),action:{code:"m_new",link:"#comments/"+comments.context.getKey()+"/create"},collection:comments,onDelete:function(comment,onDeleted){generalService.deleteModel(comment,onDeleted)},onReply:function(comment){appContext.navigate("#replies/"+comment.getKey()+"/create")}};if(dateOfSelection){options["dateOfSelection"]=parseInt(dateOfSelection)}var view=new CommentListView(options);view.render()})},createComment:function(contextKey){commentService.getComments(contextKey,this.showCommentCreate)},createReply:function(commentKey){var comment=cache.get(commentKey);this.showCommentCreate(comment.getReplies(),comment.collection)},showCommentCreate:function(comments,parent){if(!parent){parent=comments}new CommentCreateView({context:parent.context.getGroup(),comments:comments,entity:parent.context}).render()}})});var io="undefined"===typeof module?{}:module.exports;(function(){(function(exports,global){var io=exports;io.version="0.9.16";io.protocol=1;io.transports=[];io.j=[];io.sockets={};io.connect=function(host,details){var uri=io.util.parseUri(host),uuri,socket;if(global&&global.location){uri.protocol=uri.protocol||global.location.protocol.slice(0,-1);uri.host=uri.host||(global.document?global.document.domain:global.location.hostname);uri.port=uri.port||global.location.port}uuri=io.util.uniqueUri(uri);var options={host:uri.host,secure:"https"==uri.protocol,port:uri.port||("https"==uri.protocol?443:80),query:uri.query||""};io.util.merge(options,details);if(options["force new connection"]||!io.sockets[uuri]){socket=new io.Socket(options)}if(!options["force new connection"]&&socket){io.sockets[uuri]=socket}socket=socket||io.sockets[uuri];return socket.of(uri.path.length>1?uri.path:"")}})("object"===typeof module?module.exports:this.io={},this);(function(exports,global){var util=exports.util={};var re=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/;var parts=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];util.parseUri=function(str){var m=re.exec(str||""),uri={},i=14;while(i--){uri[parts[i]]=m[i]||""}return uri};util.uniqueUri=function(uri){var protocol=uri.protocol,host=uri.host,port=uri.port;if("document"in global){host=host||document.domain;port=port||(protocol=="https"&&document.location.protocol!=="https:"?443:document.location.port)}else{host=host||"localhost";if(!port&&protocol=="https"){port=443}}return(protocol||"http")+"://"+host+":"+(port||80)};util.query=function(base,addition){var query=util.chunkQuery(base||""),components=[];util.merge(query,util.chunkQuery(addition||""));for(var part in query){if(query.hasOwnProperty(part)){components.push(part+"="+query[part])}}return components.length?"?"+components.join("&"):""};util.chunkQuery=function(qs){var query={},params=qs.split("&"),i=0,l=params.length,kv;for(;i<l;++i){kv=params[i].split("=");if(kv[0]){query[kv[0]]=kv[1]}}return query};var pageLoaded=false;util.load=function(fn){if("document"in global&&document.readyState==="complete"||pageLoaded){return fn()}util.on(global,"load",fn,false)};util.on=function(element,event,fn,capture){if(element.attachEvent){element.attachEvent("on"+event,fn)}else if(element.addEventListener){element.addEventListener(event,fn,capture)}};util.request=function(xdomain){if(xdomain&&"undefined"!=typeof XDomainRequest&&!util.ua.hasCORS){return new XDomainRequest}if("undefined"!=typeof XMLHttpRequest&&(!xdomain||util.ua.hasCORS)){return new XMLHttpRequest}if(!xdomain){try{return new(window[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(e){}}return null};if("undefined"!=typeof window){util.load(function(){pageLoaded=true})}util.defer=function(fn){if(!util.ua.webkit||"undefined"!=typeof importScripts){return fn()}util.load(function(){setTimeout(fn,100)})};util.merge=function merge(target,additional,deep,lastseen){var seen=lastseen||[],depth=typeof deep=="undefined"?2:deep,prop;for(prop in additional){if(additional.hasOwnProperty(prop)&&util.indexOf(seen,prop)<0){if(typeof target[prop]!=="object"||!depth){target[prop]=additional[prop];seen.push(additional[prop])}else{util.merge(target[prop],additional[prop],depth-1,seen)}}}return target};util.mixin=function(ctor,ctor2){util.merge(ctor.prototype,ctor2.prototype)};util.inherit=function(ctor,ctor2){function f(){}f.prototype=ctor2.prototype;ctor.prototype=new f};util.isArray=Array.isArray||function(obj){return Object.prototype.toString.call(obj)==="[object Array]"};util.intersect=function(arr,arr2){var ret=[],longest=arr.length>arr2.length?arr:arr2,shortest=arr.length>arr2.length?arr2:arr;for(var i=0,l=shortest.length;i<l;i++){if(~util.indexOf(longest,shortest[i]))ret.push(shortest[i])}return ret};util.indexOf=function(arr,o,i){for(var j=arr.length,i=i<0?i+j<0?0:i+j:i||0;i<j&&arr[i]!==o;i++){}return j<=i?-1:i};util.toArray=function(enu){var arr=[];for(var i=0,l=enu.length;i<l;i++)arr.push(enu[i]);return arr};util.ua={};util.ua.hasCORS="undefined"!=typeof XMLHttpRequest&&function(){try{var a=new XMLHttpRequest}catch(e){return false}return a.withCredentials!=undefined}();util.ua.webkit="undefined"!=typeof navigator&&/webkit/i.test(navigator.userAgent);util.ua.iDevice="undefined"!=typeof navigator&&/iPad|iPhone|iPod/i.test(navigator.userAgent)})("undefined"!=typeof io?io:module.exports,this);(function(exports,io){exports.EventEmitter=EventEmitter;function EventEmitter(){}EventEmitter.prototype.on=function(name,fn){if(!this.$events){this.$events={}}if(!this.$events[name]){this.$events[name]=fn}else if(io.util.isArray(this.$events[name])){this.$events[name].push(fn)}else{this.$events[name]=[this.$events[name],fn]}return this};EventEmitter.prototype.addListener=EventEmitter.prototype.on;EventEmitter.prototype.once=function(name,fn){var self=this;function on(){self.removeListener(name,on);fn.apply(this,arguments)}on.listener=fn;this.on(name,on);return this};EventEmitter.prototype.removeListener=function(name,fn){if(this.$events&&this.$events[name]){var list=this.$events[name];if(io.util.isArray(list)){var pos=-1;for(var i=0,l=list.length;i<l;i++){if(list[i]===fn||list[i].listener&&list[i].listener===fn){pos=i;break}}if(pos<0){return this}list.splice(pos,1);if(!list.length){delete this.$events[name]}}else if(list===fn||list.listener&&list.listener===fn){delete this.$events[name]}}return this};EventEmitter.prototype.removeAllListeners=function(name){if(name===undefined){this.$events={};return this}if(this.$events&&this.$events[name]){this.$events[name]=null}return this};EventEmitter.prototype.listeners=function(name){if(!this.$events){this.$events={}}if(!this.$events[name]){this.$events[name]=[]}if(!io.util.isArray(this.$events[name])){this.$events[name]=[this.$events[name]]}return this.$events[name]};EventEmitter.prototype.emit=function(name){if(!this.$events){return false}var handler=this.$events[name];if(!handler){return false}var args=Array.prototype.slice.call(arguments,1);if("function"==typeof handler){handler.apply(this,args)}else if(io.util.isArray(handler)){var listeners=handler.slice();for(var i=0,l=listeners.length;i<l;i++){listeners[i].apply(this,args)}}else{return false}return true}})("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports);(function(exports,nativeJSON){if(nativeJSON&&nativeJSON.parse){return exports.JSON={parse:nativeJSON.parse,stringify:nativeJSON.stringify}}var JSON=exports.JSON={};function f(n){return n<10?"0"+n:n}function date(d,key){return isFinite(d.valueOf())?d.getUTCFullYear()+"-"+f(d.getUTCMonth()+1)+"-"+f(d.getUTCDate())+"T"+f(d.getUTCHours())+":"+f(d.getUTCMinutes())+":"+f(d.getUTCSeconds())+"Z":null}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value instanceof Date){value=date(key)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==="[object Array]"){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){if(typeof rep[i]==="string"){k=rep[i];v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";
gap=mind;return v}}JSON.stringify=function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else if(typeof space==="string"){indent=space}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify")}return str("",{"":value})};JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}})("undefined"!=typeof io?io:module.exports,typeof JSON!=="undefined"?JSON:undefined);(function(exports,io){var parser=exports.parser={};var packets=parser.packets=["disconnect","connect","heartbeat","message","json","event","ack","error","noop"];var reasons=parser.reasons=["transport not supported","client not handshaken","unauthorized"];var advice=parser.advice=["reconnect"];var JSON=io.JSON,indexOf=io.util.indexOf;parser.encodePacket=function(packet){var type=indexOf(packets,packet.type),id=packet.id||"",endpoint=packet.endpoint||"",ack=packet.ack,data=null;switch(packet.type){case"error":var reason=packet.reason?indexOf(reasons,packet.reason):"",adv=packet.advice?indexOf(advice,packet.advice):"";if(reason!==""||adv!=="")data=reason+(adv!==""?"+"+adv:"");break;case"message":if(packet.data!=="")data=packet.data;break;case"event":var ev={name:packet.name};if(packet.args&&packet.args.length){ev.args=packet.args}data=JSON.stringify(ev);break;case"json":data=JSON.stringify(packet.data);break;case"connect":if(packet.qs)data=packet.qs;break;case"ack":data=packet.ackId+(packet.args&&packet.args.length?"+"+JSON.stringify(packet.args):"");break}var encoded=[type,id+(ack=="data"?"+":""),endpoint];if(data!==null&&data!==undefined)encoded.push(data);return encoded.join(":")};parser.encodePayload=function(packets){var decoded="";if(packets.length==1)return packets[0];for(var i=0,l=packets.length;i<l;i++){var packet=packets[i];decoded+="�"+packet.length+"�"+packets[i]}return decoded};var regexp=/([^:]+):([0-9]+)?(\+)?:([^:]+)?:?([\s\S]*)?/;parser.decodePacket=function(data){var pieces=data.match(regexp);if(!pieces)return{};var id=pieces[2]||"",data=pieces[5]||"",packet={type:packets[pieces[1]],endpoint:pieces[4]||""};if(id){packet.id=id;if(pieces[3])packet.ack="data";else packet.ack=true}switch(packet.type){case"error":var pieces=data.split("+");packet.reason=reasons[pieces[0]]||"";packet.advice=advice[pieces[1]]||"";break;case"message":packet.data=data||"";break;case"event":try{var opts=JSON.parse(data);packet.name=opts.name;packet.args=opts.args}catch(e){}packet.args=packet.args||[];break;case"json":try{packet.data=JSON.parse(data)}catch(e){}break;case"connect":packet.qs=data||"";break;case"ack":var pieces=data.match(/^([0-9]+)(\+)?(.*)/);if(pieces){packet.ackId=pieces[1];packet.args=[];if(pieces[3]){try{packet.args=pieces[3]?JSON.parse(pieces[3]):[]}catch(e){}}}break;case"disconnect":case"heartbeat":break}return packet};parser.decodePayload=function(data){if(data.charAt(0)=="�"){var ret=[];for(var i=1,length="";i<data.length;i++){if(data.charAt(i)=="�"){ret.push(parser.decodePacket(data.substr(i+1).substr(0,length)));i+=Number(length)+1;length=""}else{length+=data.charAt(i)}}return ret}else{return[parser.decodePacket(data)]}}})("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports);(function(exports,io){exports.Transport=Transport;function Transport(socket,sessid){this.socket=socket;this.sessid=sessid}io.util.mixin(Transport,io.EventEmitter);Transport.prototype.heartbeats=function(){return true};Transport.prototype.onData=function(data){this.clearCloseTimeout();if(this.socket.connected||this.socket.connecting||this.socket.reconnecting){this.setCloseTimeout()}if(data!==""){var msgs=io.parser.decodePayload(data);if(msgs&&msgs.length){for(var i=0,l=msgs.length;i<l;i++){this.onPacket(msgs[i])}}}return this};Transport.prototype.onPacket=function(packet){this.socket.setHeartbeatTimeout();if(packet.type=="heartbeat"){return this.onHeartbeat()}if(packet.type=="connect"&&packet.endpoint==""){this.onConnect()}if(packet.type=="error"&&packet.advice=="reconnect"){this.isOpen=false}this.socket.onPacket(packet);return this};Transport.prototype.setCloseTimeout=function(){if(!this.closeTimeout){var self=this;this.closeTimeout=setTimeout(function(){self.onDisconnect()},this.socket.closeTimeout)}};Transport.prototype.onDisconnect=function(){if(this.isOpen)this.close();this.clearTimeouts();this.socket.onDisconnect();return this};Transport.prototype.onConnect=function(){this.socket.onConnect();return this};Transport.prototype.clearCloseTimeout=function(){if(this.closeTimeout){clearTimeout(this.closeTimeout);this.closeTimeout=null}};Transport.prototype.clearTimeouts=function(){this.clearCloseTimeout();if(this.reopenTimeout){clearTimeout(this.reopenTimeout)}};Transport.prototype.packet=function(packet){this.send(io.parser.encodePacket(packet))};Transport.prototype.onHeartbeat=function(heartbeat){this.packet({type:"heartbeat"})};Transport.prototype.onOpen=function(){this.isOpen=true;this.clearCloseTimeout();this.socket.onOpen()};Transport.prototype.onClose=function(){var self=this;this.isOpen=false;this.socket.onClose();this.onDisconnect()};Transport.prototype.prepareUrl=function(){var options=this.socket.options;return this.scheme()+"://"+options.host+":"+options.port+"/"+options.resource+"/"+io.protocol+"/"+this.name+"/"+this.sessid};Transport.prototype.ready=function(socket,fn){fn.call(this)}})("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports);(function(exports,io,global){exports.Socket=Socket;function Socket(options){this.options={port:80,secure:false,document:"document"in global?document:false,resource:"socket.io",transports:io.transports,"connect timeout":1e4,"try multiple transports":true,reconnect:true,"reconnection delay":500,"reconnection limit":Infinity,"reopen delay":3e3,"max reconnection attempts":10,"sync disconnect on unload":false,"auto connect":true,"flash policy port":10843,manualFlush:false};io.util.merge(this.options,options);this.connected=false;this.open=false;this.connecting=false;this.reconnecting=false;this.namespaces={};this.buffer=[];this.doBuffer=false;if(this.options["sync disconnect on unload"]&&(!this.isXDomain()||io.util.ua.hasCORS)){var self=this;io.util.on(global,"beforeunload",function(){self.disconnectSync()},false)}if(this.options["auto connect"]){this.connect()}}io.util.mixin(Socket,io.EventEmitter);Socket.prototype.of=function(name){if(!this.namespaces[name]){this.namespaces[name]=new io.SocketNamespace(this,name);if(name!==""){this.namespaces[name].packet({type:"connect"})}}return this.namespaces[name]};Socket.prototype.publish=function(){this.emit.apply(this,arguments);var nsp;for(var i in this.namespaces){if(this.namespaces.hasOwnProperty(i)){nsp=this.of(i);nsp.$emit.apply(nsp,arguments)}}};function empty(){}Socket.prototype.handshake=function(fn){var self=this,options=this.options;function complete(data){if(data instanceof Error){self.connecting=false;self.onError(data.message)}else{fn.apply(null,data.split(":"))}}var url=["http"+(options.secure?"s":"")+":/",options.host+":"+options.port,options.resource,io.protocol,io.util.query(this.options.query,"t="+ +new Date)].join("/");if(this.isXDomain()&&!io.util.ua.hasCORS){var insertAt=document.getElementsByTagName("script")[0],script=document.createElement("script");script.src=url+"&jsonp="+io.j.length;insertAt.parentNode.insertBefore(script,insertAt);io.j.push(function(data){complete(data);script.parentNode.removeChild(script)})}else{var xhr=io.util.request();xhr.open("GET",url,true);if(this.isXDomain()){xhr.withCredentials=true}xhr.onreadystatechange=function(){if(xhr.readyState==4){xhr.onreadystatechange=empty;if(xhr.status==200){complete(xhr.responseText)}else if(xhr.status==403){self.onError(xhr.responseText)}else{self.connecting=false;!self.reconnecting&&self.onError(xhr.responseText)}}};xhr.send(null)}};Socket.prototype.getTransport=function(override){var transports=override||this.transports,match;for(var i=0,transport;transport=transports[i];i++){if(io.Transport[transport]&&io.Transport[transport].check(this)&&(!this.isXDomain()||io.Transport[transport].xdomainCheck(this))){return new io.Transport[transport](this,this.sessionid)}}return null};Socket.prototype.connect=function(fn){if(this.connecting){return this}var self=this;self.connecting=true;this.handshake(function(sid,heartbeat,close,transports){self.sessionid=sid;self.closeTimeout=close*1e3;self.heartbeatTimeout=heartbeat*1e3;if(!self.transports)self.transports=self.origTransports=transports?io.util.intersect(transports.split(","),self.options.transports):self.options.transports;self.setHeartbeatTimeout();function connect(transports){if(self.transport)self.transport.clearTimeouts();self.transport=self.getTransport(transports);if(!self.transport)return self.publish("connect_failed");self.transport.ready(self,function(){self.connecting=true;self.publish("connecting",self.transport.name);self.transport.open();if(self.options["connect timeout"]){self.connectTimeoutTimer=setTimeout(function(){if(!self.connected){self.connecting=false;if(self.options["try multiple transports"]){var remaining=self.transports;while(remaining.length>0&&remaining.splice(0,1)[0]!=self.transport.name){}if(remaining.length){connect(remaining)}else{self.publish("connect_failed")}}}},self.options["connect timeout"])}})}connect(self.transports);self.once("connect",function(){clearTimeout(self.connectTimeoutTimer);fn&&typeof fn=="function"&&fn()})});return this};Socket.prototype.setHeartbeatTimeout=function(){clearTimeout(this.heartbeatTimeoutTimer);if(this.transport&&!this.transport.heartbeats())return;var self=this;this.heartbeatTimeoutTimer=setTimeout(function(){self.transport.onClose()},this.heartbeatTimeout)};Socket.prototype.packet=function(data){if(this.connected&&!this.doBuffer){this.transport.packet(data)}else{this.buffer.push(data)}return this};Socket.prototype.setBuffer=function(v){this.doBuffer=v;if(!v&&this.connected&&this.buffer.length){if(!this.options["manualFlush"]){this.flushBuffer()}}};Socket.prototype.flushBuffer=function(){this.transport.payload(this.buffer);this.buffer=[]};Socket.prototype.disconnect=function(){if(this.connected||this.connecting){if(this.open){this.of("").packet({type:"disconnect"})}this.onDisconnect("booted")}return this};Socket.prototype.disconnectSync=function(){var xhr=io.util.request();var uri=["http"+(this.options.secure?"s":"")+":/",this.options.host+":"+this.options.port,this.options.resource,io.protocol,"",this.sessionid].join("/")+"/?disconnect=1";xhr.open("GET",uri,false);xhr.send(null);this.onDisconnect("booted")};Socket.prototype.isXDomain=function(){var port=global.location.port||("https:"==global.location.protocol?443:80);return this.options.host!==global.location.hostname||this.options.port!=port};Socket.prototype.onConnect=function(){if(!this.connected){this.connected=true;this.connecting=false;if(!this.doBuffer){this.setBuffer(false)}this.emit("connect")}};Socket.prototype.onOpen=function(){this.open=true};Socket.prototype.onClose=function(){this.open=false;clearTimeout(this.heartbeatTimeoutTimer)};Socket.prototype.onPacket=function(packet){this.of(packet.endpoint).onPacket(packet)};Socket.prototype.onError=function(err){if(err&&err.advice){if(err.advice==="reconnect"&&(this.connected||this.connecting)){this.disconnect();if(this.options.reconnect){this.reconnect()}}}this.publish("error",err&&err.reason?err.reason:err)};Socket.prototype.onDisconnect=function(reason){var wasConnected=this.connected,wasConnecting=this.connecting;this.connected=false;this.connecting=false;this.open=false;if(wasConnected||wasConnecting){this.transport.close();this.transport.clearTimeouts();if(wasConnected){this.publish("disconnect",reason);if("booted"!=reason&&this.options.reconnect&&!this.reconnecting){this.reconnect()}}}};Socket.prototype.reconnect=function(){this.reconnecting=true;this.reconnectionAttempts=0;this.reconnectionDelay=this.options["reconnection delay"];var self=this,maxAttempts=this.options["max reconnection attempts"],tryMultiple=this.options["try multiple transports"],limit=this.options["reconnection limit"];function reset(){if(self.connected){for(var i in self.namespaces){if(self.namespaces.hasOwnProperty(i)&&""!==i){self.namespaces[i].packet({type:"connect"})}}self.publish("reconnect",self.transport.name,self.reconnectionAttempts)}clearTimeout(self.reconnectionTimer);self.removeListener("connect_failed",maybeReconnect);self.removeListener("connect",maybeReconnect);self.reconnecting=false;delete self.reconnectionAttempts;delete self.reconnectionDelay;delete self.reconnectionTimer;delete self.redoTransports;self.options["try multiple transports"]=tryMultiple}function maybeReconnect(){if(!self.reconnecting){return}if(self.connected){return reset()}if(self.connecting&&self.reconnecting){return self.reconnectionTimer=setTimeout(maybeReconnect,1e3)}if(self.reconnectionAttempts++>=maxAttempts){if(!self.redoTransports){self.on("connect_failed",maybeReconnect);self.options["try multiple transports"]=true;self.transports=self.origTransports;self.transport=self.getTransport();self.redoTransports=true;self.connect()}else{self.publish("reconnect_failed");reset()}}else{if(self.reconnectionDelay<limit){self.reconnectionDelay*=2}self.connect();self.publish("reconnecting",self.reconnectionDelay,self.reconnectionAttempts);self.reconnectionTimer=setTimeout(maybeReconnect,self.reconnectionDelay)}}this.options["try multiple transports"]=false;this.reconnectionTimer=setTimeout(maybeReconnect,this.reconnectionDelay);this.on("connect",maybeReconnect)}})("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports,this);(function(exports,io){exports.SocketNamespace=SocketNamespace;function SocketNamespace(socket,name){this.socket=socket;this.name=name||"";this.flags={};this.json=new Flag(this,"json");this.ackPackets=0;this.acks={}}io.util.mixin(SocketNamespace,io.EventEmitter);SocketNamespace.prototype.$emit=io.EventEmitter.prototype.emit;SocketNamespace.prototype.of=function(){return this.socket.of.apply(this.socket,arguments)};SocketNamespace.prototype.packet=function(packet){packet.endpoint=this.name;this.socket.packet(packet);this.flags={};return this};SocketNamespace.prototype.send=function(data,fn){var packet={type:this.flags.json?"json":"message",data:data};if("function"==typeof fn){packet.id=++this.ackPackets;packet.ack=true;this.acks[packet.id]=fn}return this.packet(packet)};SocketNamespace.prototype.emit=function(name){var args=Array.prototype.slice.call(arguments,1),lastArg=args[args.length-1],packet={type:"event",name:name};if("function"==typeof lastArg){packet.id=++this.ackPackets;packet.ack="data";this.acks[packet.id]=lastArg;args=args.slice(0,args.length-1)}packet.args=args;return this.packet(packet)};SocketNamespace.prototype.disconnect=function(){if(this.name===""){this.socket.disconnect()}else{this.packet({type:"disconnect"});this.$emit("disconnect")}return this};SocketNamespace.prototype.onPacket=function(packet){var self=this;function ack(){self.packet({type:"ack",args:io.util.toArray(arguments),ackId:packet.id})}switch(packet.type){case"connect":this.$emit("connect");break;case"disconnect":if(this.name===""){this.socket.onDisconnect(packet.reason||"booted")}else{this.$emit("disconnect",packet.reason)}break;case"message":case"json":var params=["message",packet.data];if(packet.ack=="data"){params.push(ack)}else if(packet.ack){this.packet({type:"ack",ackId:packet.id})}this.$emit.apply(this,params);break;case"event":var params=[packet.name].concat(packet.args);if(packet.ack=="data")params.push(ack);this.$emit.apply(this,params);break;case"ack":if(this.acks[packet.ackId]){this.acks[packet.ackId].apply(this,packet.args);delete this.acks[packet.ackId]}break;case"error":if(packet.advice){this.socket.onError(packet)}else{if(packet.reason=="unauthorized"){this.$emit("connect_failed",packet.reason)}else{this.$emit("error",packet.reason)}}break}};function Flag(nsp,name){this.namespace=nsp;this.name=name}Flag.prototype.send=function(){this.namespace.flags[this.name]=true;this.namespace.send.apply(this.namespace,arguments)};Flag.prototype.emit=function(){this.namespace.flags[this.name]=true;this.namespace.emit.apply(this.namespace,arguments)}})("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports);(function(exports,io,global){exports.websocket=WS;function WS(socket){io.Transport.apply(this,arguments)}io.util.inherit(WS,io.Transport);WS.prototype.name="websocket";WS.prototype.open=function(){var query=io.util.query(this.socket.options.query),self=this,Socket;if(!Socket){Socket=global.MozWebSocket||global.WebSocket}this.websocket=new Socket(this.prepareUrl()+query);this.websocket.onopen=function(){self.onOpen();self.socket.setBuffer(false)};this.websocket.onmessage=function(ev){self.onData(ev.data)};this.websocket.onclose=function(){self.onClose();self.socket.setBuffer(true)};this.websocket.onerror=function(e){self.onError(e)};return this};if(io.util.ua.iDevice){WS.prototype.send=function(data){var self=this;setTimeout(function(){self.websocket.send(data)},0);return this}}else{WS.prototype.send=function(data){this.websocket.send(data);return this}}WS.prototype.payload=function(arr){for(var i=0,l=arr.length;i<l;i++){this.packet(arr[i])}return this};WS.prototype.close=function(){this.websocket.close();return this};WS.prototype.onError=function(e){this.socket.onError(e)};WS.prototype.scheme=function(){return this.socket.options.secure?"wss":"ws"};WS.check=function(){return"WebSocket"in global&&!("__addTask"in WebSocket)||"MozWebSocket"in global};WS.xdomainCheck=function(){return true};io.transports.push("websocket")})("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this);(function(exports,io){exports.flashsocket=Flashsocket;function Flashsocket(){io.Transport.websocket.apply(this,arguments)}io.util.inherit(Flashsocket,io.Transport.websocket);Flashsocket.prototype.name="flashsocket";Flashsocket.prototype.open=function(){var self=this,args=arguments;WebSocket.__addTask(function(){io.Transport.websocket.prototype.open.apply(self,args)});return this};Flashsocket.prototype.send=function(){var self=this,args=arguments;WebSocket.__addTask(function(){io.Transport.websocket.prototype.send.apply(self,args)});return this};Flashsocket.prototype.close=function(){WebSocket.__tasks.length=0;io.Transport.websocket.prototype.close.call(this);return this};Flashsocket.prototype.ready=function(socket,fn){function init(){var options=socket.options,port=options["flash policy port"],path=["http"+(options.secure?"s":"")+":/",options.host+":"+options.port,options.resource,"static/flashsocket","WebSocketMain"+(socket.isXDomain()?"Insecure":"")+".swf"];if(!Flashsocket.loaded){if(typeof WEB_SOCKET_SWF_LOCATION==="undefined"){WEB_SOCKET_SWF_LOCATION=path.join("/")}if(port!==843){WebSocket.loadFlashPolicyFile("xmlsocket://"+options.host+":"+port)}WebSocket.__initialize();Flashsocket.loaded=true}fn.call(self)}var self=this;if(document.body)return init();io.util.load(init)};Flashsocket.check=function(){if(typeof WebSocket=="undefined"||!("__initialize"in WebSocket)||!swfobject)return false;return swfobject.getFlashPlayerVersion().major>=10};Flashsocket.xdomainCheck=function(){return true};if(typeof window!="undefined"){WEB_SOCKET_DISABLE_AUTO_INITIALIZATION=true}io.transports.push("flashsocket")})("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports);if("undefined"!=typeof window){var swfobject=function(){var D="undefined",r="object",S="Shockwave Flash",W="ShockwaveFlash.ShockwaveFlash",q="application/x-shockwave-flash",R="SWFObjectExprInst",x="onreadystatechange",O=window,j=document,t=navigator,T=false,U=[h],o=[],N=[],I=[],l,Q,E,B,J=false,a=false,n,G,m=true,M=function(){var aa=typeof j.getElementById!=D&&typeof j.getElementsByTagName!=D&&typeof j.createElement!=D,ah=t.userAgent.toLowerCase(),Y=t.platform.toLowerCase(),ae=Y?/win/.test(Y):/win/.test(ah),ac=Y?/mac/.test(Y):/mac/.test(ah),af=/webkit/.test(ah)?parseFloat(ah.replace(/^.*webkit\/(\d+(\.\d+)?).*$/,"$1")):false,X=!+"1",ag=[0,0,0],ab=null;if(typeof t.plugins!=D&&typeof t.plugins[S]==r){ab=t.plugins[S].description;if(ab&&!(typeof t.mimeTypes!=D&&t.mimeTypes[q]&&!t.mimeTypes[q].enabledPlugin)){T=true;X=false;ab=ab.replace(/^.*\s+(\S+\s+\S+$)/,"$1");ag[0]=parseInt(ab.replace(/^(.*)\..*$/,"$1"),10);ag[1]=parseInt(ab.replace(/^.*\.(.*)\s.*$/,"$1"),10);ag[2]=/[a-zA-Z]/.test(ab)?parseInt(ab.replace(/^.*[a-zA-Z]+(.*)$/,"$1"),10):0}}else{if(typeof O[["Active"].concat("Object").join("X")]!=D){try{var ad=new(window[["Active"].concat("Object").join("X")])(W);if(ad){ab=ad.GetVariable("$version");if(ab){X=true;ab=ab.split(" ")[1].split(",");ag=[parseInt(ab[0],10),parseInt(ab[1],10),parseInt(ab[2],10)]}}}catch(Z){}}}return{w3:aa,pv:ag,wk:af,ie:X,win:ae,mac:ac}}(),k=function(){if(!M.w3){return}if(typeof j.readyState!=D&&j.readyState=="complete"||typeof j.readyState==D&&(j.getElementsByTagName("body")[0]||j.body)){f()}if(!J){if(typeof j.addEventListener!=D){j.addEventListener("DOMContentLoaded",f,false)}if(M.ie&&M.win){j.attachEvent(x,function(){if(j.readyState=="complete"){j.detachEvent(x,arguments.callee);f()}});if(O==top){(function(){if(J){return}try{j.documentElement.doScroll("left")}catch(X){setTimeout(arguments.callee,0);return}f()})()}}if(M.wk){(function(){if(J){return}if(!/loaded|complete/.test(j.readyState)){setTimeout(arguments.callee,0);return}f()})()}s(f)}}();function f(){if(J){return}try{var Z=j.getElementsByTagName("body")[0].appendChild(C("span"));Z.parentNode.removeChild(Z)}catch(aa){return}J=true;var X=U.length;for(var Y=0;Y<X;Y++){U[Y]()}}function K(X){if(J){X()}else{U[U.length]=X}}function s(Y){if(typeof O.addEventListener!=D){O.addEventListener("load",Y,false)}else{if(typeof j.addEventListener!=D){j.addEventListener("load",Y,false)}else{if(typeof O.attachEvent!=D){i(O,"onload",Y)}else{if(typeof O.onload=="function"){var X=O.onload;O.onload=function(){X();Y()}}else{O.onload=Y}}}}}function h(){if(T){V()}else{H()}}function V(){var X=j.getElementsByTagName("body")[0];var aa=C(r);aa.setAttribute("type",q);var Z=X.appendChild(aa);if(Z){var Y=0;(function(){if(typeof Z.GetVariable!=D){var ab=Z.GetVariable("$version");if(ab){ab=ab.split(" ")[1].split(",");M.pv=[parseInt(ab[0],10),parseInt(ab[1],10),parseInt(ab[2],10)]}}else{if(Y<10){Y++;setTimeout(arguments.callee,10);return}}X.removeChild(aa);Z=null;H()})()}else{H()}}function H(){var ag=o.length;if(ag>0){for(var af=0;af<ag;af++){var Y=o[af].id;var ab=o[af].callbackFn;var aa={success:false,id:Y};if(M.pv[0]>0){var ae=c(Y);if(ae){if(F(o[af].swfVersion)&&!(M.wk&&M.wk<312)){w(Y,true);if(ab){aa.success=true;aa.ref=z(Y);ab(aa)}}else{if(o[af].expressInstall&&A()){var ai={};ai.data=o[af].expressInstall;ai.width=ae.getAttribute("width")||"0";ai.height=ae.getAttribute("height")||"0";if(ae.getAttribute("class")){ai.styleclass=ae.getAttribute("class")}if(ae.getAttribute("align")){ai.align=ae.getAttribute("align")}var ah={};var X=ae.getElementsByTagName("param");var ac=X.length;for(var ad=0;ad<ac;ad++){if(X[ad].getAttribute("name").toLowerCase()!="movie"){ah[X[ad].getAttribute("name")]=X[ad].getAttribute("value")}}P(ai,ah,Y,ab)}else{p(ae);if(ab){ab(aa)}}}}}else{w(Y,true);if(ab){var Z=z(Y);if(Z&&typeof Z.SetVariable!=D){aa.success=true;aa.ref=Z}ab(aa)}}}}}function z(aa){var X=null;var Y=c(aa);if(Y&&Y.nodeName=="OBJECT"){if(typeof Y.SetVariable!=D){X=Y}else{var Z=Y.getElementsByTagName(r)[0];if(Z){X=Z}}}return X}function A(){return!a&&F("6.0.65")&&(M.win||M.mac)&&!(M.wk&&M.wk<312)}function P(aa,ab,X,Z){a=true;E=Z||null;B={success:false,id:X};var ae=c(X);if(ae){if(ae.nodeName=="OBJECT"){l=g(ae);Q=null}else{l=ae;Q=X}aa.id=R;if(typeof aa.width==D||!/%$/.test(aa.width)&&parseInt(aa.width,10)<310){aa.width="310"}if(typeof aa.height==D||!/%$/.test(aa.height)&&parseInt(aa.height,10)<137){aa.height="137"}j.title=j.title.slice(0,47)+" - Flash Player Installation";var ad=M.ie&&M.win?["Active"].concat("").join("X"):"PlugIn",ac="MMredirectURL="+O.location.toString().replace(/&/g,"%26")+"&MMplayerType="+ad+"&MMdoctitle="+j.title;if(typeof ab.flashvars!=D){ab.flashvars+="&"+ac}else{ab.flashvars=ac}if(M.ie&&M.win&&ae.readyState!=4){var Y=C("div");X+="SWFObjectNew";Y.setAttribute("id",X);ae.parentNode.insertBefore(Y,ae);ae.style.display="none";(function(){if(ae.readyState==4){ae.parentNode.removeChild(ae)}else{setTimeout(arguments.callee,10)}})()}u(aa,ab,X)}}function p(Y){if(M.ie&&M.win&&Y.readyState!=4){var X=C("div");Y.parentNode.insertBefore(X,Y);X.parentNode.replaceChild(g(Y),X);Y.style.display="none";(function(){if(Y.readyState==4){Y.parentNode.removeChild(Y)}else{setTimeout(arguments.callee,10)}})()}else{Y.parentNode.replaceChild(g(Y),Y)}}function g(ab){var aa=C("div");if(M.win&&M.ie){aa.innerHTML=ab.innerHTML}else{var Y=ab.getElementsByTagName(r)[0];if(Y){var ad=Y.childNodes;if(ad){var X=ad.length;for(var Z=0;Z<X;Z++){if(!(ad[Z].nodeType==1&&ad[Z].nodeName=="PARAM")&&!(ad[Z].nodeType==8)){aa.appendChild(ad[Z].cloneNode(true))}}}}}return aa}function u(ai,ag,Y){var X,aa=c(Y);if(M.wk&&M.wk<312){return X}if(aa){if(typeof ai.id==D){ai.id=Y}if(M.ie&&M.win){var ah="";for(var ae in ai){if(ai[ae]!=Object.prototype[ae]){if(ae.toLowerCase()=="data"){ag.movie=ai[ae]}else{if(ae.toLowerCase()=="styleclass"){ah+=' class="'+ai[ae]+'"'}else{if(ae.toLowerCase()!="classid"){ah+=" "+ae+'="'+ai[ae]+'"'}}}}}var af="";for(var ad in ag){if(ag[ad]!=Object.prototype[ad]){af+='<param name="'+ad+'" value="'+ag[ad]+'" />'}}aa.outerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"'+ah+">"+af+"</object>";N[N.length]=ai.id;X=c(ai.id)}else{var Z=C(r);Z.setAttribute("type",q);for(var ac in ai){if(ai[ac]!=Object.prototype[ac]){if(ac.toLowerCase()=="styleclass"){Z.setAttribute("class",ai[ac])}else{if(ac.toLowerCase()!="classid"){Z.setAttribute(ac,ai[ac])}}}}for(var ab in ag){if(ag[ab]!=Object.prototype[ab]&&ab.toLowerCase()!="movie"){e(Z,ab,ag[ab])}}aa.parentNode.replaceChild(Z,aa);X=Z}}return X}function e(Z,X,Y){var aa=C("param");aa.setAttribute("name",X);aa.setAttribute("value",Y);Z.appendChild(aa)}function y(Y){var X=c(Y);if(X&&X.nodeName=="OBJECT"){if(M.ie&&M.win){X.style.display="none";(function(){if(X.readyState==4){b(Y)}else{setTimeout(arguments.callee,10)}})()}else{X.parentNode.removeChild(X)}}}function b(Z){var Y=c(Z);if(Y){for(var X in Y){if(typeof Y[X]=="function"){Y[X]=null}}Y.parentNode.removeChild(Y)}}function c(Z){var X=null;try{X=j.getElementById(Z)}catch(Y){}return X}function C(X){return j.createElement(X)}function i(Z,X,Y){Z.attachEvent(X,Y);I[I.length]=[Z,X,Y]}function F(Z){var Y=M.pv,X=Z.split(".");X[0]=parseInt(X[0],10);X[1]=parseInt(X[1],10)||0;X[2]=parseInt(X[2],10)||0;return Y[0]>X[0]||Y[0]==X[0]&&Y[1]>X[1]||Y[0]==X[0]&&Y[1]==X[1]&&Y[2]>=X[2]?true:false}function v(ac,Y,ad,ab){if(M.ie&&M.mac){return}var aa=j.getElementsByTagName("head")[0];if(!aa){return}var X=ad&&typeof ad=="string"?ad:"screen";if(ab){n=null;G=null}if(!n||G!=X){var Z=C("style");Z.setAttribute("type","text/css");Z.setAttribute("media",X);n=aa.appendChild(Z);if(M.ie&&M.win&&typeof j.styleSheets!=D&&j.styleSheets.length>0){n=j.styleSheets[j.styleSheets.length-1]}G=X}if(M.ie&&M.win){if(n&&typeof n.addRule==r){n.addRule(ac,Y)}}else{if(n&&typeof j.createTextNode!=D){n.appendChild(j.createTextNode(ac+" {"+Y+"}"))}}}function w(Z,X){if(!m){return}var Y=X?"visible":"hidden";if(J&&c(Z)){c(Z).style.visibility=Y}else{v("#"+Z,"visibility:"+Y)}}function L(Y){var Z=/[\\\"<>\.;]/;var X=Z.exec(Y)!=null;return X&&typeof encodeURIComponent!=D?encodeURIComponent(Y):Y}var d=function(){if(M.ie&&M.win){window.attachEvent("onunload",function(){var ac=I.length;for(var ab=0;ab<ac;ab++){I[ab][0].detachEvent(I[ab][1],I[ab][2])}var Z=N.length;for(var aa=0;aa<Z;aa++){y(N[aa])}for(var Y in M){M[Y]=null}M=null;for(var X in swfobject){swfobject[X]=null}swfobject=null})}}();return{registerObject:function(ab,X,aa,Z){if(M.w3&&ab&&X){var Y={};Y.id=ab;Y.swfVersion=X;Y.expressInstall=aa;Y.callbackFn=Z;o[o.length]=Y;w(ab,false)}else{if(Z){Z({success:false,id:ab})}}},getObjectById:function(X){if(M.w3){return z(X)}},embedSWF:function(ab,ah,ae,ag,Y,aa,Z,ad,af,ac){var X={success:false,id:ah};if(M.w3&&!(M.wk&&M.wk<312)&&ab&&ah&&ae&&ag&&Y){w(ah,false);K(function(){ae+="";ag+="";var aj={};if(af&&typeof af===r){for(var al in af){aj[al]=af[al]}}aj.data=ab;aj.width=ae;aj.height=ag;var am={};if(ad&&typeof ad===r){for(var ak in ad){am[ak]=ad[ak]}}if(Z&&typeof Z===r){for(var ai in Z){if(typeof am.flashvars!=D){am.flashvars+="&"+ai+"="+Z[ai]}else{am.flashvars=ai+"="+Z[ai]}}}if(F(Y)){var an=u(aj,am,ah);if(aj.id==ah){w(ah,true)}X.success=true;X.ref=an}else{if(aa&&A()){aj.data=aa;P(aj,am,ah,ac);return}else{w(ah,true)}}if(ac){ac(X)}})}else{if(ac){ac(X)}}},switchOffAutoHideShow:function(){m=false},ua:M,getFlashPlayerVersion:function(){return{major:M.pv[0],minor:M.pv[1],release:M.pv[2]}},hasFlashPlayerVersion:F,createSWF:function(Z,Y,X){if(M.w3){return u(Z,Y,X)}else{return undefined}},showExpressInstall:function(Z,aa,X,Y){if(M.w3&&A()){P(Z,aa,X,Y)}},removeSWF:function(X){if(M.w3){y(X)}},createCSS:function(aa,Z,Y,X){if(M.w3){v(aa,Z,Y,X)}},addDomLoadEvent:K,addLoadEvent:s,getQueryParamValue:function(aa){var Z=j.location.search||j.location.hash;if(Z){if(/\?/.test(Z)){Z=Z.split("?")[1]}if(aa==null){return L(Z)}var Y=Z.split("&");for(var X=0;X<Y.length;X++){if(Y[X].substring(0,Y[X].indexOf("="))==aa){return L(Y[X].substring(Y[X].indexOf("=")+1))}}}return""},expressInstallCallback:function(){if(a){var X=c(R);if(X&&l){X.parentNode.replaceChild(l,X);if(Q){w(Q,true);if(M.ie&&M.win){l.style.display="block"}}if(E){E(B)}}a=false}}}}()}(function(){if("undefined"==typeof window||window.WebSocket)return;var console=window.console;if(!console||!console.log||!console.error){console={log:function(){},error:function(){}}}if(!swfobject.hasFlashPlayerVersion("10.0.0")){console.error("Flash Player >= 10.0.0 is required.");return}if(location.protocol=="file:"){console.error("WARNING: web-socket-js doesn't work in file:///... URL "+"unless you set Flash Security Settings properly. "+"Open the page via Web server i.e. http://...")}WebSocket=function(url,protocols,proxyHost,proxyPort,headers){var self=this;self.__id=WebSocket.__nextId++;WebSocket.__instances[self.__id]=self;self.readyState=WebSocket.CONNECTING;self.bufferedAmount=0;self.__events={};if(!protocols){protocols=[]}else if(typeof protocols=="string"){protocols=[protocols]}setTimeout(function(){WebSocket.__addTask(function(){WebSocket.__flash.create(self.__id,url,protocols,proxyHost||null,proxyPort||0,headers||null)})},0)};WebSocket.prototype.send=function(data){if(this.readyState==WebSocket.CONNECTING){throw"INVALID_STATE_ERR: Web Socket connection has not been established"}var result=WebSocket.__flash.send(this.__id,encodeURIComponent(data));if(result<0){return true}else{this.bufferedAmount+=result;return false}};WebSocket.prototype.close=function(){if(this.readyState==WebSocket.CLOSED||this.readyState==WebSocket.CLOSING){return}this.readyState=WebSocket.CLOSING;WebSocket.__flash.close(this.__id)};WebSocket.prototype.addEventListener=function(type,listener,useCapture){if(!(type in this.__events)){this.__events[type]=[]}this.__events[type].push(listener)
};WebSocket.prototype.removeEventListener=function(type,listener,useCapture){if(!(type in this.__events))return;var events=this.__events[type];for(var i=events.length-1;i>=0;--i){if(events[i]===listener){events.splice(i,1);break}}};WebSocket.prototype.dispatchEvent=function(event){var events=this.__events[event.type]||[];for(var i=0;i<events.length;++i){events[i](event)}var handler=this["on"+event.type];if(handler)handler(event)};WebSocket.prototype.__handleEvent=function(flashEvent){if("readyState"in flashEvent){this.readyState=flashEvent.readyState}if("protocol"in flashEvent){this.protocol=flashEvent.protocol}var jsEvent;if(flashEvent.type=="open"||flashEvent.type=="error"){jsEvent=this.__createSimpleEvent(flashEvent.type)}else if(flashEvent.type=="close"){jsEvent=this.__createSimpleEvent("close")}else if(flashEvent.type=="message"){var data=decodeURIComponent(flashEvent.message);jsEvent=this.__createMessageEvent("message",data)}else{throw"unknown event type: "+flashEvent.type}this.dispatchEvent(jsEvent)};WebSocket.prototype.__createSimpleEvent=function(type){if(document.createEvent&&window.Event){var event=document.createEvent("Event");event.initEvent(type,false,false);return event}else{return{type:type,bubbles:false,cancelable:false}}};WebSocket.prototype.__createMessageEvent=function(type,data){if(document.createEvent&&window.MessageEvent&&!window.opera){var event=document.createEvent("MessageEvent");event.initMessageEvent("message",false,false,data,null,null,window,null);return event}else{return{type:type,data:data,bubbles:false,cancelable:false}}};WebSocket.CONNECTING=0;WebSocket.OPEN=1;WebSocket.CLOSING=2;WebSocket.CLOSED=3;WebSocket.__flash=null;WebSocket.__instances={};WebSocket.__tasks=[];WebSocket.__nextId=0;WebSocket.loadFlashPolicyFile=function(url){WebSocket.__addTask(function(){WebSocket.__flash.loadManualPolicyFile(url)})};WebSocket.__initialize=function(){if(WebSocket.__flash)return;if(WebSocket.__swfLocation){window.WEB_SOCKET_SWF_LOCATION=WebSocket.__swfLocation}if(!window.WEB_SOCKET_SWF_LOCATION){console.error("[WebSocket] set WEB_SOCKET_SWF_LOCATION to location of WebSocketMain.swf");return}var container=document.createElement("div");container.id="webSocketContainer";container.style.position="absolute";if(WebSocket.__isFlashLite()){container.style.left="0px";container.style.top="0px"}else{container.style.left="-100px";container.style.top="-100px"}var holder=document.createElement("div");holder.id="webSocketFlash";container.appendChild(holder);document.body.appendChild(container);swfobject.embedSWF(WEB_SOCKET_SWF_LOCATION,"webSocketFlash","1","1","10.0.0",null,null,{hasPriority:true,swliveconnect:true,allowScriptAccess:"always"},null,function(e){if(!e.success){console.error("[WebSocket] swfobject.embedSWF failed")}})};WebSocket.__onFlashInitialized=function(){setTimeout(function(){WebSocket.__flash=document.getElementById("webSocketFlash");WebSocket.__flash.setCallerUrl(location.href);WebSocket.__flash.setDebug(!!window.WEB_SOCKET_DEBUG);for(var i=0;i<WebSocket.__tasks.length;++i){WebSocket.__tasks[i]()}WebSocket.__tasks=[]},0)};WebSocket.__onFlashEvent=function(){setTimeout(function(){try{var events=WebSocket.__flash.receiveEvents();for(var i=0;i<events.length;++i){WebSocket.__instances[events[i].webSocketId].__handleEvent(events[i])}}catch(e){console.error(e)}},0);return true};WebSocket.__log=function(message){console.log(decodeURIComponent(message))};WebSocket.__error=function(message){console.error(decodeURIComponent(message))};WebSocket.__addTask=function(task){if(WebSocket.__flash){task()}else{WebSocket.__tasks.push(task)}};WebSocket.__isFlashLite=function(){if(!window.navigator||!window.navigator.mimeTypes){return false}var mimeType=window.navigator.mimeTypes["application/x-shockwave-flash"];if(!mimeType||!mimeType.enabledPlugin||!mimeType.enabledPlugin.filename){return false}return mimeType.enabledPlugin.filename.match(/flashlite/i)?true:false};if(!window.WEB_SOCKET_DISABLE_AUTO_INITIALIZATION){if(window.addEventListener){window.addEventListener("load",function(){WebSocket.__initialize()},false)}else{window.attachEvent("onload",function(){WebSocket.__initialize()})}}})();(function(exports,io,global){exports.XHR=XHR;function XHR(socket){if(!socket)return;io.Transport.apply(this,arguments);this.sendBuffer=[]}io.util.inherit(XHR,io.Transport);XHR.prototype.open=function(){this.socket.setBuffer(false);this.onOpen();this.get();this.setCloseTimeout();return this};XHR.prototype.payload=function(payload){var msgs=[];for(var i=0,l=payload.length;i<l;i++){msgs.push(io.parser.encodePacket(payload[i]))}this.send(io.parser.encodePayload(msgs))};XHR.prototype.send=function(data){this.post(data);return this};function empty(){}XHR.prototype.post=function(data){var self=this;this.socket.setBuffer(true);function stateChange(){if(this.readyState==4){this.onreadystatechange=empty;self.posting=false;if(this.status==200){self.socket.setBuffer(false)}else{self.onClose()}}}function onload(){this.onload=empty;self.socket.setBuffer(false)}this.sendXHR=this.request("POST");if(global.XDomainRequest&&this.sendXHR instanceof XDomainRequest){this.sendXHR.onload=this.sendXHR.onerror=onload}else{this.sendXHR.onreadystatechange=stateChange}this.sendXHR.send(data)};XHR.prototype.close=function(){this.onClose();return this};XHR.prototype.request=function(method){var req=io.util.request(this.socket.isXDomain()),query=io.util.query(this.socket.options.query,"t="+ +new Date);req.open(method||"GET",this.prepareUrl()+query,true);if(method=="POST"){try{if(req.setRequestHeader){req.setRequestHeader("Content-type","text/plain;charset=UTF-8")}else{req.contentType="text/plain"}}catch(e){}}return req};XHR.prototype.scheme=function(){return this.socket.options.secure?"https":"http"};XHR.check=function(socket,xdomain){try{var request=io.util.request(xdomain),usesXDomReq=global.XDomainRequest&&request instanceof XDomainRequest,socketProtocol=socket&&socket.options&&socket.options.secure?"https:":"http:",isXProtocol=global.location&&socketProtocol!=global.location.protocol;if(request&&!(usesXDomReq&&isXProtocol)){return true}}catch(e){}return false};XHR.xdomainCheck=function(socket){return XHR.check(socket,true)}})("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this);(function(exports,io){exports.htmlfile=HTMLFile;function HTMLFile(socket){io.Transport.XHR.apply(this,arguments)}io.util.inherit(HTMLFile,io.Transport.XHR);HTMLFile.prototype.name="htmlfile";HTMLFile.prototype.get=function(){this.doc=new(window[["Active"].concat("Object").join("X")])("htmlfile");this.doc.open();this.doc.write("<html></html>");this.doc.close();this.doc.parentWindow.s=this;var iframeC=this.doc.createElement("div");iframeC.className="socketio";this.doc.body.appendChild(iframeC);this.iframe=this.doc.createElement("iframe");iframeC.appendChild(this.iframe);var self=this,query=io.util.query(this.socket.options.query,"t="+ +new Date);this.iframe.src=this.prepareUrl()+query;io.util.on(window,"unload",function(){self.destroy()})};HTMLFile.prototype._=function(data,doc){data=data.replace(/\\\//g,"/");this.onData(data);try{var script=doc.getElementsByTagName("script")[0];script.parentNode.removeChild(script)}catch(e){}};HTMLFile.prototype.destroy=function(){if(this.iframe){try{this.iframe.src="about:blank"}catch(e){}this.doc=null;this.iframe.parentNode.removeChild(this.iframe);this.iframe=null;CollectGarbage()}};HTMLFile.prototype.close=function(){this.destroy();return io.Transport.XHR.prototype.close.call(this)};HTMLFile.check=function(socket){if(typeof window!="undefined"&&["Active"].concat("Object").join("X")in window){try{var a=new(window[["Active"].concat("Object").join("X")])("htmlfile");return a&&io.Transport.XHR.check(socket)}catch(e){}}return false};HTMLFile.xdomainCheck=function(){return false};io.transports.push("htmlfile")})("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports);(function(exports,io,global){exports["xhr-polling"]=XHRPolling;function XHRPolling(){io.Transport.XHR.apply(this,arguments)}io.util.inherit(XHRPolling,io.Transport.XHR);io.util.merge(XHRPolling,io.Transport.XHR);XHRPolling.prototype.name="xhr-polling";XHRPolling.prototype.heartbeats=function(){return false};XHRPolling.prototype.open=function(){var self=this;io.Transport.XHR.prototype.open.call(self);return false};function empty(){}XHRPolling.prototype.get=function(){if(!this.isOpen)return;var self=this;function stateChange(){if(this.readyState==4){this.onreadystatechange=empty;if(this.status==200){self.onData(this.responseText);self.get()}else{self.onClose()}}}function onload(){this.onload=empty;this.onerror=empty;self.retryCounter=1;self.onData(this.responseText);self.get()}function onerror(){self.retryCounter++;if(!self.retryCounter||self.retryCounter>3){self.onClose()}else{self.get()}}this.xhr=this.request();if(global.XDomainRequest&&this.xhr instanceof XDomainRequest){this.xhr.onload=onload;this.xhr.onerror=onerror}else{this.xhr.onreadystatechange=stateChange}this.xhr.send(null)};XHRPolling.prototype.onClose=function(){io.Transport.XHR.prototype.onClose.call(this);if(this.xhr){this.xhr.onreadystatechange=this.xhr.onload=this.xhr.onerror=empty;try{this.xhr.abort()}catch(e){}this.xhr=null}};XHRPolling.prototype.ready=function(socket,fn){var self=this;io.util.defer(function(){fn.call(self)})};io.transports.push("xhr-polling")})("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this);(function(exports,io,global){var indicator=global.document&&"MozAppearance"in global.document.documentElement.style;exports["jsonp-polling"]=JSONPPolling;function JSONPPolling(socket){io.Transport["xhr-polling"].apply(this,arguments);this.index=io.j.length;var self=this;io.j.push(function(msg){self._(msg)})}io.util.inherit(JSONPPolling,io.Transport["xhr-polling"]);JSONPPolling.prototype.name="jsonp-polling";JSONPPolling.prototype.post=function(data){var self=this,query=io.util.query(this.socket.options.query,"t="+ +new Date+"&i="+this.index);if(!this.form){var form=document.createElement("form"),area=document.createElement("textarea"),id=this.iframeId="socketio_iframe_"+this.index,iframe;form.className="socketio";form.style.position="absolute";form.style.top="0px";form.style.left="0px";form.style.display="none";form.target=id;form.method="POST";form.setAttribute("accept-charset","utf-8");area.name="d";form.appendChild(area);document.body.appendChild(form);this.form=form;this.area=area}this.form.action=this.prepareUrl()+query;function complete(){initIframe();self.socket.setBuffer(false)}function initIframe(){if(self.iframe){self.form.removeChild(self.iframe)}try{iframe=document.createElement('<iframe name="'+self.iframeId+'">')}catch(e){iframe=document.createElement("iframe");iframe.name=self.iframeId}iframe.id=self.iframeId;self.form.appendChild(iframe);self.iframe=iframe}initIframe();this.area.value=io.JSON.stringify(data);try{this.form.submit()}catch(e){}if(this.iframe.attachEvent){iframe.onreadystatechange=function(){if(self.iframe.readyState=="complete"){complete()}}}else{this.iframe.onload=complete}this.socket.setBuffer(true)};JSONPPolling.prototype.get=function(){var self=this,script=document.createElement("script"),query=io.util.query(this.socket.options.query,"t="+ +new Date+"&i="+this.index);if(this.script){this.script.parentNode.removeChild(this.script);this.script=null}script.async=true;script.src=this.prepareUrl()+query;script.onerror=function(){self.onClose()};var insertAt=document.getElementsByTagName("script")[0];insertAt.parentNode.insertBefore(script,insertAt);this.script=script;if(indicator){setTimeout(function(){var iframe=document.createElement("iframe");document.body.appendChild(iframe);document.body.removeChild(iframe)},100)}};JSONPPolling.prototype._=function(msg){this.onData(msg);if(this.isOpen){this.get()}return this};JSONPPolling.prototype.ready=function(socket,fn){var self=this;if(!indicator)return fn.call(this);io.util.load(function(){fn.call(self)})};JSONPPolling.check=function(){return"document"in global};JSONPPolling.xdomainCheck=function(){return true};io.transports.push("jsonp-polling")})("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this);if(typeof define==="function"&&define.amd){define("io",[],function(){return io})}})();define("pubsub",["ext/underscore","app-context","io"],function(_,appContext,io){var $=jQuery;var groupIdMap={};var getGroupId=function(conversationId,callback){if(groupIdMap[conversationId]){callback(groupIdMap[conversationId])}else{$.ajax({url:appContext.fullUrl("/v2/messages/"+conversationId+"/participants"),success:function(participants){_.assert(participants.length==1,"only 1 participant expected");var idParts=participants[0].id.split(":");_.assert(idParts[1]=="group","not a group participant: "+idParts[1]);groupIdMap[conversationId]=idParts[3];callback(groupIdMap[conversationId])},error:function(jqXHR,textStatus,errorThrown){console.log(JSON.stringify(jqXHR));console.log(JSON.stringify(textStatus));console.log(JSON.stringify(errorThrown));appContext.navigate("#error",true)}})}};var createSocket=function(accessToken){console.log("creating socket ..");var socket=io.connect(appContext.resolvePubsubEndPoint()+"?auth_type=token&token="+accessToken.access_token+"&subscribe=chat");socket.on("connect",function(){setInterval(function(){socket.emit("ping")},3e4)});socket.on("buddies",function(conversation,buddies){var receiver=$(".receiver-"+conversation);_.each(buddies,function(buddy){receiver.trigger("buddy",buddy)})});socket.on("chat-message",function(message){var receiver=$(".receiver-"+message.conversation);if(receiver.length==1){receiver.trigger("chatmsg",message)}else{if(message.type=="text"){getGroupId(message.conversation,function(groupId){appContext.addNotification("#messages/groups:@"+groupId)})}}});socket.on("unread",function(conversations){_.each(conversations,function(conversation){getGroupId(conversation.id,function(groupId){appContext.addNotification("#messages/groups:@"+groupId)})})});return socket};var socket=null;var accessToken=appContext.getAccessToken();if(accessToken){socket=createSocket(accessToken)}appContext.on("accessToken",function(){if(socket){socket.removeAllListeners("unread");socket.removeAllListeners("chat-message");socket.removeAllListeners("buddies");socket.removeAllListeners("connect")}socket=createSocket(appContext.getAccessToken())});return{emit:function(event,data){if(!socket){throw"no socket available"}socket.emit(event,data)}}});define("api/model/message",["ext/underscore","moment","api/model/base"],function(_,moment,BaseModel){return BaseModel.extend({initialize:function(attributes,options){this.principle=options.principle;this.created=new Date},getSourceId:function(){var source=this.get("source");return source?source.id.split(":")[3]:this.principle.id},getSourceName:function(){var source=this.get("source");return source?source.name:this.principle.name},getDateReceived:function(){var date=moment(this.get("dateReceived"));return date?new Date(moment(date,"YYYY-MM-DDTHH:mm:ss.SSSZ").valueOf()):this.created},isType:function(){return this.get("type")=="type"},isTyping:function(){_.assert(this.isType(),"not a type message");return this.get("body")=="yes"},noThumb:function(){var noThumb=_.find(this.get("properties"),function(property){return property=="nothumb"});return!!noThumb}})});define("api/collection/messages",["api/collection/base","api/model/message"],function(BaseCollection,Message){return BaseCollection.extend({model:Message,initialize:function(models,options){if(options.current){this.conversation=options.current.conversation;if(options.current.offset){this.params={offset:options.current.offset}}else if(options.current.length>0){this.params={"condition.offset":options.current.length}}}else{this.conversation=options.conversation}},url:function(){return"/v2/messages/"+this.conversation.id+"/history"},parse:function(response){if(response instanceof Array){this.more=response.length>0;return response}this.offset=response.offset;this.more=response.more;return response.items},addPage:function(page){this.add(page.models);this.offset=page.offset;this.more=page.more},comparator:function(model){return-model.getDateReceived().getTime()}})});define("text!text/message/item.html",[],function(){return'\n<% if (noThumb()) { %>\n	<img src="<%= appurl %>/styles/images/default_thumbnail.png">\n<% } else { %>\n	<img src="<%= cdn %>/users/<%= getSourceId() %>/thumbnail">\n<% } %>\n<div class="info <% if (getSourceId() == me.id) { print(\'self\') } %>">\n	<p>\n		<strong class="name"><%= getSourceName() %></strong>\n		<abbr data-time="<%= getDateReceived().getTime() %>" class="timeago">\n			<%= $.timeago(getDateReceived()) %>\n		</abbr>\n	</p>\n	<p class="body"><%= get(\'body\') %></p>\n</div>	\n'});define("view/message/item",["ext/underscore","app-context","view/base","text!text/message/item.html"],function(_,appContext,BaseView,template){var $=jQuery;return BaseView.extend({tagName:"li",events:{"click div.self":"update"},initialize:function(options){_.bindToMethods(this);this.options=options;this.model.on("change",this.change)},render:function(){var args=_.extend({cdn:appContext.cdn,me:appContext.getPrinciple()},this.model);this.$el.html(this.template(template,args));return this},change:function(){$(".body",this.$el).html(this.model.get("body"))},update:function(){this.options.inputView.update(this.model)}})});define("text!text/message/input.html",[],function(){return'<textarea placeholder="<%= m_message_placeholder %>"></textarea>\n<a href="javascript:void(0)" class="send hidden">\n	<span class="glyphicon glyphicon-send"></span>\n</a>\n<div class="update-btns hidden">\n	<a href="javascript:void(0)" class="update">\n		<span class="glyphicon glyphicon-ok"></span>\n	</a>\n	<a href="javascript:void(0)" class="cancel">\n		<span class="glyphicon glyphicon-remove"></span>\n	</a>\n</div>\n'});define("view/message/input",["ext/underscore","view/base","app-context","pubsub","text!text/message/input.html"],function(_,BaseView,appContext,pubsub,template){var $=jQuery;return BaseView.extend({back:{code:"m_btn_context",link:"#context"},className:"messages-input",events:{"keyup textarea":"keyup","click .send,.update":"send","click .cancel":"cancel"},initialize:function(options){_.bindToMethods(this);this.options=options},render:function(){this.$el.html(this.template(template));this.$input=$("textarea",this.$el);this.$send=$(".send",this.$el);return this},keyup:function(){if(_.trim(this.$input.val()).length==0){if(this.target){this.cancel()}else{this.stopTyping;this.sendBtn(false)}}else{if(!this.typing){this.emitMessage("type","yes")}this.typing=true;this.stopTyping_debounced();if(!this.target){this.sendBtn(true)}}},send:function(){var body=_.trim(this.$input.val()).replace(/\n/gm,"<br/>");if(this.target){this.emitMessage("update",body,this.target);this.cancel()}else{this.emitMessage("text",body);this.$input.val("");this.stopTyping();this.sendBtn(false)}},cancel:function(){this.target=null;this.$input.val("");this.updateBtns(false);this.stopTyping()},emitMessage:function(type,body,target){var conversationId=this.options.conversation.id;var message={conversation:conversationId,deliveryId:conversationId+Math.random().toString(36).substr(2),body:body,type:type,properties:[]};if(typeof target!="undefined"){message.id=target.id;message.deliveryId=target.get("deliveryId")}if(!appContext.getPrinciple().logo){message.properties.push("nothumb")}pubsub.emit("chat-message",message);$(".receiver-"+conversationId).trigger("chatmsg",message)},stopTyping:function(){this.emitMessage("type","no");this.typing=false},stopTyping_debounced:_.debounce(function(){this.stopTyping()},5e3),update:function(message){this.target=message;this.$input.val(message.get("body").replace(/<br ?\/>/g,"\n")).focus();this.sendBtn(false);this.updateBtns(true)},updateBtns:function(show){var $btns=$(".update-btns",this.$el);if(show){$btns.removeClass("hidden");this.$input.width(this.$el.width()-65)}else{$btns.addClass("hidden");this.$input.css("width","100%")}},sendBtn:function(show){if(show){this.$send.removeClass("hidden");this.$input.width(this.$el.width()-40)}else{this.$send.addClass("hidden");this.$input.css("width","100%")}}})});define("view/message/list",["ext/underscore","app-context","view/page","api/collection/messages","api/model/message","view/navbar-factory","view/message/item","view/message/input"],function(_,appContext,PageView,Messages,Message,navbarFactory,MessageItemView,MessageInputView){var $=jQuery;return PageView.extend({back:{code:"m_btn_context",link:"#context"},tagName:"ul",className:"messages list-unstyled",events:{buddy:"receiveBuddy",chatmsg:"receiveMessage"},initialize:function(options){PageView.prototype.initialize.apply(this,arguments);this.title=_.escape(this.collection.conversation.group.get("friendlyName"));this.timer=setInterval(this.updateTime,6e4)},render:function(){PageView.prototype.render.apply(this,arguments);this.inputView=new MessageInputView({conversation:this.collection.conversation});this.addFooter(this.inputView.render().$el);this.$el.addClass("receiver-"+this.collection.conversation.id);this.$header=$("<div>").addClass("messages-header");this.addHeader(this.$header);this.retrievePage();return this},receiveBuddy:function(e,buddy){var $image=$(".user-"+buddy.user.id,this.$header);if(buddy.online&&$image.length==0){var src=appContext.defaultThumb;if(buddy.user.logo){src=appContext.cdn+"/users/"+buddy.user.id+"/thumbnail"}$("<img>").addClass("user-"+buddy.user.id).attr("src",src).appendTo(this.$header)}else if(!buddy.online&&$image.length>0){$image.remove()}},receiveMessage:function(e,message){message=new Message(message,{principle:appContext.getPrinciple()});if(message.isType()){if(message.isTyping()){if(message.get("source")){var html=message.get("source").name+" typing..";$("<li>").addClass("typing").html(html).appendTo(this.$el)}}else{$("li.typing",this.$el).remove()}}else{var target=this.collection.findWhere({deliveryId:message.get("deliveryId")});if(target){target.set("body",message.get("body"))}else{var itemView=new MessageItemView({model:message,inputView:this.inputView});this.$el.append(itemView.render().el);this.collection.add(message)}}this.scrollToEnd()},retrievePage:function(){var messages=new Messages([],{current:this.collection});messages.once("sync",this.renderPage);messages.fetch()},renderPage:function(messages){var $first=$("li",this.$el).first();messages.each(function(message){var itemView=new MessageItemView({model:message,inputView:this.inputView});this.$el.prepend(itemView.render().el)},this);if(this.collection.length==0){this.scrollToEnd()}else{this.scroll($first.position().top-1)}messages.more&&_.defer(_.bind(function(){$("li",this.$el).first().one("inview",this.retrievePage)},this));this.collection.addPage(messages)},scrollToEnd:function(){var last=$("li",this.$el).last();if(last.length>0){this.scroll(last.position().top+last.height())}},updateTime:function(){$("abbr.timeago",this.$el).each(function(){var $abbr=$(this);$abbr.html($.timeago(new Date($abbr.data("time"))))})},remove:function(){PageView.prototype.remove.apply(this,arguments);clearInterval(this.timer);this.removeMarginal(this.$header);this.removeMarginal(this.inputView.$el)},navbar:function(callback){this.navbarCreate("messages",this.collection.conversation.group.id,callback)}}).extend(navbarFactory)});define("api/model/conversation",["api/model/base"],function(BaseModel){return BaseModel.extend({initialize:function(attributes,options){this.group=options.group},url:function(){return this.group.url()+"/conversation"}})});define("router/message",["ext/underscore","router/group","app-context","pubsub","view/message/list","api/model/conversation","api/collection/messages"],function(_,GroupRouter,appContext,pubsub,MessageListView,Conversation,Messages){var $=jQuery;var showMessages=function(conversation){var view=new MessageListView({collection:new Messages([],{conversation:conversation})});view.render();pubsub.emit("buddies-notify",conversation.id);$.ajax({type:"POST",url:appContext.fullUrl("/v2/messages"),data:JSON.stringify({conversations:[conversation.id]}),error:function(){appContext.navigate("#error",true)},contentType:"application/json"})};return GroupRouter.extend({routes:{"messages/:groupKey":"getConversation"},getConversation:function(group){var conversation=new Conversation({},{group:group});conversation.once("sync",showMessages);conversation.fetch()}})});requirejs.config({baseUrl:"app",paths:{io:"lib/socket.io","native":"../native","underscore.string":"lib/underscore.string",moment:"lib/moment.min"},shim:{"lib/iscroll":{exports:"iScroll"}}});require(["app-context","native","router/default","router/update","router/file","router/note","router/discussion","router/event","router/task","router/comment","router/message"],function(appContext,_native,DefaultRouter,UpdateRouter,FileRouter,NoteRouter,DiscussionRouter,EventRouter,TaskRouter,CommentRouter,MessageRouter){new DefaultRouter;new UpdateRouter;new FileRouter;new NoteRouter;new DiscussionRouter;new EventRouter;new TaskRouter;new CommentRouter;new MessageRouter;Backbone.history.start({silent:true});_native.resumeAt(function(location){console.log("initialising: "+location);appContext.navigate(location?location:"#updates/dashboard",true)})});define("main",function(){});